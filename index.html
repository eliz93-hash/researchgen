<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NursePrep ‚Äì NMCN Exam Prep Nigeria</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --g:#0A6E4E;--gl:#12A070;--gd:#064A34;
  --gold:#F5A623;--goldd:#D4891A;
  --bg:#F0F7F4;--bd:#C8E6DC;
  --tx:#0D2B1F;--mt:#5A7A6E;
  --red:#E53E3E;--ok:#22C55E;
}
body{font-family:'DM Sans',sans-serif;background:#e8f5f0;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;transition:background .3s}
#app{width:100%;max-width:430px;min-height:100vh;background:#fff;position:relative;overflow:hidden;transition:background .3s}

/* === DARK MODE === */
body.dark{background:#0a0f0d}
body.dark #app{background:#0f1a14}
body.dark .pg{background:#0f1a14}
body.dark input,body.dark select,body.dark textarea{background:#1a2920;color:#e2ede8;border-color:#2a3d30}
body.dark input:focus,body.dark select:focus,body.dark textarea:focus{border-color:var(--gl)}
body.dark .auth-bar{background:#0f1a14;border-color:#1e2d22}
body.dark .auth-body{background:#0f1a14}
body.dark .auth-wrap{background:#0f1a14}
body.dark .bk{background:#1a2920;color:#a8c4b0}
body.dark .bar-title{color:#c8e6d4}
body.dark .bar-sub{color:#6a9276}
body.dark .fg .fl{color:#c8e6d4}
body.dark .sbox{background:#1a2920;border-color:#2a3d30}
body.dark .snum{color:#4ade80}
body.dark .slbl2{color:#6a9276}
body.dark .ycard{background:#1a2920;border-color:#2a3d30;color:#e2ede8}
body.dark .ycard:hover{border-color:var(--gl)}
body.dark .ynum{color:#4ade80}
body.dark .ysub{color:#6a9276}
body.dark .pchip{background:#2a3d30;color:#4ade80;border-color:#3a5040}
body.dark .tab{background:#0f1a14}
body.dark .bnav{background:#0f1a14;border-color:#1e2d22}
body.dark .ni-lbl{color:#6a9276}
body.dark .ni.on .ni-lbl{color:#4ade80}
body.dark .adcard{background:#1a2920;border-color:#2a3d30}
body.dark .adtitle{color:#c8e6d4}
body.dark .sectitle{color:#c8e6d4}
body.dark .mitem{border-color:#1e2d22}
body.dark .mlbl{color:#c8e6d4}
body.dark .mico{background:#1a2920}
body.dark .pstat{background:#1a2920;box-shadow:none}
body.dark .psnum{color:#4ade80}
body.dark .pslbl{color:#6a9276}
body.dark .promo{background:#1a2920;border-color:#2a3d30}
body.dark .fchip{background:#1a2920;border-color:#2a3d30;color:#c8e6d4}
body.dark .fchip.on{background:var(--g);color:#fff}
body.dark .opt{background:#1a2920;border-color:#2a3d30;color:#e2ede8}
body.dark .opt:hover{background:#2a3d30;border-color:var(--gl)}
body.dark .oltr{background:#2a3d30;color:#a8c4b0}
body.dark .qtxt{color:#e2ede8}
body.dark .qnum{color:#6a9276}
body.dark .expl{background:rgba(74,222,128,.06);border-color:#4ade80;color:#e2ede8}
body.dark .insight-card{background:#1a2920;border-color:#2a3d30}
body.dark .insight-title{color:#c8e6d4}
body.dark .streak-card{background:#1a2c10;border-color:rgba(245,166,35,.3)}
body.dark .al-warn{background:rgba(245,166,35,.08);border-color:rgba(245,166,35,.2)}
body.dark .al-ok{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.2)}
body.dark .al-err{background:rgba(229,62,62,.06);border-color:rgba(229,62,62,.2)}
body.dark .saved-box{border-color:#2a3d30;background:#1a2920}
body.dark .saved-hd{background:#1a2920;border-color:#2a3d30;color:#6a9276}
body.dark .saved-row{border-color:#1e2d22}
body.dark .saved-row:hover{background:#2a3d30}
body.dark .sav-name{color:#e2ede8}
body.dark .plan-card{background:#1a2920;border-color:#2a3d30;color:#e2ede8}
body.dark .plan-name{color:#c8e6d4}
body.dark .plan-price{color:#4ade80}
body.dark .ref-progress-card{background:#1a2920;border-color:#2a3d30}
body.dark .pg-result{background:#0f1a14}
body.dark .res-circle{background:#1a2920;border-color:var(--g)}
body.dark #pg-result{background:#0f1a14}
body.dark .perf-tab-btns{background:#1a2920}
body.dark .perf-tab-btn{color:#6a9276}
body.dark .perf-tab-btn.on{background:#2a3d30;color:#4ade80}
body.dark .analytics-hero{background:linear-gradient(135deg,#064A34,#0a1f15)}
body.dark .mode-btn{background:#1a2920;border-color:#2a3d30;color:#e2ede8}
body.dark .edit-modal-card{background:#1a2920;border-color:#2a3d30}
body.dark .pw-card{background:#1a2920}
body.dark .chat-bar{background:#0f1a14;border-color:#1e2d22}
body.dark .chat-inp{background:#1a2920;border-color:#2a3d30;color:#e2ede8}
body.dark .mbub{background:#1a2920;color:#e2ede8}
body.dark .info-card{background:#1a2920;border-color:#2a3d30}
body.dark .irow{border-color:#2a3d30}
body.dark .ilbl{color:#6a9276}
body.dark .ival{color:#c8e6d4}
body.dark .active-plan-card{background:#1a2920;border-color:#2a3d30}
body.dark .div{color:#6a9276}
body.dark .div::before,body.dark .div::after{background:#2a3d30}
body.dark #pg-mode-select .pg{background:#0f1a14}

/* Dark mode toggle button */
.dm-toggle{position:absolute;top:16px;right:16px;width:38px;height:38px;border-radius:50%;border:none;background:rgba(255,255,255,.15);color:#fff;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;transition:all .2s}
.dm-toggle:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}
body.dark .dm-toggle{background:rgba(255,255,255,.1)}

/* === SCREENS === */
.pg{
  display:none;min-height:100vh;
  position:absolute;top:0;left:0;width:100%;
  transform:translateX(100%);
  transition:transform .35s cubic-bezier(.4,0,.2,1),opacity .35s;
  opacity:0;will-change:transform,opacity;background:#fff;
}
.pg.on{display:block;transform:translateX(0);opacity:1;position:relative;}
#app{overflow:hidden;position:relative;}

/* === SPLASH === */
#pg-splash{background:linear-gradient(160deg,#0A6E4E 0%,#064A34 55%,#0D1F18 100%);flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
#pg-splash.on{display:flex}
.logo{font-family:'Playfair Display',serif;font-size:46px;color:#fff;margin-bottom:6px}
.logo b{color:var(--gold)}
.tagline{color:rgba(255,255,255,.6);font-size:13px;letter-spacing:2px;text-transform:uppercase;margin-bottom:48px}
.splash-icon{font-size:100px;margin-bottom:48px}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:15px 24px;border-radius:12px;font-family:'DM Sans';font-size:16px;font-weight:700;border:none;cursor:pointer;transition:all .2s;width:100%;max-width:320px;text-align:center}
.btn-gold{background:var(--gold);color:var(--gd)}
.btn-gold:hover{background:var(--goldd)}
.btn-ghost{background:transparent;color:#fff;border:1.5px solid rgba(255,255,255,.4);margin-top:12px}
.btn-ghost:hover{background:rgba(255,255,255,.1)}
.btn-green{background:var(--g);color:#fff}
.btn-green:hover{background:var(--gl)}
.btn-grey{background:var(--bg);color:var(--mt)}
.btn-red{background:var(--red);color:#fff}
.btn:disabled{opacity:.6;cursor:not-allowed}

/* === AUTH WRAPPER === */
.auth-wrap{display:flex;flex-direction:column;min-height:100vh}
.auth-bar{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--bd);background:#fff;position:sticky;top:0;z-index:20}
.bk{width:36px;height:36px;border-radius:50%;border:none;background:var(--bg);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bar-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--gd)}
.bar-sub{font-size:12px;color:var(--mt)}
.auth-body{padding:24px 20px 60px;flex:1;overflow-y:auto}

/* === STEPS === */
.steps-row{display:flex;align-items:center;margin-bottom:6px}
.sdot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;transition:all .3s}
.sdot.done{background:var(--g);color:#fff}
.sdot.active{background:var(--gold);color:var(--gd);box-shadow:0 0 0 4px rgba(245,166,35,.2)}
.sdot.todo{background:var(--bd);color:var(--mt)}
.sline{flex:1;height:2px;background:var(--bd);margin:0 5px;transition:background .3s}
.sline.done{background:var(--g)}
.slabels{display:flex;justify-content:space-between;margin-bottom:24px}
.slabel{font-size:10px;color:var(--mt);text-align:center;flex:1}
.slabel.active{color:var(--g);font-weight:700}

/* === FORM === */
.fg{margin-bottom:16px}
.fl{font-size:13px;font-weight:600;color:var(--tx);margin-bottom:6px;display:block}
.iw{position:relative}
.il{position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:15px;pointer-events:none}
.ir{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:15px;color:var(--mt)}
input,select,textarea{width:100%;padding:13px 16px;border:1.5px solid var(--bd);border-radius:10px;font-family:'DM Sans';font-size:15px;background:#fff;color:var(--tx);transition:border-color .2s;-webkit-appearance:none;appearance:none}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--g)}
.pl{padding-left:42px}
.pr{padding-right:42px}
.err-field{font-size:12px;color:var(--red);margin-top:5px;min-height:18px}
.hint{font-size:12px;color:var(--mt);margin-top:5px}

/* === PW STRENGTH === */
.pw-bars{display:flex;gap:4px;margin-top:8px}
.pw-bar{flex:1;height:4px;border-radius:2px;background:var(--bd);transition:background .3s}
.pw-lbl{font-size:11px;font-weight:600;margin-top:4px;min-height:16px}

/* === PHOTO === */
.photo-area{display:flex;flex-direction:column;align-items:center;margin-bottom:24px}
.photo-ring{width:90px;height:90px;border-radius:50%;border:2.5px dashed var(--bd);background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;overflow:hidden}
.photo-ring:hover{border-color:var(--g)}
.photo-ring img{width:100%;height:100%;object-fit:cover}
.photo-tip{font-size:13px;color:var(--mt);margin-top:8px}

/* === CHECKBOX === */
.ckrow{display:flex;align-items:flex-start;gap:10px;padding:12px;background:var(--bg);border-radius:10px;margin-bottom:4px;cursor:pointer;user-select:none}
.ckbox{width:20px;height:20px;border-radius:6px;border:2px solid var(--bd);background:#fff;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;transition:all .2s;margin-top:1px}
.ckbox.on{background:var(--g);border-color:var(--g)}
.cktext{font-size:13px;color:var(--mt);line-height:1.6}
.cktext a{color:var(--g);font-weight:600}

/* === OTP === */
.otp-row{display:flex;gap:10px;justify-content:center;margin:20px 0}
.otp-box{width:52px;height:60px;border:2px solid var(--bd);border-radius:12px;font-size:26px;font-weight:700;text-align:center;font-family:'DM Sans';color:var(--tx);transition:all .2s;background:#fff}
.otp-box:focus{outline:none;border-color:var(--g);box-shadow:0 0 0 3px rgba(10,110,78,.1)}
.otp-box.filled{border-color:var(--g);background:rgba(10,110,78,.04)}

/* === SUCCESS === */
#pg-success{flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center;background:linear-gradient(160deg,#f0f9f4,#fff)}
#pg-success.on{display:flex}
.suc-icon{width:110px;height:110px;border-radius:50%;background:linear-gradient(135deg,var(--g),var(--gl));display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:50px;animation:pop .5s cubic-bezier(.175,.885,.32,1.275)}
@keyframes pop{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.suc-title{font-family:'Playfair Display',serif;font-size:26px;color:var(--gd);margin-bottom:10px}
.suc-sub{color:var(--mt);font-size:14px;line-height:1.7;margin-bottom:20px}
.info-card{background:#fff;border-radius:14px;border:1.5px solid var(--bd);padding:16px;width:100%;max-width:300px;margin:0 auto 20px;text-align:left}
.irow{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--bg);font-size:13px}
.irow:last-child{border-bottom:none}
.ilbl{color:var(--mt)}
.ival{font-weight:600;color:var(--tx);max-width:55%;text-align:right;font-size:12px}

/* === ALERTS === */
.al{padding:13px 16px;border-radius:12px;font-size:14px;margin-bottom:14px;line-height:1.5}
.al-warn{background:rgba(245,166,35,.1);color:var(--goldd);border:1px solid rgba(245,166,35,.3)}
.al-err{background:rgba(229,62,62,.08);color:var(--red);border:1px solid rgba(229,62,62,.25)}
.al-ok{background:rgba(34,197,94,.08);color:#15803d;border:1px solid rgba(34,197,94,.25)}

/* === DIVIDER === */
.div{display:flex;align-items:center;gap:12px;margin:18px 0;color:var(--mt);font-size:13px}
.div::before,.div::after{content:'';flex:1;height:1px;background:var(--bd)}

/* === SAVED ACCOUNTS === */
.saved-box{margin-top:20px;border:1.5px solid var(--bd);border-radius:12px;overflow:hidden}
.saved-hd{padding:10px 16px;font-size:11px;font-weight:700;color:var(--mt);background:var(--bg);border-bottom:1px solid var(--bd);letter-spacing:1px;text-transform:uppercase}
.saved-row{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--bg);transition:background .15s}
.saved-row:last-child{border-bottom:none}
.saved-row:hover{background:var(--bg)}
.sav-av{width:34px;height:34px;border-radius:50%;background:var(--g);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;overflow:hidden}
.sav-av img{width:100%;height:100%;object-fit:cover}
.sav-name{font-weight:600;font-size:14px}
.sav-email{font-size:12px;color:var(--mt)}
.sav-hint{font-size:11px;color:var(--g);margin-left:auto;white-space:nowrap}

/* === MAIN APP === */
#pg-main{padding-bottom:72px}
#pg-main.on{display:block}
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:#fff;border-top:1px solid var(--bd);display:flex;padding:8px 0 14px;z-index:100}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:4px;transition:all .2s}
.ni-ico{font-size:22px}
.ni-lbl{font-size:10px;font-weight:600;color:var(--mt)}
.ni.on .ni-lbl{color:var(--g)}
.ni.on .ni-ico{transform:scale(1.1)}
.tab{display:none;padding:20px 16px 20px}
.tab.on{display:block}

/* Home */
.greet{background:linear-gradient(135deg,var(--g),var(--gd));border-radius:20px;padding:22px;margin-bottom:18px;position:relative;overflow:hidden}
.greet::after{content:'üè•';position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:56px;opacity:.1;pointer-events:none}
.greet-name{font-family:'Playfair Display',serif;font-size:22px;color:#fff}
.greet-sch{color:rgba(255,255,255,.7);font-size:13px;margin-top:3px}
.gbadge{display:inline-flex;align-items:center;gap:5px;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:600;margin-top:10px}
.gbadge.free{background:rgba(245,166,35,.2);border:1px solid rgba(245,166,35,.5);color:var(--gold)}
.gbadge.pro{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.5);color:#22c55e}
.smini{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px}
.sbox{background:#fff;border:1.5px solid var(--bd);border-radius:14px;padding:14px 8px;text-align:center}
.snum{font-family:'Playfair Display',serif;font-size:22px;color:var(--g);font-weight:900}
.slbl2{font-size:11px;color:var(--mt);margin-top:2px}
.sectitle{font-family:'Playfair Display',serif;font-size:18px;color:var(--gd);margin-bottom:12px}
.qbtns{display:flex;gap:8px;margin-bottom:20px}
.qbtn{flex:1;padding:14px 6px;border-radius:12px;background:var(--g);color:#fff;border:none;cursor:pointer;font-family:'DM Sans';font-size:12px;font-weight:700;line-height:1.5;text-align:center;transition:all .2s}
.qbtn:hover{background:var(--gl);transform:translateY(-1px)}
.promo{background:#fff8e6;border:1.5px solid rgba(245,166,35,.35);border-radius:16px;padding:18px;display:flex;gap:12px;align-items:flex-start}

/* Questions */
.fbar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.fchip{padding:6px 14px;border-radius:20px;border:1.5px solid var(--bd);background:#fff;font-family:'DM Sans';font-size:12px;font-weight:600;cursor:pointer;color:var(--tx);transition:all .2s}
.fchip.on{background:var(--g);color:#fff;border-color:var(--g)}
.ygrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ycard{background:#fff;border:1.5px solid var(--bd);border-radius:14px;padding:16px;cursor:pointer;transition:all .2s;position:relative}
.ycard:hover{border-color:var(--g);transform:translateY(-2px);box-shadow:0 4px 20px rgba(10,110,78,.1)}
.ycard.locked{opacity:.75}
.ynum{font-family:'Playfair Display',serif;font-size:22px;color:var(--g);font-weight:900}
.ysub{font-size:11px;color:var(--mt);margin-top:2px}
.lockico{position:absolute;top:10px;right:10px;font-size:14px}
.pchips{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.pchip{font-size:10px;padding:3px 9px;border-radius:20px;background:var(--bg);color:var(--g);font-weight:600;border:1px solid var(--bd);cursor:pointer;transition:all .2s}
.pchip:hover{background:var(--g);color:#fff}
.pchip.empty{opacity:.5;cursor:default}

/* Chat */
#tab-chat{padding:0}
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 72px)}
.chat-hdr{background:var(--gd);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:12px;flex-shrink:0}
.chav{width:38px;height:38px;border-radius:50%;background:var(--gold);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:var(--gd);flex-shrink:0}
.ch-title{font-weight:600;font-size:15px}
.ch-sub{font-size:11px;opacity:.7}
.cbtns{margin-left:auto;display:flex;gap:8px}
.cbtn{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.15);border:none;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cbtn:hover{background:rgba(255,255,255,.25)}
.msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.msg{display:flex;gap:8px;max-width:82%}
.msg.me{align-self:flex-end;flex-direction:row-reverse}
.mav{width:30px;height:30px;border-radius:50%;background:var(--gl);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.mbub{background:var(--bg);border-radius:0 14px 14px 14px;padding:10px 14px;font-size:14px;line-height:1.5}
.msg.me .mbub{background:var(--g);color:#fff;border-radius:14px 0 14px 14px}
.msender{font-size:11px;font-weight:700;color:var(--g);margin-bottom:3px}
.mtime{font-size:10px;color:var(--mt);margin-top:3px;text-align:right}
.msg.me .mtime{color:rgba(255,255,255,.7)}
.vbub{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(10,110,78,.1);border-radius:20px;cursor:pointer}
.wave{display:flex;gap:2px;align-items:center}
.wave span{display:block;width:3px;background:var(--g);border-radius:2px}
@keyframes wv{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.4)}}
.wave span:nth-child(1){height:8px;animation:wv .8s infinite 0s}
.wave span:nth-child(2){height:16px;animation:wv .8s infinite .1s}
.wave span:nth-child(3){height:11px;animation:wv .8s infinite .2s}
.wave span:nth-child(4){height:20px;animation:wv .8s infinite .3s}
.wave span:nth-child(5){height:9px;animation:wv .8s infinite .15s}
.chat-bar{padding:12px 16px;border-top:1px solid var(--bd);display:flex;gap:8px;align-items:center;background:#fff;flex-shrink:0}
.chat-inp{flex:1;padding:10px 14px;border:1.5px solid var(--bd);border-radius:24px;font-family:'DM Sans';font-size:14px;color:var(--tx)}
.chat-inp:focus{outline:none;border-color:var(--g)}
.sendbtn{width:40px;height:40px;border-radius:50%;background:var(--g);border:none;color:#fff;font-size:18px;cursor:pointer;flex-shrink:0}
.micbtn{width:40px;height:40px;border-radius:50%;background:var(--bg);border:1.5px solid var(--bd);font-size:18px;cursor:pointer;flex-shrink:0}

/* Profile */
#tab-profile{padding:0 0 20px}
.prof-hdr{background:linear-gradient(135deg,var(--gd),var(--g));padding:36px 24px 56px;text-align:center}
.pav{width:88px;height:88px;border-radius:50%;background:var(--gold);border:3px solid #fff;display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:700;color:var(--gd);margin:0 auto 12px;overflow:hidden}
.pav img{width:100%;height:100%;object-fit:cover}
.pname{font-family:'Playfair Display',serif;font-size:22px;color:#fff}
.psch{color:rgba(255,255,255,.7);font-size:13px;margin-top:3px}
.pstats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:-30px 16px 20px}
.pstat{background:#fff;border-radius:14px;padding:12px 8px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.08)}
.psnum{font-family:'Playfair Display',serif;font-size:20px;color:var(--g);font-weight:900}
.pslbl{font-size:10px;color:var(--mt);margin-top:2px}
.pmenu{padding:0 16px}
.mitem{display:flex;align-items:center;gap:14px;padding:15px 0;border-bottom:1px solid var(--bg);cursor:pointer;transition:background .15s}
.mico{font-size:18px;width:36px;height:36px;background:var(--bg);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.mlbl{flex:1;font-size:15px;font-weight:500}
.marr{color:var(--mt)}

/* Quiz */
#pg-quiz{padding:20px 16px 40px}
.quiz-top{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.quiz-ttl{font-family:'Playfair Display',serif;font-size:17px;flex:1}
.tag{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700}
.tag-o{background:rgba(245,166,35,.15);color:var(--goldd)}
.tag-g{background:rgba(34,197,94,.1);color:#15803d}
.pbar{height:6px;background:var(--bd);border-radius:3px;margin-bottom:20px}
.pfill{height:100%;background:linear-gradient(90deg,var(--g),var(--gl));border-radius:3px;transition:width .4s}
.qnum{font-size:11px;color:var(--mt);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.qtxt{font-size:16px;font-weight:500;line-height:1.65;margin-bottom:20px;color:var(--tx)}
.opts{display:flex;flex-direction:column;gap:10px}
.opt{padding:14px 16px;border:1.5px solid var(--bd);border-radius:12px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;font-size:15px;color:var(--tx)}
.opt:hover{border-color:var(--g);background:var(--bg)}
.opt.sel{border-color:var(--g);background:rgba(10,110,78,.06)}
.opt.cor{border-color:var(--ok);background:rgba(34,197,94,.08)}
.opt.wrg{border-color:var(--red);background:rgba(229,62,62,.08)}
.oltr{width:28px;height:28px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.opt.sel .oltr{background:var(--g);color:#fff}
.opt.cor .oltr{background:var(--ok);color:#fff}
.opt.wrg .oltr{background:var(--red);color:#fff}
.expl{margin-top:16px;padding:14px;background:rgba(10,110,78,.06);border-left:3px solid var(--g);border-radius:0 8px 8px 0;font-size:14px;line-height:1.6;color:var(--tx)}

/* Result */
#pg-result{padding:48px 24px 40px;text-align:center;min-height:100vh;flex-direction:column;align-items:center;justify-content:center}
#pg-result.on{display:flex}
.res-circle{width:150px;height:150px;border-radius:50%;border:6px solid var(--g);margin:0 auto 20px;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#fff}
.res-pct{font-family:'Playfair Display',serif;font-size:40px;color:var(--g);line-height:1}
.res-frac{font-size:12px;color:var(--mt);margin-top:2px}

/* === LOADING ANIMATION === */
#quiz-loading-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:linear-gradient(160deg,#0A6E4E,#064A34 55%,#0D1F18);
  z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:40px 24px;
}
#quiz-loading-overlay.show{display:flex}
.loading-pulse{font-size:80px;animation:pulse-in 1.2s cubic-bezier(.175,.885,.32,1.275) forwards}
@keyframes pulse-in{0%{transform:scale(0) rotate(-15deg);opacity:0}60%{transform:scale(1.1) rotate(3deg)}100%{transform:scale(1) rotate(0deg);opacity:1}}
.loading-title{font-family:'Playfair Display',serif;font-size:24px;color:#fff;margin:18px 0 8px}
.loading-sub{color:rgba(255,255,255,.6);font-size:13px;margin-bottom:32px;line-height:1.7}
.loading-bar-wrap{width:220px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden}
.loading-bar-fill{height:100%;background:var(--gold);border-radius:3px;animation:loadbar 1.5s cubic-bezier(.4,0,.2,1) forwards}
@keyframes loadbar{from{width:0}to{width:100%}}
.loading-facts{margin-top:28px;font-size:12px;color:rgba(255,255,255,.45);max-width:260px;line-height:1.7;min-height:50px}

/* === BOOKMARK BUTTON === */
.bm-btn{
  width:36px;height:36px;border-radius:50%;border:none;
  background:rgba(245,166,35,.1);color:var(--gold);
  font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;flex-shrink:0;
}
.bm-btn:hover{background:rgba(245,166,35,.2);transform:scale(1.1)}
.bm-btn.bookmarked{background:var(--gold);color:#fff}
.bookmark-toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--goldd);color:#fff;padding:8px 18px;border-radius:20px;font-size:13px;font-weight:700;z-index:1000;opacity:0;transition:opacity .3s;white-space:nowrap}
.bookmark-toast.show{opacity:1}

/* Bookmarks page */
#pg-bookmarks .bm-q-card{background:#fff;border:1.5px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:12px}
body.dark #pg-bookmarks .bm-q-card{background:#1a2920;border-color:#2a3d30}
.bm-q-meta{font-size:11px;color:var(--mt);font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.bm-q-text{font-size:14px;font-weight:500;line-height:1.6;color:var(--tx);margin-bottom:10px}
body.dark .bm-q-text{color:#e2ede8}
.bm-q-answer{font-size:13px;padding:8px 12px;background:rgba(10,110,78,.07);border-left:3px solid var(--g);border-radius:0 8px 8px 0;color:var(--g);font-weight:600;margin-bottom:8px}

/* === REPORT BUTTON === */
.rpt-btn{
  width:36px;height:36px;border-radius:50%;border:none;
  background:rgba(229,62,62,.08);color:var(--red);
  font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;flex-shrink:0;
}
.rpt-btn:hover{background:rgba(229,62,62,.18);transform:scale(1.1)}
/* Report modal */
#report-modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);
  z-index:9000;display:none;align-items:flex-end;justify-content:center;
}
#report-modal-overlay.show{display:flex}
.report-modal-card{
  background:#fff;border-radius:20px 20px 0 0;padding:24px 20px 40px;
  width:100%;max-width:430px;
}
body.dark .report-modal-card{background:#1a2920}
.report-modal-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--gd);margin-bottom:6px}
body.dark .report-modal-title{color:#c8e6d4}
.report-modal-sub{font-size:13px;color:var(--mt);margin-bottom:16px}
.report-options{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.report-opt{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg);border-radius:10px;cursor:pointer;transition:all .2s;border:1.5px solid transparent}
body.dark .report-opt{background:#2a3d30}
.report-opt:hover,.report-opt.on{border-color:var(--red);background:rgba(229,62,62,.07)}
.report-opt-ico{font-size:20px;width:32px;text-align:center}
.report-opt-lbl{font-size:14px;font-weight:500;color:var(--tx)}
body.dark .report-opt-lbl{color:#e2ede8}

/* === SHAREABLE RESULT CERTIFICATE === */
#cert-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.85);z-index:9500;display:none;
  flex-direction:column;align-items:center;justify-content:center;padding:20px;
}
#cert-overlay.show{display:flex}
.cert-card{
  background:linear-gradient(145deg,#0f2318,#1a3a25);
  border:2px solid rgba(245,166,35,.5);border-radius:20px;
  padding:28px 24px;width:100%;max-width:380px;text-align:center;
  position:relative;overflow:hidden;
}
.cert-card::before{
  content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;
  border-radius:50%;background:rgba(245,166,35,.06);
}
.cert-card::after{
  content:'';position:absolute;bottom:-40px;left:-40px;width:140px;height:140px;
  border-radius:50%;background:rgba(10,110,78,.1);
}
.cert-logo{font-family:'Playfair Display',serif;font-size:28px;color:#fff;margin-bottom:4px}
.cert-logo b{color:var(--gold)}
.cert-tagline{font-size:10px;color:rgba(255,255,255,.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:20px}
.cert-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(245,166,35,.4),transparent);margin:14px 0}
.cert-title{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
.cert-name{font-family:'Playfair Display',serif;font-size:22px;color:#fff;margin-bottom:4px}
.cert-score-ring{width:100px;height:100px;margin:12px auto}
.cert-pct{font-family:'Playfair Display',serif;font-size:32px;font-weight:900;margin:6px 0}
.cert-verdict{font-size:18px;font-weight:700;letter-spacing:1px;margin-bottom:4px}
.cert-paper{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:16px}
.cert-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.cert-stat{background:rgba(255,255,255,.06);border-radius:10px;padding:8px 4px;text-align:center}
.cert-stat-num{font-family:'Playfair Display',serif;font-size:16px;color:#fff;font-weight:900}
.cert-stat-lbl{font-size:10px;color:rgba(255,255,255,.45);margin-top:2px}
.cert-date{font-size:11px;color:rgba(255,255,255,.35);margin-top:6px}
.cert-actions{display:flex;flex-direction:column;gap:10px;margin-top:16px;width:100%;max-width:380px}

/* === CONTINUE LAST QUIZ === */
.continue-card{
  background:linear-gradient(135deg,#1a2920,#0f2318);
  border:1.5px solid rgba(74,222,128,.25);border-radius:16px;
  padding:16px;margin-bottom:18px;display:none;
  cursor:pointer;transition:all .2s;position:relative;overflow:hidden;
}
.continue-card::after{content:'';position:absolute;right:-10px;top:-10px;width:80px;height:80px;border-radius:50%;background:rgba(74,222,128,.05)}
.continue-card:hover{border-color:rgba(74,222,128,.5);transform:translateY(-1px)}
.continue-card-top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.continue-card-ico{font-size:28px}
.continue-card-label{font-size:10px;color:rgba(255,255,255,.45);letter-spacing:1.5px;text-transform:uppercase;font-weight:700}
.continue-card-title{font-family:'Playfair Display',serif;font-size:16px;color:#fff}
.continue-card-meta{font-size:12px;color:rgba(255,255,255,.5);margin-top:3px}
.continue-card-bar{height:3px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;margin-top:10px}
.continue-card-fill{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);border-radius:2px;transition:width .5s}
.continue-card-pct{font-size:11px;color:#4ade80;font-weight:700;margin-top:4px}

/* === ADMIN PAGE (separate from student) === */
#pg-admin{background:#f5f7fa}
#pg-admin.on{display:block}
.adm-bar{background:linear-gradient(135deg,#1a1a2e,#16213e);padding:20px 20px 16px;display:flex;align-items:center;gap:12px}
.adm-bar-title{font-family:'Playfair Display',serif;font-size:20px;color:#fff;flex:1}
.adm-bar-sub{font-size:11px;color:rgba(255,255,255,.6)}
.adm-badge{background:rgba(245,166,35,.2);border:1px solid rgba(245,166,35,.5);color:var(--gold);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
.adm-body{padding:16px;overflow-y:auto;padding-bottom:40px}
.adcard{background:#fff;border:1.5px solid var(--bd);border-radius:16px;padding:20px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.adtitle{font-weight:700;font-size:15px;color:var(--gd);margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* code generation */
.code-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg);border-radius:10px;margin-bottom:8px;border:1px solid var(--bd)}
.code-val{font-family:monospace;font-size:16px;font-weight:700;color:var(--g);flex:1;letter-spacing:2px}
.code-meta{font-size:11px;color:var(--mt)}
.code-badge{font-size:10px;padding:3px 8px;border-radius:12px;font-weight:700}
.code-badge.active{background:rgba(34,197,94,.1);color:#15803d;border:1px solid rgba(34,197,94,.3)}
.code-badge.used{background:rgba(229,62,62,.08);color:var(--red);border:1px solid rgba(229,62,62,.2)}
.code-badge.expired{background:rgba(90,122,110,.1);color:var(--mt);border:1px solid var(--bd)}

/* parse area */
.parse-area{width:100%;padding:14px;border:1.5px dashed var(--bd);border-radius:10px;font-family:'DM Sans';font-size:14px;min-height:120px;resize:vertical;color:var(--tx);background:#fafffe;line-height:1.6}
.parse-area:focus{outline:none;border-color:var(--g)}
.parsed-preview{background:var(--bg);border-radius:10px;padding:14px;margin-top:10px;font-size:13px;line-height:1.7;max-height:200px;overflow-y:auto}
.pq-item{border-bottom:1px solid var(--bd);padding-bottom:10px;margin-bottom:10px}
.pq-item:last-child{border-bottom:none;margin-bottom:0}
.pq-q{font-weight:600;color:var(--tx);margin-bottom:4px}
.pq-opts{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.pq-opt{font-size:12px;color:var(--mt);padding:3px 8px;border-radius:6px;background:#fff}
.pq-opt.correct{background:rgba(34,197,94,.1);color:#15803d;font-weight:600}

/* Admin login page */
#pg-admin-login{background:linear-gradient(160deg,#1a1a2e 0%,#16213e 55%,#0f3460 100%);flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
#pg-admin-login.on{display:flex}

/* Paywall overlay */
#pw-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:300;display:none;align-items:flex-end;justify-content:center}
#pw-overlay.show{display:flex}
.pw-card{background:#fff;border-radius:24px 24px 0 0;padding:28px 24px;width:100%;max-width:430px;animation:sup .3s ease}
@keyframes sup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.pw-ico{font-size:46px;text-align:center;margin-bottom:14px}
.pw-ttl{font-family:'Playfair Display',serif;font-size:22px;text-align:center;margin-bottom:8px;color:var(--gd)}
.pw-sub{color:var(--mt);text-align:center;font-size:14px;margin-bottom:20px;line-height:1.6}
.pbox{border:2px solid var(--g);border-radius:14px;padding:18px;text-align:center;margin-bottom:16px;background:var(--bg)}
.pamt{font-family:'Playfair Display',serif;font-size:30px;color:var(--g)}
.pdesc{font-size:13px;color:var(--mt);margin-top:4px}
.crow{display:flex;gap:10px;margin-top:14px}

/* ===== COUNCIL MOCK EXAM ===== */
/* Mock exam full-screen page */
#pg-mock{background:#0D1117;min-height:100vh}
#pg-mock.on{display:flex;flex-direction:column}

/* Top bar */
.mock-topbar{background:#111827;padding:10px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;border-bottom:1px solid #1F2937;position:sticky;top:0;z-index:50}
.mock-topbar-title{font-family:'Playfair Display',serif;font-size:14px;color:#fff;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mock-timer{display:flex;align-items:center;gap:5px;background:#1F2937;border-radius:10px;padding:6px 12px;flex-shrink:0}
.mock-timer-ico{font-size:14px}
.mock-timer-val{font-family:'DM Sans';font-size:16px;font-weight:700;color:#34D399;letter-spacing:.5px;min-width:48px;text-align:center}
.mock-timer.warn .mock-timer-val{color:#FBBF24;animation:pulse-warn 1s ease-in-out infinite}
.mock-timer.crit .mock-timer-val{color:#F87171;animation:pulse-crit .6s ease-in-out infinite}
@keyframes pulse-warn{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes pulse-crit{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.mock-timer-bar{height:3px;background:#1F2937;flex-shrink:0}
.mock-timer-fill{height:100%;background:linear-gradient(90deg,#34D399,#10B981);transition:width 1s linear;border-radius:0 2px 2px 0}
.mock-timer-fill.warn{background:linear-gradient(90deg,#FBBF24,#F59E0B)}
.mock-timer-fill.crit{background:linear-gradient(90deg,#F87171,#EF4444)}

/* Question palette */
.mock-palette-wrap{background:#111827;padding:10px 14px;border-bottom:1px solid #1F2937;flex-shrink:0}
.mock-palette-label{font-size:10px;font-weight:700;color:#6B7280;letter-spacing:1px;margin-bottom:8px;text-transform:uppercase}
.mock-palette{display:flex;flex-wrap:wrap;gap:5px}
.mock-dot{width:28px;height:28px;border-radius:6px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0;border:1.5px solid transparent}
.mock-dot.unanswered{background:#1F2937;color:#6B7280;border-color:#374151}
.mock-dot.answered{background:#065F46;color:#34D399;border-color:#059669}
.mock-dot.current{background:#1D4ED8;color:#fff;border-color:#3B82F6;transform:scale(1.15)}
.mock-dot.flagged{background:#78350F;color:#FCD34D;border-color:#D97706}
.mock-dot.flagged.answered{background:#854D0E;color:#FDE68A;border-color:#D97706}

/* Question body */
.mock-body{flex:1;overflow-y:auto;padding:16px;background:#0D1117}
.mock-qnum{font-size:11px;font-weight:700;letter-spacing:1px;color:#6B7280;margin-bottom:6px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between}
.mock-flag-btn{background:none;border:1px solid #374151;color:#9CA3AF;font-size:11px;font-weight:700;padding:3px 8px;border-radius:8px;cursor:pointer;transition:all .2s}
.mock-flag-btn.on{background:#78350F;border-color:#D97706;color:#FCD34D}
.mock-qtxt{font-size:15px;font-weight:500;line-height:1.7;color:#F9FAFB;margin-bottom:18px}
.mock-opts{display:flex;flex-direction:column;gap:9px}
.mock-opt{padding:13px 15px;border:1.5px solid #374151;border-radius:12px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;color:#D1D5DB;background:#111827}
.mock-opt:hover{border-color:#4B5563;background:#1F2937}
.mock-opt.sel{border-color:#3B82F6;background:rgba(59,130,246,.12);color:#93C5FD}
.mock-oltr{width:28px;height:28px;border-radius:50%;background:#1F2937;border:1.5px solid #4B5563;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;color:#9CA3AF;transition:all .2s}
.mock-opt.sel .mock-oltr{background:#3B82F6;border-color:#3B82F6;color:#fff}

/* Nav bar */
.mock-navbar{background:#111827;border-top:1px solid #1F2937;padding:10px 14px;display:flex;gap:8px;align-items:center;flex-shrink:0}
.mock-navbtn{flex:1;padding:11px;border-radius:10px;border:none;font-family:'DM Sans';font-size:13px;font-weight:700;cursor:pointer;transition:all .2s}
.mock-navbtn:disabled{opacity:.35;cursor:not-allowed}
.mock-prev{background:#1F2937;color:#9CA3AF}
.mock-prev:hover:not(:disabled){background:#374151;color:#fff}
.mock-next{background:#1D4ED8;color:#fff}
.mock-next:hover:not(:disabled){background:#2563EB}
.mock-submit-btn{background:linear-gradient(135deg,#059669,#047857);color:#fff;padding:11px 16px;border-radius:10px;border:none;font-family:'DM Sans';font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap}
.mock-submit-btn:hover{background:linear-gradient(135deg,#10B981,#059669)}

/* Submit confirm overlay */
.mock-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:flex;align-items:flex-end;justify-content:center}
.mock-overlay-card{background:#1F2937;border-radius:24px 24px 0 0;padding:28px 24px 36px;width:100%;max-width:430px;animation:sup .3s ease}
.mock-overlay-title{font-family:'Playfair Display',serif;font-size:20px;color:#fff;margin-bottom:8px}
.mock-overlay-sub{font-size:14px;color:#9CA3AF;line-height:1.6;margin-bottom:20px}
.mock-stat-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151;font-size:14px}
.mock-stat-row:last-child{border-bottom:none}
.mock-stat-lbl{color:#9CA3AF}
.mock-stat-val{font-weight:700;color:#F9FAFB}

/* Mock result page */
#pg-mock-result{background:linear-gradient(160deg,#0D1117 0%,#111827 100%);min-height:100vh}
#pg-mock-result.on{display:flex;flex-direction:column}
.mock-cert{margin:20px 16px;background:#111827;border:2px solid #1F2937;border-radius:20px;padding:24px;text-align:center}
.mock-cert-title{font-family:'Playfair Display',serif;font-size:13px;letter-spacing:2px;color:#6B7280;text-transform:uppercase;margin-bottom:4px}
.mock-cert-name{font-family:'Playfair Display',serif;font-size:22px;color:#F9FAFB;margin-bottom:16px}
.mock-score-ring{width:140px;height:140px;border-radius:50%;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;flex-direction:column;position:relative}
.mock-score-ring svg{position:absolute;inset:0;width:100%;height:100%;transform:rotate(-90deg)}
.mock-score-pct{font-family:'Playfair Display',serif;font-size:38px;font-weight:900;line-height:1;position:relative;z-index:1}
.mock-score-lbl{font-size:11px;color:#9CA3AF;position:relative;z-index:1;margin-top:2px}
.mock-verdict{font-size:18px;font-weight:700;margin-bottom:4px}
.mock-verdict-sub{font-size:13px;color:#9CA3AF;margin-bottom:20px}
.mock-breakdown-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:0 16px 14px}
.mock-stat-card{background:#111827;border:1.5px solid #1F2937;border-radius:14px;padding:14px;text-align:center}
.mock-stat-card-num{font-family:'Playfair Display',serif;font-size:24px;font-weight:900;margin-bottom:2px}
.mock-stat-card-lbl{font-size:11px;color:#6B7280}
.mock-review-section{margin:0 16px;background:#111827;border:1.5px solid #1F2937;border-radius:16px;overflow:hidden;margin-bottom:16px}
.mock-review-hdr{padding:14px 16px;border-bottom:1px solid #1F2937;font-weight:700;font-size:14px;color:#F9FAFB;display:flex;justify-content:space-between;align-items:center}
.mock-review-item{padding:14px 16px;border-bottom:1px solid #1F2937;cursor:pointer}
.mock-review-item:last-child{border-bottom:none}
.mock-review-item-top{display:flex;gap:10px;align-items:flex-start;margin-bottom:8px}
.mock-review-item-num{font-size:11px;font-weight:700;color:#6B7280;flex-shrink:0;margin-top:2px}
.mock-review-item-q{font-size:13px;color:#D1D5DB;line-height:1.5;flex:1}
.mock-review-opts{display:flex;flex-direction:column;gap:4px}
.mock-review-opt{font-size:12px;padding:5px 10px;border-radius:7px;display:flex;align-items:center;gap:7px}
.mock-review-opt.cor{background:rgba(16,185,129,.12);color:#34D399}
.mock-review-opt.wrg{background:rgba(239,68,68,.1);color:#FCA5A5}
.mock-review-opt.neu{color:#6B7280}
.mock-review-expl{font-size:12px;color:#6B7280;line-height:1.6;padding:8px 10px;background:rgba(255,255,255,.03);border-radius:8px;margin-top:6px;border-left:2px solid #34D399}

/* Mock home card */
.mock-home-card{background:linear-gradient(135deg,#1E1B4B,#312E81);border-radius:18px;padding:18px;margin-bottom:18px;position:relative;overflow:hidden;cursor:pointer;transition:transform .2s}
.mock-home-card:hover{transform:translateY(-2px)}
.mock-home-card::after{content:'üè•';position:absolute;right:14px;bottom:-4px;font-size:60px;opacity:.12;pointer-events:none}
.mock-home-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(167,139,250,.2);border:1px solid rgba(167,139,250,.4);color:#C4B5FD;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;margin-bottom:10px}
.mock-home-title{font-family:'Playfair Display',serif;font-size:20px;color:#fff;margin-bottom:5px}
.mock-home-desc{font-size:12px;color:rgba(255,255,255,.6);line-height:1.6;margin-bottom:14px}
.mock-home-pills{display:flex;gap:6px;flex-wrap:wrap}
.mock-home-pill{background:rgba(255,255,255,.1);color:rgba(255,255,255,.75);font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px}
.mock-locked-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);border-radius:18px;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px)}

/* Admin mock tab */
.mock-admin-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.mock-admin-stat{background:var(--bg);border-radius:10px;padding:12px 8px;text-align:center}
.mock-admin-stat-num{font-family:'Playfair Display',serif;font-size:20px;color:var(--g)}
.mock-admin-stat-lbl{font-size:10px;color:var(--mt);margin-top:2px}

/* === NEW ADMIN POWER FEATURES === */

/* Analytics per year */
.analytics-year-grid{display:flex;flex-direction:column;gap:8px}
.analytics-year-row{background:#fff;border:1.5px solid var(--bd);border-radius:12px;padding:14px;cursor:pointer;transition:all .2s}
.analytics-year-row:hover{border-color:var(--g);box-shadow:0 4px 12px rgba(10,110,78,.1)}
.analytics-year-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.analytics-year-badge{font-family:'Playfair Display',serif;font-size:18px;color:var(--gd)}
.analytics-year-total{font-size:12px;color:var(--mt)}
.analytics-year-bars{display:flex;gap:6px}
.analytics-paper-bar{flex:1;text-align:center}
.analytics-paper-track{height:6px;background:var(--bd);border-radius:3px;margin-bottom:3px;overflow:hidden}
.analytics-paper-fill{height:100%;border-radius:3px;background:var(--g);transition:width .5s}
.analytics-paper-lbl{font-size:9px;color:var(--mt)}
.analytics-paper-num{font-size:11px;font-weight:700;color:var(--gd)}

/* User performance tracking */
.user-perf-card{background:#fff;border:1.5px solid var(--bd);border-radius:14px;overflow:hidden;margin-bottom:10px}
.user-perf-hd{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;transition:background .15s}
.user-perf-hd:hover{background:var(--bg)}
.user-perf-body{padding:0 14px 14px;display:none}
.user-perf-body.open{display:block}
.user-quiz-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--bg);font-size:12px}
.user-quiz-row:last-child{border-bottom:none}
.user-quiz-badge{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:700}

/* Edit questions modal */
.edit-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:500;display:none;align-items:flex-end;justify-content:center}
.edit-modal-overlay.open{display:flex}
.edit-modal-card{background:#fff;border-radius:24px 24px 0 0;padding:24px 20px 40px;width:100%;max-width:430px;max-height:90vh;overflow-y:auto;animation:sup .3s ease}
.edit-modal-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--gd);margin-bottom:16px}

/* CSV upload area */
.csv-drop-area{border:2.5px dashed var(--bd);border-radius:14px;padding:28px 20px;text-align:center;cursor:pointer;transition:all .25s;background:#fafffe}
.csv-drop-area:hover,.csv-drop-area.drag-over{border-color:var(--g);background:rgba(10,110,78,.04)}
.csv-drop-ico{font-size:40px;margin-bottom:10px}
.csv-drop-title{font-weight:700;font-size:14px;color:var(--gd);margin-bottom:4px}
.csv-drop-sub{font-size:12px;color:var(--mt)}
.csv-template-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;background:var(--bg);border:1.5px solid var(--bd);font-size:12px;font-weight:700;color:var(--g);cursor:pointer;margin-top:10px;font-family:'DM Sans'}
.csv-template-btn:hover{background:rgba(10,110,78,.06)}
.csv-preview-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:12px}
.csv-preview-table th{background:var(--bg);padding:7px 10px;text-align:left;font-size:11px;font-weight:700;color:var(--mt);border-bottom:2px solid var(--bd)}
.csv-preview-table td{padding:7px 10px;border-bottom:1px solid var(--bg);color:var(--tx);vertical-align:top}
.csv-preview-table tr:last-child td{border-bottom:none}
.csv-preview-table .correct-cell{color:#15803d;font-weight:700;background:rgba(34,197,94,.06)}

/* Q-status toggle */
.q-status-toggle{display:flex;align-items:center;gap:6px;margin-top:8px}
.toggle-track{width:38px;height:22px;border-radius:11px;background:#CBD5E0;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle-track.on{background:var(--g)}
.toggle-thumb{width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.25)}
.toggle-track.on .toggle-thumb{transform:translateX(16px)}
.toggle-lbl{font-size:11px;font-weight:600;color:var(--mt)}
.toggle-track.on + .toggle-lbl{color:var(--g)}

/* Admin stats dashboard */
.adm-stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.adm-stat-card{background:#fff;border:1.5px solid var(--bd);border-radius:14px;padding:16px;text-align:center;position:relative;overflow:hidden}
.adm-stat-card.green-accent{border-color:rgba(10,110,78,.2);background:linear-gradient(135deg,#f0fdf7,#fff)}
.adm-stat-card.gold-accent{border-color:rgba(245,166,35,.2);background:linear-gradient(135deg,#fffbf0,#fff)}
.adm-stat-card.red-accent{border-color:rgba(229,62,62,.2);background:linear-gradient(135deg,#fff5f5,#fff)}
.adm-stat-card.blue-accent{border-color:rgba(59,130,246,.2);background:linear-gradient(135deg,#eff6ff,#fff)}
.adm-stat-num{font-family:'Playfair Display',serif;font-size:28px;color:var(--g);font-weight:900}
.adm-stat-lbl{font-size:11px;color:var(--mt);margin-top:2px}
.adm-stat-trend{font-size:10px;margin-top:4px;font-weight:600}
.adm-stat-trend.up{color:var(--ok)}
.adm-stat-trend.down{color:var(--red)}

/* Revenue section */
.rev-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.rev-card{background:linear-gradient(135deg,#064A34,#0A6E4E);border-radius:12px;padding:14px;color:#fff;text-align:center}
.rev-card.gold{background:linear-gradient(135deg,#D4891A,#F5A623)}
.rev-num{font-family:'Playfair Display',serif;font-size:22px;font-weight:900}
.rev-lbl{font-size:10px;opacity:.75;margin-top:2px}
.rev-breakdown-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--bg);font-size:13px}
.rev-breakdown-row:last-child{border:none}
.rev-plan-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}

/* Failed questions */
.fail-q-row{padding:12px;border-radius:10px;border:1.5px solid var(--bd);margin-bottom:8px;position:relative;overflow:hidden}
.fail-q-row::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--red)}
.fail-q-text{font-size:13px;font-weight:600;color:var(--tx);margin-bottom:6px;padding-left:8px;line-height:1.4}
.fail-q-meta{display:flex;align-items:center;gap:8px;padding-left:8px;flex-wrap:wrap}
.fail-q-badge{background:rgba(229,62,62,.1);color:var(--red);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:700}
.fail-q-year{background:var(--bg);color:var(--mt);border-radius:20px;padding:2px 8px;font-size:11px}
.fail-bar-wrap{margin-top:6px;padding-left:8px}
.fail-bar-track{background:var(--bg);border-radius:10px;height:5px;margin-top:3px}
.fail-bar-fill{background:linear-gradient(90deg,var(--red),#ff6b6b);height:5px;border-radius:10px;transition:width .6s ease}

/* Active users */
.active-stat-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bg);font-size:13px}
.active-dot{width:9px;height:9px;border-radius:50%;background:var(--ok);flex-shrink:0;box-shadow:0 0 0 3px rgba(34,197,94,.2)}
.active-dot.warn{background:var(--gold);box-shadow:0 0 0 3px rgba(245,166,35,.2)}
.active-dot.cold{background:var(--mt);box-shadow:none}

/* CSV enhanced */
.csv-template-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:11px 16px;border-radius:10px;border:1.5px dashed var(--g);background:var(--bg);color:var(--g);font-weight:600;font-size:13px;cursor:pointer;transition:all .2s}
.csv-template-btn:hover{background:rgba(10,110,78,.08)}

/* Dark mode for new elements */
body.dark .adm-stat-card{background:#1a2920;border-color:#2a3d30}
body.dark .adm-stat-card.green-accent{background:#0d2318;border-color:rgba(74,222,128,.15)}
body.dark .adm-stat-card.gold-accent{background:#1a1500;border-color:rgba(245,166,35,.15)}
body.dark .adm-stat-card.red-accent{background:#1a0a0a;border-color:rgba(229,62,62,.15)}
body.dark .adm-stat-card.blue-accent{background:#0a1020;border-color:rgba(59,130,246,.15)}
body.dark .fail-q-row{background:#1a2920;border-color:#2a3d30}
body.dark .fail-q-text{color:#e2ede8}
body.dark .rev-breakdown-row{border-color:#2a3d30}
body.dark .active-stat-row{border-color:#2a3d30}

/* Revenue mini-chart bars */
.rev-mini-chart{display:flex;align-items:flex-end;gap:3px;height:48px;margin-top:10px}
.rev-mini-bar{flex:1;border-radius:3px 3px 0 0;background:rgba(10,110,78,.2);min-height:4px;transition:all .3s;cursor:pointer;position:relative}
.rev-mini-bar.active{background:var(--g)}
.rev-mini-bar:hover .rev-mini-tip{display:block}
.rev-mini-tip{display:none;position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--gd);color:#fff;font-size:9px;padding:2px 5px;border-radius:4px;white-space:nowrap}

/* Insights alert */
.insight-alert{background:linear-gradient(135deg,rgba(245,166,35,.08),rgba(245,166,35,.03));border:1.5px solid rgba(245,166,35,.25);border-radius:12px;padding:12px 14px;margin-bottom:10px;font-size:13px;color:var(--tx);display:flex;align-items:flex-start;gap:10px}
.insight-alert-ico{font-size:18px;flex-shrink:0;margin-top:1px}
body.dark .insight-alert{color:#c8e6d4;border-color:rgba(245,166,35,.2)}

/* Question row with edit/delete/toggle */
.q-action-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:10px}
.q-action-btn{padding:5px 12px;border-radius:8px;border:1.5px solid;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Sans';transition:all .15s}
.q-action-edit{border-color:var(--g);color:var(--g);background:#fff}
.q-action-edit:hover{background:rgba(10,110,78,.06)}
.q-action-del{border-color:var(--red);color:var(--red);background:#fff}
.q-action-del:hover{background:rgba(229,62,62,.06)}
.q-inactive{opacity:.45}

/* === QUIZ MODES === */
.mode-selector{display:flex;gap:8px;margin-bottom:20px}
.mode-btn{flex:1;padding:13px 8px;border-radius:14px;border:2px solid var(--bd);background:#fff;cursor:pointer;font-family:'DM Sans';transition:all .25s;text-align:center}
.mode-btn.on{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.12)}
.mode-btn-ico{font-size:26px;margin-bottom:4px}
.mode-btn-name{font-size:13px;font-weight:700;margin-bottom:2px}
.mode-btn-desc{font-size:11px;line-height:1.4;opacity:.75}
.mode-btn.review-mode.on{border-color:var(--g);background:rgba(10,110,78,.05);color:var(--gd)}
.mode-btn.exam-mode.on{border-color:#3B82F6;background:rgba(59,130,246,.05);color:#1D4ED8}
.exam-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:#EFF6FF;color:#1D4ED8;border:1px solid #BFDBFE}
.review-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(10,110,78,.08);color:var(--gd);border:1px solid var(--bd)}
/* Exam mode ‚Äî hide colour feedback until answer revealed */
.exam-active .opt{cursor:pointer}
.exam-active .opt.answered-sel{border-color:#94A3B8;background:#F8FAFC}
/* Exam result review */
.exam-review-wrap{padding:16px}
.exam-q-card{border:1.5px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:12px;background:#fff}
.exam-q-card.correct{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.03)}
.exam-q-card.wrong{border-color:rgba(229,62,62,.35);background:rgba(229,62,62,.03)}
.exam-q-label{font-size:11px;font-weight:700;letter-spacing:.5px;margin-bottom:6px;text-transform:uppercase}
.exam-q-text{font-size:14px;font-weight:500;line-height:1.6;margin-bottom:10px;color:var(--tx)}
.exam-opts-mini{display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
.exam-opt-mini{font-size:13px;padding:7px 11px;border-radius:8px;display:flex;align-items:center;gap:8px}
.exam-opt-mini.is-correct{background:rgba(34,197,94,.12);color:#15803d;font-weight:700}
.exam-opt-mini.is-wrong{background:rgba(229,62,62,.08);color:var(--red)}
.exam-opt-mini.is-neutral{color:var(--mt)}
.exam-expl{font-size:13px;line-height:1.6;padding:10px 12px;background:rgba(10,110,78,.06);border-left:3px solid var(--g);border-radius:0 8px 8px 0;color:var(--tx)}
/* Quiz mode pill in header */
.quiz-mode-pill{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;display:flex;align-items:center;gap:4px}
.quiz-mode-pill.review{background:rgba(10,110,78,.1);color:var(--gd)}
.quiz-mode-pill.exam{background:#EFF6FF;color:#1D4ED8}

/* === ANALYTICS === */
.analytics-hero{background:linear-gradient(135deg,#0A6E4E 0%,#064A34 100%);border-radius:20px;padding:20px;margin-bottom:18px;color:#fff}
.analytics-hero-title{font-family:'Playfair Display',serif;font-size:20px;margin-bottom:4px}
.analytics-hero-sub{font-size:12px;opacity:.7;margin-bottom:14px}
.hero-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.hero-stat{background:rgba(255,255,255,.12);border-radius:12px;padding:10px;text-align:center}
.hero-stat-num{font-family:'Playfair Display',serif;font-size:22px;font-weight:900}
.hero-stat-lbl{font-size:10px;opacity:.75;margin-top:2px}
.streak-card{background:#fff8e6;border:2px solid rgba(245,166,35,.4);border-radius:16px;padding:16px;margin-bottom:14px}
.streak-top{display:flex;align-items:center;gap:14px;margin-bottom:12px}
.streak-flame{font-size:40px;line-height:1;flex-shrink:0}
.streak-num{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;color:var(--goldd);line-height:1}
.streak-lbl{font-size:12px;color:var(--mt);margin-top:2px}
.streak-best{font-size:11px;font-weight:700;color:var(--goldd);margin-top:4px}
.streak-days{display:flex;gap:4px;justify-content:space-between}
.sday{flex:1;min-width:0;aspect-ratio:1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-direction:column;gap:1px;padding:4px 0}
.sday.done{background:var(--gold);color:var(--gd)}
.sday.today{background:var(--g);color:#fff;box-shadow:0 0 0 2px rgba(10,110,78,.3)}
.sday.miss{background:var(--bg);color:var(--mt)}
.sday-lbl{font-size:8px;font-weight:400;opacity:.8}
.insight-card{background:#fff;border:1.5px solid var(--bd);border-radius:16px;padding:16px;margin-bottom:14px}
.insight-title{font-weight:700;font-size:14px;color:var(--gd);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.subject-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--bg)}
.subject-row:last-child{border-bottom:none}
.subject-name{font-size:13px;font-weight:600;color:var(--tx);width:66px;flex-shrink:0}
.subject-bar-wrap{flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden}
.subject-bar{height:100%;border-radius:4px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.subject-pct{font-size:13px;font-weight:700;width:36px;text-align:right;flex-shrink:0}
.subject-count{font-size:11px;color:var(--mt);width:40px;text-align:right;flex-shrink:0}
.recommend-chip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;font-size:12px;font-weight:700;margin:4px;cursor:pointer;border:none;transition:all .2s;font-family:'DM Sans'}
.rc-weak{background:rgba(229,62,62,.1);color:var(--red);border:1.5px solid rgba(229,62,62,.3)}
.rc-mid{background:rgba(245,166,35,.12);color:var(--goldd);border:1.5px solid rgba(245,166,35,.35)}
.rc-strong{background:rgba(34,197,94,.1);color:#15803d;border:1.5px solid rgba(34,197,94,.3)}
.year-row{padding:10px 0;border-bottom:1px solid var(--bg);display:flex;align-items:center;gap:10px}
.year-row:last-child{border-bottom:none}
.year-badge{background:var(--bg);color:var(--g);font-size:11px;font-weight:700;padding:3px 8px;border-radius:8px;min-width:36px;text-align:center}
.year-detail{flex:1;font-size:13px;color:var(--tx)}
.year-pct{font-size:16px;font-weight:700}
.perf-tab-btns{display:flex;gap:6px;margin-bottom:14px;background:var(--bg);border-radius:12px;padding:4px}
.perf-tab-btn{flex:1;padding:8px;border-radius:8px;border:none;background:transparent;font-family:'DM Sans';font-size:12px;font-weight:600;color:var(--mt);cursor:pointer;transition:all .2s}
.perf-tab-btn.on{background:#fff;color:var(--g);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.perf-tab-panel{display:none}
.perf-tab-panel.on{display:block}
.empty-state{text-align:center;padding:30px 16px;color:var(--mt)}
.empty-state-ico{font-size:48px;margin-bottom:12px}
.time-stat-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--bg)}
.time-stat-row:last-child{border-bottom:none}
.time-stat-lbl{font-size:13px;color:var(--tx)}
.time-stat-val{font-size:16px;font-weight:700;color:var(--g)}

/* ===== REFERRAL SYSTEM ===== */
#pg-referral{background:var(--bg)}
#pg-referral.on{display:block}

/* Hero banner */
.ref-hero{background:linear-gradient(145deg,#064A34 0%,#0A6E4E 50%,#12A070 100%);padding:32px 20px 28px;position:relative;overflow:hidden;text-align:center}
.ref-hero::before{content:'';position:absolute;right:-30px;top:-30px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.05)}
.ref-hero::after{content:'';position:absolute;left:-20px;bottom:-40px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.04)}
.ref-hero-ico{font-size:52px;margin-bottom:10px;position:relative;z-index:1;display:block}
.ref-hero-title{font-family:'Playfair Display',serif;font-size:24px;color:#fff;margin-bottom:6px;position:relative;z-index:1}
.ref-hero-sub{font-size:13px;color:rgba(255,255,255,.7);line-height:1.6;position:relative;z-index:1}

/* Progress tracker */
.ref-progress-card{background:#fff;border-radius:20px;margin:16px;padding:20px;box-shadow:0 4px 24px rgba(10,110,78,.08);border:1.5px solid var(--bd)}
.ref-progress-title{font-size:12px;font-weight:700;color:var(--mt);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px}
.ref-milestones{display:flex;flex-direction:column;gap:0}
.ref-milestone{display:flex;align-items:center;gap:14px;padding:12px 0;position:relative}
.ref-milestone:not(:last-child)::after{content:'';position:absolute;left:19px;top:44px;width:2px;height:calc(100% - 20px);background:var(--bd);z-index:0}
.ref-milestone.done:not(:last-child)::after{background:var(--g)}
.ref-milestone-dot{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;border:2.5px solid var(--bd);background:#fff;position:relative;z-index:1;transition:all .3s}
.ref-milestone.done .ref-milestone-dot{background:var(--g);border-color:var(--g);color:#fff;box-shadow:0 0 0 4px rgba(10,110,78,.15)}
.ref-milestone.current .ref-milestone-dot{border-color:var(--gold);box-shadow:0 0 0 4px rgba(245,166,35,.2);animation:ref-pulse 1.8s ease-in-out infinite}
@keyframes ref-pulse{0%,100%{box-shadow:0 0 0 4px rgba(245,166,35,.2)}50%{box-shadow:0 0 0 8px rgba(245,166,35,.08)}}
.ref-milestone-info{flex:1}
.ref-milestone-label{font-weight:700;font-size:14px;color:var(--tx)}
.ref-milestone.done .ref-milestone-label{color:var(--g)}
.ref-milestone-desc{font-size:12px;color:var(--mt);margin-top:2px}
.ref-milestone-reward{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-top:5px}
.ref-reward-locked{background:var(--bg);color:var(--mt);border:1px solid var(--bd)}
.ref-reward-done{background:rgba(34,197,94,.1);color:#15803d;border:1px solid rgba(34,197,94,.3)}
.ref-reward-current{background:rgba(245,166,35,.15);color:var(--goldd);border:1px solid rgba(245,166,35,.4)}

/* Counter display */
.ref-counter-row{display:flex;align-items:center;justify-content:space-between;background:var(--bg);border-radius:14px;padding:14px 16px;margin-bottom:16px}
.ref-counter-left{display:flex;flex-direction:column}
.ref-counter-num{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;color:var(--g);line-height:1}
.ref-counter-lbl{font-size:12px;color:var(--mt);margin-top:2px}
.ref-counter-right{text-align:right}
.ref-counter-next{font-size:13px;font-weight:700;color:var(--goldd)}
.ref-counter-next-lbl{font-size:11px;color:var(--mt);margin-top:2px}

/* Referral code display */
.ref-code-box{background:linear-gradient(135deg,#f0fdf8,#e6f7ef);border:2px dashed rgba(10,110,78,.35);border-radius:16px;padding:18px;text-align:center;margin-bottom:16px;position:relative;cursor:pointer;transition:all .2s}
.ref-code-box:hover{border-color:var(--g);background:linear-gradient(135deg,#e6f7ef,#d1f0e3)}
.ref-code-box:active{transform:scale(.98)}
.ref-code-label{font-size:11px;font-weight:700;color:var(--mt);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px}
.ref-code-value{font-family:monospace;font-size:26px;font-weight:900;color:var(--gd);letter-spacing:3px;margin-bottom:8px}
.ref-code-tap{font-size:12px;color:var(--g);font-weight:600}
.ref-code-copied{position:absolute;inset:0;background:rgba(34,197,94,.92);border-radius:14px;display:none;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:15px;border-radius:14px}
.ref-code-copied.show{display:flex}

/* Share buttons */
.ref-share-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.ref-share-btn{padding:12px 8px;border-radius:12px;border:1.5px solid var(--bd);background:#fff;cursor:pointer;font-family:'DM Sans';font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:7px;transition:all .2s;color:var(--tx)}
.ref-share-btn:hover{border-color:var(--g);color:var(--g);background:rgba(10,110,78,.04);transform:translateY(-1px)}
.ref-share-btn.primary{background:var(--g);color:#fff;border-color:var(--g);grid-column:1/-1}
.ref-share-btn.primary:hover{background:var(--gl)}

/* Referrals list */
.ref-list-item{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--bg)}
.ref-list-item:last-child{border-bottom:none}
.ref-list-av{width:36px;height:36px;border-radius:50%;background:var(--g);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0}
.ref-list-name{font-weight:600;font-size:14px;color:var(--tx)}
.ref-list-date{font-size:11px;color:var(--mt)}
.ref-list-badge{margin-left:auto;font-size:11px;font-weight:700;padding:3px 9px;border-radius:10px;background:rgba(34,197,94,.1);color:#15803d;border:1px solid rgba(34,197,94,.25)}

/* Reward unlocked overlay */
.ref-reward-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:600;display:none;align-items:center;justify-content:center;padding:24px}
.ref-reward-overlay.show{display:flex}
.ref-reward-card{background:#fff;border-radius:24px;padding:32px 24px;text-align:center;width:100%;max-width:340px;animation:pop .5s cubic-bezier(.175,.885,.32,1.275)}
.ref-reward-ico{font-size:72px;margin-bottom:12px;display:block;animation:ref-bounce 1s ease infinite alternate}
@keyframes ref-bounce{from{transform:translateY(0)}to{transform:translateY(-8px)}}
.ref-reward-title{font-family:'Playfair Display',serif;font-size:24px;color:var(--gd);margin-bottom:8px}
.ref-reward-desc{font-size:14px;color:var(--mt);line-height:1.7;margin-bottom:20px}

/* Home referral nudge card */
.ref-nudge{background:linear-gradient(135deg,#fff8e6,#fffbf0);border:1.5px solid rgba(245,166,35,.4);border-radius:16px;padding:16px;display:flex;gap:12px;align-items:flex-start;margin-bottom:18px;cursor:pointer;transition:all .2s}
.ref-nudge:hover{border-color:var(--gold);box-shadow:0 4px 16px rgba(245,166,35,.15)}
.ref-nudge-ico{font-size:28px;flex-shrink:0}
.ref-nudge-title{font-weight:700;font-size:14px;color:var(--gd);margin-bottom:3px}
.ref-nudge-desc{font-size:12px;color:var(--mt);line-height:1.5}
.ref-nudge-cta{font-size:12px;color:var(--goldd);font-weight:700;margin-top:5px}

/* Toast */
.toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#0D2B1F;color:#fff;padding:12px 20px;border-radius:12px;font-size:14px;z-index:9999;animation:tin .3s ease;white-space:nowrap;pointer-events:none;max-width:90vw;text-align:center}
@keyframes tin{from{transform:translateX(-50%) translateY(-20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}

/* === CONTACT ADMIN FAQ === */
.contact-faq{border-bottom:1px solid var(--bg);padding:12px 0;cursor:pointer}
.contact-faq:last-child{border-bottom:none;padding-bottom:0}
.faq-q{font-size:14px;font-weight:600;color:var(--tx);display:flex;justify-content:space-between;align-items:center;gap:8px}
.faq-arr{font-size:18px;color:var(--mt);transition:transform .25s;flex-shrink:0}
.faq-a{font-size:13px;color:var(--mt);line-height:1.7;max-height:0;overflow:hidden;transition:max-height .35s ease,margin-top .25s;margin-top:0}
.contact-faq.open .faq-a{max-height:200px;margin-top:8px}
.contact-faq.open .faq-arr{transform:rotate(90deg)}
.spin{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spinning .8s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px}
@keyframes spinning{to{transform:rotate(360deg)}}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Autocomplete dropdown */
.ac-drop{position:absolute;top:calc(100% - 18px);left:0;right:0;background:#fff;border:1.5px solid var(--g);border-top:none;border-radius:0 0 12px 12px;box-shadow:0 8px 24px rgba(10,110,78,.12);z-index:200;overflow:hidden;max-height:220px;overflow-y:auto}
.ac-item{display:flex;align-items:center;gap:10px;padding:11px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--bg)}
.ac-item:last-child{border-bottom:none}
.ac-item:hover,.ac-item.focused{background:var(--bg)}
.ac-av{width:32px;height:32px;border-radius:50%;background:var(--g);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;overflow:hidden}
.ac-av img{width:100%;height:100%;object-fit:cover}
.ac-name{font-weight:600;font-size:14px;color:var(--tx)}
.ac-user{font-size:12px;color:var(--mt)}

/* === PAYMENT PAGE === */
#pg-payment{background:var(--bg)}
#pg-payment.on{display:block}
.pay-hero{background:linear-gradient(135deg,var(--gd) 0%,var(--g) 100%);padding:28px 20px 32px;text-align:center;color:#fff}
.pay-hero-title{font-family:'Playfair Display',serif;font-size:24px;margin-bottom:6px}
.pay-hero-sub{font-size:13px;opacity:.75;line-height:1.6}
.plan-tabs{display:flex;gap:8px;margin:20px 0 16px}
.plan-tab{flex:1;padding:10px 4px;border-radius:10px;border:2px solid var(--bd);background:#fff;font-size:12px;font-weight:700;color:var(--mt);cursor:pointer;transition:all .2s;text-align:center;line-height:1.4}
.plan-tab.on{border-color:var(--g);background:rgba(10,110,78,.06);color:var(--g)}
.plan-card{background:#fff;border-radius:16px;border:2px solid var(--bd);padding:20px;margin-bottom:14px;cursor:pointer;transition:all .22s;position:relative}
.plan-card.on{border-color:var(--g);box-shadow:0 4px 20px rgba(10,110,78,.13)}
.plan-card.featured{border-color:var(--gold)}
.plan-badge{position:absolute;top:-11px;left:50%;transform:translateX(-50%);background:var(--gold);color:var(--gd);font-size:11px;font-weight:700;padding:3px 14px;border-radius:20px;white-space:nowrap}
.plan-name{font-weight:800;font-size:17px;color:var(--gd);margin-bottom:4px}
.plan-price{font-family:'Playfair Display',serif;font-size:32px;color:var(--g);font-weight:900;line-height:1}
.plan-price span{font-size:14px;font-weight:500;color:var(--mt);font-family:'DM Sans',sans-serif}
.plan-desc{font-size:13px;color:var(--mt);margin:10px 0 12px;line-height:1.6}
.plan-features{list-style:none;margin:0;padding:0}
.plan-features li{font-size:13px;color:var(--tx);padding:4px 0;display:flex;align-items:center;gap:8px}
.plan-features li::before{content:'‚úì';color:var(--g);font-weight:700;flex-shrink:0}
.plan-radio{position:absolute;top:18px;right:18px;width:22px;height:22px;border-radius:50%;border:2px solid var(--bd);background:#fff;display:flex;align-items:center;justify-content:center;transition:all .2s}
.plan-card.on .plan-radio{border-color:var(--g);background:var(--g)}
.plan-card.on .plan-radio::after{content:'';width:8px;height:8px;border-radius:50%;background:#fff}
.prov-title{font-size:13px;font-weight:700;color:var(--mt);margin:18px 0 10px;letter-spacing:.5px;text-transform:uppercase}
.prov-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.prov-card{border:2px solid var(--bd);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;background:#fff;transition:all .2s}
.prov-card:hover{border-color:var(--g)}
.prov-card.on{border-color:var(--g);background:rgba(10,110,78,.05)}
.prov-logo{font-size:22px;margin-bottom:4px}
.prov-name{font-size:11px;font-weight:700;color:var(--tx)}
.prov-tag{font-size:10px;color:var(--mt);margin-top:2px}
.bulk-fields{background:#fff;border-radius:14px;border:1.5px solid var(--bd);padding:16px;margin-bottom:16px}
.bulk-fields .fl{margin-top:12px}
.pay-total{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;border:1.5px solid var(--bd);padding:14px 18px;margin-bottom:16px}
.pay-total-lbl{font-size:13px;color:var(--mt)}
.pay-total-amt{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--g)}
.pay-secure{text-align:center;font-size:12px;color:var(--mt);margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:6px}
/* Payment modal */
.pay-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.pay-modal-bg.show{display:flex}
.pay-modal{background:#fff;border-radius:20px;width:100%;max-width:390px;overflow:hidden;animation:pop .3s cubic-bezier(.175,.885,.32,1.275)}
.pay-modal-hd{background:linear-gradient(135deg,var(--gd),var(--g));padding:20px;text-align:center;color:#fff}
.pay-modal-hd .pmo-ico{font-size:44px;margin-bottom:8px}
.pay-modal-hd h3{font-family:'Playfair Display',serif;font-size:20px;margin-bottom:4px}
.pay-modal-hd p{font-size:13px;opacity:.8}
.pay-modal-body{padding:20px}
.pay-step-row{display:flex;gap:10px;align-items:flex-start;margin-bottom:16px}
.pay-step-num{width:28px;height:28px;border-radius:50%;background:var(--bg);color:var(--g);font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.pay-step-txt{font-size:14px;color:var(--tx);line-height:1.5}
.pay-step-txt strong{color:var(--gd)}
.pay-processing{text-align:center;padding:20px 0}
.pay-spinner{width:48px;height:48px;border:4px solid var(--bg);border-top:4px solid var(--g);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.pay-success-anim{text-align:center;padding:10px 0 20px}
.pay-success-ico{font-size:56px;animation:pop .4s ease}
/* Active plan card on profile */
.active-plan-card{background:linear-gradient(135deg,var(--gd),var(--g));border-radius:16px;padding:18px 20px;margin-bottom:16px;color:#fff;position:relative;overflow:hidden}
.active-plan-card::after{content:'‚ú¶';position:absolute;right:-8px;bottom:-20px;font-size:90px;opacity:.08;line-height:1}
.apc-label{font-size:11px;opacity:.7;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.apc-plan{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;margin-bottom:6px}
.apc-expiry{font-size:12px;opacity:.75}
.apc-manage{display:inline-block;margin-top:12px;background:rgba(255,255,255,.2);border:none;color:#fff;padding:7px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}

/* === YEAR MANAGEMENT === */
.yr-mgmt-row{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#fff;border:1.5px solid var(--bd);border-radius:12px;margin-bottom:8px;transition:all .2s}
.yr-mgmt-row:hover{border-color:var(--g);box-shadow:0 2px 10px rgba(10,110,78,.08)}
.yr-mgmt-num{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:var(--g);min-width:54px}
.yr-mgmt-info{flex:1}
.yr-mgmt-papers{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px}
.yr-paper-chip{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;background:var(--bg);color:var(--mt);border:1px solid var(--bd);display:flex;align-items:center;gap:4px}
.yr-paper-chip .remove-paper{cursor:pointer;color:var(--red);font-size:13px;font-weight:700;line-height:1;margin-left:2px}
.yr-mgmt-actions{display:flex;gap:6px;flex-shrink:0}
.yr-action-btn{width:32px;height:32px;border-radius:8px;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.yr-del-btn{background:rgba(229,62,62,.1);color:var(--red)}
.yr-del-btn:hover{background:var(--red);color:#fff}
.yr-qcount{font-size:12px;color:var(--mt)}
.yr-locked-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:rgba(245,166,35,.15);color:var(--goldd);border:1px solid rgba(245,166,35,.3)}
.yr-pro-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:rgba(10,110,78,.12);color:var(--g);border:1px solid rgba(10,110,78,.2)}

/* === MOCK ROTATION SYSTEM === */
.mock-version-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);color:#818CF8;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;margin-bottom:8px}
.mock-schedule-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:16px;margin-bottom:16px}
.mock-schedule-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
.mock-schedule-row:last-child{border-bottom:none;padding-bottom:0}
.mock-schedule-lbl{color:rgba(255,255,255,.5)}
.mock-schedule-val{color:#F9FAFB;font-weight:600}
.mock-countdown{font-family:'Playfair Display',serif;font-size:20px;color:#818CF8;font-weight:700;text-align:center;margin:8px 0}
.mock-history-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all .2s}
.mock-history-card:hover{background:rgba(255,255,255,.07);border-color:rgba(99,102,241,.3)}
.mock-hist-ver{font-size:11px;font-weight:700;color:#818CF8;margin-bottom:4px;letter-spacing:.5px}
.mock-hist-title{font-size:14px;font-weight:700;color:#F9FAFB;margin-bottom:4px}
.mock-hist-meta{font-size:12px;color:rgba(255,255,255,.4)}
.mock-hist-score{font-family:'Playfair Display',serif;font-size:22px;font-weight:900}
/* Admin bank archive */
.bank-archive-card{background:#fff;border:1.5px solid var(--bd);border-radius:14px;padding:16px;margin-bottom:10px;position:relative}
.bank-archive-card.active-bank{border-color:var(--g);background:rgba(10,110,78,.02)}
.bank-active-dot{width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block;margin-right:6px;animation:pulse-ok 2s infinite}
@keyframes pulse-ok{0%,100%{opacity:1}50%{opacity:.4}}
.bank-ver-tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:rgba(99,102,241,.1);color:#4338CA;border:1px solid rgba(99,102,241,.2)}
.bank-stats-row{display:flex;gap:16px;margin-top:8px;flex-wrap:wrap}
.bank-stat{text-align:center}
.bank-stat-num{font-weight:800;font-size:16px;color:var(--gd)}
.bank-stat-lbl{font-size:10px;color:var(--mt)}
.rotation-timer-bar{height:4px;background:var(--bg);border-radius:2px;margin-top:10px;overflow:hidden}
.rotation-timer-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--g),var(--gl));transition:width .5s}

/* === MOCK ROTATION ENHANCEMENTS === */
.mock-update-banner{background:linear-gradient(135deg,rgba(99,102,241,.25),rgba(124,58,237,.2));border:1px solid rgba(99,102,241,.4);border-radius:14px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.mock-update-dot{width:10px;height:10px;border-radius:50%;background:#818CF8;flex-shrink:0;animation:pulse-ok 1.5s infinite}
.mock-update-txt{flex:1;font-size:13px;color:#C4B5FD;line-height:1.5}
.mock-countdown-ring{position:relative;width:80px;height:80px;flex-shrink:0}
.mock-countdown-ring svg{transform:rotate(-90deg)}
.mock-countdown-num{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.mock-countdown-h{font-family:'Playfair Display',serif;font-size:18px;font-weight:900;color:#fff;line-height:1}
.mock-countdown-lbl{font-size:9px;color:rgba(255,255,255,.4);font-weight:600;letter-spacing:.5px;margin-top:1px}
.mock-new-badge{display:inline-block;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;margin-bottom:10px;animation:pop .4s ease}
.prev-exams-section{margin-top:20px}
.prev-exams-hd{font-size:11px;font-weight:700;color:rgba(255,255,255,.4);letter-spacing:1px;margin-bottom:12px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between}
.prev-bank-group{margin-bottom:16px}
.prev-bank-label{font-size:12px;font-weight:700;color:#818CF8;margin-bottom:8px;padding:6px 10px;background:rgba(99,102,241,.1);border-radius:8px;border-left:3px solid #4338CA}
.mock-sched-next-input{background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;padding:11px 14px;font-family:'DM Sans',sans-serif;font-size:14px;width:100%;-webkit-appearance:none}
.mock-sched-next-input:focus{outline:none;border-color:#818CF8}
.rotation-live-pill{display:inline-flex;align-items:center;gap:6px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;color:#34D399}
.rotation-off-pill{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:4px 12px;font-size:12px;font-weight:600;color:rgba(255,255,255,.4)}


/* ============================================================
   AI EXPLAIN MODAL
   ============================================================ */
.ai-explain-btn {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  margin-top: 12px;
  padding: 13px 20px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #0A6E4E 0%, #064A34 100%);
  color: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
  position: relative;
  overflow: hidden;
}
.ai-explain-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,.08) 0%, transparent 60%);
  pointer-events: none;
}
.ai-explain-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(10,110,78,.35); }
.ai-explain-btn:active { transform: translateY(0); }
.ai-explain-btn .ai-sparkle { font-size: 17px; animation: sparkle-spin 3s linear infinite; }
@keyframes sparkle-spin {
  0%,100% { transform: scale(1) rotate(0deg); }
  25% { transform: scale(1.2) rotate(-10deg); }
  75% { transform: scale(1.2) rotate(10deg); }
}
body.dark .ai-explain-btn { background: linear-gradient(135deg, #12A070 0%, #0A6E4E 100%); }

/* Overlay */
.ai-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 500;
  display: none;
  align-items: flex-end;
  justify-content: center;
  padding: 0;
}
.ai-modal-overlay.show { display: flex; }

/* Sheet */
.ai-modal-sheet {
  background: #fff;
  border-radius: 24px 24px 0 0;
  width: 100%;
  max-width: 430px;
  max-height: 88vh;
  display: flex;
  flex-direction: column;
  animation: sheet-up .35s cubic-bezier(.32,1.1,.7,1) both;
  overflow: hidden;
}
@keyframes sheet-up {
  from { transform: translateY(100%); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}
body.dark .ai-modal-sheet { background: #0f1a14; }

/* Sheet handle */
.ai-sheet-handle {
  width: 40px; height: 4px;
  border-radius: 2px;
  background: rgba(0,0,0,.15);
  margin: 12px auto 0;
  flex-shrink: 0;
}
body.dark .ai-sheet-handle { background: rgba(255,255,255,.15); }

/* Sheet header */
.ai-sheet-hdr {
  padding: 14px 20px 12px;
  border-bottom: 1px solid var(--bd);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
body.dark .ai-sheet-hdr { border-color: #1e2d22; }
.ai-sheet-hdr-ico {
  width: 38px; height: 38px;
  border-radius: 10px;
  background: linear-gradient(135deg, #0A6E4E, #12A070);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.ai-sheet-hdr-title {
  font-family: 'Playfair Display', serif;
  font-size: 17px; font-weight: 700;
  color: var(--gd); flex: 1;
}
body.dark .ai-sheet-hdr-title { color: #c8e6d4; }
.ai-sheet-hdr-close {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: none;
  background: var(--bg);
  color: var(--mt);
  font-size: 17px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.ai-sheet-hdr-close:hover { background: var(--bd); }
body.dark .ai-sheet-hdr-close { background: #1a2920; color: #6a9276; }

/* Question recap */
.ai-q-recap {
  margin: 14px 20px 0;
  background: var(--bg);
  border-radius: 10px;
  padding: 11px 13px;
  font-size: 13px;
  color: var(--mt);
  line-height: 1.5;
  border-left: 3px solid var(--g);
  flex-shrink: 0;
}
body.dark .ai-q-recap { background: #1a2920; color: #8ab09a; border-color: #4ade80; }

/* Depth selector */
.ai-depth-row {
  display: flex;
  gap: 6px;
  padding: 12px 20px 0;
  flex-shrink: 0;
}
.ai-depth-btn {
  flex: 1;
  padding: 7px 4px;
  border-radius: 8px;
  border: 1.5px solid var(--bd);
  background: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 11px;
  font-weight: 600;
  color: var(--mt);
  cursor: pointer;
  transition: all .15s;
  text-align: center;
}
.ai-depth-btn:hover { border-color: var(--g); color: var(--g); }
.ai-depth-btn.on {
  background: var(--g);
  border-color: var(--g);
  color: #fff;
}
body.dark .ai-depth-btn { background: #1a2920; border-color: #2a3d30; color: #6a9276; }
body.dark .ai-depth-btn.on { background: var(--g); color: #fff; border-color: var(--g); }

/* Scroll body */
.ai-sheet-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px 32px;
  -webkit-overflow-scrolling: touch;
}

/* States */
.ai-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 32px 20px;
  gap: 14px;
}
.ai-loading-dots {
  display: flex; gap: 6px;
}
.ai-loading-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--g);
  animation: dot-bounce .9s ease infinite;
}
.ai-loading-dot:nth-child(2) { animation-delay: .15s; }
.ai-loading-dot:nth-child(3) { animation-delay: .3s; }
@keyframes dot-bounce {
  0%,80%,100% { transform: scale(.7); opacity:.4; }
  40% { transform: scale(1); opacity:1; }
}
.ai-loading-lbl {
  font-size: 13px; color: var(--mt);
  font-weight: 600;
  animation: pulse-text 1.5s ease infinite alternate;
}
@keyframes pulse-text { from { opacity:.5; } to { opacity:1; } }

/* The actual AI response */
.ai-response {
  font-size: 14px;
  line-height: 1.75;
  color: var(--tx);
}
body.dark .ai-response { color: #d4e8dc; }
.ai-response h3 {
  font-family: 'Playfair Display', serif;
  font-size: 15px;
  color: var(--gd);
  margin: 16px 0 6px;
}
body.dark .ai-response h3 { color: #6ade9a; }
.ai-response h3:first-child { margin-top: 0; }
.ai-response strong { color: var(--g); font-weight: 700; }
body.dark .ai-response strong { color: #4ade80; }
.ai-response .ai-r-block {
  background: rgba(10,110,78,.05);
  border-radius: 10px;
  padding: 12px 14px;
  margin: 10px 0;
  border-left: 3px solid var(--g);
  font-size: 13px;
}
body.dark .ai-response .ai-r-block { background: rgba(74,222,128,.06); border-color: #4ade80; }
.ai-response .ai-wrong-block {
  background: rgba(229,62,62,.05);
  border-radius: 10px;
  padding: 12px 14px;
  margin: 10px 0;
  border-left: 3px solid var(--red);
  font-size: 13px;
}
.ai-response .ai-mnemonic {
  background: linear-gradient(135deg, rgba(245,166,35,.08), rgba(245,166,35,.03));
  border: 1.5px solid rgba(245,166,35,.3);
  border-radius: 10px;
  padding: 12px 14px;
  margin: 10px 0;
  font-size: 13px;
}
.ai-mnemonic-lbl {
  font-size: 10px;
  font-weight: 800;
  color: var(--goldd);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 4px;
}
body.dark .ai-response .ai-mnemonic { border-color: rgba(245,166,35,.2); }

/* Cursor blink during typewriter */
.ai-cursor {
  display: inline-block;
  width: 2px; height: 1em;
  background: var(--g);
  margin-left: 2px;
  vertical-align: text-bottom;
  animation: blink .7s step-end infinite;
}
@keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }

/* Error state */
.ai-error {
  background: rgba(229,62,62,.05);
  border: 1.5px solid rgba(229,62,62,.2);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  font-size: 13px;
  color: var(--red);
}

/* Regenerate / follow-up row */
.ai-action-row {
  display: flex;
  gap: 8px;
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid var(--bd);
  flex-wrap: wrap;
}
body.dark .ai-action-row { border-color: #1e2d22; }
.ai-action-btn {
  flex: 1;
  min-width: 120px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1.5px solid var(--bd);
  background: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 600;
  color: var(--mt);
  cursor: pointer;
  transition: all .15s;
  display: flex; align-items: center; justify-content: center; gap: 5px;
}
.ai-action-btn:hover { border-color: var(--g); color: var(--g); background: rgba(10,110,78,.04); }
body.dark .ai-action-btn { background: #1a2920; border-color: #2a3d30; color: #6a9276; }
body.dark .ai-action-btn:hover { border-color: var(--gl); color: #4ade80; }

/* Pro gate */
.ai-pro-gate {
  text-align: center;
  padding: 24px 16px;
}
.ai-pro-gate-ico { font-size: 48px; margin-bottom: 12px; }
.ai-pro-gate-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--gd); margin-bottom: 8px; }
body.dark .ai-pro-gate-title { color: #c8e6d4; }
.ai-pro-gate-sub { font-size: 13px; color: var(--mt); line-height: 1.6; margin-bottom: 20px; }

/* Usage counter */
.ai-usage-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--bg);
  border-radius: 8px;
  font-size: 11px;
  color: var(--mt);
  margin-bottom: 12px;
}
body.dark .ai-usage-bar { background: #1a2920; color: #6a9276; }
.ai-usage-dots { display: flex; gap: 3px; }
.ai-usage-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--bd); }
.ai-usage-dot.used { background: var(--g); }
body.dark .ai-usage-dot.used { background: #4ade80; }


/* ============================================================
   HOSPITAL FINAL EXAM ‚Äî CSS
   ============================================================ */

/* Home card */
.hosp-home-card {
  margin: 0 16px 14px;
  background: linear-gradient(135deg, #1a1744 0%, #2d1b6e 50%, #1e3a5f 100%);
  border-radius: 20px;
  padding: 18px 16px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: transform .2s, box-shadow .2s;
}
.hosp-home-card:hover { transform: translateY(-2px); box-shadow: 0 10px 32px rgba(45,27,110,.4); }
.hosp-home-card::before {
  content: '';
  position: absolute;
  top: -30px; right: -30px;
  width: 120px; height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,.04);
}
.hosp-home-tag {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.2);
  color: #a78bfa;
  font-size: 10px; font-weight: 800;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 3px 8px; border-radius: 20px;
  margin-bottom: 8px;
}
.hosp-home-title {
  font-family: 'Playfair Display', serif;
  font-size: 20px; font-weight: 900;
  color: #fff; margin-bottom: 4px;
}
.hosp-home-desc {
  font-size: 12px; color: rgba(255,255,255,.6);
  line-height: 1.5; margin-bottom: 12px;
}
.hosp-home-pills { display: flex; gap: 6px; flex-wrap: wrap; }
.hosp-home-pill {
  background: rgba(255,255,255,.1);
  border: 1px solid rgba(255,255,255,.15);
  color: rgba(255,255,255,.85);
  font-size: 11px; font-weight: 600;
  padding: 4px 10px; border-radius: 20px;
}
.hosp-daily-badge {
  position: absolute; top: 14px; right: 14px;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #fff; font-size: 10px; font-weight: 800;
  padding: 4px 8px; border-radius: 8px;
  letter-spacing: .5px;
}

/* Hospital question bank cards */
.hosp-ycard {
  background: linear-gradient(135deg, #f5f3ff, #fff);
  border: 1.5px solid #ddd6fe;
  border-radius: 14px; padding: 16px;
  cursor: pointer; transition: all .2s;
  position: relative;
}
.hosp-ycard:hover { border-color: #7c3aed; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(124,58,237,.12); }
.hosp-ycard.locked { opacity: .75; }
.hosp-ynum { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 900; color: #4c1d95; }
.hosp-ysub { font-size: 11px; color: #7c3aed; margin-top: 2px; }
.hosp-pchip {
  display: inline-block;
  background: rgba(124,58,237,.08);
  border: 1px solid rgba(124,58,237,.2);
  color: #6d28d9; font-size: 11px; font-weight: 600;
  padding: 3px 10px; border-radius: 20px;
  cursor: pointer; transition: all .15s;
  margin: 2px 2px 0 0;
}
.hosp-pchip:hover { background: #6d28d9; color: #fff; }
.hosp-daily-dot {
  position: absolute; top: 10px; right: 10px;
  width: 8px; height: 8px; border-radius: 50%;
  background: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245,158,11,.2);
  animation: pulse-dot 2s ease infinite;
}
@keyframes pulse-dot { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.3);opacity:.7} }

/* Dark mode for hospital cards */
body.dark .hosp-ycard { background: #1a1020; border-color: #3b2060; }
body.dark .hosp-ycard:hover { border-color: #7c3aed; }
body.dark .hosp-ynum { color: #c4b5fd; }
body.dark .hosp-ysub { color: #a78bfa; }
body.dark .hosp-pchip { background: rgba(124,58,237,.15); border-color: rgba(124,58,237,.3); color: #a78bfa; }
body.dark .hosp-pchip:hover { background: #6d28d9; color: #fff; }

/* Hospital quiz header accent */
.hosp-quiz-pill {
  background: linear-gradient(135deg, #4c1d95, #6d28d9);
  color: #e9d5ff;
  font-size: 11px; font-weight: 700;
  padding: 4px 10px; border-radius: 20px;
  letter-spacing: .3px;
}

/* Admin hospital tab */
.hosp-admin-stat {
  background: linear-gradient(135deg, #f5f3ff, #ede9fe);
  border: 1.5px solid #ddd6fe;
  border-radius: 12px; padding: 14px 10px; text-align: center;
}
.hosp-admin-stat-num { font-family: 'Playfair Display', serif; font-size: 22px; color: #5b21b6; font-weight: 900; }
.hosp-admin-stat-lbl { font-size: 10px; color: #7c3aed; margin-top: 2px; }
body.dark .hosp-admin-stat { background: #1a1020; border-color: #3b2060; }
body.dark .hosp-admin-stat-num { color: #c4b5fd; }
body.dark .hosp-admin-stat-lbl { color: #a78bfa; }

/* Daily rotation countdown */
.hosp-countdown-card {
  background: linear-gradient(135deg, #1a1744, #2d1b6e);
  border-radius: 14px; padding: 14px 16px;
  margin-bottom: 14px; color: #fff;
  display: flex; align-items: center; gap: 12px;
}
.hosp-countdown-ico { font-size: 28px; flex-shrink: 0; }
.hosp-countdown-lbl { font-size: 11px; color: rgba(255,255,255,.6); margin-bottom: 2px; }
.hosp-countdown-time { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 900; color: #f59e0b; }

/* Quiz mode pill override for hospital */
.quiz-mode-pill.hospital { background: linear-gradient(135deg, #4c1d95, #6d28d9); color: #e9d5ff; }

</style>
<script>
// Early dark mode ‚Äî must be defined before body renders so onclick handlers work
var _darkMode = false;
function toggleDarkMode() {
  _darkMode = !_darkMode;
  document.body.classList.toggle('dark', _darkMode);
  var icon = _darkMode ? '‚òÄÔ∏è' : 'üåô';
  document.querySelectorAll('.dm-toggle').forEach(function(b){ b.textContent = icon; });
  try { localStorage.setItem('np_dark', _darkMode ? '1' : '0'); } catch(e){}
}
function loadDarkMode() {
  try {
    var d = localStorage.getItem('np_dark');
    if(d === '1') {
      _darkMode = true;
      document.body.classList.add('dark');
      document.querySelectorAll('.dm-toggle').forEach(function(b){ b.textContent = '‚òÄÔ∏è'; });
    }
  } catch(e){}
}
// Apply dark mode immediately to avoid flash
(function(){ try { if(localStorage.getItem('np_dark')==='1'){ _darkMode=true; document.documentElement.classList.add('dark'); } } catch(e){} })();
</script>
</head>
<body>
<div id="app">

<!-- ========== SPLASH ========== -->
<div id="pg-splash" class="pg on">
  <button class="dm-toggle" id="dm-btn-splash" onclick="toggleDarkMode()" title="Toggle dark mode">üåô</button>
  <div class="logo">Nurse<b>Prep</b></div>
  <div class="tagline">NMCN Exam Prep ¬∑ Nigeria</div>
  <div class="splash-icon">ü©∫</div>
  <button class="btn btn-gold" onclick="go('register')">Create Account</button>
  <button class="btn btn-ghost" onclick="go('login')">Log In</button>
  <p style="margin-top:24px;color:rgba(255,255,255,.35);font-size:12px">Paper 1 ¬∑ Paper 2 ¬∑ OSCE ¬∑ 2018‚Äì2025</p>
</div>

<!-- ========== REGISTER ========== -->
<div id="pg-register" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" id="reg-back-btn" onclick="regBack()">‚Üê</button>
      <div>
        <div class="bar-title">Create Account</div>
        <div class="bar-sub" id="reg-sub">Step 1 of 3 ‚Äî Personal Info</div>
      </div>
    </div>
    <div class="auth-body">
      <div class="steps-row">
        <div class="sdot active" id="sd1">1</div><div class="sline" id="sl12"></div>
        <div class="sdot todo" id="sd2">2</div><div class="sline" id="sl23"></div>
        <div class="sdot todo" id="sd3">3</div>
      </div>
      <div class="slabels">
        <span class="slabel active" id="sla1">Personal</span>
        <span class="slabel" id="sla2">Security</span>
        <span class="slabel" id="sla3">Verify</span>
      </div>

      <!-- STEP 1 -->
      <div id="s1">
        <p style="font-family:'Playfair Display',serif;font-size:22px;color:var(--gd);margin-bottom:20px">Tell us about yourself</p>
        <div class="photo-area">
          <div class="photo-ring" onclick="document.getElementById('photo-file').click()" id="photo-ring">
            <div style="text-align:center"><div style="font-size:26px">üì∑</div><div style="font-size:10px;color:var(--mt);margin-top:4px">Add Photo</div></div>
          </div>
          <div class="photo-tip">Profile photo (optional)</div>
          <input type="file" id="photo-file" accept="image/*" style="display:none" onchange="pickPhoto(this)">
        </div>
        <div class="grid2">
          <div class="fg">
            <label class="fl">First Name *</label>
            <div class="iw"><span class="il">üë§</span><input type="text" id="r1" class="pl" placeholder="Abena" oninput="ce('e1')"></div>
            <div class="err-field" id="e1"></div>
          </div>
          <div class="fg">
            <label class="fl">Last Name *</label>
            <input type="text" id="r2" placeholder="Mensah" oninput="ce('e2')">
            <div class="err-field" id="e2"></div>
          </div>
        </div>
        <div class="fg">
          <label class="fl">Username *</label>
          <div class="iw"><span class="il">ü™™</span><input type="text" id="r_uname" class="pl" placeholder="e.g. abena_mensah" autocomplete="username" oninput="ce('e_uname');checkUsernameAvail()"></div>
          <div class="hint" id="uname-hint"></div>
          <div class="err-field" id="e_uname"></div>
        </div>
        <div class="fg">
          <label class="fl">Phone Number *</label>
          <div class="iw"><span class="il">üìû</span><input type="tel" id="r3" class="pl" placeholder="0244 123 456" oninput="ce('e3')"></div>
          <div class="err-field" id="e3"></div>
        </div>
        <div class="fg">
          <label class="fl">Email Address *</label>
          <div class="iw"><span class="il">‚úâÔ∏è</span><input type="email" id="r4" class="pl" placeholder="abena@example.com" oninput="ce('e4')"></div>
          <div class="err-field" id="e4"></div>
          <div class="hint">üì¨ We'll send your verification code here</div>
        </div>
        <div class="fg">
          <label class="fl">Year Level *</label>
          <div class="iw"><span class="il">üéì</span>
            <select id="r7" style="padding-left:42px" onchange="ce('e7')">
              <option value="">‚Äî Select year level ‚Äî</option>
              <option>Year 1</option><option>Year 2</option><option>Year 3</option>
              <option>Final Year</option><option>Awaiting Licensure</option><option>Registered Nurse</option>
            </select>
          </div>
          <div class="err-field" id="e7"></div>
        </div>
        <div class="fg">
          <label class="fl">Referral Code <span style="color:var(--mt);font-weight:400">(Optional)</span></label>
          <div class="iw"><span class="il">üéÅ</span><input type="text" id="r_refcode" class="pl" placeholder="e.g. NPAB1234" autocomplete="off" oninput="checkRefCode()" style="text-transform:uppercase"></div>
          <div class="hint" id="refcode-hint">Have a friend's referral code? Enter it to give them credit.</div>
        </div>
        <button class="btn btn-green" style="width:100%;margin-top:4px" onclick="s1next()">Continue ‚Üí</button>
        <p style="text-align:center;margin-top:16px;font-size:14px;color:var(--mt)">Already have an account? <a onclick="go('login')" style="color:var(--g);font-weight:700;cursor:pointer">Log In</a></p>
      </div>

      <!-- STEP 2 ‚Äî Security -->
      <div id="s2" style="display:none">
        <p style="font-family:'Playfair Display',serif;font-size:22px;color:var(--gd);margin-bottom:20px">Secure your account</p>
        <div class="fg">
          <label class="fl">Password *</label>
          <div class="iw"><span class="il">üîí</span>
            <input type="password" id="r9" class="pl pr" placeholder="Create a strong password" oninput="pwStrCheck();ce('e9')">
            <button class="ir" onclick="togglePw('r9','eye1')" id="eye1">üëÅÔ∏è</button>
          </div>
          <div class="pw-bars"><div class="pw-bar" id="pb1"></div><div class="pw-bar" id="pb2"></div><div class="pw-bar" id="pb3"></div><div class="pw-bar" id="pb4"></div></div>
          <div class="pw-lbl" id="pwlbl"></div>
          <div class="err-field" id="e9"></div>
          <div class="hint">Min 8 chars ¬∑ Include uppercase &amp; numbers</div>
        </div>
        <div class="fg">
          <label class="fl">Confirm Password *</label>
          <div class="iw"><span class="il">üîí</span>
            <input type="password" id="r10" class="pl pr" placeholder="Re-enter password" oninput="matchCheck();ce('e10')">
            <button class="ir" onclick="togglePw('r10','eye2')" id="eye2">üëÅÔ∏è</button>
          </div>
          <div class="hint" id="match-hint"></div>
          <div class="err-field" id="e10"></div>
        </div>
        <div class="ckrow" onclick="toggleAgree()">
          <div class="ckbox" id="ckbox"></div>
          <div class="cktext">I agree to the <a onclick="event.stopPropagation()">Terms &amp; Conditions</a> and <a onclick="event.stopPropagation()">Privacy Policy</a> of NursePrep.</div>
        </div>
        <div class="err-field" id="e-terms"></div>
        <button class="btn btn-green" style="width:100%;margin-top:8px" id="send-btn" onclick="s2next()">Send Verification Code ‚Üí</button>
      </div>

      <!-- STEP 3 ‚Äî OTP -->
      <div id="s3" style="display:none;text-align:center">
        <div style="font-size:52px;margin-bottom:16px">üì¨</div>
        <p style="font-family:'Playfair Display',serif;font-size:22px;color:var(--gd);margin-bottom:10px">Check your email</p>
        <p style="color:var(--mt);font-size:14px;margin-bottom:6px">We've sent a 5-digit code to</p>
        <p style="font-weight:700;color:var(--g);font-size:15px;margin-bottom:24px" id="otp-email"></p>
        <div class="otp-row">
          <input class="otp-box" type="tel" maxlength="1" id="otp0" oninput="otpIn(0)" onkeydown="otpKey(0,event)">
          <input class="otp-box" type="tel" maxlength="1" id="otp1" oninput="otpIn(1)" onkeydown="otpKey(1,event)">
          <input class="otp-box" type="tel" maxlength="1" id="otp2" oninput="otpIn(2)" onkeydown="otpKey(2,event)">
          <input class="otp-box" type="tel" maxlength="1" id="otp3" oninput="otpIn(3)" onkeydown="otpKey(3,event)">
          <input class="otp-box" type="tel" maxlength="1" id="otp4" oninput="otpIn(4)" onkeydown="otpKey(4,event)">
        </div>
        <div class="err-field" id="e-otp" style="text-align:center;margin-bottom:10px"></div>
        <div class="al al-warn" style="text-align:left;margin-bottom:16px">üí° <strong>Demo mode:</strong> Type any 5 digits to proceed.</div>
        <button class="btn btn-green" style="width:100%;margin-bottom:14px" id="verify-btn" onclick="doVerify()">Verify &amp; Create Account ‚úì</button>
        <p style="font-size:14px;color:var(--mt)">Didn't receive it? <a onclick="toast('Code resent!')" style="color:var(--g);font-weight:700;cursor:pointer">Resend</a></p>
        <p style="margin-top:10px;font-size:13px;color:var(--mt)">Wrong email? <a onclick="goStep(1)" style="color:var(--g);font-weight:700;cursor:pointer">Go back</a></p>
      </div>
    </div>
  </div>
</div>

<!-- ========== SUCCESS ========== -->
<div id="pg-success" class="pg">
  <div class="suc-icon">üéâ</div>
  <div class="suc-title" id="suc-title">Welcome!</div>
  <div class="suc-sub">Your NursePrep account has been created. You're ready to start your exam preparation!</div>
  <div class="info-card" id="suc-card"></div>
  <div class="al al-warn" style="max-width:300px;font-size:13px">üîë Get a <strong>Pro Code</strong> from your coordinator to unlock all years.</div>
  <button class="btn btn-green" style="width:100%;max-width:300px;margin-top:16px" onclick="enterApp()">Start Preparing Now ü©∫</button>
</div>

<!-- ========== LOGIN ========== -->
<div id="pg-login" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('splash',true)">‚Üê</button>
      <div><div class="bar-title">Welcome Back</div><div class="bar-sub">Log in to your account</div></div>
    </div>
    <div class="auth-body">
      <div style="text-align:center;margin-bottom:28px">
        <div style="font-size:52px">ü©∫</div>
        <p style="font-family:'Playfair Display',serif;font-size:22px;color:var(--gd);margin-top:10px">Continue your preparation</p>
      </div>
      <div class="fg" style="position:relative">
        <label class="fl">Username</label>
        <div class="iw"><span class="il">üë§</span><input type="text" id="le" class="pl" placeholder="Your username" autocomplete="off" oninput="ce('le-err');filterAutocomplete('le','ac-user')" onfocus="showAutocomplete('le','ac-user')" onblur="hideAutocomplete('ac-user')" onkeydown="acKey(event,'ac-user')"></div>
        <div id="ac-user" class="ac-drop" style="display:none"></div>
        <div class="err-field" id="le-err"></div>
      </div>
      <div class="fg" style="position:relative">
        <label class="fl">Password</label>
        <div class="iw"><span class="il">üîí</span>
          <input type="password" id="lp" class="pl pr" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="ce('lp-err')" onkeydown="if(event.key==='Enter')doLogin()">
          <button class="ir" onclick="togglePw('lp','leye')" id="leye">üëÅÔ∏è</button>
        </div>
        <div class="err-field" id="lp-err"></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--mt);font-weight:600;user-select:none">
          <input type="checkbox" id="remember-me" style="width:16px;height:16px;accent-color:var(--g);cursor:pointer">
          Remember me
        </label>
        <a style="font-size:13px;color:var(--g);cursor:pointer;font-weight:600">Forgot Password?</a>
      </div>
      <div class="al al-err" id="l-err" style="display:none"></div>
      <button class="btn btn-green" style="width:100%" id="login-btn" onclick="doLogin()">Log In ‚Üí</button>
      <div class="div">or</div>
      <p style="text-align:center;font-size:14px;color:var(--mt)">New here? <a onclick="go('register')" style="color:var(--g);font-weight:700;cursor:pointer">Create an Account</a></p>
    </div>
  </div>
</div>

<!-- ========== MAIN STUDENT APP ========== -->
<div id="pg-main" class="pg">

  <!-- HOME TAB -->
  <div class="tab on" id="tab-home">
    <div class="greet">
      <button class="dm-toggle" id="dm-btn-home" onclick="toggleDarkMode()" title="Toggle dark mode" style="top:14px;right:14px">üåô</button>
      <div class="greet-name" id="greet-name">Hello üëã</div>
      <div class="greet-sch" id="greet-sch">NMCN Exam Prep Nigeria</div>
      <div class="gbadge free" id="gbadge">üîí Free ‚Äî 10 questions/session</div>
    </div>

    <!-- CONTINUE LAST QUIZ CARD -->
    <div class="continue-card" id="continue-card" onclick="continueLastQuiz()">
      <div class="continue-card-top">
        <div class="continue-card-ico">‚ñ∂Ô∏è</div>
        <div>
          <div class="continue-card-label">Continue where you left off</div>
          <div class="continue-card-title" id="continue-title">Loading...</div>
          <div class="continue-card-meta" id="continue-meta">‚Äî</div>
        </div>
      </div>
      <div class="continue-card-bar"><div class="continue-card-fill" id="continue-bar" style="width:0%"></div></div>
      <div class="continue-card-pct" id="continue-pct">0% through</div>
    </div>
    <div class="smini">
      <div class="sbox"><div class="snum" id="h-ans">0</div><div class="slbl2">Answered</div></div>
      <div class="sbox"><div class="snum">300+</div><div class="slbl2">Questions</div></div>
      <div class="sbox"><div class="snum">8</div><div class="slbl2">Years</div></div>
    </div>
    <div class="sectitle">Quick Start ‚Äî 2025</div>
    <div class="qbtns">
      <button class="qbtn" onclick="startQuiz('2025','Paper 1')">2025<br>Paper 1</button>
      <button class="qbtn" onclick="startQuiz('2025','Paper 2')">2025<br>Paper 2</button>
      <button class="qbtn" onclick="startQuiz('2025','OSCE')">2025<br>OSCE</button>
    </div>

    <!-- COUNCIL MOCK EXAM CARD -->
    <div class="mock-home-card" id="mock-home-card" onclick="goMockExam()">
      <div class="mock-home-tag">üè• NEW</div>
      <div class="mock-home-title">NMCN Mock Exam</div>
      <div class="mock-home-desc">250 questions ¬∑ 2-hour timer ¬∑ Real CBT format.<br>Test yourself under full exam conditions.</div>
      <div class="mock-home-pills">
        <span class="mock-home-pill">‚è± 120 min</span>
        <span class="mock-home-pill">üìã 250 Qs</span>
        <span class="mock-home-pill">üéì CBT Format</span>
        <span class="mock-home-pill">‚úÖ Pass: 50%</span>
      </div>
      <div id="mock-locked-overlay" class="mock-locked-overlay" style="display:none">
        <div style="text-align:center;color:#fff"><div style="font-size:32px;margin-bottom:6px">üîí</div><div style="font-size:13px;font-weight:700">Pro Access Required</div></div>
      </div>
    </div>
    <div class="promo" id="promo">
      <div style="font-size:30px">üöÄ</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:15px;color:var(--gd);margin-bottom:4px">Unlock Full Access</div>
        <div style="font-size:13px;color:var(--mt);margin-bottom:12px">Unlimited questions, all years, mock exams &amp; analytics.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-gold" style="padding:9px 16px;font-size:13px;max-width:150px" onclick="go('payment')">üí≥ Upgrade Now</button>
          <button class="btn btn-ghost" style="padding:9px 14px;font-size:12px;max-width:130px;border-color:var(--bd);color:var(--mt)" onclick="showPW()">Have a code?</button>
        </div>
      </div>
    </div>

    <!-- Referral nudge -->
    <div class="ref-nudge" id="ref-nudge-home" onclick="go('referral')">
      <div class="ref-nudge-ico">üéÅ</div>
      <div>
        <div class="ref-nudge-title">Invite Friends, Unlock Rewards</div>
        <div class="ref-nudge-desc">Invite 3 friends ‚Üí unlock 1 extra year free. No payment needed.</div>
        <div class="ref-nudge-cta">View my referral link ‚Üí</div>
      </div>
    </div>
  </div>

  <!-- QUESTIONS TAB -->
  <div class="tab" id="tab-questions">
    <div class="sectitle">Question Bank</div>
    <div class="fbar">
      <button class="fchip on" onclick="setFilter(this,'all')">All</button>
      <button class="fchip" onclick="setFilter(this,'Paper 1')">Paper 1</button>
      <button class="fchip" onclick="setFilter(this,'Paper 2')">Paper 2</button>
      <button class="fchip" onclick="setFilter(this,'OSCE')">OSCE</button>
    </div>
    <div class="ygrid" id="ygrid"></div>

  </div>

  <!-- CHAT TAB -->
  <div class="tab" id="tab-chat" style="padding:0">
    <div class="chat-wrap">
      <div class="chat-hdr">
        <div class="chav">NC</div>
        <div><div class="ch-title">NMCN Exam Prep 2025 üá≥üá¨</div><div class="ch-sub">üü¢ 247 students online</div></div>
        <div class="cbtns">
          <button class="cbtn" onclick="toast('üìû Voice call ‚Äî connect backend to enable')">üéôÔ∏è</button>
          <button class="cbtn" onclick="toast('üìπ Video call ‚Äî connect backend to enable')">üìπ</button>
        </div>
      </div>
      <div class="msgs" id="msgs"></div>
      <div class="chat-bar">
        <button class="micbtn" onclick="toast('üéô Voice notes ‚Äî connect backend to enable')">üéô</button>
        <input class="chat-inp" id="chat-inp" placeholder="Message the class..." onkeydown="if(event.key==='Enter')sendMsg()">
        <button class="sendbtn" onclick="sendMsg()">‚Üë</button>
      </div>
    </div>
  </div>

  <!-- PROFILE TAB -->
  <div class="tab" id="tab-profile" style="padding:0 0 20px">
    <div class="prof-hdr">
      <div class="pav" id="pav">S</div>
      <div class="pname" id="pname">Student</div>
      <div class="psch" id="psch">NursePrep Member</div>
    </div>
    <div class="pstats">
      <div class="pstat"><div class="psnum" id="ps1">0</div><div class="pslbl">Answered</div></div>
      <div class="pstat"><div class="psnum" id="ps2">‚Äî</div><div class="pslbl">Avg Score</div></div>
      <div class="pstat"><div class="psnum" id="ps3">Free</div><div class="pslbl">Access</div></div>
    </div>
    <div class="pmenu">
      <div id="pro-entry">
        <div class="adcard" style="background:#fff8e6;border-color:rgba(245,166,35,.35);margin:0 0 4px">
          <div class="adtitle">üîë Activate Pro Access</div>
          <p style="font-size:13px;color:var(--mt);margin-bottom:12px">Enter your code to unlock all years.</p>
          <div class="crow"><input type="text" id="pcode" placeholder="Enter Pro Code" style="flex:1">
            <button class="btn btn-green" style="padding:10px 14px;font-size:13px;max-width:85px;min-width:70px" onclick="applyProfileCode()">Apply</button>
          </div>
          <div class="err-field" id="pcode-err"></div>
        </div>
      </div>
      <div id="upgrade-menu-item" class="mitem" onclick="go('payment')" style="background:linear-gradient(135deg,rgba(245,166,35,.08),rgba(245,166,35,.02));border-radius:12px;margin-bottom:4px"><div class="mico" style="background:linear-gradient(135deg,var(--gold),var(--goldd));color:#fff">üí≥</div><div class="mlbl" style="color:var(--goldd);font-weight:700">Upgrade to Pro</div><div class="marr" style="color:var(--goldd)">‚Ä∫</div></div>
      <div id="active-plan-menu" style="display:none;margin-bottom:4px" onclick="go('payment')">
        <div class="active-plan-card"><div class="apc-label">CURRENT PLAN</div><div class="apc-plan" id="apc-plan-name">Lifetime Access</div><div class="apc-expiry" id="apc-expiry-txt">Active ¬∑ Never expires</div><button class="apc-manage" onclick="event.stopPropagation();go('payment')">Manage Plan ‚Ä∫</button></div>
      </div>
      <div class="mitem" onclick="go('performance')"><div class="mico">üìä</div><div class="mlbl">My Performance</div><div class="marr">‚Ä∫</div></div>
      <div class="mitem" onclick="go('bookmarks')"><div class="mico">üîñ</div><div class="mlbl">Bookmarks</div><div class="marr">‚Ä∫</div></div>
      <div class="mitem" onclick="go('referral')" style="background:linear-gradient(135deg,rgba(245,166,35,.06),rgba(245,166,35,.02));border-radius:12px;margin-bottom:4px"><div class="mico" style="background:linear-gradient(135deg,#F5A623,#D4891A);color:#fff">üéÅ</div><div class="mlbl" style="color:var(--goldd);font-weight:700">Invite & Earn Rewards</div><div id="ref-menu-badge" class="marr" style="color:var(--goldd)">‚Ä∫</div></div>
      <div class="mitem" onclick="goMockExam()" style="background:linear-gradient(135deg,rgba(30,27,75,.06),rgba(49,46,129,.06));border-radius:12px;margin-bottom:4px"><div class="mico" style="background:linear-gradient(135deg,#4338CA,#6D28D9);color:#fff">üè•</div><div class="mlbl" style="color:#3730A3;font-weight:700">NMCN Mock Exam</div><div class="marr" style="color:#6D28D9">‚Ä∫</div></div>
      <div class="mitem" onclick="go('notifications')"><div class="mico">üîî</div><div class="mlbl">Notifications</div><div class="marr">‚Ä∫</div></div>
      <div class="mitem" onclick="go('change-password')"><div class="mico">üîí</div><div class="mlbl">Change Password</div><div class="marr">‚Ä∫</div></div>
      <div class="mitem" onclick="go('contact-admin')"><div class="mico">üìû</div><div class="mlbl">Contact Admin</div><div class="marr">‚Ä∫</div></div>
      <div class="mitem" onclick="doLogout()"><div class="mico">üö™</div><div class="mlbl" style="color:var(--red)">Log Out</div><div class="marr">‚Ä∫</div></div>
    </div>
  </div>

  <!-- STUDENT BOTTOM NAV (no admin tab) -->
  <div class="bnav">
    <div class="ni on" onclick="switchTab('home',this)"><div class="ni-ico">üè†</div><div class="ni-lbl">Home</div></div>
    <div class="ni" onclick="switchTab('questions',this)"><div class="ni-ico">üìã</div><div class="ni-lbl">Questions</div></div>
    <div class="ni" onclick="switchTab('chat',this)"><div class="ni-ico">üí¨</div><div class="ni-lbl">Class</div></div>
    <div class="ni" onclick="switchTab('profile',this)"><div class="ni-ico">üë§</div><div class="ni-lbl">Profile</div></div>
  </div>
</div>

<!-- ========== MODE SELECTOR ========== -->
<div id="pg-mode-select" class="pg">
  <div style="min-height:100vh;display:flex;flex-direction:column">
    <div class="auth-bar">
      <button class="bk" onclick="go('main',true)">‚Üê</button>
      <div><div class="bar-title" id="ms-title">2025 ‚Äî Paper 1</div><div class="bar-sub" id="ms-sub">Choose your practice mode</div></div>
    </div>
    <div style="padding:24px 20px;flex:1">

      <div style="text-align:center;margin-bottom:28px">
        <div style="font-size:48px;margin-bottom:10px">ü©∫</div>
        <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--gd);margin-bottom:6px">How do you want to practice?</div>
        <div style="font-size:13px;color:var(--mt);line-height:1.6">Choose a mode that matches your study goal today.</div>
      </div>

      <!-- Mode cards -->
      <div class="mode-selector" style="flex-direction:column;gap:14px">

        <div class="mode-btn review-mode on" id="mbtn-review" onclick="selectMode('review')">
          <div style="display:flex;align-items:center;gap:14px;text-align:left">
            <div style="font-size:38px">üìñ</div>
            <div style="flex:1">
              <div class="mode-btn-name" style="font-size:15px;color:var(--gd)">Review Mode</div>
              <div class="mode-btn-desc" style="color:var(--mt);font-size:13px;margin-top:3px">See the correct answer and explanation immediately after each question. Best for learning concepts.</div>
              <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
                <span style="background:rgba(34,197,94,.1);color:#15803d;font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid rgba(34,197,94,.3)">‚úÖ Instant feedback</span>
                <span style="background:rgba(34,197,94,.1);color:#15803d;font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid rgba(34,197,94,.3)">üí° Explanations</span>
              </div>
            </div>
            <div id="mcheck-review" style="font-size:22px">‚úÖ</div>
          </div>
        </div>

        <div class="mode-btn exam-mode" id="mbtn-exam" onclick="selectMode('exam')">
          <div style="display:flex;align-items:center;gap:14px;text-align:left">
            <div style="font-size:38px">üéì</div>
            <div style="flex:1">
              <div class="mode-btn-name" style="font-size:15px;color:#1D4ED8">Exam Mode</div>
              <div class="mode-btn-desc" style="color:var(--mt);font-size:13px;margin-top:3px">No feedback during the quiz ‚Äî just like the real NMCN CBT. Full review shown at the end.</div>
              <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
                <span style="background:#EFF6FF;color:#1D4ED8;font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid #BFDBFE">üîï No hints</span>
                <span style="background:#EFF6FF;color:#1D4ED8;font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid #BFDBFE">üìã End review</span>
              </div>
            </div>
            <div id="mcheck-exam" style="font-size:22px;opacity:.25">‚úÖ</div>
          </div>
        </div>

      </div>

      <div id="ms-free-note" style="display:none;margin-top:14px">
        <div class="al al-warn" style="font-size:13px">üîí Free plan: <strong id="ms-free-count">10</strong> questions. <a onclick="go('payment')" style="color:var(--goldd);font-weight:700;cursor:pointer">Upgrade to Pro</a> for unlimited.</div>
      </div>

      <button class="btn btn-green" style="width:100%;margin-top:24px;font-size:16px" id="start-btn" onclick="confirmStartQuiz()">Start Practice ‚Üí</button>

    </div>
  </div>
</div>

<!-- ========== QUIZ ========== -->
<div id="pg-quiz" class="pg">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:20px 16px 0">
    <button class="bk" onclick="confirmQuitQuiz()">‚Üê</button>
    <div class="quiz-ttl" id="qhdr" style="font-family:'Playfair Display',serif;font-size:17px;flex:1">2025 ‚Äî Paper 1</div>
    <button class="bm-btn" id="bm-btn" onclick="toggleBookmark()" title="Bookmark this question">üîñ</button>
    <button class="rpt-btn" id="rpt-btn" onclick="showReportModal()" title="Report this question">‚öë</button>
    <div class="quiz-mode-pill review" id="qmodepill">üìñ Review</div>
    <span class="tag tag-o" id="qtag" style="margin-left:4px">10 left</span>
  </div>
  <div style="padding:0 16px">
    <div class="pbar"><div class="pfill" id="pfill" style="width:0%"></div></div>
    <div class="qnum" id="qnum">QUESTION 1 OF 10</div>
    <div class="qtxt" id="qtxt"></div>
    <div class="opts" id="opts"></div>
    <div class="expl" id="expl" style="display:none"></div>
    <button class="ai-explain-btn" id="ai-explain-btn" onclick="openAIExplain()">
      <span class="ai-sparkle">‚ú¶</span>
      <span id="ai-explain-btn-lbl">Explain this with AI</span>
    </button>
    <button class="btn btn-green" style="width:100%;margin-top:12px;display:none" id="nxtbtn" onclick="nextQ()">Next Question ‚Üí</button>
  </div>
</div>

<!-- ========== MY PERFORMANCE ========== -->
<div id="pg-performance" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('main',true)">‚Üê</button>
      <div><div class="bar-title">My Performance</div><div class="bar-sub" id="perf-header-sub">Track your progress</div></div>
    </div>
    <div class="auth-body">

      <!-- Hero summary -->
      <div class="analytics-hero">
        <div class="analytics-hero-title">Performance Dashboard</div>
        <div class="analytics-hero-sub" id="perf-last-active">Start your first quiz to see analytics</div>
        <div class="hero-stats">
          <div class="hero-stat">
            <div class="hero-stat-num" id="perf-ans">0</div>
            <div class="hero-stat-lbl">Answered</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-num" id="perf-avg">‚Äî</div>
            <div class="hero-stat-lbl">Avg Score</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-num" id="perf-sessions">0</div>
            <div class="hero-stat-lbl">Sessions</div>
          </div>
        </div>
      </div>

      <!-- Streak Tracker -->
      <div class="streak-card">
        <div class="streak-top">
          <div class="streak-flame">üî•</div>
          <div>
            <div class="streak-num" id="streak-count">0</div>
            <div class="streak-lbl">Day Streak</div>
            <div class="streak-best" id="streak-best"></div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div style="font-size:11px;color:var(--mt);font-weight:600">THIS WEEK</div>
            <div id="streak-msg" style="font-size:12px;color:var(--goldd);font-weight:700;margin-top:4px">Practice daily!</div>
          </div>
        </div>
        <div class="streak-days" id="streak-days"></div>
      </div>

      <!-- Tab navigation -->
      <div class="perf-tab-btns">
        <button class="perf-tab-btn on" onclick="switchPerfTab('overview',this)">Overview</button>
        <button class="perf-tab-btn" onclick="switchPerfTab('subjects',this)">Subjects</button>
        <button class="perf-tab-btn" onclick="switchPerfTab('history',this)">History</button>
        <button class="perf-tab-btn" onclick="switchPerfTab('tips',this)">Tips</button>
      </div>

      <!-- OVERVIEW TAB -->
      <div class="perf-tab-panel on" id="ptab-overview">
        <!-- Accuracy by Subject -->
        <div class="insight-card">
          <div class="insight-title">üìä Accuracy by Subject</div>
          <div id="subject-breakdown">
            <div class="empty-state"><div class="empty-state-ico">üìã</div><div style="font-size:14px">Complete quizzes to see subject breakdown</div></div>
          </div>
        </div>

        <!-- Weakest & Strongest -->
        <div class="insight-card">
          <div class="insight-title">üéØ Recommended Practice</div>
          <div id="recommendations">
            <div class="empty-state"><div class="empty-state-ico">üéØ</div><div style="font-size:14px">Complete quizzes to get recommendations</div></div>
          </div>
        </div>

        <!-- By Year -->
        <div class="insight-card">
          <div class="insight-title">üìÖ Performance by Year</div>
          <div id="year-breakdown">
            <div class="empty-state"><div class="empty-state-ico">üìÖ</div><div style="font-size:14px">No year data yet</div></div>
          </div>
        </div>
      </div>

      <!-- SUBJECTS TAB -->
      <div class="perf-tab-panel" id="ptab-subjects">
        <div class="insight-card">
          <div class="insight-title">üìä Paper 1 Performance</div>
          <div id="paper1-detail"><div class="empty-state"><div style="font-size:14px;color:var(--mt)">No Paper 1 data yet</div></div></div>
        </div>
        <div class="insight-card">
          <div class="insight-title">üìä Paper 2 Performance</div>
          <div id="paper2-detail"><div class="empty-state"><div style="font-size:14px;color:var(--mt)">No Paper 2 data yet</div></div></div>
        </div>
        <div class="insight-card">
          <div class="insight-title">üìä OSCE Performance</div>
          <div id="osce-detail"><div class="empty-state"><div style="font-size:14px;color:var(--mt)">No OSCE data yet</div></div></div>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div class="perf-tab-panel" id="ptab-history">
        <div class="insight-card" style="padding:0;overflow:hidden">
          <div style="padding:14px 16px 10px;font-weight:700;font-size:14px;color:var(--gd);border-bottom:1px solid var(--bg)">üïê Quiz History</div>
          <div id="quiz-history">
            <div class="empty-state"><div class="empty-state-ico">üìù</div><div style="font-size:14px">No quizzes taken yet. Start practicing!</div></div>
          </div>
        </div>
      </div>

      <!-- TIPS TAB -->
      <div class="perf-tab-panel" id="ptab-tips">
        <div class="insight-card">
          <div class="insight-title">üí° Study Tips</div>
          <div id="study-tips-content"></div>
        </div>
        <div class="insight-card" style="background:#f0f9f4">
          <div class="insight-title">üìà Time Stats</div>
          <div id="time-stats">
            <div class="time-stat-row"><span class="time-stat-lbl">Total study sessions</span><span class="time-stat-val" id="ts-sessions">0</span></div>
            <div class="time-stat-row"><span class="time-stat-lbl">Correct answers (total)</span><span class="time-stat-val" id="ts-correct">0</span></div>
            <div class="time-stat-row"><span class="time-stat-lbl">Best score ever</span><span class="time-stat-val" id="ts-best">‚Äî</span></div>
            <div class="time-stat-row"><span class="time-stat-lbl">Most studied paper</span><span class="time-stat-val" id="ts-fav">‚Äî</span></div>
            <div class="time-stat-row"><span class="time-stat-lbl">Questions this week</span><span class="time-stat-val" id="ts-week">0</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ========== NOTIFICATIONS ========== -->
<div id="pg-notifications" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('main',true)">‚Üê</button>
      <div><div class="bar-title">Notifications</div><div class="bar-sub">Stay updated</div></div>
    </div>
    <div class="auth-body">
      <div class="adcard">
        <div class="adtitle">üîî Notification Settings</div>
        <div class="ckrow" onclick="toggleNotif(this,'chat')">
          <div class="ckbox on" id="notif-chat">‚úì</div>
          <div class="cktext"><strong>Chat Messages</strong><br><span style="font-size:12px;color:var(--mt)">Get notified when there are new messages in the group chat</span></div>
        </div>
        <div class="ckrow" onclick="toggleNotif(this,'admin')">
          <div class="ckbox on" id="notif-admin">‚úì</div>
          <div class="cktext"><strong>Admin Announcements</strong><br><span style="font-size:12px;color:var(--mt)">Receive important updates from administrators</span></div>
        </div>
        <div class="ckrow" onclick="toggleNotif(this,'questions')">
          <div class="ckbox on" id="notif-questions">‚úì</div>
          <div class="cktext"><strong>New Questions</strong><br><span style="font-size:12px;color:var(--mt)">Be alerted when new practice questions are uploaded</span></div>
        </div>
        <div class="al al-warn" style="margin-top:16px">
          <strong>üì± Browser Notifications</strong><br>
          <span style="font-size:13px">Click below to enable push notifications on your device.</span>
        </div>
        <button class="btn btn-green" style="width:100%;margin-top:12px" onclick="requestNotificationPermission()">Enable Push Notifications</button>
      </div>

      <div class="adcard">
        <div class="adtitle">üì¨ Recent Notifications</div>
        <div id="notif-list">
          <p style="color:var(--mt);font-size:14px;text-align:center;padding:20px 0">No notifications yet.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== CHANGE PASSWORD ========== -->
<div id="pg-change-password" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('main',true)">‚Üê</button>
      <div><div class="bar-title">Change Password</div><div class="bar-sub">Update your security</div></div>
    </div>
    <div class="auth-body">
      <div class="adcard">
        <div class="adtitle">üîí Update Password</div>
        <div class="fg">
          <label class="fl">Current Password</label>
          <div class="iw"><span class="il">üîí</span>
            <input type="password" id="curr-pw" class="pl pr" placeholder="Enter current password" oninput="ce('curr-pw-err')">
            <button class="ir" onclick="togglePw('curr-pw','eye-curr')" id="eye-curr">üëÅÔ∏è</button>
          </div>
          <div class="err-field" id="curr-pw-err"></div>
        </div>
        <div class="fg">
          <label class="fl">New Password</label>
          <div class="iw"><span class="il">üîí</span>
            <input type="password" id="new-pw" class="pl pr" placeholder="Enter new password" oninput="checkNewPW();ce('new-pw-err')">
            <button class="ir" onclick="togglePw('new-pw','eye-new')" id="eye-new">üëÅÔ∏è</button>
          </div>
          <div class="pw-bars"><div class="pw-bar" id="npb1"></div><div class="pw-bar" id="npb2"></div><div class="pw-bar" id="npb3"></div><div class="pw-bar" id="npb4"></div></div>
          <div class="pw-lbl" id="npwlbl"></div>
          <div class="err-field" id="new-pw-err"></div>
        </div>
        <div class="fg">
          <label class="fl">Confirm New Password</label>
          <div class="iw"><span class="il">üîí</span>
            <input type="password" id="conf-pw" class="pl pr" placeholder="Re-enter new password" oninput="matchNewPW();ce('conf-pw-err')">
            <button class="ir" onclick="togglePw('conf-pw','eye-conf')" id="eye-conf">üëÅÔ∏è</button>
          </div>
          <div class="hint" id="match-new-hint"></div>
          <div class="err-field" id="conf-pw-err"></div>
        </div>
        <button class="btn btn-green" style="width:100%" onclick="changePassword()">Update Password</button>
        <div id="pw-change-msg" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>



<!-- ========== PAYMENT / UPGRADE ========== -->
<div id="pg-payment" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar" style="background:var(--gd);border-color:rgba(255,255,255,.1)">
      <button class="bk" onclick="go('main',true)" style="background:rgba(255,255,255,.15);color:#fff">‚Üê</button>
      <div><div class="bar-title" style="color:#fff">Upgrade to Pro</div><div class="bar-sub" style="color:rgba(255,255,255,.6)">Unlock full access</div></div>
    </div>

    <!-- Hero -->
    <div class="pay-hero">
      <div style="font-size:48px;margin-bottom:12px">üéì</div>
      <div class="pay-hero-title">Choose Your Plan</div>
      <div class="pay-hero-sub">Unlimited questions ¬∑ All years ¬∑ Mock exams ¬∑ Study analytics</div>
    </div>

    <div style="padding:0 16px 80px">

      <!-- Plan type tabs -->
      <div class="plan-tabs">
        <div class="plan-tab on" id="ptab-individual" onclick="switchPlanType('individual')">üë§ Individual</div>
        <div class="plan-tab" id="ptab-school" onclick="switchPlanType('school')">üè´ School / Bulk</div>
      </div>

      <!-- ‚îÄ‚îÄ INDIVIDUAL PLANS ‚îÄ‚îÄ -->
      <div id="plans-individual">

        <!-- Monthly -->
        <div class="plan-card" id="pcard-monthly" onclick="selectPlan('monthly')">
          <div class="plan-radio"></div>
          <div class="plan-name">Monthly</div>
          <div class="plan-price">‚Ç¶2,500 <span>/ month</span></div>
          <div class="plan-desc">Perfect if you're sitting the exam soon. Cancel anytime.</div>
          <ul class="plan-features">
            <li>Unlimited practice questions</li>
            <li>All past years (Paper 1, 2 &amp; OSCE)</li>
            <li>NMCN Mock Exam mode</li>
            <li>Performance analytics</li>
            <li>Auto-renews monthly</li>
          </ul>
        </div>

        <!-- Lifetime -->
        <div class="plan-card featured on" id="pcard-lifetime" onclick="selectPlan('lifetime')">
          <div class="plan-badge">‚≠ê BEST VALUE</div>
          <div class="plan-radio"></div>
          <div class="plan-name">Lifetime Access</div>
          <div class="plan-price">‚Ç¶9,999 <span>one-time</span></div>
          <div class="plan-desc">Pay once, access forever. Includes all future updates and new questions.</div>
          <ul class="plan-features">
            <li>Everything in Monthly</li>
            <li>Lifetime updates ‚Äî free</li>
            <li>Priority support</li>
            <li>Early access to new features</li>
            <li>No recurring charges ever</li>
          </ul>
        </div>

      </div>

      <!-- ‚îÄ‚îÄ SCHOOL / BULK PLANS ‚îÄ‚îÄ -->
      <div id="plans-school" style="display:none">

        <!-- Starter bulk -->
        <div class="plan-card on" id="pcard-bulk10" onclick="selectPlan('bulk10')">
          <div class="plan-badge" style="background:var(--g);color:#fff">BULK</div>
          <div class="plan-radio"></div>
          <div class="plan-name">Starter Bulk ‚Äî 10 Seats</div>
          <div class="plan-price">‚Ç¶24,999 <span>/ year</span></div>
          <div class="plan-desc">Ideal for small nursing schools or study groups.</div>
          <ul class="plan-features">
            <li>10 student accounts</li>
            <li>School admin dashboard</li>
            <li>Bulk Pro code generation</li>
            <li>Group performance reports</li>
          </ul>
        </div>

        <!-- Pro bulk -->
        <div class="plan-card" id="pcard-bulk50" onclick="selectPlan('bulk50')">
          <div class="plan-badge" style="background:linear-gradient(135deg,#4338CA,#6D28D9);color:#fff">POPULAR</div>
          <div class="plan-radio"></div>
          <div class="plan-name">Pro Bulk ‚Äî 50 Seats</div>
          <div class="plan-price">‚Ç¶99,999 <span>/ year</span></div>
          <div class="plan-desc">Best for mid-size institutions ‚Äî includes priority onboarding.</div>
          <ul class="plan-features">
            <li>50 student accounts</li>
            <li>Everything in Starter</li>
            <li>Priority onboarding &amp; training</li>
            <li>Dedicated admin contact</li>
            <li>Custom branding option</li>
          </ul>
        </div>

        <!-- Enterprise -->
        <div class="plan-card" id="pcard-enterprise" onclick="selectPlan('enterprise')">
          <div class="plan-radio"></div>
          <div class="plan-name">Enterprise ‚Äî Unlimited</div>
          <div class="plan-price" style="font-size:22px">Custom <span>pricing</span></div>
          <div class="plan-desc">For large institutions. Includes SLA, integrations &amp; invoice billing.</div>
          <ul class="plan-features">
            <li>Unlimited student accounts</li>
            <li>Invoice / PO / Remita billing</li>
            <li>Custom domain &amp; branding</li>
            <li>API access for your LMS</li>
            <li>Dedicated account manager</li>
          </ul>
        </div>

        <!-- Bulk: extra fields -->
        <div class="bulk-fields" id="bulk-extra-fields" style="display:none">
          <div class="adtitle" style="margin-bottom:12px">üè´ School Details</div>
          <div class="fg">
            <label class="fl">School / Institution Name</label>
            <input type="text" id="bulk-school-name" placeholder="e.g. Nairobi Nursing College">
          </div>
          <div class="fg">
            <label class="fl">Admin Contact Email</label>
            <input type="email" id="bulk-admin-email" placeholder="admin@school.ac.ke">
          </div>
          <div class="fg">
            <label class="fl">Number of Students</label>
            <input type="number" id="bulk-student-count" placeholder="e.g. 45" min="1">
          </div>
        </div>

      </div>

      <!-- Payment provider -->
      <div class="prov-title">Pay with</div>
      <div class="prov-grid">
        <div class="prov-card on" id="prov-paystack" onclick="selectProvider('paystack')">
          <div class="prov-logo">üí≥</div>
          <div class="prov-name">Paystack</div>
          <div class="prov-tag">Card ¬∑ M-Pesa</div>
        </div>
        <div class="prov-card" id="prov-flutterwave" onclick="selectProvider('flutterwave')">
          <div class="prov-logo">üåä</div>
          <div class="prov-name">Flutterwave</div>
          <div class="prov-tag">Card ¬∑ Mobile</div>
        </div>
        <div class="prov-card" id="prov-remita" onclick="selectProvider('remita')">
          <div class="prov-logo">üèõÔ∏è</div>
          <div class="prov-name">Remita</div>
          <div class="prov-tag">Invoice ¬∑ Schools</div>
        </div>
      </div>

      <!-- Remita note -->
      <div id="remita-note" class="al al-warn" style="display:none;margin-bottom:14px">
        üèõÔ∏è <strong>Remita</strong> is recommended for school/institution payments. A payment reference (RRR) will be generated for your accounts team to process.
      </div>

      <!-- Order total -->
      <div class="pay-total">
        <div>
          <div class="pay-total-lbl">Total due today</div>
          <div style="font-size:12px;color:var(--mt);margin-top:2px" id="pay-plan-label">Lifetime Access ‚Äî One-time</div>
        </div>
        <div class="pay-total-amt" id="pay-total-display">‚Ç¶9,999</div>
      </div>

      <div class="pay-secure">üîí 256-bit SSL ¬∑ Secured by <strong id="pay-secure-prov">Paystack</strong></div>

      <button class="btn btn-gold" style="width:100%;font-size:17px;padding:16px" onclick="initiatePayment()" id="pay-cta-btn">
        Pay ‚Ç¶9,999 ‚Üí
      </button>

      <p style="text-align:center;font-size:12px;color:var(--mt);margin-top:14px;line-height:1.6">
        By proceeding you agree to our <a style="color:var(--g)">Terms of Service</a>.<br>
        Payments processed securely. No card data stored on our servers.
      </p>

    </div>
  </div>
</div>

<!-- ========== PAYMENT MODAL (progress/result) ========== -->
<div class="pay-modal-bg" id="pay-modal-bg">
  <div class="pay-modal">
    <!-- Awaiting -->
    <div id="pay-modal-awaiting">
      <div class="pay-modal-hd">
        <div class="pmo-ico" id="pmo-ico">üí≥</div>
        <h3 id="pmo-title">Processing Payment</h3>
        <p id="pmo-sub">Please complete payment in the window that opens</p>
      </div>
      <div class="pay-modal-body">
        <div class="pay-step-row"><div class="pay-step-num">1</div><div class="pay-step-txt"><strong>Payment window opened</strong> ‚Äî complete the payment in the <span id="pmo-prov-name">Paystack</span> checkout</div></div>
        <div class="pay-step-row"><div class="pay-step-num">2</div><div class="pay-step-txt">Return here after payment ‚Äî your account upgrades automatically</div></div>
        <div class="pay-step-row"><div class="pay-step-num">3</div><div class="pay-step-txt">A confirmation receipt will be sent to your email</div></div>
        <div class="pay-processing">
          <div class="pay-spinner"></div>
          <div style="font-size:14px;color:var(--mt)">Waiting for payment confirmation‚Ä¶</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:4px">
          <button class="btn btn-grey" style="flex:1;font-size:14px" onclick="closePayModal()">Cancel</button>
          <button class="btn btn-green" style="flex:1;font-size:14px" onclick="simulatePaymentSuccess()">‚úÖ I've Paid</button>
        </div>
        <p style="font-size:11px;color:var(--mt);text-align:center;margin-top:10px">Having trouble? <span onclick="go('contact-admin');closePayModal()" style="color:var(--g);cursor:pointer;font-weight:600">Contact Admin</span></p>
      </div>
    </div>

    <!-- Success -->
    <div id="pay-modal-success" style="display:none">
      <div class="pay-modal-hd" style="background:linear-gradient(135deg,#15803d,#22c55e)">
        <div class="pmo-ico">üéâ</div>
        <h3>Payment Successful!</h3>
        <p>Your account has been upgraded</p>
      </div>
      <div class="pay-modal-body">
        <div class="pay-success-anim"><div style="font-size:60px">‚úÖ</div></div>
        <div class="info-card" style="margin-bottom:16px">
          <div class="irow"><span class="ilbl">Plan</span><span class="ival" id="suc-plan-label">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Amount</span><span class="ival" id="suc-amount">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Provider</span><span class="ival" id="suc-provider">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Ref #</span><span class="ival" id="suc-ref">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Valid until</span><span class="ival" id="suc-expiry">Lifetime</span></div>
        </div>
        <button class="btn btn-green" style="width:100%" onclick="closePaySuccess()">üöÄ Start Learning</button>
      </div>
    </div>

    <!-- Remita flow -->
    <div id="pay-modal-remita" style="display:none">
      <div class="pay-modal-hd" style="background:linear-gradient(135deg,#1e3a5f,#2563eb)">
        <div class="pmo-ico">üèõÔ∏è</div>
        <h3>Remita Payment</h3>
        <p>Government &amp; institutional billing</p>
      </div>
      <div class="pay-modal-body">
        <div class="al al-ok" style="margin-bottom:16px">Your Remita Retrieval Reference (RRR) has been generated.</div>
        <div class="info-card" style="margin-bottom:16px">
          <div class="irow"><span class="ilbl">RRR</span><span class="ival" id="remita-rrr" style="font-family:monospace;font-size:14px;color:var(--g);font-weight:800">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Amount</span><span class="ival" id="remita-amount">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Plan</span><span class="ival" id="remita-plan-label">‚Äî</span></div>
          <div class="irow"><span class="ilbl">Biller</span><span class="ival">NursePrep Ltd</span></div>
        </div>
        <div class="al al-warn" style="margin-bottom:14px;font-size:13px">
          üìã Take this RRR to any bank, use <strong>remita.net</strong>, or instruct your accounts department to process payment.
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-grey" style="flex:1;font-size:13px" onclick="copyRRR()">üìã Copy RRR</button>
          <button class="btn btn-green" style="flex:1;font-size:13px" onclick="simulatePaymentSuccess()">‚úÖ Confirm Paid</button>
        </div>
        <button class="btn" style="width:100%;margin-top:10px;background:#EFF6FF;color:#1D4ED8;border:1.5px solid #BFDBFE;font-size:13px" onclick="window.open('https://login.remita.net/remita/exapp/api/v1/send/api/echannelsvc/merchant/api/paymentinit','_blank')">üåê Pay on Remita.net</button>
        <button class="btn btn-grey" style="width:100%;margin-top:8px;font-size:13px" onclick="closePayModal()">Close</button>
      </div>
    </div>

  </div>
</div>


<!-- ========== CONTACT ADMIN ========== -->
<div id="pg-contact-admin" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('main',true)">‚Üê</button>
      <div><div class="bar-title">Contact Admin</div><div class="bar-sub">We're here to help</div></div>
    </div>
    <div class="auth-body">

      <!-- Quick contact cards -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px">
        <div onclick="window.open('mailto:admin@nurseprep.ng')" style="background:linear-gradient(135deg,#e8f5f0,#d0ede3);border-radius:14px;padding:16px 12px;cursor:pointer;text-align:center;border:1.5px solid var(--bd);transition:all .2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
          <div style="font-size:28px;margin-bottom:6px">üìß</div>
          <div style="font-weight:700;font-size:13px;color:var(--gd)">Email</div>
          <div style="font-size:11px;color:var(--mt);margin-top:3px"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2647424b4f48664853545543565443560845494b">[email&#160;protected]</a></div>
        </div>
        <div onclick="window.open('https://wa.me/254700000000','_blank')" style="background:linear-gradient(135deg,#e8f5e8,#d0edd0);border-radius:14px;padding:16px 12px;cursor:pointer;text-align:center;border:1.5px solid #b8dbb8;transition:all .2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
          <div style="font-size:28px;margin-bottom:6px">üí¨</div>
          <div style="font-weight:700;font-size:13px;color:#15803d">WhatsApp</div>
          <div style="font-size:11px;color:var(--mt);margin-top:3px">Chat with us</div>
        </div>
      </div>

      <!-- Message form -->
      <div class="adcard">
        <div class="adtitle">‚úâÔ∏è Send a Message</div>
        <p style="font-size:13px;color:var(--mt);margin-bottom:16px">Fill in the form below and our team will respond within 24 hours.</p>

        <div class="fg">
          <label class="fl">Subject</label>
          <select id="contact-subject" oninput="ce('contact-err')">
            <option value="">‚Äî Select a topic ‚Äî</option>
            <option value="Account Issue">Account Issue</option>
            <option value="Pro Code Problem">Pro Code Problem</option>
            <option value="Question Error / Typo">Question Error / Typo</option>
            <option value="Payment / Billing">Payment / Billing</option>
            <option value="Technical Problem">Technical Problem</option>
            <option value="Suggestion / Feedback">Suggestion / Feedback</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="fg">
          <label class="fl">Your Name</label>
          <div class="iw"><span class="il">üë§</span>
            <input type="text" id="contact-name" class="pl" placeholder="Full name" oninput="ce('contact-err')">
          </div>
        </div>

        <div class="fg">
          <label class="fl">Email or Phone</label>
          <div class="iw"><span class="il">üì±</span>
            <input type="text" id="contact-contact" class="pl" placeholder="So we can reach you back" oninput="ce('contact-err')">
          </div>
        </div>

        <div class="fg">
          <label class="fl">Message</label>
          <textarea id="contact-message" rows="5" placeholder="Describe your issue or question in detail..." oninput="ce('contact-err')" style="resize:none;line-height:1.6"></textarea>
        </div>

        <div class="err-field" id="contact-err"></div>
        <button class="btn btn-green" style="width:100%" onclick="submitContact()">üì® Send Message</button>
        <div id="contact-msg" style="margin-top:12px"></div>
      </div>

      <!-- FAQ accordion -->
      <div class="adcard" style="margin-top:4px">
        <div class="adtitle">‚ùì Common Questions</div>
        <div id="contact-faqs">
          <div class="contact-faq" onclick="toggleFAQ(this)">
            <div class="faq-q">üîë My Pro Code isn't working <span class="faq-arr">‚Ä∫</span></div>
            <div class="faq-a">Make sure you enter the code exactly as given (case-sensitive). Codes have an expiry date ‚Äî if it has expired, contact your coordinator for a new one.</div>
          </div>
          <div class="contact-faq" onclick="toggleFAQ(this)">
            <div class="faq-q">üîí I forgot my password <span class="faq-arr">‚Ä∫</span></div>
            <div class="faq-a">Use "Change Password" in your profile (you'll need your current password). If you're fully locked out, send us a message above and we'll reset it.</div>
          </div>
          <div class="contact-faq" onclick="toggleFAQ(this)">
            <div class="faq-q">üìã I found an error in a question <span class="faq-arr">‚Ä∫</span></div>
            <div class="faq-a">Thank you! Use the form above, select "Question Error / Typo", and include the question number and paper. We review and fix all reported errors quickly.</div>
          </div>
          <div class="contact-faq" onclick="toggleFAQ(this)">
            <div class="faq-q">üìä My performance data disappeared <span class="faq-arr">‚Ä∫</span></div>
            <div class="faq-a">Performance data is stored locally on your device. Clearing your browser cache or switching devices will reset it. We're working on cloud sync!</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ========== RESULT ========== -->
<div id="pg-result" class="pg">
  <div style="font-size:48px;margin-bottom:16px" id="remo">üéâ</div>
  <div class="res-circle">
    <div class="res-pct" id="rpct">0%</div>
    <div class="res-frac" id="rfrac">0/0</div>
  </div>
  <div style="font-family:'Playfair Display',serif;font-size:22px;margin-bottom:8px" id="rmsg">Well done!</div>
  <div style="color:var(--mt);font-size:14px;margin-bottom:6px" id="rsub">2025 ‚Äî Paper 1</div>
  <div style="margin-bottom:20px" id="rmode-badge"></div>
  <div class="al al-warn" id="rwarn" style="display:none;max-width:300px">üîí Free limit reached. Enter a Pro code for unlimited access!</div>
  <!-- Exam Mode: Review Answers CTA -->
  <button class="btn" id="rreviewbtn" style="width:100%;max-width:300px;margin-bottom:12px;background:#EFF6FF;color:#1D4ED8;border:2px solid #BFDBFE;display:none" onclick="go('exam-review')">üìã Review All Answers</button>
  <button class="btn" style="width:100%;max-width:300px;margin-bottom:12px;background:linear-gradient(135deg,var(--goldd),var(--gold));color:var(--gd);font-weight:700" onclick="showQuizCertificate()">üèÖ Share Certificate</button>
  <button class="btn btn-green" style="width:100%;max-width:300px;margin-bottom:12px" onclick="go('main',true)">Back to Question Bank</button>
  <button class="btn btn-gold" style="width:100%;max-width:300px;display:none" id="rprobtn" onclick="go('payment')">üí≥ Upgrade to Pro</button>
</div>

<!-- ========== EXAM REVIEW PAGE ========== -->
<div id="pg-exam-review" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('result',true)">‚Üê</button>
      <div>
        <div class="bar-title">Answer Review</div>
        <div class="bar-sub" id="exam-review-sub">See all answers & explanations</div>
      </div>
    </div>
    <div id="exam-review-body" style="padding-bottom:40px"></div>
  </div>
</div>

<!-- ========== ADMIN LOGIN (separate page) ========== -->
<div id="pg-admin-login" class="pg">
  <div style="font-size:64px;margin-bottom:16px">üõ°Ô∏è</div>
  <div style="font-family:'Playfair Display',serif;font-size:28px;color:#fff;margin-bottom:6px">Admin Portal</div>
  <div style="color:rgba(255,255,255,.5);font-size:13px;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:40px">NursePrep Management</div>
  <div style="width:100%;max-width:320px;text-align:left">
    <div class="fg">
      <label class="fl" style="color:rgba(255,255,255,.7)">Username</label>
      <div class="iw"><span class="il">üë§</span>
        <input type="text" id="adm-user" class="pl" placeholder="Enter username" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2);color:#fff" oninput="ce('adm-err')" onkeydown="if(event.key==='Enter')doAdminLogin()">
      </div>
    </div>
    <div class="fg">
      <label class="fl" style="color:rgba(255,255,255,.7)">Password</label>
      <div class="iw"><span class="il">üîí</span>
        <input type="password" id="adm-pw" class="pl" placeholder="Enter password" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2);color:#fff" oninput="ce('adm-err')" onkeydown="if(event.key==='Enter')doAdminLogin()">
      </div>
    </div>
    <div style="color:var(--red);font-size:13px;min-height:20px;margin-bottom:10px" id="adm-err"></div>
    <button class="btn btn-gold" style="width:100%" id="adm-login-btn" onclick="doAdminLogin()">Access Admin Panel ‚Üí</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:10px;border-color:rgba(255,255,255,.2)" onclick="go('splash',true)">‚Üê Back</button>
  </div>
</div>

<!-- ========== ADMIN DASHBOARD (separate page) ========== -->
<div id="pg-admin" class="pg">
  <div class="adm-bar">
    <div>
      <div class="adm-bar-title">Admin Panel ‚öôÔ∏è</div>
      <div class="adm-bar-sub">NursePrep Management System</div>
    </div>
    <span class="adm-badge">ADMIN</span>
  </div>
  <div style="display:flex;gap:8px;padding:12px 16px;background:#fff;border-bottom:1px solid var(--bd);overflow-x:auto">
    <button class="fchip on" id="atab-codes" onclick="switchAdminTab('codes',this)" style="white-space:nowrap">üîë Pro Codes</button>
    <button class="fchip" id="atab-upload" onclick="switchAdminTab('upload',this)" style="white-space:nowrap">üì§ Upload Q's</button>
    <button class="fchip" id="atab-csv" onclick="switchAdminTab('csv',this)" style="white-space:nowrap">üìä CSV Import</button>
    <button class="fchip" id="atab-view" onclick="switchAdminTab('view',this)" style="white-space:nowrap">‚úèÔ∏è Edit Q's</button>
    <button class="fchip" id="atab-mock" onclick="switchAdminTab('mock',this)" style="white-space:nowrap">üè• Mock Exam</button>
    <button class="fchip" id="atab-analytics" onclick="switchAdminTab('analytics',this)" style="white-space:nowrap">üìà Analytics</button>
    <button class="fchip" id="atab-students" onclick="switchAdminTab('students',this)" style="white-space:nowrap">üë• Students</button>
    <button class="fchip" id="atab-chat" onclick="switchAdminTab('chat',this)" style="white-space:nowrap">üí¨ Group Chat</button>
    <button class="fchip" id="atab-years" onclick="switchAdminTab('years',this)" style="white-space:nowrap">üìÖ Years</button>
  </div>
  <div class="adm-body">

    <!-- CODES TAB -->
    <div id="admtab-codes">
      <div class="adcard">
        <div class="adtitle">üîë Generate Pro Access Code</div>
        <div class="fg">
          <label class="fl">Number of Codes</label>
          <input type="number" id="gen-qty" value="1" min="1" max="50" placeholder="e.g. 5">
        </div>
        <div class="fg">
          <label class="fl">Expiry</label>
          <select id="gen-exp">
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90">90 days</option>
            <option value="180">6 months</option>
            <option value="365">1 year</option>
          </select>
        </div>
        <button class="btn btn-green" style="width:100%" onclick="generateCodes()">Generate Codes ‚úì</button>
        <div id="gen-msg" style="margin-top:10px"></div>
      </div>
      <div class="adcard">
        <div class="adtitle">üìã All Pro Codes <span id="codes-count" style="font-size:12px;color:var(--mt);font-weight:400"></span></div>
        <div id="codes-list"><p style="color:var(--mt);font-size:14px">No codes generated yet.</p></div>
      </div>
    </div>

    <!-- UPLOAD TAB -->
    <div id="admtab-upload" style="display:none">
      <div class="adcard">
        <div class="adtitle">üì§ Import Questions</div>
        <div class="fg">
          <label class="fl">Year</label>
          <select id="ay"><option>2025</option></select>
        </div>
        <div class="fg">
          <label class="fl">Paper</label>
          <select id="ap"><option>Paper 1</option><option>Paper 2</option><option>OSCE</option></select>
        </div>
        <div class="fg">
          <label class="fl">Upload a Document (.txt / .doc content)</label>
          <input type="file" id="qfile" accept=".txt,.doc,.docx,.pdf,.text" onchange="handleFileUpload(this)" style="padding:10px">
        </div>
        <div style="text-align:center;color:var(--mt);font-size:13px;margin:8px 0">‚Äî or paste text below ‚Äî</div>
        <div class="fg">
          <label class="fl">Paste Questions Here</label>
          <textarea class="parse-area" id="qpaste" placeholder="Paste questions in any format, e.g:&#10;&#10;1. A nurse is administering insulin. What should she check first?&#10;A) Blood pressure  B) Blood glucose  C) Temperature  D) Weight&#10;Answer: B&#10;Explanation: Blood glucose must be checked before insulin...&#10;&#10;2. Normal adult heart rate is:&#10;A) 40-60 bpm  B) 60-100 bpm  C) 100-120 bpm  D) 50-90 bpm&#10;Answer: B"></textarea>
        </div>
        <div class="fg">
          <label class="fl">Paste Answer Key (Optional - if not in questions)</label>
          <textarea class="parse-area" id="answer-paste" rows="6" placeholder="Paste answers in any format:&#10;&#10;1.A, 2.B, 3.C, 4.D&#10;or&#10;A B C D A B&#10;or&#10;A, B, C, D&#10;or&#10;A&#10;B&#10;C&#10;D"></textarea>
          <div class="hint">üí° Auto-detects: numbered (1.A), space-separated (A B C), comma-separated (A,B,C), or line-by-line</div>
        </div>
        <button class="btn btn-green" style="width:100%;margin-bottom:10px" onclick="parseAndPreview()">üîç Parse &amp; Preview</button>
        <div id="parse-preview" style="display:none">
          <div class="parsed-preview" id="parse-result"></div>
          <button class="btn btn-gold" style="width:100%;margin-top:10px" onclick="confirmImport()">‚úÖ Confirm &amp; Import All</button>
          <button class="btn btn-grey" style="width:100%;margin-top:8px" onclick="cancelImport()">Cancel</button>
        </div>
        <div id="import-msg" style="margin-top:10px"></div>
      </div>
      <div class="adcard">
        <div class="adtitle">üìù Add Single Question</div>
        <div class="fg"><label class="fl">Question</label><textarea id="aq" rows="3" style="resize:vertical" placeholder="Type the question..."></textarea></div>
        <div class="fg"><label class="fl">Option A</label><input type="text" id="aa" placeholder="Option A"></div>
        <div class="fg"><label class="fl">Option B</label><input type="text" id="ab" placeholder="Option B"></div>
        <div class="fg"><label class="fl">Option C</label><input type="text" id="ac" placeholder="Option C"></div>
        <div class="fg"><label class="fl">Option D</label><input type="text" id="ad" placeholder="Option D"></div>
        <div class="fg"><label class="fl">Correct Answer</label><select id="acor"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select></div>
        <div class="fg"><label class="fl">Explanation</label><textarea id="aexp" rows="3" style="resize:vertical" placeholder="Explain the correct answer..."></textarea></div>
        <button class="btn btn-green" style="width:100%" onclick="addQ()">Add Question ‚úì</button>
        <div id="amsg" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- VIEW / EDIT QUESTIONS TAB -->
    <div id="admtab-view" style="display:none">
      <div class="adcard">
        <div class="adtitle">‚úèÔ∏è Edit Questions</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="fg">
            <label class="fl">Filter Year</label>
            <select id="vq-yr" onchange="renderAdminQView()">
              <option value="all">All Years</option>
            </select>
          </div>
          <div class="fg">
            <label class="fl">Filter Paper</label>
            <select id="vq-paper" onchange="renderAdminQView()">
              <option value="all">All Papers</option>
              <option>Paper 1</option><option>Paper 2</option><option>OSCE</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
          <input type="text" id="vq-search" placeholder="üîç Search questions..." oninput="renderAdminQView()" style="flex:1;min-width:150px;font-size:13px">
          <select id="vq-status" onchange="renderAdminQView()" style="font-size:12px;padding:10px 12px">
            <option value="all">All Status</option>
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
          </select>
        </div>
        <div id="vq-summary" style="font-size:13px;color:var(--mt);margin-bottom:12px"></div>
        <div id="vq-list"></div>
      </div>
    </div>

    <!-- MOCK EXAM ADMIN TAB -->
    <div id="admtab-mock" style="display:none">
      <div class="adcard">
        <div class="adtitle">üè• NMCN Mock Exam Settings</div>
        <div class="mock-admin-stats">
          <div class="mock-admin-stat"><div class="mock-admin-stat-num" id="adm-mock-qcount">0</div><div class="mock-admin-stat-lbl">Questions</div></div>
          <div class="mock-admin-stat"><div class="mock-admin-stat-num" id="adm-mock-attempts">0</div><div class="mock-admin-stat-lbl">Attempts</div></div>
          <div class="mock-admin-stat"><div class="mock-admin-stat-num" id="adm-mock-passrate">‚Äî</div><div class="mock-admin-stat-lbl">Pass Rate</div></div>
        </div>
        <div class="fg">
          <label class="fl">Mock Exam Title</label>
          <input type="text" id="mock-title-inp" value="NMCN Mock Exam 2025" placeholder="e.g. NMCN Mock Exam 2025">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="fg">
            <label class="fl">Time Limit (minutes)</label>
            <input type="number" id="mock-time-inp" value="120" min="30" max="300">
          </div>
          <div class="fg">
            <label class="fl">Pass Mark (%)</label>
            <input type="number" id="mock-pass-inp" value="50" min="1" max="100">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="fg">
            <label class="fl">Max Questions</label>
            <input type="number" id="mock-maxq-inp" value="250" min="10" max="500">
          </div>
          <div class="fg" style="display:flex;flex-direction:column;justify-content:flex-end">
            <label class="fl">Require Pro?</label>
            <select id="mock-pro-inp"><option value="yes">Yes (Pro only)</option><option value="no">No (All users)</option></select>
          </div>
        </div>
        <button class="btn btn-green" style="width:100%;margin-bottom:8px" onclick="saveMockSettingsFn()">üíæ Save Settings</button>
        <div id="mock-settings-msg" style="margin-top:8px"></div>
      </div>

      <!-- Rotation Schedule Card -->
      <div class="adcard" id="mock-rotation-admin-card">
        <div class="adtitle">üîÑ Auto-Rotation Schedule</div>
        <div id="mock-rotation-status-adm" style="margin-bottom:14px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <div class="fg" style="margin-bottom:0">
            <label class="fl">Rotation Interval</label>
            <select id="mock-rotation-interval">
              <option value="0">Manual only (no auto-rotate)</option>
              <option value="12">Every 12 hours</option>
              <option value="24" selected>Every 24 hours</option>
              <option value="48">Every 48 hours</option>
              <option value="72">Every 72 hours</option>
              <option value="168">Weekly</option>
            </select>
          </div>
          <div class="fg" style="margin-bottom:0">
            <label class="fl">Active Banks</label>
            <div style="padding:13px 16px;border:1.5px solid var(--bd);border-radius:10px;font-weight:700;color:var(--g)" id="adm-bank-count">0 banks</div>
          </div>
        </div>
        <div class="fg" style="margin-bottom:12px">
          <label class="fl">Set Next Update Time (optional)</label>
          <input type="datetime-local" id="mock-next-update-time" class="mock-sched-next-input" style="color-scheme:dark">
          <div class="hint" style="color:rgba(255,255,255,.4);margin-top:4px">Leave blank to use interval only. Setting a specific time overrides the interval for the next rotation.</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <button class="btn btn-green" style="padding:13px" onclick="saveRotationSettings()">üíæ Save Schedule</button>
          <button class="btn" style="background:#EFF6FF;color:#1D4ED8;border:1.5px solid #BFDBFE;font-size:14px;padding:13px" onclick="adminManualRotate()">üîÑ Rotate Now</button>
        </div>
        <div id="rotation-msg" style="margin-top:10px"></div>
      </div>

      <div class="adcard">
        <div class="adtitle">üì§ Upload New Mock Exam Bank</div>
        <div class="al al-warn" style="margin-bottom:14px;font-size:13px">
          <strong>üìã Versioning:</strong> Each upload creates a new bank version. The previous bank is archived and students' attempts against it are preserved. Auto-rotation cycles through banks on schedule.
        </div>
        <div class="fg">
          <label class="fl">Bank Title / Label</label>
          <input type="text" id="mock-bank-title-inp" placeholder="e.g. Mock Exam ‚Äî February 2026" style="font-weight:600">
        </div>
        <div class="fg">
          <label class="fl">Upload File (.txt / .doc content)</label>
          <input type="file" id="mock-qfile" accept=".txt,.doc,.docx,.pdf,.text" onchange="handleMockFileUpload(this)" style="padding:10px">
        </div>
        <div style="text-align:center;color:var(--mt);font-size:13px;margin:8px 0">‚Äî or paste text below ‚Äî</div>
        <div class="fg">
          <label class="fl">Paste Mock Questions Here</label>
          <textarea class="parse-area" id="mock-qpaste" style="min-height:160px" placeholder="1. A patient presents with chest pain radiating to the left arm. What is the priority nursing action?&#10;A) Administer aspirin  B) Obtain ECG  C) Call the doctor  D) Check blood pressure&#10;Answer: B&#10;Explanation: An ECG should be obtained immediately to rule out MI...&#10;&#10;2. Normal SpO2 range is:&#10;A) 85‚Äì90%  B) 90‚Äì94%  C) 95‚Äì100%  D) 80‚Äì85%&#10;Answer: C"></textarea>
        </div>
        <div class="fg">
          <label class="fl">Paste Answer Key (Optional)</label>
          <textarea class="parse-area" id="mock-answer-paste" rows="4" placeholder="1.A, 2.B, 3.C ...  or  A B C D A B ..."></textarea>
        </div>
        <button class="btn btn-green" style="width:100%;margin-bottom:8px" onclick="parseMockAndPreview()">üîç Parse &amp; Preview</button>
        <div id="mock-parse-preview" style="display:none">
          <div class="parsed-preview" id="mock-parse-result"></div>
          <button class="btn btn-gold" style="width:100%;margin-top:10px" onclick="confirmMockImport()">‚úÖ Publish as New Bank Version</button>
          <button class="btn btn-grey" style="width:100%;margin-top:8px" onclick="cancelMockImport()">Cancel</button>
        </div>
        <div id="mock-import-msg" style="margin-top:10px"></div>
      </div>

      <div class="adcard">
        <div class="adtitle">üóÉÔ∏è Bank Archive <span id="bank-archive-count" style="font-size:12px;color:var(--mt);font-weight:400"></span></div>
        <div id="bank-archive-list"><p style="color:var(--mt);font-size:14px">No banks uploaded yet.</p></div>
      </div>

      <div class="adcard">
        <div class="adtitle">üìä Recent Mock Attempts</div>
        <div id="adm-mock-attempts-list"><p style="color:var(--mt);font-size:14px">No attempts recorded yet.</p></div>
      </div>
    </div>

    <!-- STUDENTS TAB -->
    <div id="admtab-students" style="display:none">
      <div class="adcard">
        <div class="adtitle">üë• Registered Students <span id="adm-student-count" style="font-size:12px;color:var(--mt);font-weight:400"></span></div>
        <div class="fg" style="margin-bottom:12px">
          <input type="text" id="student-search" placeholder="üîç Search by name, username..." oninput="updateAdminSt()" style="font-size:13px">
        </div>
        <div id="stlist"><p style="color:var(--mt);font-size:14px">No students registered yet.</p></div>
      </div>
    </div>

    <!-- CHAT TAB -->
    <div id="admtab-chat" style="display:none;padding:0">
      <div class="chat-wrap" style="height:calc(100vh - 180px)">
        <div class="chat-hdr">
          <div class="chav">ADMIN</div>
          <div><div class="ch-title">Admin Group Chat Access</div><div class="ch-sub">üü¢ Monitor & participate in student discussions</div></div>
        </div>
        <div class="msgs" id="admin-msgs"></div>
        <div class="chat-bar">
          <button class="micbtn" onclick="toast('üéô Voice notes ‚Äî connect backend to enable')">üéô</button>
          <input class="chat-inp" id="admin-chat-inp" placeholder="Send message as Admin..." onkeydown="if(event.key==='Enter')sendAdminMsg()">
          <button class="sendbtn" onclick="sendAdminMsg()">‚Üë</button>
        </div>
      </div>
    </div>

    <!-- CSV IMPORT TAB -->
    <div id="admtab-csv" style="display:none">
      <div class="adcard">
        <div class="adtitle">üìä Bulk CSV Import</div>
        <div class="al al-warn" style="margin-bottom:14px;font-size:13px">
          <strong>üìã CSV Format:</strong> question, option_a, option_b, option_c, option_d, correct_answer (A/B/C/D), explanation (optional)
        </div>
        <button class="csv-template-btn" onclick="downloadCSVTemplate()">‚¨áÔ∏è Download CSV Template</button>
        <div style="margin-top:16px">
          <div class="fg">
            <label class="fl">Year</label>
            <select id="csv-ay"><option>2025</option></select>
          </div>
          <div class="fg">
            <label class="fl">Paper</label>
            <select id="csv-ap"><option>Paper 1</option><option>Paper 2</option><option>OSCE</option></select>
          </div>
        </div>
        <div class="csv-drop-area" id="csv-drop-area" onclick="document.getElementById('csv-file').click()" ondragover="csvDragOver(event)" ondragleave="csvDragLeave(event)" ondrop="csvDrop(event)">
          <div class="csv-drop-ico">üìÇ</div>
          <div class="csv-drop-title">Drop CSV file here or click to upload</div>
          <div class="csv-drop-sub">Supports .csv files ¬∑ Max 1000 rows</div>
        </div>
        <input type="file" id="csv-file" accept=".csv" style="display:none" onchange="handleCSVUpload(this)">
        <div id="csv-preview-area" style="display:none;margin-top:16px">
          <div style="font-weight:700;font-size:13px;color:var(--gd);margin-bottom:8px" id="csv-preview-title"></div>
          <div style="overflow-x:auto;border-radius:10px;border:1.5px solid var(--bd)">
            <table class="csv-preview-table" id="csv-preview-table"></table>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn-gold" style="flex:1" onclick="confirmCSVImport()">‚úÖ Import All</button>
            <button class="btn btn-grey" style="flex:1" onclick="cancelCSVImport()">Cancel</button>
          </div>
        </div>
        <div id="csv-msg" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="admtab-analytics" style="display:none">

      <!-- KEY METRICS OVERVIEW -->
      <div class="adm-stats-grid" id="adm-analytics-summary"></div>

      <!-- ACTIVE USERS BREAKDOWN -->
      <div class="adcard">
        <div class="adtitle">üü¢ User Activity</div>
        <div id="adm-active-users"></div>
      </div>

      <!-- REVENUE TRACKING -->
      <div class="adcard">
        <div class="adtitle">üí∞ Revenue Tracking</div>
        <div class="rev-grid">
          <div class="rev-card">
            <div class="rev-num" id="rev-total">‚Ç¶0</div>
            <div class="rev-lbl">Total Revenue (est.)</div>
          </div>
          <div class="rev-card gold">
            <div class="rev-num" id="rev-monthly">‚Ç¶0</div>
            <div class="rev-lbl">This Month (est.)</div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--mt);margin-bottom:10px">Revenue by Plan</div>
        <div id="rev-breakdown"></div>
        <div style="margin-top:14px">
          <div style="font-size:11px;color:var(--mt);margin-bottom:6px">Pro Activation Trend (Last 8 Weeks)</div>
          <div class="rev-mini-chart" id="rev-mini-chart"></div>
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--mt);margin-top:4px" id="rev-chart-labels"></div>
        </div>
        <div class="hint" style="margin-top:10px">üí° Estimates based on plan prices and Pro code activations. Connect Paystack or Flutterwave for live billing data.</div>
      </div>

      <!-- MOST FAILED QUESTIONS -->
      <div class="adcard">
        <div class="adtitle">üî¥ Most Failed Questions <span style="font-size:11px;font-weight:400;color:var(--mt)">Top 10</span></div>
        <div class="insight-alert">
          <span class="insight-alert-ico">üí°</span>
          <span>These questions have the lowest correct-answer rates. Review for accuracy or improve their explanations.</span>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:12px">
          <select id="fail-yr-filter" onchange="renderMostFailed()" style="font-size:12px;padding:8px 10px;flex:1">
            <option value="all">All Years</option>
          </select>
          <select id="fail-paper-filter" onchange="renderMostFailed()" style="font-size:12px;padding:8px 10px;flex:1">
            <option value="all">All Papers</option>
            <option>Paper 1</option><option>Paper 2</option><option>OSCE</option>
          </select>
        </div>
        <div id="adm-most-failed"><p style="color:var(--mt);font-size:14px">No quiz attempts recorded yet.</p></div>
      </div>

      <!-- Questions per year breakdown -->
      <div class="adcard">
        <div class="adtitle">üìÖ Questions by Year & Paper</div>
        <div id="adm-year-analytics" class="analytics-year-grid"></div>
      </div>

      <!-- Student performance by year -->
      <div class="adcard">
        <div class="adtitle">üéØ Student Performance by Year</div>
        <div id="adm-perf-by-year"></div>
      </div>

      <!-- Top scorers -->
      <div class="adcard">
        <div class="adtitle">üèÜ Top Performers</div>
        <div id="adm-top-scorers"></div>
      </div>

    <!-- YEARS MANAGEMENT TAB -->
    <div id="admtab-years" style="display:none">

      <!-- Add New Year -->
      <div class="adcard">
        <div class="adtitle">üìÖ Add New Exam Year</div>
        <p style="font-size:13px;color:var(--mt);margin-bottom:14px">Create a year slot that students and admins can upload questions into.</p>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div class="fg" style="flex:1;min-width:120px;margin-bottom:0">
            <label class="fl">Year (e.g. 2026)</label>
            <input type="number" id="new-year-input" placeholder="e.g. 2026" min="2000" max="2099" style="font-size:18px;font-weight:700;text-align:center">
          </div>
          <button class="btn btn-green" style="max-width:140px;padding:13px" onclick="adminAddYear()">+ Add Year</button>
        </div>
        <div class="err-field" id="new-year-err" style="margin-top:8px"></div>
        <div id="new-year-msg" style="margin-top:8px"></div>
      </div>

      <!-- Papers management per year -->
      <div class="adcard">
        <div class="adtitle">üìã Manage Papers per Year</div>
        <p style="font-size:13px;color:var(--mt);margin-bottom:14px">Add custom paper names or remove unused papers from any year.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <div class="fg" style="flex:1;min-width:110px;margin-bottom:0">
            <label class="fl">Select Year</label>
            <select id="paper-mgmt-yr" onchange="renderPaperMgmt()">
              <option value="">‚Äî Select ‚Äî</option>
            </select>
          </div>
          <div class="fg" style="flex:2;min-width:120px;margin-bottom:0">
            <label class="fl">New Paper Name</label>
            <input type="text" id="new-paper-input" placeholder="e.g. OSCE 2, Clinical" maxlength="30">
          </div>
          <button class="btn btn-gold" style="max-width:110px;padding:13px;align-self:flex-end" onclick="adminAddPaper()">+ Paper</button>
        </div>
        <div id="paper-mgmt-list"></div>
      </div>

      <!-- All years overview -->
      <div class="adcard">
        <div class="adtitle">üóìÔ∏è All Years <span id="years-count" style="font-size:12px;color:var(--mt);font-weight:400"></span></div>
        <div id="years-mgmt-list">
          <p style="color:var(--mt);font-size:14px">No years in the database yet.</p>
        </div>
      </div>

    </div>

    </div>

  </div>
  <div style="padding:16px;border-top:1px solid var(--bd);background:#fff">
    <button class="btn btn-red" style="width:100%;max-width:200px;margin:0 auto;font-size:14px;padding:12px" onclick="doAdminLogout()">üö™ Log Out Admin</button>
  </div>
</div>

<!-- ========== MOCK EXAM LOBBY ========== -->
<div id="pg-mock-lobby" class="pg">
  <div style="min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(160deg,#0D1117,#1E1B4B)">
    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08)">
      <button class="bk" onclick="go('main',true)" style="background:rgba(255,255,255,.1);color:#fff">‚Üê</button>
      <div><div style="font-family:'Playfair Display',serif;font-size:18px;color:#fff">NMCN Mock Exam</div><div style="font-size:12px;color:rgba(255,255,255,.5)">Read carefully before starting ¬∑ NMCN</div></div>
    </div>
    <div style="padding:24px 20px;flex:1;overflow-y:auto">

      <div style="text-align:center;margin-bottom:28px">
        <div style="font-size:64px;margin-bottom:12px">üè•</div>
        <div style="font-family:'Playfair Display',serif;font-size:24px;color:#fff;margin-bottom:6px" id="mock-lobby-title">NMCN Mock Exam</div>
        <div style="font-size:13px;color:rgba(255,255,255,.5)" id="mock-lobby-subtitle">Full simulation ¬∑ Real CBT conditions</div>
      </div>

      <!-- Exam info cards -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;text-align:center">
          <div style="font-size:28px;margin-bottom:4px">üìã</div>
          <div style="font-family:'Playfair Display',serif;font-size:22px;color:#C4B5FD" id="mock-lobby-qcount">250</div>
          <div style="font-size:11px;color:rgba(255,255,255,.5)">Questions</div>
        </div>
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;text-align:center">
          <div style="font-size:28px;margin-bottom:4px">‚è±</div>
          <div style="font-family:'Playfair Display',serif;font-size:22px;color:#34D399" id="mock-lobby-time">120 min</div>
          <div style="font-size:11px;color:rgba(255,255,255,.5)">Time Limit</div>
        </div>
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;text-align:center">
          <div style="font-size:28px;margin-bottom:4px">‚úÖ</div>
          <div style="font-family:'Playfair Display',serif;font-size:22px;color:#FBBF24" id="mock-lobby-pass">50%</div>
          <div style="font-size:11px;color:rgba(255,255,255,.5)">Pass Mark</div>
        </div>
        <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;text-align:center">
          <div style="font-size:28px;margin-bottom:4px">üéØ</div>
          <div style="font-family:'Playfair Display',serif;font-size:22px;color:#F9FAFB">MCQ</div>
          <div style="font-size:11px;color:rgba(255,255,255,.5)">Format</div>
        </div>
      </div>

      <!-- Rules -->
      <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin-bottom:20px">
        <div style="font-size:13px;font-weight:700;color:#C4B5FD;margin-bottom:12px;letter-spacing:.5px">üìú EXAM RULES</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;gap:10px;font-size:13px;color:rgba(255,255,255,.7);line-height:1.5"><span>‚è±</span><span>Timer starts immediately when you click Start. The exam auto-submits when time runs out.</span></div>
          <div style="display:flex;gap:10px;font-size:13px;color:rgba(255,255,255,.7);line-height:1.5"><span>üîï</span><span>No explanations shown during the exam. Full answer review available after submission.</span></div>
          <div style="display:flex;gap:10px;font-size:13px;color:rgba(255,255,255,.7);line-height:1.5"><span>üî¢</span><span>You can navigate freely between questions using the number palette at the top.</span></div>
          <div style="display:flex;gap:10px;font-size:13px;color:rgba(255,255,255,.7);line-height:1.5"><span>üö©</span><span>Flag questions for review with the flag button. Come back to them before submitting.</span></div>
          <div style="display:flex;gap:10px;font-size:13px;color:rgba(255,255,255,.7);line-height:1.5"><span>‚ö†Ô∏è</span><span>Once submitted, you cannot change your answers. Submit only when ready.</span></div>
          <div style="display:flex;gap:10px;font-size:13px;color:rgba(255,255,255,.7);line-height:1.5"><span>üì±</span><span>Do not close this tab during the exam. Progress is saved locally.</span></div>
        </div>
      </div>

      <!-- üÜï New exam banner (shown after rotation) -->
      <div id="mock-new-banner" style="display:none" class="mock-update-banner">
        <div class="mock-update-dot"></div>
        <div class="mock-update-txt"><span class="mock-new-badge">üÜï NEW</span><br><strong style="color:#fff">Exam updated!</strong> A fresh question set is now live. Good luck!</div>
      </div>

      <!-- Rotation schedule info -->
      <div id="mock-schedule-display" class="mock-schedule-card" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.4);letter-spacing:1px">üìÖ EXAM SCHEDULE</div>
          <div id="lobby-rotation-pill"></div>
        </div>
        <div class="mock-schedule-row">
          <span class="mock-schedule-lbl">Current Version</span>
          <span class="mock-schedule-val" id="lobby-bank-version">‚Äî</span>
        </div>
        <div class="mock-schedule-row">
          <span class="mock-schedule-lbl">Questions</span>
          <span class="mock-schedule-val" id="lobby-bank-qcount">‚Äî</span>
        </div>
        <div class="mock-schedule-row" id="lobby-next-rotation-row" style="display:none">
          <span class="mock-schedule-lbl">Next update</span>
          <span class="mock-schedule-val"><span id="lobby-next-rotation-date" style="font-size:11px;color:rgba(255,255,255,.5);display:block"></span><span id="lobby-next-rotation" style="color:#FBBF24">‚Äî</span></span>
        </div>
        <div class="rotation-timer-bar" id="lobby-timer-bar-wrap" style="margin-top:8px;display:none"><div class="rotation-timer-fill" id="lobby-rotation-bar" style="width:100%"></div></div>
      </div>

      <div id="mock-lobby-locked" style="display:none">
        <div class="al al-warn" style="margin-bottom:16px">üîí NMCN Mock Exam requires <strong>Pro access</strong>. Enter your Pro code to unlock.</div>
        <button class="btn btn-gold" style="width:100%;margin-bottom:12px" onclick="go('payment')">üí≥ Upgrade to Pro</button>
      </div>

      <div id="mock-lobby-start">
        <div id="mock-lobby-noq" style="display:none">
          <div class="al al-err" style="margin-bottom:16px">‚ö†Ô∏è No mock exam questions uploaded yet. Ask your admin to upload the question bank.</div>
        </div>
        <button class="btn" id="mock-start-btn" onclick="startMockExam()" style="width:100%;background:linear-gradient(135deg,#4338CA,#7C3AED);color:#fff;font-size:16px;padding:17px">üè• Start Mock Exam</button>
        <div id="mock-last-attempt" style="margin-top:12px;font-size:12px;color:rgba(255,255,255,.4);text-align:center"></div>
      </div>

      <!-- Past Exam History -->
      <div id="mock-lobby-history-wrap" class="prev-exams-section" style="display:none">
        <div class="prev-exams-hd">
          <span>üóÇÔ∏è YOUR EXAM HISTORY</span>
          <span id="mock-hist-total-badge" style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.5);font-size:11px;padding:2px 8px;border-radius:20px;font-weight:600;letter-spacing:0"></span>
        </div>
        <div id="mock-lobby-history-list"></div>
      </div>

    </div>
  </div>
</div>

<!-- ========== MOCK EXAM IN PROGRESS ========== -->
<div id="pg-mock" class="pg">
  <!-- Timer bar fill -->
  <div class="mock-timer-bar" style="width:100%"><div id="mock-timer-fill" class="mock-timer-fill" style="width:100%"></div></div>

  <!-- Top bar -->
  <div class="mock-topbar">
    <div class="mock-topbar-title" id="mock-topbar-title">NMCN Mock Exam</div>
    <div class="mock-timer" id="mock-timer-display">
      <span class="mock-timer-ico">‚è±</span>
      <span class="mock-timer-val" id="mock-timer-val">2:00:00</span>
    </div>
  </div>

  <!-- Question palette -->
  <div class="mock-palette-wrap">
    <div class="mock-palette-label">Questions <span id="mock-answered-count" style="color:#34D399">0</span>/<span id="mock-total-count">250</span> answered ¬∑ <span id="mock-flagged-count" style="color:#FCD34D">0</span> flagged</div>
    <div class="mock-palette" id="mock-palette"></div>
  </div>

  <!-- Question body -->
  <div class="mock-body" id="mock-body">
    <div class="mock-qnum">
      <span id="mock-qnum-lbl">QUESTION 1 OF 250</span>
      <button class="mock-flag-btn" id="mock-flag-btn" onclick="toggleMockFlag()">üö© Flag</button>
    </div>
    <div class="mock-qtxt" id="mock-qtxt"></div>
    <div class="mock-opts" id="mock-opts"></div>
  </div>

  <!-- Bottom nav -->
  <div class="mock-navbar">
    <button class="mock-navbtn mock-prev" id="mock-prev-btn" onclick="mockNav(-1)" disabled>‚Üê Prev</button>
    <button class="mock-navbtn mock-next" id="mock-next-btn" onclick="mockNav(1)">Next ‚Üí</button>
    <button class="mock-submit-btn" onclick="promptMockSubmit()">Submit Exam</button>
  </div>

  <!-- Submit confirm overlay -->
  <div id="mock-submit-overlay" class="mock-overlay" style="display:none">
    <div class="mock-overlay-card">
      <div class="mock-overlay-title">Submit Exam?</div>
      <div class="mock-overlay-sub" id="mock-submit-msg">Make sure you've answered all questions before submitting.</div>
      <div id="mock-submit-stats" style="margin-bottom:20px"></div>
      <button class="btn btn-green" style="width:100%;margin-bottom:10px" onclick="submitMockExam()">‚úÖ Yes, Submit Now</button>
      <button class="btn btn-grey" style="width:100%" onclick="document.getElementById('mock-submit-overlay').style.display='none'">‚Üê Go Back &amp; Review</button>
    </div>
  </div>
</div>

<!-- ========== MOCK RESULT ========== -->
<div id="pg-mock-result" class="pg">
  <div style="flex:1;overflow-y:auto;padding-bottom:40px">
    <!-- Certificate -->
    <div class="mock-cert">
      <div class="mock-cert-title">NMCN Mock Exam</div>
      <div class="mock-cert-name" id="mock-res-name">Student Name</div>
      <div class="mock-score-ring" id="mock-score-ring">
        <svg viewBox="0 0 140 140"><circle cx="70" cy="70" r="60" fill="none" stroke="#1F2937" stroke-width="10"/><circle id="mock-res-circle" cx="70" cy="70" r="60" fill="none" stroke="#34D399" stroke-width="10" stroke-linecap="round" stroke-dasharray="377" stroke-dashoffset="377"/></svg>
        <div class="mock-score-pct" id="mock-res-pct" style="color:#34D399">0%</div>
        <div class="mock-score-lbl">Score</div>
      </div>
      <div class="mock-verdict" id="mock-res-verdict" style="color:#34D399">PASS</div>
      <div class="mock-verdict-sub" id="mock-res-verdict-sub">Congratulations! You passed the mock exam.</div>
    </div>

    <!-- Stats grid -->
    <div class="mock-breakdown-grid">
      <div class="mock-stat-card"><div class="mock-stat-card-num" id="mock-res-correct" style="color:#34D399">0</div><div class="mock-stat-card-lbl">Correct</div></div>
      <div class="mock-stat-card"><div class="mock-stat-card-num" id="mock-res-wrong" style="color:#F87171">0</div><div class="mock-stat-card-lbl">Wrong</div></div>
      <div class="mock-stat-card"><div class="mock-stat-card-num" id="mock-res-unanswered" style="color:#FBBF24">0</div><div class="mock-stat-card-lbl">Unanswered</div></div>
      <div class="mock-stat-card"><div class="mock-stat-card-num" id="mock-res-time" style="color:#C4B5FD">‚Äî</div><div class="mock-stat-card-lbl">Time Used</div></div>
    </div>

    <!-- Pass mark note -->
    <div style="margin:0 16px 14px;background:#111827;border:1.5px solid #1F2937;border-radius:14px;padding:14px;font-size:13px;color:#9CA3AF;line-height:1.7" id="mock-res-note"></div>

    <!-- Action buttons -->
    <div style="padding:0 16px;display:flex;flex-direction:column;gap:10px">
      <button class="btn" style="width:100%;background:linear-gradient(135deg,#1E1B4B,#312E81);color:#C4B5FD;border:1.5px solid #312E81" onclick="go('mock-answer-review')">üìã Review All Answers</button>
      <button class="btn" style="width:100%;background:linear-gradient(135deg,var(--goldd),var(--gold));color:var(--gd)" onclick="showMockCertificate()">üèÖ Share Certificate</button>
      <button class="btn btn-green" style="width:100%" onclick="go('main',true)">Back to Home</button>
    </div>
  </div>
</div>

<!-- ========== MOCK ANSWER REVIEW ========== -->
<div id="pg-mock-answer-review" class="pg">
  <div style="min-height:100vh;background:#0D1117;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #1F2937;position:sticky;top:0;background:#0D1117;z-index:10">
      <button class="bk" onclick="go('mock-result',true)" style="background:#1F2937;color:#9CA3AF">‚Üê</button>
      <div><div style="font-family:'Playfair Display',serif;font-size:17px;color:#F9FAFB">Answer Review</div><div style="font-size:12px;color:#6B7280" id="mock-ar-sub">All questions</div></div>
    </div>
    <!-- Filter chips -->
    <div style="display:flex;gap:6px;padding:12px 16px;background:#111827;border-bottom:1px solid #1F2937;overflow-x:auto">
      <button class="fchip on" onclick="filterMockReview('all',this)" style="background:#374151;color:#D1D5DB;border-color:#4B5563;font-size:12px">All</button>
      <button class="fchip" onclick="filterMockReview('wrong',this)" style="background:#1F2937;color:#F87171;border-color:#EF4444;font-size:12px">‚úó Wrong</button>
      <button class="fchip" onclick="filterMockReview('correct',this)" style="background:#1F2937;color:#34D399;border-color:#059669;font-size:12px">‚úì Correct</button>
      <button class="fchip" onclick="filterMockReview('unanswered',this)" style="background:#1F2937;color:#FBBF24;border-color:#D97706;font-size:12px">‚Äî Unanswered</button>
      <button class="fchip" onclick="filterMockReview('flagged',this)" style="background:#1F2937;color:#FCD34D;border-color:#D97706;font-size:12px">üö© Flagged</button>
    </div>
    <div id="mock-answer-review-body" style="flex:1;overflow-y:auto;padding:12px 16px 40px"></div>
  </div>
</div>

<!-- ========== PAYWALL ========== -->
<div id="pw-overlay" onclick="if(event.target===this)hidePW()">
  <div class="pw-card">
    <div class="pw-ico">üîê</div>
    <div class="pw-ttl">Unlock Full Access</div>
    <div class="pw-sub">Enter your Pro code to access all years, all papers, and unlimited questions.</div>
    <div class="pbox"><div class="pamt">Pro Code</div><div class="pdesc">Papers 1 &amp; 2 + OSCE ¬∑ 2018‚Äì2025 ¬∑ Daily Updates</div></div>
    <div class="al al-err" id="pw-err" style="display:none"></div>
    <div class="crow">
      <input type="text" id="pw-inp" placeholder="e.g. NP-XXXX-XXXX" style="flex:1" onkeydown="if(event.key==='Enter')applyCode()">
      <button class="btn btn-green" style="padding:12px 16px;font-size:14px;max-width:90px;min-width:75px" onclick="applyCode()">Apply</button>
    </div>
    <button class="btn btn-grey" style="width:100%;margin-top:12px" onclick="hidePW()">Maybe Later</button>
  </div>
</div>

<!-- ========== REFERRAL PAGE ========== -->
<div id="pg-referral" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar" style="background:transparent;border-bottom:none;position:absolute;z-index:10">
      <button class="bk" onclick="go('main',true)" style="background:rgba(255,255,255,.2);color:#fff">‚Üê</button>
    </div>

    <!-- Hero -->
    <div class="ref-hero">
      <span class="ref-hero-ico">üéÅ</span>
      <div class="ref-hero-title">Invite & Earn Rewards</div>
      <div class="ref-hero-sub">Share your code with classmates.<br>You both win when they join NursePrep.</div>
    </div>

    <div style="padding:16px 16px 80px">

      <!-- Progress + counter -->
      <div class="ref-progress-card">
        <div class="ref-progress-title">Your Referral Progress</div>

        <!-- Big counter -->
        <div class="ref-counter-row">
          <div class="ref-counter-left">
            <div class="ref-counter-num" id="ref-count-display">0</div>
            <div class="ref-counter-lbl">Friends joined</div>
          </div>
          <div class="ref-counter-right">
            <div class="ref-counter-next" id="ref-next-label">3 more needed</div>
            <div class="ref-counter-next-lbl">for next reward</div>
          </div>
        </div>

        <!-- Milestone steps -->
        <div class="ref-milestones" id="ref-milestones"></div>
      </div>

      <!-- Referral code -->
      <div class="ref-code-box" onclick="copyRefCode()" id="ref-code-box">
        <div class="ref-code-label">Your Referral Code</div>
        <div class="ref-code-value" id="ref-code-display">NP-XXXX</div>
        <div class="ref-code-tap">üìã Tap to copy</div>
        <div class="ref-code-copied" id="ref-code-copied">‚úÖ Copied to clipboard!</div>
      </div>

      <!-- Share buttons -->
      <div class="ref-share-grid">
        <button class="ref-share-btn primary" onclick="shareRefLink()">üîó Share My Referral Link</button>
        <button class="ref-share-btn" onclick="shareWhatsApp()">üí¨ WhatsApp</button>
        <button class="ref-share-btn" onclick="shareSMS()">üì± SMS</button>
      </div>

      <!-- How it works -->
      <div class="adcard" style="margin-bottom:14px">
        <div class="adtitle">üí° How It Works</div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="width:28px;height:28px;border-radius:50%;background:var(--g);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0">1</div>
            <div><div style="font-weight:700;font-size:14px;color:var(--tx)">Share your unique code</div><div style="font-size:12px;color:var(--mt);margin-top:2px">Your code is uniquely tied to your account.</div></div>
          </div>
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="width:28px;height:28px;border-radius:50%;background:var(--g);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0">2</div>
            <div><div style="font-weight:700;font-size:14px;color:var(--tx)">Friend registers with your code</div><div style="font-size:12px;color:var(--mt);margin-top:2px">They enter it during sign-up. You both get credit.</div></div>
          </div>
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="width:28px;height:28px;border-radius:50%;background:var(--gold);color:var(--gd);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0">3</div>
            <div><div style="font-weight:700;font-size:14px;color:var(--tx)">Unlock milestone rewards</div><div style="font-size:12px;color:var(--mt);margin-top:2px">Hit 3, 5, or 10 referrals to earn extra access.</div></div>
          </div>
        </div>
      </div>

      <!-- Referrals list -->
      <div class="adcard">
        <div class="adtitle">üë• Your Referrals <span id="ref-list-count" style="font-size:12px;color:var(--mt);font-weight:400"></span></div>
        <div id="ref-list-body">
          <div class="empty-state"><div class="empty-state-ico">ü§ù</div><div>No referrals yet.<br><span style="font-size:12px">Share your code to get started!</span></div></div>
        </div>
      </div>

      <!-- Demo: simulate referrals (visible in demo mode) -->
      <div style="margin-top:8px;text-align:center">
        <button onclick="simulateReferral()" style="background:none;border:1px dashed var(--bd);color:var(--mt);font-size:12px;padding:8px 16px;border-radius:20px;cursor:pointer;font-family:'DM Sans'">üß™ Simulate a Referral (Demo)</button>
      </div>

    </div>
  </div>
</div>

<!-- Reward unlocked overlay -->
<div id="ref-reward-overlay" class="ref-reward-overlay" onclick="closeRewardOverlay()">
  <div class="ref-reward-card" onclick="event.stopPropagation()">
    <span class="ref-reward-ico" id="ref-reward-ico">üéâ</span>
    <div class="ref-reward-title" id="ref-reward-title">Reward Unlocked!</div>
    <div class="ref-reward-desc" id="ref-reward-desc">You've earned a reward for your referrals.</div>
    <button class="btn btn-green" style="width:100%" onclick="closeRewardOverlay()">üéâ Awesome, Thanks!</button>
  </div>
</div>

<!-- ========== EDIT QUESTION MODAL ========== -->
<div id="edit-modal" class="edit-modal-overlay" onclick="if(event.target===this)closeEditModal()">
  <div class="edit-modal-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="edit-modal-title">‚úèÔ∏è Edit Question</div>
      <button onclick="closeEditModal()" style="background:var(--bg);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px">‚úï</button>
    </div>
    <input type="hidden" id="edit-yr"><input type="hidden" id="edit-paper"><input type="hidden" id="edit-idx">
    <div class="fg"><label class="fl">Question</label><textarea id="edit-q" rows="3" style="resize:vertical"></textarea></div>
    <div class="fg"><label class="fl">Option A</label><input type="text" id="edit-a"></div>
    <div class="fg"><label class="fl">Option B</label><input type="text" id="edit-b"></div>
    <div class="fg"><label class="fl">Option C</label><input type="text" id="edit-c"></div>
    <div class="fg"><label class="fl">Option D</label><input type="text" id="edit-d"></div>
    <div class="fg"><label class="fl">Correct Answer</label>
      <select id="edit-cor"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select>
    </div>
    <div class="fg"><label class="fl">Explanation</label><textarea id="edit-exp" rows="3" style="resize:vertical"></textarea></div>
    <button class="btn btn-green" style="width:100%" onclick="saveEditQ()">üíæ Save Changes</button>
    <div id="edit-msg" style="margin-top:10px"></div>
  </div>
</div>

<!-- ========== QUIZ LOADING OVERLAY ========== -->
<div id="quiz-loading-overlay">
  <div class="loading-pulse" id="loading-emoji">ü©∫</div>
  <div class="loading-title" id="loading-title">Preparing Your Quiz</div>
  <div class="loading-sub" id="loading-sub">Loading questions...</div>
  <div class="loading-bar-wrap"><div class="loading-bar-fill" id="loading-bar"></div></div>
  <div class="loading-facts" id="loading-fact"></div>
</div>

<!-- ========== REPORT QUESTION MODAL ========== -->
<div id="report-modal-overlay" onclick="if(event.target===this)closeReportModal()">
  <div class="report-modal-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div class="report-modal-title">‚öë Report Question</div>
      <button onclick="closeReportModal()" style="background:var(--bg);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;color:var(--mt)">‚úï</button>
    </div>
    <div class="report-modal-sub">Help us improve! What's wrong with this question?</div>
    <div class="report-options" id="report-options">
      <div class="report-opt" onclick="selectReport(this,'Wrong answer key')"><div class="report-opt-ico">‚ùå</div><div class="report-opt-lbl">Wrong answer key</div></div>
      <div class="report-opt" onclick="selectReport(this,'Typo or spelling error')"><div class="report-opt-ico">üìù</div><div class="report-opt-lbl">Typo or spelling error</div></div>
      <div class="report-opt" onclick="selectReport(this,'Unclear question')"><div class="report-opt-ico">‚ùì</div><div class="report-opt-lbl">Unclear or ambiguous question</div></div>
      <div class="report-opt" onclick="selectReport(this,'Incorrect explanation')"><div class="report-opt-ico">üí°</div><div class="report-opt-lbl">Incorrect explanation</div></div>
      <div class="report-opt" onclick="selectReport(this,'Duplicate question')"><div class="report-opt-ico">üîÅ</div><div class="report-opt-lbl">Duplicate question</div></div>
    </div>
    <button class="btn btn-red" style="width:100%;margin-bottom:10px" id="report-submit-btn" onclick="submitReport()" disabled>Submit Report</button>
    <button class="btn btn-grey" style="width:100%" onclick="closeReportModal()">Cancel</button>
  </div>
</div>

<!-- ========== CERTIFICATE OVERLAY ========== -->
<div id="cert-overlay" onclick="if(event.target===this)closeCertificate()">
  <div class="cert-card" id="cert-card">
    <div class="cert-logo">Nurse<b>Prep</b></div>
    <div class="cert-tagline">NMCN Exam Prep ¬∑ Nigeria</div>
    <div class="cert-divider"></div>
    <div class="cert-title">CERTIFICATE OF COMPLETION</div>
    <div class="cert-name" id="cert-name">Student Name</div>
    <div class="cert-pct" id="cert-pct" style="color:#34D399">0%</div>
    <div class="cert-verdict" id="cert-verdict" style="color:#34D399">PASS</div>
    <div class="cert-paper" id="cert-paper">2025 ‚Äî Paper 1</div>
    <div class="cert-divider"></div>
    <div class="cert-stats">
      <div class="cert-stat"><div class="cert-stat-num" id="cert-correct">0</div><div class="cert-stat-lbl">Correct</div></div>
      <div class="cert-stat"><div class="cert-stat-num" id="cert-total">0</div><div class="cert-stat-lbl">Total</div></div>
      <div class="cert-stat"><div class="cert-stat-num" id="cert-mode">‚Äî</div><div class="cert-stat-lbl">Mode</div></div>
    </div>
    <div class="cert-date" id="cert-date">‚Äî</div>
  </div>
  <div class="cert-actions">
    <button class="btn btn-gold" style="width:100%;max-width:380px" onclick="shareCertificate()">üì§ Share Result</button>
    <button class="btn" style="width:100%;max-width:380px;background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.2)" onclick="closeCertificate()">‚úï Close</button>
  </div>
</div>

<!-- ========== BOOKMARKS PAGE ========== -->
<div id="pg-bookmarks" class="pg">
  <div class="auth-wrap">
    <div class="auth-bar">
      <button class="bk" onclick="go('main',true)">‚Üê</button>
      <div><div class="bar-title">üîñ Bookmarks</div><div class="bar-sub" id="bm-count-sub">Saved questions</div></div>
    </div>
    <div class="auth-body">
      <div id="bm-list-body">
        <div class="empty-state"><div class="empty-state-ico">üîñ</div><div style="font-size:14px">No bookmarks yet.<br><span style="font-size:12px">Tap üîñ on any quiz question to save it.</span></div></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== BOOKMARK TOAST ========== -->
<div class="bookmark-toast" id="bm-toast"></div>

</div><!-- #app -->
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// =========================================================
// CONSTANTS
// =========================================================
var ADMIN_USER = 'admin 123';
var ADMIN_PASS = 'admin123';
var FREE_LIM = 10;

// =========================================================
// STATE
// =========================================================
var accounts = [];
var ME = null;
var isPro = false;
var agreed = false;
var photoB64 = null;
var curStep = 1;
var activeFilter = 'all';
var generatedCodes = []; // [{code, expiry, usedBy, deviceId}]
var parsedQBuffer = []; // temp buffer for parsed questions
var _curPage = null;

// Quiz state
var QQ = [], QI = 0, QScore = 0, QYear = '', QPaper = '', QAnsed = false, QSessAns = 0;
var QMode = 'review'; // 'review' | 'exam'
var QAnswers = []; // [{chosen, correct}] ‚Äî for exam mode review
var QPendingYear = '', QPendingPaper = ''; // for mode selector

// =========================================================
// MOCK EXAM STATE
// =========================================================
var MOCK_DB = []; // question bank ‚Äî array of {q,o,c,e}
var mockSettings = { title:'NMCN Mock Exam 2025', timeLimit:120, passMark:50, maxQ:250, requirePro:'yes' };
var mockParsedBuffer = [];
var mockHistory = []; // [{date, score, total, pct, timeTaken, passed}]

// Active exam state
var MX = {
  active: false,
  questions: [],       // shuffled slice of MOCK_DB
  answers: [],         // chosen index or -1 for unanswered
  flags: [],           // boolean per question
  currentQ: 0,
  totalSecs: 0,        // countdown in seconds
  startTime: null,
  timerInterval: null
};

// Performance tracking
var quizHistory = []; // [{year, paper, score, total, date, percentage}]
var notificationSettings = {chat: true, admin: true, questions: true};
var notifications = []; // [{type, message, date, read}]

// =========================================================
// DEVICE ID (fingerprint-based, stable per device)
// =========================================================
function getDeviceId() {
  try {
    var stored = localStorage.getItem('np_device_id');
    if (stored) return stored;
  } catch(e){}
  // Generate a fingerprint from browser properties
  var nav = window.navigator;
  var raw = [
    nav.userAgent,
    nav.language,
    nav.hardwareConcurrency || '',
    screen.width + 'x' + screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset(),
    nav.platform || ''
  ].join('|');
  // Simple hash
  var hash = 0;
  for (var i = 0; i < raw.length; i++) {
    hash = ((hash << 5) - hash) + raw.charCodeAt(i);
    hash = hash & hash;
  }
  var id = 'dev_' + Math.abs(hash).toString(36) + '_' + Date.now().toString(36);
  try { localStorage.setItem('np_device_id', id); } catch(e){}
  return id;
}
var DEVICE_ID = getDeviceId();

// =========================================================
// QUESTION DATABASE ‚Äî starts empty, admin uploads all questions
// =========================================================
var DB = {};

var defaultMsgs = [
  {sender:"Abena Mensah",init:"AM",txt:"Has anyone studied ECG interpretation? I'm struggling üòì",t:"9:00 AM",me:false},
  {sender:"Kwame Asante",init:"KA",voice:true,dur:"0:47",t:"9:05 AM",me:false},
  {sender:"Fatima Ibrahim",init:"FI",txt:"My exam is in 2 weeks. Where do I start?",t:"9:15 AM",me:false},
  {sender:"Dr. Prep (Admin)",init:"DP",txt:"üì¢ New OSCE questions from 2025 just uploaded! Check the question bank. Good luck! ü©∫",t:"9:30 AM",me:false}
];
var chatLog = defaultMsgs.slice();

// =========================================================
// STORAGE
// =========================================================
function saveAcc() { try { localStorage.setItem('np_acc', JSON.stringify(accounts)); } catch(x){} }
function loadAcc() { try { var d=localStorage.getItem('np_acc'); if(d) accounts=JSON.parse(d); } catch(x){} }
function saveCodes() { try { localStorage.setItem('np_codes', JSON.stringify(generatedCodes)); } catch(x){} }
function loadCodes() { try { var d=localStorage.getItem('np_codes'); if(d) generatedCodes=JSON.parse(d); } catch(x){} }
function saveDB() { try { localStorage.setItem('np_db', JSON.stringify(DB)); } catch(x){} }
function loadDB() { try { var d=localStorage.getItem('np_db'); if(d) DB=JSON.parse(d); } catch(x){} }
function savePerformance() { try { localStorage.setItem('np_perf', JSON.stringify(quizHistory)); } catch(x){} }
function loadPerformance() { try { var d=localStorage.getItem('np_perf'); if(d) quizHistory=JSON.parse(d); } catch(x){} }
function saveNotifSettings() { try { localStorage.setItem('np_notif_settings', JSON.stringify(notificationSettings)); } catch(x){} }
function loadNotifSettings() { try { var d=localStorage.getItem('np_notif_settings'); if(d) notificationSettings=JSON.parse(d); else notificationSettings={chat:true,admin:true,questions:true}; } catch(x){} }
function saveNotifications() { try { localStorage.setItem('np_notifs', JSON.stringify(notifications)); } catch(x){} }
function loadNotifications() { try { var d=localStorage.getItem('np_notifs'); if(d) notifications=JSON.parse(d); } catch(x){} }
function saveStreak() {
  // Streak is derived from quizHistory dates ‚Äî no extra storage needed
  // Just ensure the lastPractice date is logged
  try { localStorage.setItem('np_last_practice', new Date().toDateString()); } catch(x){}
}
function saveMockDB() { try { localStorage.setItem('np_mockdb', JSON.stringify(MOCK_DB)); } catch(x){} }
function loadMockDB() { try { var d=localStorage.getItem('np_mockdb'); if(d) MOCK_DB=JSON.parse(d); } catch(x){} }
function saveMockSettings() { try { localStorage.setItem('np_mocksettings', JSON.stringify(mockSettings)); } catch(x){} }
function loadMockSettings() { try { var d=localStorage.getItem('np_mocksettings'); if(d) mockSettings=JSON.parse(d); } catch(x){} }
function saveMockHistory() { try { localStorage.setItem('np_mockhistory', JSON.stringify(mockHistory)); } catch(x){} }
function loadMockHistory() { try { var d=localStorage.getItem('np_mockhistory'); if(d) mockHistory=JSON.parse(d); } catch(x){} }

// =========================================================
// NAVIGATION
// =========================================================
function go(page, isBack) {
  var nextId = 'pg-' + page;
  var nextEl = document.getElementById(nextId);
  if (!nextEl) return;
  var prevEl = _curPage ? document.getElementById('pg-' + _curPage) : null;
  if (isBack === undefined) {
    isBack = (page === 'splash' || page === 'login') && _curPage !== 'splash';
  }
  nextEl.style.display = 'block';
  nextEl.style.transition = 'none';
  nextEl.style.transform = isBack ? 'translateX(-100%)' : 'translateX(100%)';
  nextEl.style.opacity = '0';
  nextEl.style.position = 'absolute';
  nextEl.style.top = '0'; nextEl.style.left = '0'; nextEl.style.width = '100%';
  nextEl.getBoundingClientRect();
  nextEl.style.transition = 'transform .35s cubic-bezier(.4,0,.2,1), opacity .35s';
  nextEl.style.transform = 'translateX(0)'; nextEl.style.opacity = '1';
  if (prevEl) {
    prevEl.style.transition = 'transform .35s cubic-bezier(.4,0,.2,1), opacity .35s';
    prevEl.style.transform = isBack ? 'translateX(100%)' : 'translateX(-35%)';
    prevEl.style.opacity = '0'; prevEl.style.position = 'absolute';
  }
  setTimeout(function () {
    document.querySelectorAll('.pg').forEach(function (p) {
      if (p.id !== nextId) {
        p.style.display = 'none'; p.style.transform = ''; p.style.opacity = '';
        p.style.transition = ''; p.style.position = ''; p.classList.remove('on');
      }
    });
    nextEl.style.position = 'relative'; nextEl.style.transform = '';
    nextEl.style.opacity = ''; nextEl.style.transition = ''; nextEl.classList.add('on');
  }, 370);
  _curPage = page;
  if (page === 'main') { renderYGrid(); renderMsgs(); updateHomeUI(); updateProfUI(); updateMockHomeCard(); updateContinueCard(); }
  if (page === 'login') {
    // Restore saved credentials
    try {
      var saved = localStorage.getItem('np_saved_creds');
      if(saved) {
        var creds = JSON.parse(saved);
        var leEl = document.getElementById('le');
        var lpEl = document.getElementById('lp');
        var rmEl = document.getElementById('remember-me');
        if(leEl) leEl.value = creds.u || '';
        if(lpEl) lpEl.value = creds.p || '';
        if(rmEl) rmEl.checked = true;
      }
    } catch(x){}
  }
  if (page === 'register') { resetReg(); goStep(1); }
  if (page === 'admin') { renderCodesTab(); updateAdminSt(); }
  if (page === 'performance') { renderPerformance(); }
  if (page === 'notifications') { renderNotifications(); }
  if (page === 'contact-admin') { prepContactPage(); }
  if (page === 'payment') { prepPaymentPage(); }
  if (page === 'exam-review') { renderExamReview(); }
  if (page === 'mock-lobby') { renderMockLobby(); }
  if (page === 'mock-answer-review') { renderMockAnswerReview('all'); }
  if (page === 'admin') { renderCodesTab(); updateAdminSt(); renderAdminAnalytics(); renderAdminMockTab(); populateYearDropdowns(); renderYearsTab(); }
  if (page === 'referral') { renderReferralPage(); }
  if (page === 'bookmarks') { renderBookmarks(); }
}

function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('on'); });
  document.querySelectorAll('.ni').forEach(function(n){ n.classList.remove('on'); });
  document.getElementById('tab-'+name).classList.add('on');
  el.classList.add('on');
  if(name==='chat'){ renderMsgs(); setTimeout(function(){ var m=document.getElementById('msgs'); if(m) m.scrollTop=m.scrollHeight; },50); }
  if(name==='profile'){ updateProfUI(); }
  if(name==='questions'){ renderYGrid(); }
}

function switchAdminTab(name, el) {
  ['codes','upload','view','mock','students','chat','csv','analytics','years'].forEach(function(t){
    var d = document.getElementById('admtab-'+t);
    if(d) d.style.display = 'none';
    var b = document.getElementById('atab-'+t);
    if(b) b.classList.remove('on');
  });
  var target = document.getElementById('admtab-'+name);
  if(target) target.style.display = 'block';
  el.classList.add('on');
  if(name === 'students') updateAdminSt();
  if(name === 'codes') renderCodesTab();
  if(name === 'view') renderAdminQView();
  if(name === 'mock') renderAdminMockTab();
  if(name === 'analytics') renderAdminAnalytics();
  if(name === 'years'){ populateYearDropdowns(); renderYearsTab(); }
  if(name === 'chat') {
    renderAdminMsgs();
    setTimeout(function(){ 
      var m=document.getElementById('admin-msgs'); 
      if(m) m.scrollTop=m.scrollHeight; 
    }, 50);
  }
}

// =========================================================
// ADMIN AUTH
// =========================================================
function doAdminLogin() {
  var u = (document.getElementById('adm-user').value || '').trim().toLowerCase();
  var p = (document.getElementById('adm-pw').value || '').trim();
  var err = document.getElementById('adm-err');
  var btn = document.getElementById('adm-login-btn');
  if (!u || !p) { err.textContent = '‚ö† Please enter both username and password.'; return; }
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Verifying...';
  setTimeout(function(){
    btn.disabled = false; btn.textContent = 'Access Admin Panel ‚Üí';
    if (u === ADMIN_USER.toLowerCase() && p === ADMIN_PASS) {
      document.getElementById('adm-user').value = '';
      document.getElementById('adm-pw').value = '';
      go('admin');
    } else {
      err.textContent = '‚ö† Invalid credentials. Access denied.';
    }
  }, 900);
}

function doAdminLogout() {
  if (!confirm('Log out of Admin Panel?')) return;
  go('splash', true);
}

// =========================================================
// PRO CODE GENERATION
// =========================================================
function generateCodeString() {
  var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  var part = function(len) {
    var s = '';
    for(var i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  };
  return 'NP-' + part(4) + '-' + part(4);
}

function generateCodes() {
  var qty = parseInt((document.getElementById('gen-qty')||{}).value||'1');
  var days = parseInt((document.getElementById('gen-exp')||{}).value||'30');
  if(isNaN(qty)||qty<1||qty>50){ toast('‚ö† Enter a number between 1 and 50'); return; }
  var expDate = new Date();
  expDate.setDate(expDate.getDate() + days);
  var newCodes = [];
  for(var i=0;i<qty;i++){
    var code;
    var attempts = 0;
    do { code = generateCodeString(); attempts++; } while(generatedCodes.some(function(c){ return c.code===code; }) && attempts<20);
    newCodes.push({
      code: code,
      created: new Date().toLocaleDateString('en-GB'),
      expiry: expDate.toLocaleDateString('en-GB'),
      expiryTs: expDate.getTime(),
      usedBy: null,
      deviceId: null
    });
  }
  generatedCodes = generatedCodes.concat(newCodes);
  saveCodes();
  renderCodesTab();
  var msg = document.getElementById('gen-msg');
  if(msg){
    msg.innerHTML = '<div class="al al-ok">‚úÖ ' + qty + ' code' + (qty>1?'s':'') + ' generated! Valid for ' + days + ' days.</div>';
    setTimeout(function(){ msg.innerHTML=''; }, 3000);
  }
}

function renderCodesTab() {
  var el = document.getElementById('codes-list');
  var ct = document.getElementById('codes-count');
  if(!el) return;
  if(ct) ct.textContent = '(' + generatedCodes.length + ' total)';
  if(generatedCodes.length === 0){ el.innerHTML='<p style="color:var(--mt);font-size:14px">No codes generated yet.</p>'; return; }
  var now = Date.now();
  el.innerHTML = generatedCodes.slice().reverse().map(function(c){
    var expired = c.expiryTs && now > c.expiryTs;
    var status = c.usedBy ? 'used' : expired ? 'expired' : 'active';
    var statusLabel = c.usedBy ? ('Used by '+c.usedBy) : expired ? 'Expired' : 'Active';
    var badge = '<span class="code-badge '+status+'">'+statusLabel+'</span>';
    return '<div class="code-item">' +
      '<div><div class="code-val">'+c.code+'</div><div class="code-meta">Created: '+c.created+' ¬∑ Expires: '+c.expiry+'</div></div>' +
      badge + '</div>';
  }).join('');
}

// =========================================================
// PRO CODE VALIDATION (device-locked)
// =========================================================
function applyCode() {
  var code = ((document.getElementById('pw-inp')||{}).value||'').trim().toUpperCase();
  validateCode(code, function(result){
    if(result === 'ok'){
      activatePro(code);
      hidePW(); updateHomeUI(); updateProfUI(); renderYGrid();
      toast('‚úÖ Pro code accepted! Full access unlocked!');
    } else {
      var pe = document.getElementById('pw-err');
      if(pe){ pe.style.display='block'; pe.textContent = result; }
    }
  });
}

function applyProfileCode() {
  var code = ((document.getElementById('pcode')||{}).value||'').trim().toUpperCase();
  validateCode(code, function(result){
    if(result === 'ok'){
      activatePro(code);
      var pc = document.getElementById('pcode'); if(pc) pc.value='';
      updateHomeUI(); updateProfUI(); renderYGrid();
      toast('‚úÖ Pro code accepted! Full access unlocked!');
    } else {
      se('pcode-err', result);
    }
  });
}

function validateCode(code, cb) {
  if(!code){ cb('‚ö† Please enter a code.'); return; }
  var match = null;
  for(var i=0;i<generatedCodes.length;i++){
    if(generatedCodes[i].code === code){ match = generatedCodes[i]; break; }
  }
  if(!match){ cb('‚ö† Invalid code. Please check and try again.'); return; }
  var now = Date.now();
  if(match.expiryTs && now > match.expiryTs){ cb('‚ö† This code has expired. Please contact your coordinator.'); return; }
  if(match.usedBy){
    // device-lock check
    if(match.deviceId !== DEVICE_ID){ cb('‚ö† This code has already been used on another device. Each code is device-locked.'); return; }
    // Already activated on this device ‚Äî allow re-login
  } else {
    // First use ‚Äî bind to this device
    match.deviceId = DEVICE_ID;
    match.usedBy = ME ? ME.name : 'Student';
    saveCodes();
  }
  cb('ok');
}

function activatePro(code) {
  isPro = true;
  if(ME){
    ME.isPro = true; ME.proCode = code; ME.proSince = ME.proSince || new Date().toISOString();
    for(var i=0;i<accounts.length;i++){ if(accounts[i].id===ME.id){ accounts[i].isPro=true; accounts[i].proCode=code; accounts[i].proSince = accounts[i].proSince || ME.proSince; break; } }
    saveAcc();
  }
}

function showPW() {
  var el=document.getElementById('pw-overlay'); if(el) el.classList.add('show');
  var pi=document.getElementById('pw-inp'); if(pi) pi.value='';
  var pe=document.getElementById('pw-err'); if(pe) pe.style.display='none';
}
function hidePW() { var el=document.getElementById('pw-overlay'); if(el) el.classList.remove('show'); }

// =========================================================
// QUESTION PARSING ENGINE
// =========================================================
// =========================================================
// PARSE ANSWER KEY
// =========================================================
function parseAnswerKey(text) {
  if(!text || !text.trim()) return [];
  text = text.trim();
  var answers = [];
  
  // Format 1: Numbered with periods or parentheses (1.A, 2.B or 1)A 2)B)
  var numberedMatch = text.match(/\d+[\.\)]\s*([A-Da-d])/gi);
  if(numberedMatch && numberedMatch.length > 0){
    numberedMatch.forEach(function(m){
      var letter = m.match(/[A-Da-d]/i);
      if(letter) answers.push(letter[0].toUpperCase());
    });
    return answers;
  }
  
  // Format 2: Comma-separated (A, B, C, D)
  if(text.includes(',')){
    var parts = text.split(',');
    parts.forEach(function(p){
      var letter = p.trim().match(/^[A-Da-d]$/i);
      if(letter) answers.push(letter[0].toUpperCase());
    });
    if(answers.length > 0) return answers;
  }
  
  // Format 3: Space-separated (A B C D)
  var spaceParts = text.split(/\s+/);
  var spaceAnswers = [];
  spaceParts.forEach(function(p){
    var letter = p.trim().match(/^[A-Da-d]$/i);
    if(letter) spaceAnswers.push(letter[0].toUpperCase());
  });
  if(spaceAnswers.length > 0) return spaceAnswers;
  
  // Format 4: One per line
  var lines = text.split('\n');
  lines.forEach(function(line){
    var letter = line.trim().match(/^[A-Da-d]$/i);
    if(letter) answers.push(letter[0].toUpperCase());
  });
  
  return answers;
}

// =========================================================
// PARSE QUESTIONS
// =========================================================
function parseQuestions(text, useAnswerKey) {
  var results = [];
  // Normalize line endings
  text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  // Split into question blocks ‚Äî look for numbered questions
  var blocks = text.split(/\n(?=\d+[\.\)]\s)/);
  blocks.forEach(function(block){
    block = block.trim();
    if(!block) return;
    // Extract question text (first line after number)
    var qMatch = block.match(/^\d+[\.\)]\s*(.+?)(?:\n|$)/);
    if(!qMatch) return;
    var qText = qMatch[1].trim();
    // Look for options ‚Äî support A) A. a) a. (A) [A] formats
    var optPat = /[A-Da-d][\.\)\]]\s*(.+?)(?=\n[A-Da-d][\.\)\]]|\nAns|\nAnswer|$)/gs;
    var opts = [];
    var m;
    var blockLower = block;
    while((m = optPat.exec(blockLower)) !== null){
      opts.push(m[1].trim().replace(/\n/g,' '));
    }
    if(opts.length < 2) return; // need at least 2 options
    
    // Find correct answer - ONLY if we're NOT using a separate answer key
    var correctIdx = 0;
    if(!useAnswerKey){
      var ansMatch = block.match(/(?:Ans(?:wer)?|Correct)[:\s]*([A-Da-d])/i);
      if(ansMatch){
        var letter = ansMatch[1].toUpperCase();
        correctIdx = ['A','B','C','D'].indexOf(letter);
        if(correctIdx < 0) correctIdx = 0;
      }
    }
    
    // Explanation
    var explMatch = block.match(/(?:Explanation|Reason|Note)[:\s]*(.+?)(?:\n\n|$)/is);
    var expl = explMatch ? explMatch[1].trim().replace(/\n/g,' ') : 'See study materials for details.';
    // Pad options to 4
    while(opts.length < 4) opts.push('‚Äî');
    opts = opts.slice(0,4);
    results.push({ q: qText, o: opts, c: correctIdx, e: expl });
  });
  return results;
}

function handleFileUpload(input) {
  var file = input.files && input.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(ev){
    var text = ev.target.result;
    var ta = document.getElementById('qpaste');
    if(ta) ta.value = text;
    toast('‚úÖ File loaded. Click Parse & Preview.');
  };
  reader.onerror = function(){ toast('‚ö† Could not read file.'); };
  reader.readAsText(file);
}

function parseAndPreview() {
  var text = (document.getElementById('qpaste')||{}).value || '';
  if(!text.trim()){ toast('‚ö† Please paste or upload questions first.'); return; }
  
  // Check if there's a separate answer key
  var answerText = (document.getElementById('answer-paste')||{}).value || '';
  var hasAnswerKey = answerText.trim().length > 0;
  
  // Parse questions - tell it whether to look for answers in the text or not
  parsedQBuffer = parseQuestions(text, hasAnswerKey);
  
  // If there's a separate answer key, apply it
  if(hasAnswerKey){
    var answerKey = parseAnswerKey(answerText);
    if(answerKey.length > 0){
      // Apply YOUR answer key to the questions
      parsedQBuffer.forEach(function(q, i){
        if(i < answerKey.length){
          var answerLetter = answerKey[i];
          var answerIdx = ['A','B','C','D'].indexOf(answerLetter);
          if(answerIdx >= 0){
            q.c = answerIdx; // Use YOUR answer, not auto-detected
            // Update explanation
            q.e = 'Correct answer is ' + answerLetter + '. ' + q.e;
          }
        }
      });
      
      // Show confirmation of how many answers were applied
      var msg = document.getElementById('import-msg');
      if(msg) msg.innerHTML = '<div class="al al-ok">‚úÖ Applied ' + Math.min(answerKey.length, parsedQBuffer.length) + ' answers from your answer key!</div>';
      setTimeout(function(){ if(msg) msg.innerHTML=''; }, 3000);
    } else {
      toast('‚ö† Could not parse answer key. Check format.');
    }
  }
  
  var prev = document.getElementById('parse-preview');
  var res = document.getElementById('parse-result');
  var msg = document.getElementById('import-msg');
  
  if(parsedQBuffer.length === 0){
    if(res) res.innerHTML = '<div class="al al-err">‚ö† Could not detect any questions. Make sure questions are numbered (1. 2. 3.) with options (A. B. C. D.).</div>';
    if(prev) prev.style.display = 'block';
    return;
  }
  if(res){
    res.innerHTML = '<div style="font-weight:700;color:var(--g);margin-bottom:10px">‚úÖ Found ' + parsedQBuffer.length + ' question(s):</div>' +
      parsedQBuffer.map(function(q,i){
        return '<div class="pq-item"><div class="pq-q">'+(i+1)+'. '+q.q+'</div><div class="pq-opts">' +
          q.o.map(function(opt,j){ return '<div class="pq-opt'+(j===q.c?' correct':'')+'">'+['A','B','C','D'][j]+'. '+opt+'</div>'; }).join('') +
          '</div><div style="font-size:12px;color:var(--g);font-weight:700;margin-top:6px">‚úì Answer: '+['A','B','C','D'][q.c]+'</div></div>';
      }).join('');
  }
  if(prev) prev.style.display = 'block';
}

function confirmImport() {
  var yr = (document.getElementById('ay')||{}).value || '2025';
  var paper = (document.getElementById('ap')||{}).value || 'Paper 1';
  if(parsedQBuffer.length === 0){ toast('‚ö† Nothing to import.'); return; }
  if(!DB[yr]) DB[yr] = {'Paper 1':[],'Paper 2':[],'OSCE':[]};
  if(!DB[yr][paper]) DB[yr][paper] = [];
  parsedQBuffer.forEach(function(q){ DB[yr][paper].push(q); });
  var count = parsedQBuffer.length;
  parsedQBuffer = [];
  saveDB();
  document.getElementById('qpaste').value = '';
  var answerPaste = document.getElementById('answer-paste');
  if(answerPaste) answerPaste.value = '';
  document.getElementById('parse-preview').style.display = 'none';
  document.getElementById('import-msg').innerHTML = '<div class="al al-ok">‚úÖ ' + count + ' questions imported to ' + yr + ' ' + paper + '!</div>';
  
  // Add notification for students
  addNotification('questions', count + ' new questions added to ' + yr + ' ' + paper + '!');
  
  renderYGrid();
  setTimeout(function(){ var m = document.getElementById('import-msg'); if(m) m.innerHTML=''; }, 4000);
}

function cancelImport() {
  parsedQBuffer = [];
  var prev = document.getElementById('parse-preview');
  if(prev) prev.style.display = 'none';
  var ta = document.getElementById('qpaste');
  if(ta) ta.value = '';
  var answerPaste = document.getElementById('answer-paste');
  if(answerPaste) answerPaste.value = '';
}

// =========================================================
// ADMIN ‚Äî ADD SINGLE QUESTION
// =========================================================
function addQ() {
  var q=g('aq').trim(),a=g('aa').trim(),b=g('ab').trim(),c=g('ac').trim(),d=g('ad').trim(),e=g('aexp').trim();
  var yr=g('ay'),paper=g('ap'),cor=parseInt(g('acor'));
  var msg=document.getElementById('amsg');
  if(!q||!a||!b||!c||!d||!e){ if(msg) msg.innerHTML='<div class="al al-err">‚ö† Please fill all fields.</div>'; return; }
  if(!DB[yr]) DB[yr]={'Paper 1':[],'Paper 2':[],'OSCE':[]};
  if(!DB[yr][paper]) DB[yr][paper]=[];
  DB[yr][paper].push({q:q,o:[a,b,c,d],c:cor,e:e});
  saveDB();
  if(msg) msg.innerHTML='<div class="al al-ok">‚úÖ Question added to '+yr+' '+paper+'!</div>';
  ['aq','aa','ab','ac','ad','aexp'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
  renderYGrid();
  setTimeout(function(){ if(msg) msg.innerHTML=''; }, 3000);
}

// =========================================================
// ADMIN ‚Äî STUDENTS LIST WITH PERFORMANCE TRACKING
// =========================================================
function updateAdminSt() {
  var el=document.getElementById('stlist'); if(!el) return;
  var searchEl = document.getElementById('student-search');
  var query = searchEl ? searchEl.value.toLowerCase() : '';
  var countEl = document.getElementById('adm-student-count');
  
  var filtered = accounts.filter(function(a){
    if(!query) return true;
    return (a.name||'').toLowerCase().includes(query) || (a.username||'').toLowerCase().includes(query) || (a.email||'').toLowerCase().includes(query);
  });
  
  if(countEl) countEl.textContent = '(' + filtered.length + ' of ' + accounts.length + ' students)';
  
  if(filtered.length === 0){
    el.innerHTML = query ? '<p style="color:var(--mt);font-size:14px;text-align:center;padding:20px">No students match your search.</p>' :
      '<p style="color:var(--mt);font-size:14px">No students registered yet.</p>';
    return;
  }
  
  el.innerHTML = filtered.map(function(a){
    var av=a.photo?('<img src="'+a.photo+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">'):initials(a.name);
    var proBadge=a.isPro?'background:rgba(34,197,94,.1);color:#15803d':'background:rgba(245,166,35,.15);color:var(--goldd)';
    var proLabel=a.isPro?'Pro':'Free';
    
    // Get this student's quiz performance from quizHistory (all users share local storage in demo)
    // In production, quizHistory would be per-user
    var totalAns = a.totalAns||0;
    var totalCor = a.totalCor||0;
    var avgScore = totalAns>0?Math.round(totalCor/totalAns*100)+'%':'‚Äî';
    
    return '<div class="user-perf-card">'+
      '<div class="user-perf-hd" onclick="toggleStudentPerf(\'sp-'+a.id+'\')">'+
        '<div class="sav-av">'+av+'</div>'+
        '<div style="flex:1">'+
          '<div style="font-weight:600;font-size:14px">'+a.name+'</div>'+
          '<div style="font-size:12px;color:var(--mt)">@'+(a.username||'‚Äî')+' ¬∑ '+a.yearLevel+'</div>'+
        '</div>'+
        '<div style="text-align:right;margin-right:8px">'+
          '<div style="font-size:13px;font-weight:700;color:var(--g)">'+avgScore+'</div>'+
          '<div style="font-size:10px;color:var(--mt)">avg score</div>'+
        '</div>'+
        '<span style="padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;'+proBadge+'">'+proLabel+'</span>'+
        '<span style="color:var(--mt);margin-left:6px">‚Ä∫</span>'+
      '</div>'+
      '<div id="sp-'+a.id+'" class="user-perf-body">'+
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">'+
          '<div style="background:var(--bg);border-radius:10px;padding:10px;text-align:center"><div style="font-family:Playfair Display,serif;font-size:18px;color:var(--g)">'+(totalAns||0)+'</div><div style="font-size:10px;color:var(--mt)">Answered</div></div>'+
          '<div style="background:var(--bg);border-radius:10px;padding:10px;text-align:center"><div style="font-family:Playfair Display,serif;font-size:18px;color:#15803d">'+(totalCor||0)+'</div><div style="font-size:10px;color:var(--mt)">Correct</div></div>'+
          '<div style="background:var(--bg);border-radius:10px;padding:10px;text-align:center"><div style="font-family:Playfair Display,serif;font-size:18px;color:var(--goldd)">'+avgScore+'</div><div style="font-size:10px;color:var(--mt)">Avg Score</div></div>'+
        '</div>'+
        '<div style="display:flex;gap:8px;flex-wrap:wrap">'+
          '<div style="font-size:12px;color:var(--mt)">üìß '+a.email+'</div>'+
          '<div style="font-size:12px;color:var(--mt)">üìû '+a.phone+'</div>'+
        '</div>'+
        '<div style="margin-top:8px;font-size:12px;color:var(--mt)">Joined: '+a.joined+'</div>'+
        (a.isPro && a.proCode ? '<div style="margin-top:6px;font-size:12px;color:var(--g)">üîë Code: <strong>'+a.proCode+'</strong></div>' : '')+
        '<div style="display:flex;gap:6px;margin-top:12px">'+
          '<button onclick="revokeProAccess(\''+a.id+'\')" style="padding:5px 12px;border-radius:8px;border:1.5px solid var(--red);color:var(--red);background:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:DM Sans;display:'+(a.isPro?'block':'none')+'">Revoke Pro</button>'+
          '<button onclick="grantProAccessUI(\''+a.id+'\')" style="padding:5px 12px;border-radius:8px;border:1.5px solid var(--g);color:var(--g);background:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:DM Sans;display:'+(a.isPro?'none':'block')+'">Grant Pro</button>'+
        '</div>'+
      '</div>'+
    '</div>';
  }).join('');
}

function toggleStudentPerf(id) {
  var el = document.getElementById(id);
  if(el) el.classList.toggle('open');
}

function revokeProAccess(userId) {
  if(!confirm('Revoke Pro access for this student?')) return;
  for(var i=0;i<accounts.length;i++){
    if(String(accounts[i].id)===String(userId)){
      accounts[i].isPro = false;
      if(ME && ME.id === accounts[i].id){ ME.isPro=false; isPro=false; }
      break;
    }
  }
  saveAcc();
  updateAdminSt();
  toast('‚úÖ Pro access revoked.');
}

function grantProAccessUI(userId) {
  for(var i=0;i<accounts.length;i++){
    if(String(accounts[i].id)===String(userId)){
      accounts[i].isPro = true;
      accounts[i].proCode = 'ADMIN-GRANT';
      break;
    }
  }
  saveAcc();
  updateAdminSt();
  toast('‚úÖ Pro access granted!');
}

// =========================================================
// ADMIN ‚Äî VIEW / EDIT QUESTIONS
// =========================================================
function renderAdminQView() {
  // Populate year filter
  var yrSel = document.getElementById('vq-yr');
  if(yrSel){
    var years = Object.keys(DB).sort(function(a,b){ return b-a; });
    var cur = yrSel.value || 'all';
    yrSel.innerHTML = '<option value="all">All Years</option>' +
      years.map(function(y){ return '<option value="'+y+'"'+(cur===y?' selected':'')+'>'+y+'</option>'; }).join('');
  }

  var filterYr = (document.getElementById('vq-yr')||{}).value || 'all';
  var filterPaper = (document.getElementById('vq-paper')||{}).value || 'all';
  var filterStatus = (document.getElementById('vq-status')||{}).value || 'all';
  var searchTerm = ((document.getElementById('vq-search')||{}).value||'').toLowerCase();

  var list = document.getElementById('vq-list');
  var summary = document.getElementById('vq-summary');
  if(!list) return;

  var total = 0, activeCount = 0, inactiveCount = 0;
  var html = '';

  var years = Object.keys(DB).sort(function(a,b){ return b-a; });
  years.forEach(function(yr){
    if(filterYr !== 'all' && yr !== filterYr) return;
    var papers = ['Paper 1','Paper 2','OSCE'];
    papers.forEach(function(paper){
      if(filterPaper !== 'all' && paper !== filterPaper) return;
      var qs = (DB[yr] && DB[yr][paper]) || [];
      if(qs.length === 0) return;
      
      var filtered = qs.map(function(q,qi){ return {q:q, qi:qi}; }).filter(function(item){
        var q = item.q;
        var isActive = q.active !== false;
        if(filterStatus === 'active' && !isActive) return false;
        if(filterStatus === 'inactive' && isActive) return false;
        if(searchTerm && !q.q.toLowerCase().includes(searchTerm) && !q.o.join(' ').toLowerCase().includes(searchTerm)) return false;
        return true;
      });
      
      if(filtered.length === 0) return;
      
      html += '<div style="margin-bottom:18px">';
      html += '<div style="font-weight:700;font-size:14px;color:var(--gd);padding:8px 12px;background:var(--bg);border-radius:8px;margin-bottom:8px">üìÖ '+yr+' ‚Äî '+paper+' <span style="color:var(--mt);font-weight:400;font-size:12px">('+filtered.length+' shown / '+qs.length+' total)</span></div>';
      
      filtered.forEach(function(item){
        var q = item.q, qi = item.qi;
        var letters = ['A','B','C','D'];
        var isActive = q.active !== false;
        if(isActive) activeCount++; else inactiveCount++;
        total++;
        
        html += '<div style="border:1.5px solid var(--bd);border-radius:12px;padding:14px;margin-bottom:8px;background:#fff'+(isActive?'':';opacity:.5')+'">' +
          '<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:10px">'+
            '<span style="color:var(--mt);font-size:12px;margin-right:2px;flex-shrink:0;padding-top:2px">Q'+(qi+1)+'.</span>'+
            '<div style="font-weight:600;font-size:14px;color:var(--tx);flex:1">'+q.q+'</div>'+
          '</div>'+
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">' +
          q.o.map(function(opt,oi){
            var isAns = oi === q.c;
            return '<div style="padding:6px 10px;border-radius:8px;font-size:13px;'+(isAns?'background:rgba(34,197,94,.12);border:1.5px solid rgba(34,197,94,.4);color:#15803d;font-weight:700':'background:var(--bg);border:1px solid var(--bd);color:var(--mt)') + '">' +
              '<span style="font-weight:700;margin-right:4px">'+letters[oi]+'.</span>' + opt +
              (isAns ? ' ‚úì' : '') + '</div>';
          }).join('') +
          '</div>' +
          (q.e ? '<div style="font-size:12px;color:var(--g);padding:8px 10px;background:rgba(10,110,78,.05);border-radius:8px;border-left:3px solid var(--g);margin-bottom:8px"><strong>Explanation:</strong> '+q.e+'</div>' : '') +
          '<div class="q-action-row">'+
            '<button class="q-action-btn q-action-edit" onclick="openEditQ(\''+yr+'\',\''+paper+'\','+qi+')">‚úèÔ∏è Edit</button>'+
            '<button class="q-action-btn" onclick="toggleQActive(\''+yr+'\',\''+paper+'\','+qi+')" style="border-color:'+(isActive?'#EF4444':'#10B981')+';color:'+(isActive?'#EF4444':'#10B981')+';background:#fff">'+(isActive?'‚äò Deactivate':'‚úì Activate')+'</button>'+
            '<button class="q-action-btn q-action-del" onclick="deleteQ(\''+yr+'\',\''+paper+'\','+qi+')">üóë Delete</button>'+
            '<span style="margin-left:auto;font-size:10px;font-weight:700;padding:3px 8px;border-radius:10px;'+(isActive?'background:rgba(34,197,94,.1);color:#15803d':'background:rgba(239,68,68,.08);color:#EF4444')+'">'+(isActive?'ACTIVE':'INACTIVE')+'</span>'+
          '</div>'+
        '</div>';
      });
      html += '</div>';
    });
  });

  if(html === ''){
    html = '<div style="text-align:center;padding:32px;color:var(--mt)"><div style="font-size:40px;margin-bottom:12px">üì≠</div><div style="font-size:14px">No questions found.<br>Try adjusting your filters.</div></div>';
  }

  list.innerHTML = html;
  if(summary) summary.textContent = 'Showing ' + total + ' question(s) ¬∑ ' + activeCount + ' active ¬∑ ' + inactiveCount + ' inactive';
}

function toggleQActive(yr, paper, idx) {
  if(DB[yr] && DB[yr][paper] && DB[yr][paper][idx] !== undefined){
    var q = DB[yr][paper][idx];
    q.active = q.active === false ? true : false;
    saveDB();
    renderAdminQView();
    renderYGrid();
    toast(q.active !== false ? '‚úÖ Question activated.' : '‚äò Question deactivated.');
  }
}

// =========================================================
// ADMIN ‚Äî EDIT QUESTION MODAL
// =========================================================
function openEditQ(yr, paper, idx) {
  var q = DB[yr] && DB[yr][paper] && DB[yr][paper][idx];
  if(!q) return;
  document.getElementById('edit-yr').value = yr;
  document.getElementById('edit-paper').value = paper;
  document.getElementById('edit-idx').value = idx;
  document.getElementById('edit-q').value = q.q || '';
  document.getElementById('edit-a').value = (q.o && q.o[0]) || '';
  document.getElementById('edit-b').value = (q.o && q.o[1]) || '';
  document.getElementById('edit-c').value = (q.o && q.o[2]) || '';
  document.getElementById('edit-d').value = (q.o && q.o[3]) || '';
  document.getElementById('edit-cor').value = q.c || 0;
  document.getElementById('edit-exp').value = q.e || '';
  document.getElementById('edit-msg').innerHTML = '';
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
}

function saveEditQ() {
  var yr = document.getElementById('edit-yr').value;
  var paper = document.getElementById('edit-paper').value;
  var idx = parseInt(document.getElementById('edit-idx').value);
  var q_txt = document.getElementById('edit-q').value.trim();
  var a = document.getElementById('edit-a').value.trim();
  var b = document.getElementById('edit-b').value.trim();
  var c = document.getElementById('edit-c').value.trim();
  var d = document.getElementById('edit-d').value.trim();
  var cor = parseInt(document.getElementById('edit-cor').value);
  var exp = document.getElementById('edit-exp').value.trim();
  var msg = document.getElementById('edit-msg');
  
  if(!q_txt||!a||!b||!c||!d){ if(msg) msg.innerHTML='<div class="al al-err">‚ö† Please fill in question and all 4 options.</div>'; return; }
  
  if(DB[yr] && DB[yr][paper] && DB[yr][paper][idx] !== undefined){
    var existing = DB[yr][paper][idx];
    DB[yr][paper][idx] = { q:q_txt, o:[a,b,c,d], c:cor, e:exp, active: existing.active !== false };
    saveDB();
    if(msg) msg.innerHTML='<div class="al al-ok">‚úÖ Question updated!</div>';
    renderAdminQView();
    renderYGrid();
    setTimeout(function(){ closeEditModal(); }, 1000);
  }
}

function deleteQ(yr, paper, idx) {
  if(!confirm('Delete this question?')) return;
  if(DB[yr] && DB[yr][paper]){
    DB[yr][paper].splice(idx, 1);
    saveDB();
    renderAdminQView();
    renderYGrid();
    toast('Question deleted.');
  }
}

// =========================================================
// ADMIN ‚Äî CSV BULK IMPORT
// =========================================================
var csvParsedBuffer = [];

function downloadCSVTemplate() {
  var csv = 'question,option_a,option_b,option_c,option_d,correct_answer,explanation\n' +
    '"A nurse is preparing to administer insulin. What should she check first?","Blood pressure","Blood glucose","Temperature","Weight","B","Blood glucose must always be checked before insulin administration to avoid hypoglycemia."\n' +
    '"Normal adult heart rate range is:","40-60 bpm","60-100 bpm","100-120 bpm","50-90 bpm","B","The normal adult resting heart rate is 60-100 beats per minute."\n';
  var blob = new Blob([csv], {type:'text/csv'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'nurseprep_questions_template.csv';
  a.click();
  toast('üìÑ Template downloaded!');
}

function csvDragOver(e) {
  e.preventDefault();
  document.getElementById('csv-drop-area').classList.add('drag-over');
}
function csvDragLeave(e) {
  document.getElementById('csv-drop-area').classList.remove('drag-over');
}
function csvDrop(e) {
  e.preventDefault();
  document.getElementById('csv-drop-area').classList.remove('drag-over');
  var file = e.dataTransfer.files && e.dataTransfer.files[0];
  if(file && file.name.endsWith('.csv')) processCSVFile(file);
  else toast('‚ö† Please drop a .csv file.');
}
function handleCSVUpload(input) {
  var file = input.files && input.files[0];
  if(!file) return;
  processCSVFile(file);
}
function processCSVFile(file) {
  var reader = new FileReader();
  reader.onload = function(ev){
    var text = ev.target.result;
    parseCSV(text);
  };
  reader.readAsText(file);
}
function parseCSV(text) {
  var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l; });
  if(lines.length < 2){ toast('‚ö† CSV has no data rows.'); return; }
  // Skip header
  var dataLines = lines.slice(1);
  csvParsedBuffer = [];
  var errors = 0;
  dataLines.forEach(function(line, li){
    // Parse CSV considering quoted fields
    var cols = parseCSVLine(line);
    if(cols.length < 6){ errors++; return; }
    var q_txt = cols[0].trim();
    var opts = [cols[1].trim(), cols[2].trim(), cols[3].trim(), cols[4].trim()];
    var ans = cols[5].trim().toUpperCase();
    var exp = cols[6] ? cols[6].trim() : 'See study materials.';
    var correctIdx = ['A','B','C','D'].indexOf(ans);
    if(!q_txt || correctIdx < 0){ errors++; return; }
    opts = opts.map(function(o){ return o || '‚Äî'; });
    csvParsedBuffer.push({ q:q_txt, o:opts, c:correctIdx, e:exp });
  });
  
  var previewArea = document.getElementById('csv-preview-area');
  var previewTitle = document.getElementById('csv-preview-title');
  var table = document.getElementById('csv-preview-table');
  var msg = document.getElementById('csv-msg');
  
  if(csvParsedBuffer.length === 0){
    if(msg) msg.innerHTML = '<div class="al al-err">‚ö† Could not parse CSV. Check format matches template.</div>';
    if(previewArea) previewArea.style.display = 'none';
    return;
  }
  
  if(previewTitle) previewTitle.textContent = '‚úÖ Found ' + csvParsedBuffer.length + ' questions' + (errors > 0 ? ' (' + errors + ' rows skipped)' : '') + ':';
  if(table) {
    table.innerHTML = '<tr><th>#</th><th>Question</th><th>Correct</th><th>Options</th></tr>' +
      csvParsedBuffer.slice(0,10).map(function(q,i){
        return '<tr><td>'+(i+1)+'</td><td>'+q.q.substring(0,60)+(q.q.length>60?'‚Ä¶':'')+'</td><td class="correct-cell">'+['A','B','C','D'][q.c]+'</td><td>'+q.o.join(', ').substring(0,50)+'</td></tr>';
      }).join('') + (csvParsedBuffer.length > 10 ? '<tr><td colspan="4" style="color:var(--mt);text-align:center;font-style:italic">... and '+(csvParsedBuffer.length-10)+' more</td></tr>' : '');
  }
  if(previewArea) previewArea.style.display = 'block';
  if(msg) msg.innerHTML = '';
}
function parseCSVLine(line) {
  var cols = [], col = '', inQ = false;
  for(var i=0;i<line.length;i++){
    var ch = line[i];
    if(ch==='"' && !inQ){ inQ=true; }
    else if(ch==='"' && inQ){ if(line[i+1]==='"'){ col+='"'; i++; } else inQ=false; }
    else if(ch===',' && !inQ){ cols.push(col); col=''; }
    else col+=ch;
  }
  cols.push(col);
  return cols;
}
function confirmCSVImport() {
  var yr = (document.getElementById('csv-ay')||{}).value || '2025';
  var paper = (document.getElementById('csv-ap')||{}).value || 'Paper 1';
  if(csvParsedBuffer.length === 0){ toast('‚ö† Nothing to import.'); return; }
  if(!DB[yr]) DB[yr] = {'Paper 1':[],'Paper 2':[],'OSCE':[]};
  if(!DB[yr][paper]) DB[yr][paper] = [];
  csvParsedBuffer.forEach(function(q){ DB[yr][paper].push(q); });
  var count = csvParsedBuffer.length;
  csvParsedBuffer = [];
  saveDB();
  var previewArea = document.getElementById('csv-preview-area');
  if(previewArea) previewArea.style.display = 'none';
  var csvFile = document.getElementById('csv-file');
  if(csvFile) csvFile.value = '';
  var msg = document.getElementById('csv-msg');
  if(msg) msg.innerHTML = '<div class="al al-ok">‚úÖ ' + count + ' questions imported to ' + yr + ' ' + paper + '!</div>';
  addNotification('questions', count + ' new questions added via CSV to ' + yr + ' ' + paper + '!');
  renderYGrid();
  setTimeout(function(){ if(msg) msg.innerHTML=''; }, 4000);
}
function cancelCSVImport() {
  csvParsedBuffer = [];
  var previewArea = document.getElementById('csv-preview-area');
  if(previewArea) previewArea.style.display = 'none';
  document.getElementById('csv-file').value = '';
}

// =========================================================
// ADMIN ‚Äî ANALYTICS PER YEAR
// =========================================================
function renderAdminAnalytics() {
  renderAnalyticsSummary();
  renderActiveUsers();
  renderRevenueTracking();
  renderMostFailed();
  renderAnalyticsYearBreakdown();
  renderAnalyticsPerfByYear();
  renderTopScorers();
  populateFailFilters();
}

// ===== PLAN PRICING (adjust these to match your actual prices) =====
var PLAN_PRICES = { 'Pro Monthly': 2500, 'Pro 3-Month': 7500, 'Pro Annual': 24999, 'Pro': 2500 };

function renderRevenueTracking() {
  // Estimate revenue from pro accounts
  var proAccounts = accounts.filter(function(a){ return a.isPro; });
  var now = new Date();
  var thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

  // Build week buckets for last 8 weeks
  var weeks = [];
  for(var w=7; w>=0; w--) {
    var wStart = new Date(); wStart.setDate(wStart.getDate() - (w+1)*7);
    var wEnd = new Date(); wEnd.setDate(wEnd.getDate() - w*7);
    var label = wStart.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    var count = accounts.filter(function(a){
      if(!a.proSince && !a.regDate) return false;
      var d = new Date(a.proSince || a.regDate).getTime();
      return a.isPro && d >= wStart.getTime() && d < wEnd.getTime();
    }).length;
    weeks.push({label:label, count:count});
  }
  var maxWk = Math.max(1, Math.max.apply(null, weeks.map(function(w){ return w.count; })));

  // Revenue estimate
  var defaultPrice = PLAN_PRICES['Pro Monthly'] || 299;
  var totalRev = proAccounts.length * defaultPrice;
  var monthlyRev = proAccounts.filter(function(a){
    var d = a.proSince ? new Date(a.proSince).getTime() : 0;
    return d >= thisMonthStart;
  }).length * defaultPrice;

  // Set totals
  var setEl = function(id,v){ var e=document.getElementById(id); if(e) e.textContent=v; };
  setEl('rev-total', '‚Ç¶'+totalRev.toLocaleString());
  setEl('rev-monthly', '‚Ç¶'+monthlyRev.toLocaleString());

  // Plan breakdown
  var bd = document.getElementById('rev-breakdown');
  if(bd) {
    var plans = [
      {name:'Pro Subscribers', count:proAccounts.length, price:defaultPrice, color:'#0A6E4E'},
      {name:'Free Users', count:accounts.length - proAccounts.length, price:0, color:'#C8E6DC'}
    ];
    bd.innerHTML = plans.map(function(p){
      return '<div class="rev-breakdown-row">'+
        '<span><span class="rev-plan-dot" style="background:'+p.color+'"></span>'+p.name+'</span>'+
        '<span style="font-weight:700">'+p.count+' users</span>'+
        '<span style="color:var(--g);font-weight:700">'+(p.price>0?'‚Ç¶'+(p.count*p.price).toLocaleString():'-')+'</span>'+
      '</div>';
    }).join('');
  }

  // Mini bar chart
  var chart = document.getElementById('rev-mini-chart');
  var labels = document.getElementById('rev-chart-labels');
  if(chart) {
    chart.innerHTML = weeks.map(function(wk, i){
      var h = Math.round((wk.count / maxWk) * 44) + 4;
      var isLatest = (i === weeks.length-1);
      return '<div class="rev-mini-bar'+(isLatest?' active':'')+'" style="height:'+h+'px" title="'+wk.label+': '+wk.count+' activations">'+
        '<span class="rev-mini-tip">'+wk.count+'</span>'+
      '</div>';
    }).join('');
  }
  if(labels) {
    labels.innerHTML = weeks.filter(function(_,i){ return i%2===0; }).map(function(wk){ return '<span>'+wk.label+'</span>'; }).join('');
  }
}

function populateFailFilters() {
  var yr = document.getElementById('fail-yr-filter');
  if(!yr) return;
  var years = Object.keys(DB).sort(function(a,b){ return b-a; });
  yr.innerHTML = '<option value="all">All Years</option>' +
    years.map(function(y){ return '<option value="'+y+'">'+y+'</option>'; }).join('');
}

function renderMostFailed() {
  var el = document.getElementById('adm-most-failed');
  if(!el) return;
  if(quizHistory.length === 0) {
    el.innerHTML = '<p style="color:var(--mt);font-size:14px">No quiz attempts recorded yet. Once students answer questions, failed questions will appear here.</p>';
    return;
  }

  var yrFilter = (document.getElementById('fail-yr-filter')||{}).value || 'all';
  var paperFilter = (document.getElementById('fail-paper-filter')||{}).value || 'all';

  // Build wrong-answer map from quizHistory
  // quizHistory entries: { year, paper, score, total, date }
  // We need per-question tracking ‚Äî use DB + quizHistory to simulate
  // Track by question text (unique key)
  var failMap = {}; // key -> {q, year, paper, wrong, total}

  // Scan all questions in DB
  var letters = ['A','B','C','D'];
  Object.keys(DB).forEach(function(yr){
    if(yrFilter !== 'all' && yr !== yrFilter) return;
    var papers = DB[yr] ? Object.keys(DB[yr]) : [];
    papers.forEach(function(paper){
      if(paperFilter !== 'all' && paper !== paperFilter) return;
      var qs = DB[yr][paper] || [];
      qs.forEach(function(q, qi){
        var key = yr+'|'+paper+'|'+qi;
        // Use stored per-question stats if available
        var stats = null;
        try { var raw = localStorage.getItem('np_qstat_'+key); if(raw) stats = JSON.parse(raw); } catch(x){}
        if(stats && stats.total > 0) {
          failMap[key] = { q:q, year:yr, paper:paper, wrong: stats.total - stats.correct, total: stats.total };
        }
      });
    });
  });

  var rows = Object.values(failMap).filter(function(r){ return r.total > 0; });
  rows.sort(function(a,b){
    var ra = a.wrong/a.total, rb = b.wrong/b.total;
    return rb - ra || b.wrong - a.wrong;
  });
  rows = rows.slice(0, 10);

  if(rows.length === 0) {
    // Simulate using quizHistory aggregate if no per-Q stats
    el.innerHTML = '<div class="al al-warn" style="font-size:13px">'+
      'üìä Per-question tracking activates automatically as students answer questions. '+
      'Question-level stats are stored locally and will populate here over time.'+
    '</div>'+
    '<div style="font-size:13px;color:var(--mt);margin-top:8px">'+
      'Currently tracking <strong>'+quizHistory.length+'</strong> quiz session'+(quizHistory.length!==1?'s':'')+' across all students.'+
    '</div>';
    return;
  }

  el.innerHTML = rows.map(function(r, i){
    var failRate = Math.round(r.wrong / r.total * 100);
    var correctRate = 100 - failRate;
    return '<div class="fail-q-row">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;padding-left:8px">'+
        '<span style="font-size:10px;font-weight:700;color:var(--mt)">#'+(i+1)+'</span>'+
        '<span class="fail-q-badge">'+failRate+'% fail rate</span>'+
      '</div>'+
      '<div class="fail-q-text">'+r.q.q.substring(0,120)+(r.q.q.length>120?'‚Ä¶':'')+'</div>'+
      '<div class="fail-q-meta">'+
        '<span class="fail-q-year">'+r.year+'</span>'+
        '<span class="fail-q-year">'+r.paper+'</span>'+
        '<span style="font-size:11px;color:var(--mt)">'+r.wrong+' wrong / '+r.total+' attempts</span>'+
      '</div>'+
      '<div class="fail-bar-wrap">'+
        '<div style="font-size:10px;color:var(--mt)">Correct rate: '+correctRate+'%</div>'+
        '<div class="fail-bar-track"><div class="fail-bar-fill" style="width:'+correctRate+'%"></div></div>'+
      '</div>'+
    '</div>';
  }).join('');
}

function renderAnalyticsSummary() {
  var el = document.getElementById('adm-analytics-summary');
  if(!el) return;
  var totalQ = 0, totalYears = Object.keys(DB).length;
  var totalStudents = accounts.length;
  var proStudents = accounts.filter(function(a){ return a.isPro; }).length;
  var freeStudents = totalStudents - proStudents;
  var now = Date.now();
  var day7 = 7*24*60*60*1000;
  var day30 = 30*24*60*60*1000;
  // Active = registered within last 30 days OR has quiz history recently
  var recentlyActive = accounts.filter(function(a){
    var regRecent = a.regDate && (now - new Date(a.regDate).getTime() < day30);
    var hasActivity = (a.totalAns||0) > 0;
    return regRecent || hasActivity;
  }).length;
  var newThisWeek = accounts.filter(function(a){
    return a.regDate && (now - new Date(a.regDate).getTime() < day7);
  }).length;
  Object.keys(DB).forEach(function(yr){
    ['Paper 1','Paper 2','OSCE'].forEach(function(p){
      totalQ += ((DB[yr]&&DB[yr][p])||[]).length;
    });
  });
  var convRate = totalStudents > 0 ? Math.round(proStudents/totalStudents*100) : 0;
  el.innerHTML = [
    {n:totalStudents, l:'Total Users', ico:'üë•', cls:'green-accent', trend: newThisWeek > 0 ? '+'+newThisWeek+' this week' : '', tdir:'up'},
    {n:recentlyActive, l:'Active Users (30d)', ico:'üü¢', cls:'blue-accent', trend: Math.round(recentlyActive/(totalStudents||1)*100)+'% of total', tdir:'up'},
    {n:proStudents, l:'Pro Subscribers', ico:'‚≠ê', cls:'gold-accent', trend: convRate+'% conversion', tdir: convRate>=10?'up':'down'},
    {n:totalQ, l:'Questions in Bank', ico:'üìã', cls:'', trend: totalYears+' year'+(totalYears!==1?'s':''), tdir:''}
  ].map(function(s){
    return '<div class="adm-stat-card '+s.cls+'">'+
      '<div style="font-size:20px;margin-bottom:2px">'+s.ico+'</div>'+
      '<div class="adm-stat-num">'+s.n+'</div>'+
      '<div class="adm-stat-lbl">'+s.l+'</div>'+
      (s.trend ? '<div class="adm-stat-trend '+s.tdir+'">'+s.trend+'</div>' : '')+
    '</div>';
  }).join('');
}

function renderActiveUsers() {
  var el = document.getElementById('adm-active-users');
  if(!el) return;
  var now = Date.now();
  var h24 = 24*60*60*1000, d7 = 7*h24, d30 = 30*h24;
  var total = accounts.length;
  var active24 = accounts.filter(function(a){ return a.lastActive && (now - new Date(a.lastActive).getTime() < h24); }).length;
  var active7 = accounts.filter(function(a){ return a.lastActive && (now - new Date(a.lastActive).getTime() < d7); }).length;
  var active30 = accounts.filter(function(a){ return a.lastActive && (now - new Date(a.lastActive).getTime() < d30); }).length;
  var proCount = accounts.filter(function(a){ return a.isPro; }).length;
  var freeCount = total - proCount;
  var withActivity = accounts.filter(function(a){ return (a.totalAns||0) > 0; }).length;
  var dormant = total - withActivity;

  function pct(n){ return total > 0 ? Math.round(n/total*100) : 0; }
  function bar(n, cls){ return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px"><div style="flex:1;background:var(--bg);border-radius:6px;height:8px;overflow:hidden"><div style="height:8px;border-radius:6px;background:'+cls+';width:'+pct(n)+'%"></div></div><div style="font-size:12px;font-weight:700;color:var(--tx);min-width:40px;text-align:right">'+n+'</div></div>'; }

  el.innerHTML =
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">'+
      '<div style="background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:12px;text-align:center">'+
        '<div style="font-size:20px;font-weight:900;color:var(--ok)">'+active24+'</div>'+
        '<div style="font-size:10px;color:var(--mt);margin-top:2px">Active (24h)</div>'+
      '</div>'+
      '<div style="background:rgba(10,110,78,.06);border:1px solid rgba(10,110,78,.15);border-radius:10px;padding:12px;text-align:center">'+
        '<div style="font-size:20px;font-weight:900;color:var(--g)">'+active7+'</div>'+
        '<div style="font-size:10px;color:var(--mt);margin-top:2px">Active (7d)</div>'+
      '</div>'+
      '<div style="background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:10px;padding:12px;text-align:center">'+
        '<div style="font-size:20px;font-weight:900;color:#3B82F6">'+active30+'</div>'+
        '<div style="font-size:10px;color:var(--mt);margin-top:2px">Active (30d)</div>'+
      '</div>'+
      '<div style="background:rgba(229,62,62,.05);border:1px solid rgba(229,62,62,.15);border-radius:10px;padding:12px;text-align:center">'+
        '<div style="font-size:20px;font-weight:900;color:var(--red)">'+dormant+'</div>'+
        '<div style="font-size:10px;color:var(--mt);margin-top:2px">No Activity</div>'+
      '</div>'+
    '</div>'+
    '<div style="font-size:11px;color:var(--mt);margin-bottom:8px;font-weight:600">Engagement Breakdown</div>'+
    '<div class="active-stat-row"><span class="active-dot"></span><span style="flex:1">Pro subscribers</span>'+bar(proCount,'var(--gold)')+pct(proCount)+'%</div>'+
    '<div class="active-stat-row"><span class="active-dot warn"></span><span style="flex:1">Free users</span>'+bar(freeCount,'var(--bd)')+pct(freeCount)+'%</div>'+
    '<div class="active-stat-row"><span class="active-dot"></span><span style="flex:1">Attempted quiz ‚â•1</span>'+bar(withActivity,'var(--g)')+pct(withActivity)+'%</div>'+
    (total===0 ? '<p style="color:var(--mt);font-size:13px;margin-top:8px">No students registered yet.</p>' : '');
}

function renderAnalyticsYearBreakdown() {
  var el = document.getElementById('adm-year-analytics');
  if(!el) return;
  var years = Object.keys(DB).sort(function(a,b){ return b-a; });
  if(years.length === 0){ el.innerHTML='<p style="color:var(--mt);font-size:14px">No questions uploaded yet.</p>'; return; }
  var papers = ['Paper 1','Paper 2','OSCE'];
  var maxTotal = 0;
  var data = years.map(function(yr){
    var counts = papers.map(function(p){ return ((DB[yr]&&DB[yr][p])||[]).length; });
    var total = counts.reduce(function(a,b){ return a+b; }, 0);
    if(total > maxTotal) maxTotal = total;
    return {yr:yr, counts:counts, total:total};
  });
  el.innerHTML = data.map(function(d){
    return '<div class="analytics-year-row">'+
      '<div class="analytics-year-hd">'+
        '<div class="analytics-year-badge">'+d.yr+'</div>'+
        '<div class="analytics-year-total">'+d.total+' questions total</div>'+
      '</div>'+
      '<div class="analytics-year-bars">'+
        papers.map(function(p,pi){
          var count = d.counts[pi];
          var pct = maxTotal > 0 ? Math.round(count/maxTotal*100) : 0;
          return '<div class="analytics-paper-bar">'+
            '<div class="analytics-paper-num">'+count+'</div>'+
            '<div class="analytics-paper-track"><div class="analytics-paper-fill" style="width:'+pct+'%"></div></div>'+
            '<div class="analytics-paper-lbl">'+p+'</div>'+
          '</div>';
        }).join('')+
      '</div>'+
    '</div>';
  }).join('');
}

function renderAnalyticsPerfByYear() {
  var el = document.getElementById('adm-perf-by-year');
  if(!el) return;
  // Aggregate quiz history across all sessions
  if(quizHistory.length === 0){ el.innerHTML='<p style="color:var(--mt);font-size:14px">No quiz attempts recorded yet.</p>'; return; }
  var byYear = {};
  quizHistory.forEach(function(h){
    if(!byYear[h.year]) byYear[h.year] = {total:0, correct:0, attempts:0};
    byYear[h.year].total += h.total;
    byYear[h.year].correct += h.score;
    byYear[h.year].attempts++;
  });
  var years = Object.keys(byYear).sort(function(a,b){ return b-a; });
  el.innerHTML = '<div style="display:flex;flex-direction:column;gap:6px">'+years.map(function(yr){
    var d = byYear[yr];
    var pct = d.total > 0 ? Math.round(d.correct/d.total*100) : 0;
    var color = pct>=70?'var(--ok)':pct>=50?'var(--gold)':'var(--red)';
    return '<div class="year-row">'+
      '<div class="year-badge">'+yr+'</div>'+
      '<div class="year-detail">'+d.attempts+' attempt'+(d.attempts!==1?'s':'')+' ¬∑ '+d.correct+'/'+d.total+' correct</div>'+
      '<div class="year-pct" style="color:'+color+'">'+pct+'%</div>'+
    '</div>';
  }).join('')+'</div>';
}

function renderTopScorers() {
  var el = document.getElementById('adm-top-scorers');
  if(!el) return;
  var scored = accounts.filter(function(a){ return (a.totalAns||0) > 0; }).map(function(a){
    return { name:a.name, username:a.username, score:a.totalAns>0?Math.round((a.totalCor||0)/a.totalAns*100):0, answered:a.totalAns||0, isPro:a.isPro };
  }).sort(function(a,b){ return b.score-a.score || b.answered-a.answered; }).slice(0,5);
  if(scored.length === 0){ el.innerHTML='<p style="color:var(--mt);font-size:14px">No performance data yet.</p>'; return; }
  el.innerHTML = scored.map(function(s,i){
    var medals = ['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'];
    return '<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--bg)">'+
      '<span style="font-size:20px">'+medals[i]+'</span>'+
      '<div style="flex:1"><div style="font-weight:600;font-size:14px">'+s.name+'</div><div style="font-size:12px;color:var(--mt)">@'+s.username+' ¬∑ '+s.answered+' answered</div></div>'+
      '<div style="text-align:right"><div style="font-size:16px;font-weight:700;color:var(--g)">'+s.score+'%</div><div style="font-size:10px;color:var(--mt)">'+(s.isPro?'‚≠ê Pro':'Free')+'</div></div>'+
    '</div>';
  }).join('');
}
function checkRefCode() {
  var code = (g('r_refcode')||'').trim().toUpperCase();
  var hint = document.getElementById('refcode-hint');
  if(!hint) return;
  if(!code){ hint.textContent = 'Have a friend\'s referral code? Enter it to give them credit.'; hint.style.color = ''; return; }
  // Check if any account has this referral code
  var found = false;
  accounts.forEach(function(acc) {
    if(found || !acc.id) return;
    try {
      var d = localStorage.getItem('np_referral_' + acc.id);
      if(d) {
        var refD = JSON.parse(d);
        if((refD.code||'').toUpperCase() === code) found = true;
      }
    } catch(x){}
  });
  if(found){ hint.style.color='var(--ok)'; hint.textContent='‚úÖ Valid code! Your friend will get credit when you join.'; }
  else if(code.length >= 6){ hint.style.color='var(--red)'; hint.textContent='‚ö† Code not found. Ask your friend to double-check.'; }
  else { hint.style.color='var(--mt)'; hint.textContent='Keep typing‚Ä¶'; }
}

function resetReg() {
  ['r1','r2','r3','r4','r7','r9','r10','r_uname','r_refcode'].forEach(function(id){
    var el=document.getElementById(id); if(el) el.value='';
  });
  ['e1','e2','e3','e4','e7','e9','e10','e-terms','e-otp','e_uname','uname-hint'].forEach(function(id){
    var el=document.getElementById(id); if(el) el.textContent='';
  });
  var rh = document.getElementById('refcode-hint');
  if(rh){ rh.textContent='Have a friend\'s referral code? Enter it to give them credit.'; rh.style.color=''; }
  agreed=false; photoB64=null;
  var ck=document.getElementById('ckbox'); if(ck){ ck.className='ckbox'; ck.textContent=''; }
  var ring=document.getElementById('photo-ring');
  if(ring) ring.innerHTML='<div style="text-align:center"><div style="font-size:26px">üì∑</div><div style="font-size:10px;color:var(--mt);margin-top:4px">Add Photo</div></div>';
  [1,2,3,4].forEach(function(i){ var b=document.getElementById('pb'+i); if(b) b.style.background=''; });
  var lbl=document.getElementById('pwlbl'); if(lbl) lbl.textContent='';
  var mh=document.getElementById('match-hint'); if(mh) mh.textContent='';
  for(var i=0;i<5;i++){ var o=document.getElementById('otp'+i); if(o){ o.value=''; o.className='otp-box'; } }
}

function regBack() {
  if(curStep>1){ goStep(curStep-1); }
  else { go('splash', true); }
}

function goStep(n) {
  curStep=n;
  for(var i=1;i<=3;i++){
    var s=document.getElementById('s'+i);
    if(s) s.style.display=(i===n)?'block':'none';
  }
  var subs=['Step 1 of 3 ‚Äî Personal Info','Step 2 of 3 ‚Äî Security','Step 3 of 3 ‚Äî Verification'];
  var sub=document.getElementById('reg-sub'); if(sub) sub.textContent=subs[n-1];
  for(var i=1;i<=3;i++){
    var dot=document.getElementById('sd'+i);
    if(dot){ dot.className='sdot '+(i<n?'done':i===n?'active':'todo'); dot.textContent=i<n?'‚úì':i; }
    var lbl=document.getElementById('sla'+i);
    if(lbl){ lbl.className='slabel'+(i===n?' active':''); }
  }
  var lines={12:1,23:2};
  for(var k in lines){
    var l=document.getElementById('sl'+k);
    if(l) l.className='sline'+(lines[k]<n?' done':'');
  }
}

function g(id){ return (document.getElementById(id)||{}).value||''; }
function ce(id){ var el=document.getElementById(id); if(el) el.textContent=''; }
function se(id,msg){ var el=document.getElementById(id); if(el) el.textContent=msg; }

function checkUsernameAvail() {
  var uname = (g('r_uname')||'').trim().toLowerCase();
  var hint = document.getElementById('uname-hint');
  if(!hint) return;
  if(!uname){ hint.textContent=''; return; }
  if(!/^[a-z0-9_\.]{3,20}$/.test(uname)){ hint.style.color='var(--red)'; hint.textContent='3‚Äì20 chars, letters/numbers/_ only'; return; }
  if(uname === ADMIN_USER){ hint.style.color='var(--red)'; hint.textContent='‚ö† That username is reserved.'; return; }
  var taken = accounts.some(function(a){ return (a.username||'').toLowerCase()===uname; });
  if(taken){ hint.style.color='var(--red)'; hint.textContent='‚ö† Username already taken.'; }
  else { hint.style.color='var(--ok)'; hint.textContent='‚úì Username available'; }
}

function s1next() {
  var ok=true;
  var first=g('r1').trim(), last=g('r2').trim(), uname=g('r_uname').trim().toLowerCase();
  var phone=g('r3').trim(), email=g('r4').trim();
  if(!first||first.length<2){ se('e1','‚ö† First name must be at least 2 characters'); ok=false; }
  if(!last){ se('e2','‚ö† Last name is required'); ok=false; }
  if(!uname||!/^[a-z0-9_\.]{3,20}$/.test(uname)){ se('e_uname','‚ö† Username must be 3‚Äì20 characters (letters, numbers, _ only)'); ok=false; }
  else if(uname === ADMIN_USER){ se('e_uname','‚ö† That username is reserved.'); ok=false; }
  else if(accounts.some(function(a){ return (a.username||'').toLowerCase()===uname; })){ se('e_uname','‚ö† Username already taken. Please choose another.'); ok=false; }
  if(!phone||!/^[0-9+\s\-]{10,15}$/.test(phone)){ se('e3','‚ö† Enter a valid phone number (10‚Äì15 digits)'); ok=false; }
  if(!email||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ se('e4','‚ö† Enter a valid email address'); ok=false; }
  else if(accounts.some(function(a){ return a.email.toLowerCase()===email.toLowerCase(); })){ se('e4','‚ö† This email already has an account. Please log in.'); ok=false; }
  if(!g('r7')){ se('e7','‚ö† Please select your year level'); ok=false; }
  if(ok) goStep(2);
}

function pwScore(pw) {
  var s=0;
  if(pw.length>=8) s++;
  if(/[A-Z]/.test(pw)) s++;
  if(/[0-9]/.test(pw)) s++;
  if(/[^A-Za-z0-9]/.test(pw)) s++;
  return s;
}
var SC=['','#E53E3E','#F5A623','#12A070','#22C55E'];
var SL=['','Weak','Fair','Good','Strong ‚úì'];

function pwStrCheck() {
  var pw=document.getElementById('r9').value;
  var s=pwScore(pw);
  for(var i=1;i<=4;i++){ var b=document.getElementById('pb'+i); if(b) b.style.background=(i<=s?SC[s]:''); }
  var lbl=document.getElementById('pwlbl');
  if(lbl){ lbl.textContent=pw?SL[s]:''; lbl.style.color=SC[s]||'var(--mt)'; }
}

function matchCheck() {
  var pw=document.getElementById('r9').value;
  var pw2=document.getElementById('r10').value;
  var h=document.getElementById('match-hint');
  if(!h||!pw2) return;
  if(pw===pw2){ h.style.color='var(--ok)'; h.textContent='‚úì Passwords match'; }
  else { h.style.color='var(--red)'; h.textContent='‚úó Do not match'; }
}

function s2next() {
  var ok=true;
  var pw=g('r9'), pw2=g('r10');
  if(!pw||pw.length<8){ se('e9','‚ö† Password must be at least 8 characters'); ok=false; }
  else if(pwScore(pw)<2){ se('e9','‚ö† Password is too weak ‚Äî add uppercase and numbers'); ok=false; }
  if(!pw2){ se('e10','‚ö† Please confirm your password'); ok=false; }
  else if(pw!==pw2){ se('e10','‚ö† Passwords do not match'); ok=false; }
  if(!agreed){ se('e-terms','‚ö† You must agree to the Terms & Conditions'); ok=false; }
  if(!ok) return;
  var btn=document.getElementById('send-btn');
  btn.disabled=true;
  btn.innerHTML='<span class="spin"></span> Sending...';
  setTimeout(function(){
    btn.disabled=false; btn.textContent='Send Verification Code ‚Üí';
    var oe=document.getElementById('otp-email');
    if(oe) oe.textContent=g('r4');
    for(var i=0;i<5;i++){ var o=document.getElementById('otp'+i); if(o){ o.value=''; o.className='otp-box'; } }
    goStep(3);
    setTimeout(function(){ var o0=document.getElementById('otp0'); if(o0) o0.focus(); },200);
  },1500);
}

function otpIn(i) {
  var el=document.getElementById('otp'+i);
  el.value=el.value.replace(/[^0-9]/g,'').slice(0,1);
  el.className='otp-box'+(el.value?' filled':'');
  if(el.value&&i<4){ var nx=document.getElementById('otp'+(i+1)); if(nx) nx.focus(); }
  ce('e-otp');
}

function otpKey(i,e) {
  if(e.key==='Backspace'&&!document.getElementById('otp'+i).value&&i>0){
    var prev=document.getElementById('otp'+(i-1)); if(prev) prev.focus();
  }
}

function doVerify() {
  var code='';
  for(var i=0;i<5;i++) code+=(document.getElementById('otp'+i)||{}).value||'';
  if(code.length<5){ se('e-otp','‚ö† Please enter all 5 digits'); return; }
  var btn=document.getElementById('verify-btn');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span> Verifying...';
  setTimeout(function(){
    btn.disabled=false; btn.textContent='Verify & Create Account ‚úì';
    var u={
      id:Date.now(),
      firstName:g('r1').trim(), lastName:g('r2').trim(),
      name:g('r1').trim()+' '+g('r2').trim(),
      username:g('r_uname').trim().toLowerCase(),
      email:g('r4').trim(), phone:g('r3').trim(),
      yearLevel:g('r7'),
      photo:photoB64, isPro:false, totalAns:0, totalCor:0,
      joined:new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})
    };
    accounts.push(u); saveAcc(); ME=u; isPro=false;
    // Initialize referral data for new user
    referralData = { code: genRefCode(), referrals: [], claimedMilestones: [], bonusYears: [], bonusQPerSession: 0 };
    saveReferral();
    // Apply referral code if entered
    var refCode = g('r_refcode').trim().toUpperCase();
    if(refCode) applyReferralCode(refCode, u.name, u.id);
    var st=document.getElementById('suc-title'); if(st) st.textContent='Welcome, '+u.firstName+'! üéâ';
    var sc=document.getElementById('suc-card');
    if(sc) sc.innerHTML=[
      {l:'Full Name',v:u.name},{l:'Username',v:'@'+u.username},
      {l:'Email',v:u.email},{l:'Phone',v:u.phone},
      {l:'Year Level',v:u.yearLevel},
      {l:'Access',v:'Free (10 questions/session)'},{l:'Joined',v:u.joined}
    ].map(function(r){ return '<div class="irow"><span class="ilbl">'+r.l+'</span><span class="ival">'+r.v+'</span></div>'; }).join('');
    go('success');
  },1500);
}

function enterApp() { loadReferral(); go('main'); }

// =========================================================
// LOGIN
// =========================================================
function doLogin() {
  var uname = (g('le')||'').trim().toLowerCase();
  var pass = g('lp').trim();
  var ok = true;
  ce('le-err'); ce('lp-err');
  var lerr = document.getElementById('l-err'); if(lerr) lerr.style.display='none';
  if(!uname){ se('le-err','‚ö† Please enter your username'); ok=false; }
  if(!pass){ se('lp-err','‚ö† Password is required'); ok=false; }
  if(!ok) return;

  var btn = document.getElementById('login-btn');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span> Logging in...';

  setTimeout(function(){
    btn.disabled=false; btn.textContent='Log In ‚Üí';

    // --- Admin shortcut via student login form ---
    if(uname === ADMIN_USER && pass === ADMIN_PASS){
      document.getElementById('le').value='';
      document.getElementById('lp').value='';
      try { localStorage.removeItem('np_saved_creds'); } catch(x){}
      go('admin');
      return;
    }

    // --- Student login: must have created a profile ---
    var found = null;
    for(var i=0; i<accounts.length; i++){
      if((accounts[i].username||'').toLowerCase() === uname){ found=accounts[i]; break; }
    }
    if(!found){
      var lerr2=document.getElementById('l-err');
      if(lerr2){ lerr2.style.display='block'; lerr2.textContent='‚ö† No account found with that username. Please create an account first.'; }
      return;
    }

    ME=found; isPro=found.isPro||false;
    ME.lastActive = new Date().toISOString(); saveAcc();
    // Device-lock check for pro code
    if(found.isPro && found.proCode){
      var codeEntry=null;
      for(var j=0;j<generatedCodes.length;j++){ if(generatedCodes[j].code===found.proCode){ codeEntry=generatedCodes[j]; break; } }
      if(codeEntry && codeEntry.deviceId && codeEntry.deviceId !== DEVICE_ID){
        isPro=false;
        toast('‚ö† Pro access is device-locked. Continuing as Free.');
      }
    }
    // Save credentials if "Remember me" checked
    var rememberMe = document.getElementById('remember-me');
    if(rememberMe && rememberMe.checked) {
      try {
        localStorage.setItem('np_saved_creds', JSON.stringify({ u: uname, p: pass }));
      } catch(x){}
    } else {
      try { localStorage.removeItem('np_saved_creds'); } catch(x){}
    }
    document.getElementById('le').value='';
    document.getElementById('lp').value='';
    loadReferral();
    go('main');
  }, 1200);
}

// =========================================================
// LOGIN AUTOCOMPLETE (popup on focus, not a box below)
// =========================================================
var _acFocusIdx = -1;

function getAcItems(query) {
  query = (query||'').toLowerCase();
  return accounts.filter(function(a){
    var u = (a.username||'').toLowerCase();
    var n = (a.name||'').toLowerCase();
    return !query || u.startsWith(query) || n.includes(query);
  });
}

function showAutocomplete(inputId, dropId) {
  var inp = document.getElementById(inputId);
  var drop = document.getElementById(dropId);
  if(!inp || !drop) return;
  _acFocusIdx = -1;
  renderAcDrop(drop, inp.value, inputId);
}

function filterAutocomplete(inputId, dropId) {
  var inp = document.getElementById(inputId);
  var drop = document.getElementById(dropId);
  if(!inp || !drop) return;
  _acFocusIdx = -1;
  renderAcDrop(drop, inp.value, inputId);
}

function renderAcDrop(drop, query, inputId) {
  var items = getAcItems(query);
  if(items.length === 0){ drop.style.display='none'; return; }
  drop.innerHTML = items.map(function(a, i){
    var av = a.photo ? ('<img src="'+a.photo+'">') : initials(a.name);
    var uname = a.username || '';
    return '<div class="ac-item" id="ac-i-'+i+'" onmousedown="pickAcItem(\''+inputId+'\',\''+uname+'\')" data-uname="'+uname+'">' +
      '<div class="ac-av">'+av+'</div>' +
      '<div><div class="ac-name">'+a.name+'</div><div class="ac-user">@'+uname+'</div></div>' +
      '</div>';
  }).join('');
  drop.style.display = 'block';
}

function hideAutocomplete(dropId) {
  // Delay to allow mousedown on item to fire first
  setTimeout(function(){
    var d = document.getElementById(dropId); if(d) d.style.display='none';
    _acFocusIdx = -1;
  }, 180);
}

function pickAcItem(inputId, uname) {
  var inp = document.getElementById(inputId);
  if(inp){ inp.value = uname; ce('le-err'); }
  var drop = document.getElementById('ac-user');
  if(drop) drop.style.display = 'none';
  var lp = document.getElementById('lp'); if(lp) lp.focus();
}

function acKey(event, dropId) {
  var drop = document.getElementById(dropId);
  if(!drop || drop.style.display==='none'){
    if(event.key==='Enter') doLogin();
    return;
  }
  var items = drop.querySelectorAll('.ac-item');
  if(event.key==='ArrowDown'){
    event.preventDefault();
    _acFocusIdx = Math.min(_acFocusIdx+1, items.length-1);
  } else if(event.key==='ArrowUp'){
    event.preventDefault();
    _acFocusIdx = Math.max(_acFocusIdx-1, -1);
  } else if(event.key==='Enter'){
    if(_acFocusIdx >= 0 && items[_acFocusIdx]){
      var u = items[_acFocusIdx].getAttribute('data-uname');
      pickAcItem('le', u);
    } else { doLogin(); }
    return;
  } else if(event.key==='Escape'){
    drop.style.display='none'; _acFocusIdx=-1; return;
  }
  items.forEach(function(it,i){ it.classList.toggle('focused', i===_acFocusIdx); });
}

function doLogout() {
  if(!confirm('Log out of NursePrep?')) return;
  ME=null; isPro=false; QSessAns=0;
  go('splash', true);
}

// =========================================================
// HELPERS
// =========================================================
function initials(name) {
  return (name||'').trim().split(' ').map(function(n){ return n[0]; }).join('').toUpperCase().slice(0,2)||'?';
}
function toggleAgree() {
  agreed=!agreed;
  var b=document.getElementById('ckbox');
  if(b){ b.className='ckbox'+(agreed?' on':''); b.textContent=agreed?'‚úì':''; }
  if(agreed) ce('e-terms');
}
function togglePw(inputId,btnId) {
  var inp=document.getElementById(inputId); var btn=document.getElementById(btnId);
  if(!inp||!btn) return;
  if(inp.type==='password'){ inp.type='text'; btn.textContent='üôà'; }
  else { inp.type='password'; btn.textContent='üëÅÔ∏è'; }
}
function pickPhoto(input) {
  var file=input.files&&input.files[0];
  if(!file) return;
  if(file.size>5*1024*1024){ toast('Photo must be under 5MB'); return; }
  var r=new FileReader();
  r.onload=function(ev){
    photoB64=ev.target.result;
    var ring=document.getElementById('photo-ring');
    if(ring) ring.innerHTML='<img src="'+photoB64+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';
  };
  r.readAsDataURL(file);
}

// =========================================================
// HOME UI
// =========================================================
function updateHomeUI() {
  if(!ME) return;
  var gn=document.getElementById('greet-name'); if(gn) gn.textContent='Hi, '+ME.firstName+' üëã';
  var gs=document.getElementById('greet-sch'); if(gs) gs.textContent=ME.yearLevel ? ME.yearLevel + ' ‚Äî NMCN Exam Prep' : 'NMCN Exam Prep Nigeria';
  var gb=document.getElementById('gbadge');
  if(gb){ gb.className='gbadge '+(isPro?'pro':'free'); gb.textContent=isPro?'‚úÖ PRO ‚Äî Full Access':'üîí Free ‚Äî 10 questions/session'; }
  var ha=document.getElementById('h-ans'); if(ha) ha.textContent=ME.totalAns||0;
  var promo=document.getElementById('promo'); if(promo) promo.style.display=isPro?'none':'flex';
}

function updateProfUI() {
  if(!ME) return;
  var av=document.getElementById('pav');
  if(av){ av.innerHTML=ME.photo?('<img src="'+ME.photo+'">'):initials(ME.name); }
  var pn=document.getElementById('pname'); if(pn) pn.textContent=ME.name;
  var ps=document.getElementById('psch'); if(ps) ps.textContent='@'+(ME.username||ME.yearLevel||'NursePrep Member');
  var p1=document.getElementById('ps1'); if(p1) p1.textContent=ME.totalAns||0;
  
  // Calculate average from quiz history
  var totalAns = quizHistory.reduce(function(sum, q){ return sum + q.total; }, 0);
  var totalCorrect = quizHistory.reduce(function(sum, q){ return sum + q.score; }, 0);
  var avg = totalAns > 0 ? Math.round((totalCorrect / totalAns) * 100) + '%' : '‚Äî';
  
  var p2=document.getElementById('ps2'); if(p2) p2.textContent=avg;
  var p3=document.getElementById('ps3'); if(p3) p3.textContent=isPro?'PRO ‚úì':'Free';
  var pe=document.getElementById('pro-entry'); if(pe) pe.style.display=isPro?'none':'block';
  // Show active plan card & hide upgrade menu item when paid
  var upgItem = document.getElementById('upgrade-menu-item');
  var planItem = document.getElementById('active-plan-menu');
  if(upgItem) upgItem.style.display = isPro ? 'none' : 'block';
  if(planItem) planItem.style.display = isPro ? 'block' : 'none';
  if(isPro && ME && ME.planLabel) {
    var apn = document.getElementById('apc-plan-name');
    var apt = document.getElementById('apc-expiry-txt');
    if(apn) apn.textContent = ME.planLabel || 'Pro Access';
    if(apt) {
      if(ME.planExpiry) {
        var exp = new Date(ME.planExpiry);
        apt.textContent = 'Active ¬∑ Expires ' + exp.toLocaleDateString('en-GB');
      } else {
        apt.textContent = 'Active ¬∑ Never expires ‚ôæÔ∏è';
      }
    }
  }
}

// =========================================================
// YEAR GRID
// =========================================================
function renderYGrid() {
  var el=document.getElementById('ygrid'); if(!el) return;
  var years = typeof getAllYears === 'function' ? getAllYears() : Object.keys(DB).sort(function(a,b){ return b-a; });
  if(years.length === 0){
    el.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px 16px;color:var(--mt)"><div style="font-size:40px;margin-bottom:12px">üì≠</div><div style="font-size:14px">No questions available yet.<br>Check back soon!</div></div>';
    return;
  }
  el.innerHTML=years.map(function(yr){
    var papers=DB[yr]||{};
    var total=Object.values(papers).reduce(function(s,a){ return s+a.length; },0);
    var locked=!isPro&&yr!=='2025'&&yr!=='2024';
    var chips=Object.keys(papers).filter(function(p){ return activeFilter==='all'||p===activeFilter; }).map(function(p){
      var cnt=(papers[p]||[]).length;
      if(locked) return '<span class="pchip" onclick="showPW();event.stopPropagation()">'+p+'</span>';
      if(cnt===0) return '<span class="pchip empty">'+p+' (0)</span>';
      return '<span class="pchip" onclick="startQuiz(\''+yr+'\',\''+p+'\');event.stopPropagation()">'+p+'</span>';
    }).join('');
    return '<div class="ycard'+(locked?' locked':'')+'"'+(locked?' onclick="showPW()"':'')+'><div class="ynum">'+yr+'</div><div class="ysub">'+total+' question'+(total!==1?'s':'')+'</div>'+(locked?'<div class="lockico">üîí</div>':'')+'<div class="pchips">'+chips+'</div></div>';
  }).join('');
}

function setFilter(btn, f) {
  activeFilter=f;
  document.querySelectorAll('.fchip').forEach(function(c){ c.classList.remove('on'); });
  btn.classList.add('on');
  renderYGrid();
}

// =========================================================
// QUIZ
// =========================================================
function startQuiz(year, paper) {
  var qs=DB[year]&&DB[year][paper];
  if(!qs||qs.length===0){ toast('No questions yet for '+year+' '+paper+'.'); return; }
  QPendingYear=year; QPendingPaper=paper;
  // Show mode selector
  var mt=document.getElementById('ms-title'); if(mt) mt.textContent=year+' ‚Äî '+paper;
  var ms=document.getElementById('ms-sub');
  var qCount = isPro ? qs.length : Math.min(FREE_LIM, qs.length);
  if(ms) ms.textContent=qCount+' question'+(qCount!==1?'s':'');
  var fn=document.getElementById('ms-free-note'); if(fn) fn.style.display=isPro?'none':'block';
  var fc=document.getElementById('ms-free-count'); if(fc) fc.textContent=Math.min(FREE_LIM, qs.length);
  // Reset mode selection UI
  selectMode(QMode);
  go('mode-select');
}

function selectMode(mode) {
  QMode = mode;
  var rb=document.getElementById('mbtn-review'), eb=document.getElementById('mbtn-exam');
  var rc=document.getElementById('mcheck-review'), ec=document.getElementById('mcheck-exam');
  if(mode==='review'){
    if(rb){ rb.classList.add('on'); } if(eb){ eb.classList.remove('on'); }
    if(rc) rc.style.opacity='1'; if(ec) ec.style.opacity='.25';
  } else {
    if(eb){ eb.classList.add('on'); } if(rb){ rb.classList.remove('on'); }
    if(ec) ec.style.opacity='1'; if(rc) rc.style.opacity='.25';
  }
  var sb=document.getElementById('start-btn');
  if(sb) sb.textContent = mode==='exam' ? 'Start Exam ‚Üí' : 'Start Practice ‚Üí';
}

function confirmStartQuiz() {
  var year=QPendingYear, paper=QPendingPaper;
  var qs=DB[year]&&DB[year][paper];
  if(!qs||qs.length===0){ toast('No questions yet.'); return; }
  QYear=year; QPaper=paper;
  QQ=isPro?qs:qs.slice(0,Math.min(FREE_LIM,qs.length));
  QI=0; QScore=0; QAnsed=false; QSessAns=0; QAnswers=[];
  showQuizLoading(year + ' ‚Äî ' + paper, QMode, function(){
    renderQ(); go('quiz');
  });
}

function confirmQuitQuiz() {
  if(QAnsed || QI > 0){
    if(!confirm('Quit this session? Your progress will be lost.')) return;
  }
  go('main',true);
}

function renderQ() {
  var q=QQ[QI];
  var pct=(QI/QQ.length)*100;
  var hdr=document.getElementById('qhdr'); if(hdr) hdr.textContent=QYear+' ‚Äî '+QPaper;
  var pf=document.getElementById('pfill'); if(pf) pf.style.width=pct+'%';
  var qn=document.getElementById('qnum'); if(qn) qn.textContent='QUESTION '+(QI+1)+' OF '+QQ.length;
  var qt=document.getElementById('qtxt'); if(qt) qt.textContent=q.q;
  var expl=document.getElementById('expl'); if(expl) expl.style.display='none';
  var aibtn=document.getElementById('ai-explain-btn'); if(aibtn) aibtn.style.display='none';
  var nb=document.getElementById('nxtbtn');
  if(nb){ nb.style.display='none'; nb.textContent=(QI+1>=QQ.length)?'See Results':'Next Question ‚Üí'; }
  // Mode pill
  var pill=document.getElementById('qmodepill');
  if(pill){
    if(QMode==='exam'){
      pill.className='quiz-mode-pill exam'; pill.textContent='üéì Exam';
    } else {
      pill.className='quiz-mode-pill review'; pill.textContent='üìñ Review';
    }
  }
  var qtag=document.getElementById('qtag');
  if(qtag){
    if(isPro){ qtag.className='tag tag-g'; qtag.textContent='PRO ‚úì'; }
    else { qtag.className='tag tag-o'; qtag.textContent=Math.max(0,FREE_LIM-QSessAns)+' left'; }
  }
  var opts=document.getElementById('opts');
  if(opts){
    opts.innerHTML=q.o.map(function(opt,i){
      return '<div class="opt" id="opt'+i+'" onclick="pickAns('+i+')"><div class="oltr" id="ol'+i+'">'+['A','B','C','D'][i]+'</div>'+opt+'</div>';
    }).join('');
  }
  QAnsed=false;
  // Update bookmark button state
  updateBmBtn();
  // Save quiz state for continue
  saveLastQuizState();
}

function pickAns(i) {
  if(QAnsed) return; QAnsed=true;
  var q=QQ[QI];
  var isCorrect = (i===q.c);
  if(isCorrect) QScore++;
  // Record for exam review
  QAnswers.push({ chosen: i, correct: q.c, q: q });
  // Track per-question stats for admin "Most Failed" report
  try {
    var qKey = 'np_qstat_'+QYear+'|'+QPaper+'|'+QI;
    var raw = localStorage.getItem(qKey);
    var stat = raw ? JSON.parse(raw) : {total:0,correct:0};
    stat.total++;
    if(isCorrect) stat.correct++;
    localStorage.setItem(qKey, JSON.stringify(stat));
  } catch(x){}
  
  if(QMode==='review'){
    // Show full colour feedback + explanation immediately
    for(var j=0;j<q.o.length;j++){
      var opt=document.getElementById('opt'+j);
      if(!opt) continue;
      if(j===q.c){ opt.className='opt cor'; }
      else if(j===i){ opt.className='opt wrg'; }
    }
    var expl=document.getElementById('expl');
    if(expl){ expl.style.display='block'; expl.innerHTML='üí° <strong>Explanation:</strong> '+(q.e||'See NMCN study materials.'); }
    showAIExplainBtn();
    var nb=document.getElementById('nxtbtn'); if(nb) nb.style.display='flex';
  } else {
    // Exam mode: just show selection, no green/red, no explanation
    var selOpt=document.getElementById('opt'+i);
    if(selOpt){ selOpt.style.borderColor='#3B82F6'; selOpt.style.background='rgba(59,130,246,.06)'; }
    var selLtr=document.getElementById('ol'+i);
    if(selLtr){ selLtr.style.background='#3B82F6'; selLtr.style.color='#fff'; }
    // Disable all options
    for(var k=0;k<q.o.length;k++){
      var o=document.getElementById('opt'+k);
      if(o) o.onclick=null;
    }
    showAIExplainBtn();
    var nb2=document.getElementById('nxtbtn'); if(nb2) nb2.style.display='flex';
  }
}

function nextQ() {
  QSessAns++;
  if(ME){
    ME.totalAns=(ME.totalAns||0)+1;
    for(var i=0;i<accounts.length;i++){ if(accounts[i].id===ME.id){ accounts[i].totalAns=ME.totalAns; break; } }
    saveAcc();
    var ha=document.getElementById('h-ans'); if(ha) ha.textContent=ME.totalAns;
  }
  if(!isPro&&QSessAns>=FREE_LIM){ showResult(); return; }
  if(QI+1>=QQ.length){ showResult(); return; }
  QI++;
  renderQ();
}

function showResult() {
  var total=QI+1;
  var pct=Math.round((QScore/total)*100);
  
  // Save performance data
  var quizData = {
    year: QYear,
    paper: QPaper,
    score: QScore,
    total: total,
    percentage: pct,
    mode: QMode,
    date: new Date().toISOString()
  };
  quizHistory.push(quizData);
  savePerformance();
  saveStreak(); // Update streak data
  
  // Update account stats
  if(ME){
    ME.totalCorrect = (ME.totalCorrect || 0) + QScore;
    ME.totalQuestions = (ME.totalAns || 0);
    for(var i=0;i<accounts.length;i++){ 
      if(accounts[i].id===ME.id){ 
        accounts[i].totalCorrect=ME.totalCorrect;
        accounts[i].totalQuestions=ME.totalQuestions;
        break; 
      } 
    }
    saveAcc();
  }
  
  var re=document.getElementById('remo'); if(re) re.textContent=pct>=70?'üéâ':'üìö';
  var rp=document.getElementById('rpct'); if(rp) rp.textContent=pct+'%';
  var rf=document.getElementById('rfrac'); if(rf) rf.textContent=QScore+'/'+total;
  var rm=document.getElementById('rmsg'); if(rm) rm.textContent=pct>=70?'Excellent Work!':'Keep Studying!';
  var rs=document.getElementById('rsub'); if(rs) rs.textContent=QYear+' ‚Äî '+QPaper;
  var rw=document.getElementById('rwarn'); if(rw) rw.style.display=(!isPro&&QSessAns>=FREE_LIM)?'block':'none';
  var rb=document.getElementById('rprobtn'); if(rb) rb.style.display=(!isPro)?'block':'none';
  
  // Mode badge on result screen
  var badge=document.getElementById('rmode-badge');
  if(badge){
    badge.innerHTML = QMode==='exam'
      ? '<span class="exam-badge">üéì Exam Mode</span>'
      : '<span class="review-badge">üìñ Review Mode</span>';
  }
  // Show "Review Answers" button only in exam mode
  var rrb=document.getElementById('rreviewbtn');
  if(rrb) rrb.style.display=QMode==='exam'?'block':'none';
  
  go('result');
}

// =========================================================
// EXAM REVIEW PAGE
// =========================================================
function renderExamReview() {
  var sub=document.getElementById('exam-review-sub');
  if(sub) sub.textContent=QYear+' ‚Äî '+QPaper+' ¬∑ '+QAnswers.length+' questions';
  
  var body=document.getElementById('exam-review-body');
  if(!body) return;
  
  var correct=QAnswers.filter(function(a){ return a.chosen===a.correct; }).length;
  var pct=Math.round((correct/QAnswers.length)*100);
  var scoreColor = pct>=70?'var(--ok)':(pct>=50?'var(--gold)':'var(--red)');
  
  var html='<div style="background:linear-gradient(135deg,#1D4ED8,#3B82F6);color:#fff;padding:20px;margin-bottom:16px;text-align:center">'+
    '<div style="font-size:36px;font-weight:900;font-family:\'Playfair Display\',serif;margin-bottom:4px;color:'+scoreColor.replace('var(--ok)','#4ade80').replace('var(--gold)','#FCD34D').replace('var(--red)','#FCA5A5')+'">'+pct+'%</div>'+
    '<div style="font-size:14px;opacity:.85">'+correct+' of '+QAnswers.length+' correct</div>'+
    '</div>';
  
  html+='<div style="padding:0 16px">';
  QAnswers.forEach(function(ans, idx){
    var q=ans.q;
    var isRight=ans.chosen===ans.correct;
    var letters=['A','B','C','D'];
    html+='<div class="exam-q-card '+(isRight?'correct':'wrong')+'">';
    html+='<div class="exam-q-label" style="color:'+(isRight?'#15803d':'var(--red)')+'">'+
      (isRight?'‚úì CORRECT':'‚úó INCORRECT')+' ¬∑ Q'+(idx+1)+'</div>';
    html+='<div class="exam-q-text">'+q.q+'</div>';
    html+='<div class="exam-opts-mini">';
    q.o.forEach(function(opt,oi){
      var isCorrectOpt=oi===ans.correct;
      var isChosenOpt=oi===ans.chosen;
      var cls='exam-opt-mini ';
      var prefix='';
      if(isCorrectOpt){ cls+='is-correct'; prefix='‚úì '; }
      else if(isChosenOpt && !isRight){ cls+='is-wrong'; prefix='‚úó '; }
      else { cls+='is-neutral'; }
      var note='';
      if(isCorrectOpt&&!isRight) note=' <span style="font-size:11px;opacity:.75">(correct answer)</span>';
      if(isChosenOpt&&!isRight) note+=' <span style="font-size:11px;opacity:.75">(your answer)</span>';
      if(isCorrectOpt&&isRight) note=' <span style="font-size:11px;opacity:.75">(your answer ‚úì)</span>';
      html+='<div class="'+cls+'"><strong>'+letters[oi]+'.</strong> '+opt+note+'</div>';
    });
    html+='</div>';
    html+='<div class="exam-expl">üí° '+q.e+'</div>';
    html+='</div>';
  });
  html+='</div>';
  body.innerHTML=html;
}

// =========================================================
// CHAT
// =========================================================
function renderMsgs() {
  var el=document.getElementById('msgs'); if(!el) return;
  el.innerHTML=chatLog.map(function(m){
    var bubble=m.voice
      ?'<div class="vbub">‚ñ∂ <div class="wave"><span></span><span></span><span></span><span></span><span></span></div> <span style="font-size:12px;color:var(--mt)">'+m.dur+'</span></div>'
      :m.txt;
    return '<div class="msg'+(m.me?' me':'')+'">'+(!m.me?'<div class="mav">'+m.init+'</div>':'')+
      '<div>'+(!m.me?'<div class="msender">'+m.sender+'</div>':'')+
      '<div class="mbub">'+bubble+'</div><div class="mtime">'+m.t+'</div></div></div>';
  }).join('');
  el.scrollTop=el.scrollHeight;
}

function sendMsg() {
  var inp=document.getElementById('chat-inp'); if(!inp) return;
  var txt=inp.value.trim(); if(!txt) return;
  var now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  chatLog.push({sender:'You',init:ME?initials(ME.name):'ME',txt:txt,t:now,me:true});
  inp.value=''; 
  saveChat();
  renderMsgs();
  renderAdminMsgs(); // Update admin view too
}

// =========================================================
// ADMIN CHAT
// =========================================================
function renderAdminMsgs() {
  var el=document.getElementById('admin-msgs'); if(!el) return;
  el.innerHTML=chatLog.map(function(m){
    var bubble=m.voice
      ?'<div class="vbub">‚ñ∂ <div class="wave"><span></span><span></span><span></span><span></span><span></span></div> <span style="font-size:12px;color:var(--mt)">'+m.dur+'</span></div>'
      :m.txt;
    var isAdmin = m.sender.indexOf('Admin') !== -1 || m.sender === 'Dr. Prep (Admin)';
    return '<div class="msg'+(isAdmin?' me':'')+'">'+(!isAdmin?'<div class="mav">'+m.init+'</div>':'')+
      '<div>'+(!isAdmin?'<div class="msender">'+m.sender+'</div>':'')+
      '<div class="mbub">'+bubble+'</div><div class="mtime">'+m.t+'</div></div></div>';
  }).join('');
  el.scrollTop=el.scrollHeight;
}

function sendAdminMsg() {
  var inp=document.getElementById('admin-chat-inp'); if(!inp) return;
  var txt=inp.value.trim(); if(!txt) return;
  var now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  chatLog.push({sender:'Dr. Prep (Admin)',init:'ADMIN',txt:'üì¢ '+txt,t:now,me:false});
  inp.value=''; 
  saveChat();
  renderMsgs();
  renderAdminMsgs();
  
  // Add notification
  addNotification('admin', 'Admin: ' + txt);
  
  toast('‚úÖ Message sent to all students!');
}

function saveChat() {
  try { localStorage.setItem('np_chat', JSON.stringify(chatLog)); } catch(x){}
}

function loadChat() {
  try { 
    var d=localStorage.getItem('np_chat'); 
    if(d) chatLog=JSON.parse(d);
    else chatLog = defaultMsgs.slice();
  } catch(x){
    chatLog = defaultMsgs.slice();
  }
}

// =========================================================
// MOCK EXAM ‚Äî ADMIN
// =========================================================
function renderAdminMockTab() {
  // Populate settings inputs
  var ti=document.getElementById('mock-title-inp'); if(ti) ti.value=mockSettings.title||'NMCN Mock Exam 2025';
  var tl=document.getElementById('mock-time-inp'); if(tl) tl.value=mockSettings.timeLimit||120;
  var pm=document.getElementById('mock-pass-inp'); if(pm) pm.value=mockSettings.passMark||50;
  var mq=document.getElementById('mock-maxq-inp'); if(mq) mq.value=mockSettings.maxQ||250;
  var pr=document.getElementById('mock-pro-inp'); if(pr) pr.value=mockSettings.requirePro||'yes';
  // Stats
  var qc=document.getElementById('adm-mock-qcount'); if(qc) qc.textContent=MOCK_DB.length;
  var att=document.getElementById('adm-mock-attempts'); if(att) att.textContent=mockHistory.length;
  var passed=mockHistory.filter(function(h){ return h.passed; }).length;
  var pr2=document.getElementById('adm-mock-passrate');
  if(pr2) pr2.textContent=mockHistory.length>0?Math.round((passed/mockHistory.length)*100)+'%':'‚Äî';
  // Recent attempts (show bank version)
  var list=document.getElementById('adm-mock-attempts-list');
  if(list){
    if(mockHistory.length===0){ list.innerHTML='<p style="color:var(--mt);font-size:14px">No attempts yet.</p>'; }
    else {
      list.innerHTML=mockHistory.slice().reverse().slice(0,20).map(function(h){
        var d=new Date(h.date).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
        var col=h.passed?'var(--ok)':'var(--red)';
        var bank=MOCK_BANKS.find(function(b){ return b.id===h.bankId; });
        var bankLabel=bank?bank.title:(h.bankVersion||'');
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--bg)">'+
          '<div><div style="font-weight:600;font-size:14px">'+(h.name||'Student')+'</div>'+
          '<div style="font-size:12px;color:var(--mt)">'+d+' ¬∑ '+(h.timeTaken||'')+(bankLabel?' ¬∑ <span style=\"color:var(--g)\">'+bankLabel+'</span>':'')+'</div></div>'+
          '<div style="text-align:right"><div style="font-size:18px;font-weight:700;color:'+col+'">'+h.pct+'%</div>'+
          '<div style="font-size:11px;font-weight:700;color:'+col+'">'+(h.passed?'PASS':'FAIL')+'</div></div>'+
          '</div>';
      }).join('');
    }
  }
  // Rotation interval selector sync
  var rotInp = document.getElementById('mock-rotation-interval');
  if(rotInp) rotInp.value = mockSchedule.intervalHours || 24;
  // Show current next-rotation time in the datetime input as placeholder
  var nextTimeEl = document.getElementById('mock-next-update-time');
  if(nextTimeEl && mockSchedule.nextRotationTs > Date.now()) {
    var d = new Date(mockSchedule.nextRotationTs);
    var pad = function(n){ return n < 10 ? '0'+n : n; };
    nextTimeEl.placeholder = d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());
  }
  // Bank archive
  renderBankArchive();
  updateRotationCountdowns();
}

function saveMockSettingsFn() {
  var ti=document.getElementById('mock-title-inp');
  var tl=document.getElementById('mock-time-inp');
  var pm=document.getElementById('mock-pass-inp');
  var mq=document.getElementById('mock-maxq-inp');
  var pr=document.getElementById('mock-pro-inp');
  if(ti) mockSettings.title=ti.value.trim()||'NMCN Mock Exam 2025';
  if(tl) mockSettings.timeLimit=Math.max(10,parseInt(tl.value)||120);
  if(pm) mockSettings.passMark=Math.min(100,Math.max(1,parseInt(pm.value)||50));
  if(mq) mockSettings.maxQ=Math.max(10,parseInt(mq.value)||250);
  if(pr) mockSettings.requirePro=pr.value||'yes';
  saveMockSettings();
  var msg=document.getElementById('mock-settings-msg');
  if(msg){ msg.innerHTML='<div class="al al-ok">‚úÖ Settings saved!</div>'; setTimeout(function(){ msg.innerHTML=''; },2500); }
}

function handleMockFileUpload(input) {
  var file=input.files&&input.files[0]; if(!file) return;
  var reader=new FileReader();
  reader.onload=function(ev){ var ta=document.getElementById('mock-qpaste'); if(ta) ta.value=ev.target.result; toast('‚úÖ File loaded. Click Parse & Preview.'); };
  reader.onerror=function(){ toast('‚ö† Could not read file.'); };
  reader.readAsText(file);
}

function parseMockAndPreview() {
  var text=(document.getElementById('mock-qpaste')||{}).value||'';
  if(!text.trim()){ toast('‚ö† Paste questions first.'); return; }
  var ansText=(document.getElementById('mock-answer-paste')||{}).value||'';
  var hasKey=ansText.trim().length>0;
  mockParsedBuffer=parseQuestions(text, hasKey);
  if(hasKey && mockParsedBuffer.length>0){
    var key=parseAnswerKey(ansText);
    if(key.length>0){ mockParsedBuffer.forEach(function(q,i){ if(i<key.length){ var idx=['A','B','C','D'].indexOf(key[i]); if(idx>=0) q.c=idx; } }); }
  }
  var prev=document.getElementById('mock-parse-preview');
  var res=document.getElementById('mock-parse-result');
  if(mockParsedBuffer.length===0){
    if(res) res.innerHTML='<div class="al al-err">‚ö† Could not detect questions. Check format.</div>';
    if(prev) prev.style.display='block'; return;
  }
  var limit=mockSettings.maxQ||250;
  var shown=mockParsedBuffer.slice(0,limit);
  if(res) res.innerHTML='<div style="font-weight:700;color:var(--g);margin-bottom:10px">‚úÖ Found '+mockParsedBuffer.length+' question(s)'+(mockParsedBuffer.length>limit?' ‚Äî first '+limit+' will be used':'')+' :</div>'+
    shown.slice(0,5).map(function(q,i){ return '<div class="pq-item"><div class="pq-q">'+(i+1)+'. '+q.q+'</div><div style="font-size:12px;color:var(--g);font-weight:700">‚úì Answer: '+['A','B','C','D'][q.c]+'</div></div>'; }).join('')+
    (shown.length>5?'<div style="font-size:12px;color:var(--mt);padding:8px 0">...and '+(shown.length-5)+' more questions</div>':'');
  if(prev) prev.style.display='block';
}

function confirmMockImport() {
  var limit = mockSettings.maxQ || 250;
  var questions = mockParsedBuffer.slice(0, limit);
  mockParsedBuffer = [];

  // Get custom title if provided
  var titleInp = document.getElementById('mock-bank-title-inp');
  var bankTitle = titleInp && titleInp.value.trim()
    ? titleInp.value.trim()
    : 'Mock Exam ‚Äî ' + new Date().toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'});

  // Create a new bank version
  var newBank = {
    id: 'bank_' + Date.now(),
    title: bankTitle,
    questions: questions,
    qCount: questions.length,
    createdAt: Date.now()
  };
  MOCK_BANKS.push(newBank);
  saveMockBanks();

  // Set as active bank and sync MOCK_DB
  mockSchedule.activeBankIdx = MOCK_BANKS.length - 1;
  var now = Date.now();
  mockSchedule.rotationStartTs = now;
  if(mockSchedule.intervalHours && mockSchedule.intervalHours > 0) {
    mockSchedule.nextRotationTs = now + mockSchedule.intervalHours * 3600 * 1000;
  }
  saveMockSchedule();

  MOCK_DB = questions;
  saveMockDB();

  // Clear UI
  var ta = document.getElementById('mock-qpaste'); if(ta) ta.value = '';
  var ak = document.getElementById('mock-answer-paste'); if(ak) ak.value = '';
  if(titleInp) titleInp.value = '';
  var prev = document.getElementById('mock-parse-preview'); if(prev) prev.style.display = 'none';
  var msg = document.getElementById('mock-import-msg');
  if(msg) {
    msg.innerHTML = '<div class="al al-ok">‚úÖ <strong>' + bankTitle + '</strong> published ‚Äî ' + questions.length + ' questions (v' + MOCK_BANKS.length + ').</div>';
    setTimeout(function(){ msg.innerHTML=''; }, 5000);
  }

  // Notify students
  addNotification('admin', 'üìÖ New Mock Exam available: ' + bankTitle);

  renderAdminMockTab();
  toast('üè• New exam bank published: ' + questions.length + ' Qs');
}

function cancelMockImport() {
  mockParsedBuffer=[];
  var prev=document.getElementById('mock-parse-preview'); if(prev) prev.style.display='none';
  var ta=document.getElementById('mock-qpaste'); if(ta) ta.value='';
}

// =========================================================
// MOCK EXAM ‚Äî STUDENT FLOW
// =========================================================
function goMockExam() { go('mock-lobby'); }

function updateMockHomeCard() {
  var card=document.getElementById('mock-home-card');
  var overlay=document.getElementById('mock-locked-overlay');
  if(!overlay) return;
  var needPro=mockSettings.requirePro==='yes';
  overlay.style.display=(needPro&&!isPro)?'flex':'none';
}

function renderMockLobby() {
  var t=document.getElementById('mock-lobby-title'); if(t) t.textContent=mockSettings.title||'NMCN Mock Exam';
  var tm=document.getElementById('mock-lobby-time'); if(tm) tm.textContent=(mockSettings.timeLimit||120)+' min';
  var pm=document.getElementById('mock-lobby-pass'); if(pm) pm.textContent=(mockSettings.passMark||50)+'%';
  var qc=document.getElementById('mock-lobby-qcount'); if(qc) qc.textContent=Math.min(MOCK_DB.length, mockSettings.maxQ||250);
  var noq=document.getElementById('mock-lobby-noq'); if(noq) noq.style.display=(MOCK_DB.length===0)?'block':'none';
  var startBtn=document.getElementById('mock-start-btn');
  var needPro=mockSettings.requirePro==='yes';
  var locked=document.getElementById('mock-lobby-locked');
  var startWrap=document.getElementById('mock-lobby-start');
  if(needPro&&!isPro){
    if(locked) locked.style.display='block';
    if(startWrap) startWrap.style.display='none';
  } else {
    if(locked) locked.style.display='none';
    if(startWrap) startWrap.style.display='block';
    if(startBtn) startBtn.disabled=MOCK_DB.length===0;
  }
  // Last attempt text
  var la=document.getElementById('mock-last-attempt');
  if(la&&mockHistory.length>0){
    var last=mockHistory[mockHistory.length-1];
    var d=new Date(last.date).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    la.textContent='Your last attempt: '+last.pct+'% on '+d+' ('+(last.passed?'PASS':'FAIL')+')';
  }
  // Rotation schedule display
  var schedDisp = document.getElementById('mock-schedule-display');
  var bank = getActiveBank();
  if(schedDisp) schedDisp.style.display = bank ? 'block' : 'none';
  var lobbyVer = document.getElementById('lobby-bank-version');
  if(lobbyVer) lobbyVer.textContent = getActiveBankVersion();
  var lobbyQc = document.getElementById('lobby-bank-qcount');
  if(lobbyQc && bank) lobbyQc.textContent = Math.min(bank.qCount||0, mockSettings.maxQ||250) + ' questions';
  updateRotationCountdowns();
  // Bank title in schedule card
  var lobbyTitle2 = document.getElementById('lobby-bank-version');
  if(lobbyTitle2 && bank) lobbyTitle2.textContent = bank.title || getActiveBankVersion();
  // Show/hide new-exam banner based on session flag
  var banner = document.getElementById('mock-new-banner');
  if(banner && !_newBannerShown) banner.style.display = 'none';
  // History
  renderLobbyHistory();
  // Auto-rotation check
  checkMockRotation();
}

function startMockExam() {
  if(MOCK_DB.length===0){ toast('‚ö† No mock exam questions available yet.'); return; }
  var limit=Math.min(mockSettings.maxQ||250, MOCK_DB.length);
  // Shuffle and slice
  var shuffled=MOCK_DB.slice().sort(function(){ return Math.random()-.5; });
  MX.questions=shuffled.slice(0,limit);
  MX.answers=MX.questions.map(function(){ return -1; });
  MX.flags=MX.questions.map(function(){ return false; });
  MX.currentQ=0;
  MX.totalSecs=(mockSettings.timeLimit||120)*60;
  MX.startTime=Date.now();
  MX.active=true;
  showQuizLoading('NMCN Mock Exam', 'exam', function(){
    renderMockPalette();
    renderMockQuestion();
    startMockTimer();
    go('mock');
  });
}

// ---- TIMER ----
function startMockTimer() {
  clearInterval(MX.timerInterval);
  MX.timerInterval=setInterval(function(){
    MX.totalSecs--;
    updateMockTimerDisplay();
    if(MX.totalSecs<=0){ clearInterval(MX.timerInterval); autoSubmitMock(); }
  }, 1000);
}

function updateMockTimerDisplay() {
  var h=Math.floor(MX.totalSecs/3600);
  var m=Math.floor((MX.totalSecs%3600)/60);
  var s=MX.totalSecs%60;
  var str=(h>0?h+':':'')+(m<10&&h>0?'0':'')+m+':'+(s<10?'0':'')+s;
  var tv=document.getElementById('mock-timer-val'); if(tv) tv.textContent=str;
  var td=document.getElementById('mock-timer-display');
  var tf=document.getElementById('mock-timer-fill');
  var totalSecs=(mockSettings.timeLimit||120)*60;
  var pct=Math.max(0,(MX.totalSecs/totalSecs)*100);
  if(tf){ tf.style.width=pct+'%'; tf.className='mock-timer-fill'+(MX.totalSecs<300?' crit':MX.totalSecs<900?' warn':''); }
  if(td){ td.className='mock-timer'+(MX.totalSecs<300?' crit':MX.totalSecs<900?' warn':''); }
}

function autoSubmitMock() {
  toast('‚è± Time is up! Submitting your exam...');
  setTimeout(submitMockExam, 1500);
}

// ---- QUESTION RENDER ----
function renderMockQuestion() {
  var q=MX.questions[MX.currentQ];
  var total=MX.questions.length;
  var lbl=document.getElementById('mock-qnum-lbl'); if(lbl) lbl.textContent='QUESTION '+(MX.currentQ+1)+' OF '+total;
  var qt=document.getElementById('mock-qtxt'); if(qt) qt.textContent=q.q;
  var opts=document.getElementById('mock-opts');
  var chosen=MX.answers[MX.currentQ];
  if(opts){
    opts.innerHTML=q.o.map(function(opt,i){
      var sel=chosen===i?' sel':'';
      return '<div class="mock-opt'+sel+'" id="mopt'+i+'" onclick="pickMockAns('+i+')">'+
        '<div class="mock-oltr" id="mol'+i+'">'+['A','B','C','D'][i]+'</div>'+opt+'</div>';
    }).join('');
  }
  // Flag button
  var fb=document.getElementById('mock-flag-btn');
  if(fb){ fb.className='mock-flag-btn'+(MX.flags[MX.currentQ]?' on':''); fb.textContent=MX.flags[MX.currentQ]?'üö© Flagged':'üö© Flag'; }
  // Nav buttons
  var prev=document.getElementById('mock-prev-btn'); if(prev) prev.disabled=MX.currentQ===0;
  var next=document.getElementById('mock-next-btn'); if(next) next.textContent=MX.currentQ+1>=total?'Last Q ‚Üí':'Next ‚Üí';
  // Palette highlight
  updateMockPaletteDot(MX.currentQ);
  // Scroll to top of body
  var body=document.getElementById('mock-body'); if(body) body.scrollTop=0;
  // Counts
  var ac=document.getElementById('mock-answered-count'); if(ac) ac.textContent=MX.answers.filter(function(a){ return a!==-1; }).length;
  var tc=document.getElementById('mock-total-count'); if(tc) tc.textContent=total;
  var fc=document.getElementById('mock-flagged-count'); if(fc) fc.textContent=MX.flags.filter(Boolean).length;
}

function pickMockAns(i) {
  MX.answers[MX.currentQ]=i;
  // Update option UI
  var q=MX.questions[MX.currentQ];
  q.o.forEach(function(opt,j){
    var el=document.getElementById('mopt'+j);
    var lt=document.getElementById('mol'+j);
    if(!el||!lt) return;
    el.className='mock-opt'+(j===i?' sel':'');
    lt.style.background=j===i?'#3B82F6':''; lt.style.borderColor=j===i?'#3B82F6':'';lt.style.color=j===i?'#fff':'';
  });
  updateMockPaletteDot(MX.currentQ);
  var ac=document.getElementById('mock-answered-count'); if(ac) ac.textContent=MX.answers.filter(function(a){ return a!==-1; }).length;
}

function toggleMockFlag() {
  MX.flags[MX.currentQ]=!MX.flags[MX.currentQ];
  var fb=document.getElementById('mock-flag-btn');
  if(fb){ fb.className='mock-flag-btn'+(MX.flags[MX.currentQ]?' on':''); fb.textContent=MX.flags[MX.currentQ]?'üö© Flagged':'üö© Flag'; }
  updateMockPaletteDot(MX.currentQ);
  var fc=document.getElementById('mock-flagged-count'); if(fc) fc.textContent=MX.flags.filter(Boolean).length;
}

function mockNav(dir) {
  var next=MX.currentQ+dir;
  if(next<0||next>=MX.questions.length) return;
  MX.currentQ=next;
  renderMockQuestion();
}

// ---- PALETTE ----
function renderMockPalette() {
  var pal=document.getElementById('mock-palette'); if(!pal) return;
  pal.innerHTML=MX.questions.map(function(q,i){
    return '<div class="mock-dot unanswered" id="mpdot'+i+'" onclick="jumpMockQ('+i+')">'+( i+1)+'</div>';
  }).join('');
  var tc=document.getElementById('mock-total-count'); if(tc) tc.textContent=MX.questions.length;
}

function updateMockPaletteDot(i) {
  var dot=document.getElementById('mpdot'+i); if(!dot) return;
  var answered=MX.answers[i]!==-1;
  var flagged=MX.flags[i];
  var current=i===MX.currentQ;
  dot.className='mock-dot'+(current?' current':answered&&flagged?' flagged answered':flagged?' flagged':answered?' answered':' unanswered');
}

function jumpMockQ(i) {
  MX.currentQ=i;
  renderMockQuestion();
  // Scroll palette dot into view
  var dot=document.getElementById('mpdot'+i); if(dot) dot.scrollIntoView({block:'nearest',inline:'center',behavior:'smooth'});
}

// ---- SUBMIT ----
function promptMockSubmit() {
  var answered=MX.answers.filter(function(a){ return a!==-1; }).length;
  var unanswered=MX.questions.length-answered;
  var flagged=MX.flags.filter(Boolean).length;
  var msg=document.getElementById('mock-submit-msg');
  if(msg) msg.textContent=unanswered>0?'You have '+unanswered+' unanswered question(s). You can still go back and answer them.':'You\'ve answered all questions. Ready to submit?';
  var stats=document.getElementById('mock-submit-stats');
  if(stats){
    var h=Math.floor((MX.totalSecs)/3600), m=Math.floor((MX.totalSecs%3600)/60);
    var rem=(h?h+'h ':'')+m+'m remaining';
    stats.innerHTML='<div class="mock-stat-row"><span class="mock-stat-lbl">Answered</span><span class="mock-stat-val" style="color:#34D399">'+answered+' / '+MX.questions.length+'</span></div>'+
      '<div class="mock-stat-row"><span class="mock-stat-lbl">Unanswered</span><span class="mock-stat-val" style="color:'+(unanswered>0?'#FBBF24':'#34D399')+'">'+unanswered+'</span></div>'+
      '<div class="mock-stat-row"><span class="mock-stat-lbl">Flagged</span><span class="mock-stat-val" style="color:#FCD34D">'+flagged+'</span></div>'+
      '<div class="mock-stat-row"><span class="mock-stat-lbl">Time Remaining</span><span class="mock-stat-val" style="color:#C4B5FD">'+rem+'</span></div>';
  }
  document.getElementById('mock-submit-overlay').style.display='flex';
}

function submitMockExam() {
  clearInterval(MX.timerInterval);
  MX.active=false;
  document.getElementById('mock-submit-overlay').style.display='none';
  // Calculate results
  var correct=0, wrong=0, unanswered=0;
  MX.questions.forEach(function(q,i){
    if(MX.answers[i]===-1) unanswered++;
    else if(MX.answers[i]===q.c) correct++;
    else wrong++;
  });
  var total=MX.questions.length;
  var pct=Math.round((correct/total)*100);
  var passed=pct>=(mockSettings.passMark||50);
  var totalSecsUsed=(mockSettings.timeLimit||120)*60 - MX.totalSecs;
  var hU=Math.floor(totalSecsUsed/3600), mU=Math.floor((totalSecsUsed%3600)/60), sU=totalSecsUsed%60;
  var timeTaken=(hU?hU+'h ':'')+mU+'m '+(sU?sU+'s':'');
  // Save to history
  var activeBank=getActiveBank();
  var rec={ date:new Date().toISOString(), name:ME?ME.name:'Student', score:correct, total:total, pct:pct, passed:passed, timeTaken:timeTaken, bankId:activeBank?activeBank.id:null, bankVersion:activeBank?activeBank.title:null };
  mockHistory.push(rec); saveMockHistory();
  // Save to general quiz history too
  quizHistory.push({ year:'Mock', paper:'NMCN Mock', score:correct, total:total, percentage:pct, mode:'mock', date:rec.date }); savePerformance(); saveStreak();
  renderMockResult(correct, wrong, unanswered, pct, passed, timeTaken);
  go('mock-result');
}

// ---- RESULT ----
function renderMockResult(correct, wrong, unanswered, pct, passed, timeTaken) {
  var col=passed?'#34D399':'#F87171';
  // Score ring animation
  var circle=document.getElementById('mock-res-circle');
  if(circle){ var circum=377; var offset=circum-(pct/100*circum); circle.style.stroke=col; setTimeout(function(){ circle.style.transition='stroke-dashoffset 1.2s ease'; circle.style.strokeDashoffset=offset; },100); }
  var rp=document.getElementById('mock-res-pct'); if(rp){ rp.textContent=pct+'%'; rp.style.color=col; }
  var rn=document.getElementById('mock-res-name'); if(rn) rn.textContent=ME?ME.name:'Student';
  var rv=document.getElementById('mock-res-verdict'); if(rv){ rv.textContent=passed?'‚úÖ PASS':'‚ùå FAIL'; rv.style.color=col; }
  var rs=document.getElementById('mock-res-verdict-sub');
  if(rs) rs.textContent=passed?'Congratulations! You passed the NMCN Mock Exam.':'You did not reach the pass mark. Review your answers and try again.';
  var rc=document.getElementById('mock-res-correct'); if(rc) rc.textContent=correct;
  var rw=document.getElementById('mock-res-wrong'); if(rw) rw.textContent=wrong;
  var ru=document.getElementById('mock-res-unanswered'); if(ru) ru.textContent=unanswered;
  var rt=document.getElementById('mock-res-time'); if(rt) rt.textContent=timeTaken;
  var note=document.getElementById('mock-res-note');
  if(note) note.innerHTML='<span style="color:#9CA3AF">Pass mark:</span> <strong style="color:#F9FAFB">'+(mockSettings.passMark||50)+'%</strong> &nbsp;¬∑&nbsp; <span style="color:#9CA3AF">Your score:</span> <strong style="color:'+col+'">'+pct+'%</strong> &nbsp;¬∑&nbsp; '+
    (passed?'<span style="color:#34D399">You exceeded the pass mark by '+(pct-(mockSettings.passMark||50))+'%</span>':'<span style="color:#F87171">You need '+(mockSettings.passMark||50-pct)+'% more to pass</span>');
}

// ---- ANSWER REVIEW ----
var _mockReviewFilter='all';
function renderMockAnswerReview(filter) {
  _mockReviewFilter=filter;
  var sub=document.getElementById('mock-ar-sub');
  var body=document.getElementById('mock-answer-review-body'); if(!body) return;
  var qs=MX.questions; var ans=MX.answers; var flags=MX.flags;
  var items=qs.map(function(q,i){ return { q:q, chosen:ans[i], flagged:flags[i], idx:i }; });
  if(filter==='wrong') items=items.filter(function(it){ return it.chosen!==-1&&it.chosen!==it.q.c; });
  else if(filter==='correct') items=items.filter(function(it){ return it.chosen===it.q.c; });
  else if(filter==='unanswered') items=items.filter(function(it){ return it.chosen===-1; });
  else if(filter==='flagged') items=items.filter(function(it){ return it.flagged; });
  if(sub) sub.textContent=items.length+' question'+(items.length!==1?'s':'')+(filter!=='all'?' ¬∑ '+filter:'');
  if(items.length===0){ body.innerHTML='<div style="text-align:center;padding:40px;color:#6B7280"><div style="font-size:48px;margin-bottom:12px">üéâ</div><div>No questions in this category.</div></div>'; return; }
  var letters=['A','B','C','D'];
  body.innerHTML=items.map(function(it){
    var q=it.q; var chosen=it.chosen;
    var isRight=chosen===q.c; var isUnans=chosen===-1;
    var badge=isUnans?'<span style="color:#FBBF24;font-size:11px;font-weight:700">‚Äî UNANSWERED</span>':isRight?'<span style="color:#34D399;font-size:11px;font-weight:700">‚úì CORRECT</span>':'<span style="color:#F87171;font-size:11px;font-weight:700">‚úó INCORRECT</span>';
    var flagBadge=it.flagged?'<span style="color:#FCD34D;font-size:11px;margin-left:6px">üö©</span>':'';
    return '<div class="mock-review-item" style="background:'+(isUnans?'rgba(251,191,36,.04)':isRight?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)')+';border-bottom:1px solid #1F2937">'+
      '<div class="mock-review-item-top">'+
      '<div class="mock-review-item-num">Q'+(it.idx+1)+'</div>'+
      '<div style="flex:1"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">'+badge+flagBadge+'</div><div class="mock-review-item-q">'+q.q+'</div></div>'+
      '</div>'+
      '<div class="mock-review-opts">'+
      q.o.map(function(opt,oi){
        var isCorrectOpt=oi===q.c; var isChosenOpt=oi===chosen;
        var cls='mock-review-opt '; var prefix='';
        if(isCorrectOpt){ cls+='cor'; prefix='‚úì '; }
        else if(isChosenOpt&&!isRight){ cls+='wrg'; prefix='‚úó '; }
        else { cls+='neu'; }
        var notes='';
        if(isChosenOpt&&!isRight) notes=' <span style="opacity:.7;font-size:11px">(your answer)</span>';
        if(isCorrectOpt&&isRight) notes=' <span style="opacity:.7;font-size:11px">(your answer ‚úì)</span>';
        if(isCorrectOpt&&!isRight) notes=' <span style="opacity:.7;font-size:11px">(correct)</span>';
        return '<div class="'+cls+'"><strong>'+letters[oi]+'.</strong> '+opt+notes+'</div>';
      }).join('')+
      '</div>'+
      (isUnans?'':'<div class="mock-review-expl">üí° '+q.e+'</div>')+
      '</div>';
  }).join('');
}

function filterMockReview(filter, btn) {
  document.querySelectorAll('#pg-mock-answer-review .fchip').forEach(function(b){ b.classList.remove('on'); b.style.background='#1F2937'; });
  btn.classList.add('on'); btn.style.background='#374151';
  renderMockAnswerReview(filter);
}

// =========================================================
// MOCK EXAM ‚Äî PERFORMANCE ANALYTICS (add mock to history)
// =========================================================
// =========================================================
// PERFORMANCE ANALYTICS
// =========================================================

function switchPerfTab(name, btn) {
  document.querySelectorAll('.perf-tab-panel').forEach(function(p){ p.classList.remove('on'); });
  document.querySelectorAll('.perf-tab-btn').forEach(function(b){ b.classList.remove('on'); });
  var panel = document.getElementById('ptab-' + name);
  if(panel) panel.classList.add('on');
  if(btn) btn.classList.add('on');
}

// ---- STREAK ----
function getStreakData() {
  var today = new Date(); today.setHours(0,0,0,0);
  var days = [];
  for(var i=6; i>=0; i--){
    var d = new Date(today); d.setDate(d.getDate()-i);
    days.push(d.getTime());
  }
  // Check which days had quiz activity
  var activeDays = {};
  quizHistory.forEach(function(q){
    var d = new Date(q.date); d.setHours(0,0,0,0);
    activeDays[d.getTime()] = true;
  });
  // Compute current streak (consecutive days backwards from today)
  var streak = 0;
  var checkDate = new Date(today);
  while(true){
    if(activeDays[checkDate.getTime()]){
      streak++;
      checkDate.setDate(checkDate.getDate()-1);
    } else { break; }
  }
  // Best streak
  var allDates = Object.keys(activeDays).map(Number).sort();
  var best = 0, cur = 0;
  for(var i=0; i<allDates.length; i++){
    if(i===0){ cur=1; }
    else {
      var diff = (allDates[i]-allDates[i-1])/(86400000);
      cur = diff===1 ? cur+1 : 1;
    }
    if(cur>best) best=cur;
  }
  return { streak: streak, best: Math.max(best, streak), days: days, activeDays: activeDays, todayTs: today.getTime() };
}

function renderStreak() {
  var data = getStreakData();
  var sc = document.getElementById('streak-count');
  var sb = document.getElementById('streak-best');
  var sm = document.getElementById('streak-msg');
  var sd = document.getElementById('streak-days');
  if(sc) sc.textContent = data.streak;
  if(sb) sb.textContent = data.best > 0 ? 'üèÜ Best: '+data.best+' days' : '';
  if(sm){
    if(data.streak === 0) sm.textContent = 'Start today!';
    else if(data.streak === 1) sm.textContent = 'Great start! üå±';
    else if(data.streak < 5) sm.textContent = 'Keep it going! üí™';
    else if(data.streak < 10) sm.textContent = "You're on fire! üî•";
    else sm.textContent = 'Unstoppable! üèÜ';
  }
  if(sd){
    var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    sd.innerHTML = data.days.map(function(ts){
      var d = new Date(ts);
      var isToday = ts === data.todayTs;
      var isDone = data.activeDays[ts];
      var cls = isToday ? 'sday today' : (isDone ? 'sday done' : 'sday miss');
      var ico = isToday ? (isDone?'‚úÖ':'üìÖ') : (isDone?'‚úì':'¬∑');
      return '<div class="'+cls+'"><span>'+ico+'</span><span class="sday-lbl">'+dayNames[d.getDay()]+'</span></div>';
    }).join('');
  }
}

// ---- SUBJECT BREAKDOWN ----
function getSubjectStats() {
  var subjects = { 'Paper 1': {correct:0,total:0,sessions:0}, 'Paper 2': {correct:0,total:0,sessions:0}, 'OSCE': {correct:0,total:0,sessions:0} };
  quizHistory.forEach(function(q){
    var key = q.paper;
    if(subjects[key]){
      subjects[key].correct += q.score;
      subjects[key].total += q.total;
      subjects[key].sessions++;
    }
  });
  return subjects;
}

function renderSubjectBreakdown() {
  var el = document.getElementById('subject-breakdown');
  if(!el) return;
  if(quizHistory.length === 0){ el.innerHTML='<div class="empty-state"><div class="empty-state-ico">üìã</div><div style="font-size:14px">Complete quizzes to see subject breakdown</div></div>'; return; }
  var stats = getSubjectStats();
  var papers = ['Paper 1','Paper 2','OSCE'];
  var colors = { 'Paper 1': '#0A6E4E', 'Paper 2': '#3B82F6', 'OSCE': '#F59E0B' };
  el.innerHTML = papers.map(function(paper){
    var s = stats[paper];
    if(s.total === 0) return '';
    var pct = Math.round((s.correct/s.total)*100);
    var barColor = pct>=70 ? '#22C55E' : (pct>=50 ? '#F59E0B' : '#EF4444');
    return '<div class="subject-row">'+
      '<div class="subject-name">'+paper+'</div>'+
      '<div class="subject-bar-wrap"><div class="subject-bar" style="width:'+pct+'%;background:'+barColor+'"></div></div>'+
      '<div class="subject-pct" style="color:'+barColor+'">'+pct+'%</div>'+
      '<div class="subject-count">'+s.correct+'/'+s.total+'</div>'+
      '</div>';
  }).filter(Boolean).join('') || '<div class="empty-state"><div style="font-size:14px;color:var(--mt)">No data yet</div></div>';
}

// ---- RECOMMENDATIONS ----
function renderRecommendations() {
  var el = document.getElementById('recommendations');
  if(!el) return;
  if(quizHistory.length === 0){ el.innerHTML='<div class="empty-state"><div class="empty-state-ico">üéØ</div><div style="font-size:14px">Complete quizzes to get recommendations</div></div>'; return; }
  var stats = getSubjectStats();
  var papers = Object.keys(stats).filter(function(p){ return stats[p].total > 0; });
  if(papers.length === 0){ el.innerHTML='<div class="empty-state"><div style="font-size:14px;color:var(--mt)">No data yet</div></div>'; return; }
  
  var sorted = papers.map(function(p){
    var s = stats[p];
    return { paper: p, pct: Math.round((s.correct/s.total)*100) };
  }).sort(function(a,b){ return a.pct - b.pct; });
  
  var weakest = sorted[0];
  var strongest = sorted[sorted.length-1];
  var mid = sorted.length > 2 ? sorted[1] : null;
  
  var html = '<div style="margin-bottom:12px">';
  html += '<div style="font-size:12px;font-weight:700;color:var(--mt);margin-bottom:8px;letter-spacing:.5px">NEEDS ATTENTION</div>';
  html += '<button class="recommend-chip rc-weak" onclick="toast(\'Start practicing '+weakest.paper+'!\')">‚ö†Ô∏è '+weakest.paper+' ‚Äî '+weakest.pct+'%</button>';
  if(mid) html += '<button class="recommend-chip rc-mid" onclick="toast(\'Keep working on '+mid.paper+'!\')">üìà '+mid.paper+' ‚Äî '+mid.pct+'%</button>';
  html += '</div>';
  html += '<div style="margin-bottom:10px">';
  html += '<div style="font-size:12px;font-weight:700;color:var(--mt);margin-bottom:8px;letter-spacing:.5px">YOUR STRENGTH</div>';
  html += '<button class="recommend-chip rc-strong" onclick="toast(\'Great work on '+strongest.paper+'!\')">‚≠ê '+strongest.paper+' ‚Äî '+strongest.pct+'%</button>';
  html += '</div>';
  
  // Personalized tip
  var tip = weakest.pct < 50
    ? 'üìå Focus heavily on <strong>'+weakest.paper+'</strong> ‚Äî you\'re below 50%. Review explanations carefully after each answer.'
    : weakest.pct < 70
    ? 'üìå <strong>'+weakest.paper+'</strong> needs more practice. Aim for 70%+ before exam day.'
    : '‚úÖ All subjects are above 70%! Keep maintaining your streak.';
  html += '<div style="background:var(--bg);border-radius:12px;padding:12px;font-size:13px;line-height:1.6;color:var(--tx)">'+tip+'</div>';
  el.innerHTML = html;
}

// ---- YEAR BREAKDOWN ----
function renderYearBreakdown() {
  var el = document.getElementById('year-breakdown');
  if(!el) return;
  if(quizHistory.length === 0){ el.innerHTML='<div class="empty-state"><div class="empty-state-ico">üìÖ</div><div style="font-size:14px">No year data yet</div></div>'; return; }
  
  var yearStats = {};
  quizHistory.forEach(function(q){
    if(!yearStats[q.year]) yearStats[q.year] = {correct:0,total:0};
    yearStats[q.year].correct += q.score;
    yearStats[q.year].total += q.total;
  });
  
  var years = Object.keys(yearStats).sort(function(a,b){ return b-a; });
  el.innerHTML = years.map(function(yr){
    var s = yearStats[yr];
    var pct = Math.round((s.correct/s.total)*100);
    var color = pct>=70 ? 'var(--ok)' : (pct>=50 ? 'var(--gold)' : 'var(--red)');
    return '<div class="year-row">'+
      '<div class="year-badge">'+yr+'</div>'+
      '<div class="year-detail">'+s.correct+' / '+s.total+' correct</div>'+
      '<div class="year-pct" style="color:'+color+'">'+pct+'%</div>'+
      '</div>';
  }).join('');
}

// ---- PAPER DETAIL TABS ----
function renderPaperDetail(paper, containerId) {
  var el = document.getElementById(containerId);
  if(!el) return;
  var sessions = quizHistory.filter(function(q){ return q.paper === paper; });
  if(sessions.length === 0){ el.innerHTML='<div class="empty-state"><div style="font-size:13px;color:var(--mt)">No '+paper+' sessions yet</div></div>'; return; }
  var total = sessions.reduce(function(s,q){ return s+q.total; },0);
  var correct = sessions.reduce(function(s,q){ return s+q.score; },0);
  var avg = Math.round((correct/total)*100);
  var best = Math.max.apply(null, sessions.map(function(q){ return q.percentage; }));
  var color = avg>=70?'var(--ok)':(avg>=50?'var(--gold)':'var(--red)');
  el.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">'+
    '<div style="text-align:center;background:var(--bg);border-radius:10px;padding:10px"><div style="font-family:\'Playfair Display\',serif;font-size:20px;color:'+color+'">'+avg+'%</div><div style="font-size:10px;color:var(--mt)">Avg</div></div>'+
    '<div style="text-align:center;background:var(--bg);border-radius:10px;padding:10px"><div style="font-family:\'Playfair Display\',serif;font-size:20px;color:var(--ok)">'+best+'%</div><div style="font-size:10px;color:var(--mt)">Best</div></div>'+
    '<div style="text-align:center;background:var(--bg);border-radius:10px;padding:10px"><div style="font-family:\'Playfair Display\',serif;font-size:20px;color:var(--g)">'+sessions.length+'</div><div style="font-size:10px;color:var(--mt)">Sessions</div></div>'+
    '</div>'+
    '<div style="font-size:12px;font-weight:700;color:var(--mt);margin-bottom:8px">RECENT SESSIONS</div>'+
    sessions.slice(-5).reverse().map(function(q){
      var d = new Date(q.date).toLocaleDateString();
      var sc = q.percentage>=70?'var(--ok)':(q.percentage>=50?'var(--gold)':'var(--red)');
      return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--bg)">'+
        '<div><div style="font-size:13px;font-weight:600">'+q.year+'</div><div style="font-size:11px;color:var(--mt)">'+d+'</div></div>'+
        '<div style="font-size:16px;font-weight:700;color:'+sc+'">'+q.percentage+'%</div>'+
        '</div>';
    }).join('');
}

// ---- QUIZ HISTORY ----
function renderQuizHistory() {
  var histEl = document.getElementById('quiz-history');
  if(!histEl) return;
  if(quizHistory.length === 0){
    histEl.innerHTML='<div class="empty-state"><div class="empty-state-ico">üìù</div><div style="font-size:14px">No quizzes taken yet. Start practicing!</div></div>';
    return;
  }
  histEl.innerHTML = quizHistory.slice().reverse().map(function(q, idx){
    var date = new Date(q.date).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    var time = new Date(q.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    var scoreColor = q.percentage >= 70 ? 'var(--ok)' : (q.percentage >= 50 ? 'var(--gold)' : 'var(--red)');
    var medal = q.percentage >= 90 ? 'ü•á' : q.percentage >= 70 ? 'ü•à' : q.percentage >= 50 ? 'ü•â' : 'üìö';
    return '<div style="padding:12px 16px;border-bottom:1px solid var(--bg);display:flex;align-items:center;gap:12px">'+
      '<div style="font-size:22px">'+medal+'</div>'+
      '<div style="flex:1">'+
      '<div style="font-weight:600;font-size:14px">'+q.year+' ‚Äî '+q.paper+'</div>'+
      '<div style="font-size:11px;color:var(--mt)">'+date+' at '+time+' ¬∑ '+q.score+'/'+q.total+' correct</div>'+
      '</div>'+
      '<div style="text-align:right">'+
      '<div style="font-size:20px;font-weight:700;color:'+scoreColor+'">'+q.percentage+'%</div>'+
      '<div style="font-size:10px;color:var(--mt)">'+(q.percentage>=70?'Pass':'Review')+'</div>'+
      '</div></div>';
  }).join('');
}

// ---- TIME STATS ----
function renderTimeStats() {
  var totalAns = quizHistory.reduce(function(s,q){ return s+q.total; },0);
  var totalCorrect = quizHistory.reduce(function(s,q){ return s+q.score; },0);
  var best = quizHistory.length > 0 ? Math.max.apply(null, quizHistory.map(function(q){ return q.percentage; })) : null;
  
  // Most studied paper
  var paperCount = {};
  quizHistory.forEach(function(q){ paperCount[q.paper] = (paperCount[q.paper]||0)+1; });
  var favPaper = Object.keys(paperCount).sort(function(a,b){ return paperCount[b]-paperCount[a]; })[0];
  
  // This week
  var oneWeekAgo = Date.now() - 7*24*60*60*1000;
  var weekQs = quizHistory.filter(function(q){ return new Date(q.date).getTime() > oneWeekAgo; }).reduce(function(s,q){ return s+q.total; },0);
  
  var set = function(id, val){ var el=document.getElementById(id); if(el) el.textContent=val; };
  set('ts-sessions', quizHistory.length);
  set('ts-correct', totalCorrect);
  set('ts-best', best !== null ? best+'%' : '‚Äî');
  set('ts-fav', favPaper || '‚Äî');
  set('ts-week', weekQs);
}

// ---- STUDY TIPS ----
function renderStudyTips() {
  var el = document.getElementById('study-tips-content');
  if(!el) return;
  var stats = getSubjectStats();
  var tips = [];
  
  if(quizHistory.length === 0){
    tips = [
      { icon:'üéØ', tip:'Start with a quick 10-question session to get baseline data.' },
      { icon:'üìÖ', tip:'Practice daily ‚Äî even 10 minutes builds a strong streak.' },
      { icon:'üí°', tip:'Read every explanation, even when you get it right.' },
    ];
  } else {
    var totalAns = quizHistory.reduce(function(s,q){ return s+q.total; },0);
    var totalCorrect = quizHistory.reduce(function(s,q){ return s+q.score; },0);
    var avg = totalAns>0 ? Math.round((totalCorrect/totalAns)*100) : 0;
    
    if(avg < 50) tips.push({ icon:'‚ö†Ô∏è', tip:'Your average is below 50%. Focus on understanding concepts before memorizing answers.' });
    else if(avg < 70) tips.push({ icon:'üìà', tip:'Good progress! You need 70%+ for a passing score. Review wrong answers carefully.' });
    else tips.push({ icon:'üåü', tip:'Excellent! You\'re above 70%. Focus on consistency and harder topics.' });
    
    // Subject-specific
    Object.keys(stats).forEach(function(paper){
      var s = stats[paper];
      if(s.total===0) return;
      var pct = Math.round((s.correct/s.total)*100);
      if(pct < 60) tips.push({ icon:'üî¥', tip:'<strong>'+paper+'</strong> needs urgent attention ('+pct+'%). Try 3 sessions this week.' });
    });
    
    var data = getStreakData();
    if(data.streak === 0) tips.push({ icon:'üî•', tip:'You haven\'t practiced today. Even one quiz keeps your streak alive!' });
    else if(data.streak >= 3) tips.push({ icon:'üèÜ', tip:'Amazing '+data.streak+'-day streak! Consistency is the #1 predictor of exam success.' });
    
    tips.push({ icon:'‚è∞', tip:'Aim for 20-30 questions per day. Spaced repetition is more effective than cramming.' });
    tips.push({ icon:'üìñ', tip:'After each quiz, review all explanations ‚Äî especially correct answers. Understanding why is key.' });
  }
  
  el.innerHTML = tips.map(function(t){
    return '<div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--bg)">'+
      '<div style="font-size:20px;flex-shrink:0">'+t.icon+'</div>'+
      '<div style="font-size:13px;line-height:1.6;color:var(--tx)">'+t.tip+'</div>'+
      '</div>';
  }).join('');
}

function renderPerformance() {
  var totalAns = quizHistory.reduce(function(sum,q){ return sum+q.total; },0);
  var totalCorrect = quizHistory.reduce(function(sum,q){ return sum+q.score; },0);
  var avgScore = totalAns > 0 ? Math.round((totalCorrect/totalAns)*100)+'%' : '‚Äî';
  
  // Hero
  var pans=document.getElementById('perf-ans'); if(pans) pans.textContent=totalAns;
  var pavg=document.getElementById('perf-avg'); if(pavg) pavg.textContent=avgScore;
  var psess=document.getElementById('perf-sessions'); if(psess) psess.textContent=quizHistory.length;
  
  // Last active
  var la=document.getElementById('perf-last-active');
  if(la){
    if(quizHistory.length>0){
      var last=new Date(quizHistory[quizHistory.length-1].date);
      la.textContent='Last active: '+last.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    } else { la.textContent='Start your first quiz to see analytics'; }
  }
  
  // All sections
  renderStreak();
  renderSubjectBreakdown();
  renderRecommendations();
  renderYearBreakdown();
  renderPaperDetail('Paper 1','paper1-detail');
  renderPaperDetail('Paper 2','paper2-detail');
  renderPaperDetail('OSCE','osce-detail');
  renderQuizHistory();
  renderTimeStats();
  renderStudyTips();
}

// =========================================================
// NOTIFICATIONS
// =========================================================
function toggleNotif(el, type) {
  var ckbox = el.querySelector('.ckbox');
  if(!ckbox) return;
  ckbox.classList.toggle('on');
  var isOn = ckbox.classList.contains('on');
  ckbox.textContent = isOn ? '‚úì' : '';
  notificationSettings[type] = isOn;
  saveNotifSettings();
}

function requestNotificationPermission() {
  if (!('Notification' in window)) {
    toast('‚ö† Your browser doesn\'t support notifications');
    return;
  }
  if (Notification.permission === 'granted') {
    toast('‚úÖ Notifications already enabled!');
    showNotification('NursePrep', 'You\'ll receive updates here!');
    return;
  }
  if (Notification.permission !== 'denied') {
    Notification.requestPermission().then(function(permission) {
      if (permission === 'granted') {
        toast('‚úÖ Notifications enabled!');
        showNotification('NursePrep', 'You\'ll receive updates here!');
      } else {
        toast('‚ö† Notification permission denied');
      }
    });
  } else {
    toast('‚ö† Please enable notifications in browser settings');
  }
}

function showNotification(title, body) {
  if (Notification.permission === 'granted') {
    new Notification(title, {
      body: body,
      icon: 'üìö',
      badge: 'ü©∫'
    });
  }
}

function addNotification(type, message) {
  var notif = {
    type: type,
    message: message,
    date: new Date().toISOString(),
    read: false
  };
  notifications.unshift(notif);
  if(notifications.length > 50) notifications = notifications.slice(0, 50);
  saveNotifications();
  
  // Show browser notification if enabled
  if(notificationSettings[type] && Notification.permission === 'granted'){
    showNotification('NursePrep', message);
  }
  
  renderNotifications();
}

function renderNotifications() {
  var el = document.getElementById('notif-list');
  if(!el) return;
  if(notifications.length === 0){
    el.innerHTML = '<p style="color:var(--mt);font-size:14px;text-align:center;padding:20px 0">No notifications yet.</p>';
  } else {
    el.innerHTML = notifications.map(function(n, i){
      var date = new Date(n.date).toLocaleString();
      var icon = n.type === 'chat' ? 'üí¨' : (n.type === 'admin' ? 'üì¢' : 'üìù');
      return '<div style="padding:12px;border-bottom:1px solid var(--bg);'+(n.read?'opacity:0.6':'')+'" onclick="markNotifRead('+i+')">'+
        '<div style="display:flex;gap:10px">'+
        '<div style="font-size:20px">'+icon+'</div>'+
        '<div style="flex:1">'+
        '<div style="font-size:14px;'+(n.read?'':'font-weight:600')+'">'+n.message+'</div>'+
        '<div style="font-size:12px;color:var(--mt);margin-top:4px">'+date+'</div>'+
        '</div></div></div>';
    }).join('');
  }
}

function markNotifRead(index) {
  if(notifications[index]) {
    notifications[index].read = true;
    saveNotifications();
    renderNotifications();
  }
}

// =========================================================
// CHANGE PASSWORD
// =========================================================
function checkNewPW() {
  var pw = document.getElementById('new-pw');
  if(!pw) return;
  var val = pw.value;
  var str = 0;
  if(val.length >= 8) str++;
  if(/[a-z]/.test(val) && /[A-Z]/.test(val)) str++;
  if(/\d/.test(val)) str++;
  if(/[^a-zA-Z0-9]/.test(val)) str++;
  
  var colors = ['var(--bd)', 'var(--red)', 'var(--gold)', 'var(--ok)', 'var(--ok)'];
  var labels = ['', 'Weak', 'Fair', 'Good', 'Strong'];
  
  ['npb1','npb2','npb3','npb4'].forEach(function(id, i){
    var bar = document.getElementById(id);
    if(bar) bar.style.background = i < str ? colors[str] : colors[0];
  });
  
  var lbl = document.getElementById('npwlbl');
  if(lbl) {
    lbl.textContent = labels[str] || '';
    lbl.style.color = colors[str] || '';
  }
}

function matchNewPW() {
  var pw = document.getElementById('new-pw');
  var cpw = document.getElementById('conf-pw');
  var hint = document.getElementById('match-new-hint');
  if(!pw || !cpw || !hint) return;
  
  if(cpw.value.length === 0) {
    hint.textContent = '';
    hint.style.color = '';
    return;
  }
  
  if(pw.value === cpw.value) {
    hint.textContent = '‚úì Passwords match';
    hint.style.color = 'var(--ok)';
  } else {
    hint.textContent = '‚úó Passwords do not match';
    hint.style.color = 'var(--red)';
  }
}

function changePassword() {
  var curr = document.getElementById('curr-pw');
  var newp = document.getElementById('new-pw');
  var conf = document.getElementById('conf-pw');
  var msg = document.getElementById('pw-change-msg');
  
  if(!curr || !newp || !conf || !msg) return;
  
  // Clear previous errors
  ['curr-pw-err', 'new-pw-err', 'conf-pw-err'].forEach(function(id){ ce(id); });
  msg.innerHTML = '';
  
  var currVal = curr.value;
  var newVal = newp.value;
  var confVal = conf.value;
  
  // Validation
  if(!currVal) {
    document.getElementById('curr-pw-err').textContent = 'Enter current password';
    return;
  }
  
  if(!ME) {
    msg.innerHTML = '<div class="al al-err">‚ö† Not logged in</div>';
    return;
  }
  
  if(currVal !== ME.password) {
    document.getElementById('curr-pw-err').textContent = 'Current password is incorrect';
    return;
  }
  
  if(newVal.length < 8) {
    document.getElementById('new-pw-err').textContent = 'Password must be at least 8 characters';
    return;
  }
  
  if(newVal !== confVal) {
    document.getElementById('conf-pw-err').textContent = 'Passwords do not match';
    return;
  }
  
  // Update password
  ME.password = newVal;
  for(var i=0; i<accounts.length; i++){
    if(accounts[i].id === ME.id){
      accounts[i].password = newVal;
      break;
    }
  }
  saveAcc();
  
  msg.innerHTML = '<div class="al al-ok">‚úÖ Password updated successfully!</div>';
  curr.value = '';
  newp.value = '';
  conf.value = '';
  
  setTimeout(function(){
    go('main', true);
  }, 2000);
}

// =========================================================
// REFERRAL SYSTEM
// =========================================================

// Milestones: { count, label, reward, rewardType }
var REF_MILESTONES = [
  { count: 1, label: '1st Referral',  ico: 'üå±', reward: '+5 Bonus Questions/session', rewardType: 'bonus_q',   bonusVal: 5  },
  { count: 3, label: '3 Referrals',   ico: 'üîì', reward: '1 Extra Year Unlocked',      rewardType: 'year',      bonusVal: 1  },
  { count: 5, label: '5 Referrals',   ico: '‚≠ê', reward: '2 More Years Unlocked',      rewardType: 'year',      bonusVal: 2  },
  { count: 10, label: '10 Referrals', ico: 'üëë', reward: 'Full Pro Access (All Years)', rewardType: 'full_pro',  bonusVal: 0  }
];

var referralData = {
  code: '',           // user's referral code
  referrals: [],      // [{name, username, date, id}]
  claimedMilestones: [], // indices of REF_MILESTONES claimed
  bonusYears: [],     // year strings unlocked via referral
  bonusQPerSession: 0 // extra questions added to FREE_LIM
};

function saveReferral() {
  try { localStorage.setItem('np_referral_' + (ME ? ME.id : 'guest'), JSON.stringify(referralData)); } catch(x){}
}
function loadReferral() {
  if(!ME) return;
  try {
    var d = localStorage.getItem('np_referral_' + ME.id);
    if(d) {
      referralData = JSON.parse(d);
    } else {
      referralData = { code: genRefCode(), referrals: [], claimedMilestones: [], bonusYears: [], bonusQPerSession: 0 };
      saveReferral();
    }
    // Ensure code exists
    if(!referralData.code) { referralData.code = genRefCode(); saveReferral(); }
  } catch(x){
    referralData = { code: genRefCode(), referrals: [], claimedMilestones: [], bonusYears: [], bonusQPerSession: 0 };
  }
}

function genRefCode() {
  var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  var code = 'NP';
  if(ME && ME.firstName) code += ME.firstName.substring(0,2).toUpperCase();
  else {
    for(var i=0;i<2;i++) code += chars[Math.floor(Math.random()*chars.length)];
  }
  for(var j=0;j<4;j++) code += chars[Math.floor(Math.random()*chars.length)];
  return code;
}

// Called when user registers with a referral code
function applyReferralCode(code, newUserName, newUserId) {
  if(!code) return;
  var upperCode = code.trim().toUpperCase();
  // Find the account whose referral code matches
  accounts.forEach(function(acc) {
    if(acc.id === (ME && ME.id)) return; // skip self
    var refKey = 'np_referral_' + acc.id;
    try {
      var d = localStorage.getItem(refKey);
      if(!d) return;
      var refD = JSON.parse(d);
      if((refD.code || '').toUpperCase() !== upperCode) return;
      // Match found ‚Äî add referral
      var alreadyReferred = refD.referrals.some(function(r){ return r.id === newUserId; });
      if(alreadyReferred) return;
      refD.referrals.push({ name: newUserName, username: newUserName, date: new Date().toLocaleDateString('en-GB'), id: newUserId });
      // Check milestones
      var newCount = refD.referrals.length;
      REF_MILESTONES.forEach(function(m, mi) {
        if(newCount >= m.count && refD.claimedMilestones.indexOf(mi) === -1) {
          refD.claimedMilestones.push(mi);
          applyRefReward(refD, m);
        }
      });
      localStorage.setItem(refKey, JSON.stringify(refD));
      // If this is the current user's referral data, update in memory
      if(ME && acc.id === ME.id) referralData = refD;
    } catch(x){}
  });
}

function applyRefReward(refD, milestone) {
  if(milestone.rewardType === 'bonus_q') {
    refD.bonusQPerSession = (refD.bonusQPerSession || 0) + milestone.bonusVal;
  } else if(milestone.rewardType === 'year') {
    // Grant access to locked years
    var allYears = ['2018','2019','2020','2021','2022','2023','2024','2025'];
    var toGrant = allYears.slice(0, milestone.bonusVal + (refD.bonusYears ? refD.bonusYears.length : 0));
    toGrant.forEach(function(yr) {
      if(!refD.bonusYears) refD.bonusYears = [];
      if(refD.bonusYears.indexOf(yr) === -1) refD.bonusYears.push(yr);
    });
  } else if(milestone.rewardType === 'full_pro') {
    // Mark full pro in account
    if(ME) {
      ME.isPro = true; isPro = true;
      accounts.forEach(function(a){ if(a.id === ME.id){ a.isPro=true; a.proCode='REF-EARNED'; }});
      saveAcc();
    }
  }
}

function renderReferralPage() {
  loadReferral();
  var count = referralData.referrals ? referralData.referrals.length : 0;

  // Code display
  var codeEl = document.getElementById('ref-code-display');
  if(codeEl) codeEl.textContent = referralData.code || '‚Äî';

  // Counter
  var countEl = document.getElementById('ref-count-display');
  if(countEl) countEl.textContent = count;

  // Next milestone label
  var nextEl = document.getElementById('ref-next-label');
  if(nextEl) {
    var nextM = null;
    for(var i=0;i<REF_MILESTONES.length;i++){
      if(count < REF_MILESTONES[i].count){ nextM = REF_MILESTONES[i]; break; }
    }
    if(nextM) nextEl.textContent = (nextM.count - count) + ' more to reach ' + nextM.label;
    else nextEl.textContent = 'All milestones reached! üéâ';
  }

  // Milestones
  var msEl = document.getElementById('ref-milestones');
  if(msEl) {
    msEl.innerHTML = REF_MILESTONES.map(function(m, mi) {
      var claimed = referralData.claimedMilestones && referralData.claimedMilestones.indexOf(mi) > -1;
      var isNext = !claimed && (mi === 0 || (referralData.claimedMilestones && referralData.claimedMilestones.indexOf(mi-1) > -1) || count > 0);
      var cls = claimed ? 'done' : (count < m.count && isNext ? 'current' : '');
      var rewardCls = claimed ? 'ref-reward-done' : isNext ? 'ref-reward-current' : 'ref-reward-locked';
      var dotContent = claimed ? '‚úì' : m.ico;
      return '<div class="ref-milestone '+cls+'">'+
        '<div class="ref-milestone-dot">'+dotContent+'</div>'+
        '<div class="ref-milestone-info">'+
          '<div class="ref-milestone-label">'+m.label+(claimed?' <span style="font-size:11px;color:var(--g)">‚Äî Claimed!</span>':'')+'</div>'+
          '<div class="ref-milestone-desc">Invite '+m.count+' friend'+(m.count>1?'s':'')+' to NursePrep</div>'+
          '<span class="ref-milestone-reward '+rewardCls+'">'+(claimed?'‚úÖ ':'')+m.reward+'</span>'+
        '</div>'+
        (claimed?'':'<div style="font-size:14px;font-weight:700;color:var(--mt);min-width:32px;text-align:right">'+count+'/'+m.count+'</div>')+
      '</div>';
    }).join('');
  }

  // Referrals list
  var listEl = document.getElementById('ref-list-body');
  var listCount = document.getElementById('ref-list-count');
  var refs = referralData.referrals || [];
  if(listCount) listCount.textContent = '(' + refs.length + ' total)';
  if(listEl) {
    if(refs.length === 0) {
      listEl.innerHTML = '<div class="empty-state"><div class="empty-state-ico">ü§ù</div><div>No referrals yet.<br><span style="font-size:12px">Share your code to get started!</span></div></div>';
    } else {
      listEl.innerHTML = refs.slice().reverse().map(function(r,i){
        var initial = (r.name||'?').charAt(0).toUpperCase();
        return '<div class="ref-list-item">'+
          '<div class="ref-list-av">'+initial+'</div>'+
          '<div style="flex:1"><div class="ref-list-name">'+r.name+'</div><div class="ref-list-date">Joined '+r.date+'</div></div>'+
          '<span class="ref-list-badge">+1 Referral</span>'+
        '</div>';
      }).join('');
    }
  }

  // Update profile menu badge
  var badge = document.getElementById('ref-menu-badge');
  if(badge && count > 0) badge.innerHTML = '<span style="background:var(--gold);color:var(--gd);font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px">'+count+'</span>';
}

function copyRefCode() {
  var code = referralData.code || '';
  var copiedEl = document.getElementById('ref-code-copied');
  try {
    navigator.clipboard.writeText(code).then(function(){
      if(copiedEl){ copiedEl.classList.add('show'); setTimeout(function(){ copiedEl.classList.remove('show'); }, 1800); }
    });
  } catch(x){
    // fallback
    var ta = document.createElement('textarea');
    ta.value = code; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    if(copiedEl){ copiedEl.classList.add('show'); setTimeout(function(){ copiedEl.classList.remove('show'); }, 1800); }
  }
}

function shareRefLink() {
  var code = referralData.code || '';
  var text = 'ü©∫ I\'m using NursePrep to prepare for my NMCN Exam!\n\nJoin me using my referral code: ' + code + '\n\nSign up at NursePrep and enter this code when registering. We both get rewards! üéÅ';
  if(navigator.share) {
    navigator.share({ title: 'Join NursePrep', text: text }).catch(function(){});
  } else {
    copyTextFallback(text);
    toast('üìã Link copied! Paste it to share.');
  }
}
function shareWhatsApp() {
  var code = referralData.code || '';
  var text = encodeURIComponent('ü©∫ Join NursePrep with my referral code *' + code + '* and we both get rewards!\n\nBest NMCN Exam prep app üí™');
  window.open('https://wa.me/?text=' + text, '_blank');
}
function shareSMS() {
  var code = referralData.code || '';
  var text = encodeURIComponent('Join me on NursePrep! Use my code ' + code + ' when signing up and we both get rewards üéÅ');
  window.open('sms:?body=' + text);
}
function copyTextFallback(text) {
  var ta = document.createElement('textarea');
  ta.value = text; document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); } catch(x){}
  document.body.removeChild(ta);
}

function showRewardOverlay(milestone) {
  document.getElementById('ref-reward-ico').textContent = milestone.ico;
  document.getElementById('ref-reward-title').textContent = 'üéâ ' + milestone.label + ' Reached!';
  document.getElementById('ref-reward-desc').textContent = 'You\'ve unlocked: ' + milestone.reward + '! Keep inviting to reach the next milestone.';
  document.getElementById('ref-reward-overlay').classList.add('show');
}
function closeRewardOverlay() {
  document.getElementById('ref-reward-overlay').classList.remove('show');
}

// Demo: simulate a referral (for testing, accessible via console or hidden button)
function simulateReferral(name) {
  loadReferral();
  name = name || 'Demo Friend ' + (referralData.referrals.length + 1);
  var newRef = { name: name, username: name.toLowerCase().replace(' ','_'), date: new Date().toLocaleDateString('en-GB'), id: Date.now() };
  referralData.referrals.push(newRef);
  var count = referralData.referrals.length;
  // Check milestones
  var newlyUnlocked = [];
  REF_MILESTONES.forEach(function(m, mi) {
    if(count >= m.count && referralData.claimedMilestones.indexOf(mi) === -1) {
      referralData.claimedMilestones.push(mi);
      applyRefReward(referralData, m);
      newlyUnlocked.push(m);
    }
  });
  // Apply bonus Q to live session
  FREE_LIM = 10 + (referralData.bonusQPerSession || 0);
  saveReferral();
  renderReferralPage();
  if(newlyUnlocked.length > 0) showRewardOverlay(newlyUnlocked[0]);
  else toast('‚úÖ Referral added! ' + count + ' total.');
}

// =========================================================
// TOAST
// =========================================================

// =========================================================
// CONTACT ADMIN
// =========================================================
function prepContactPage() {
  var nameEl = document.getElementById('contact-name');
  var contactEl = document.getElementById('contact-contact');
  if(nameEl && ME) nameEl.value = (ME.fullname || ME.name || '');
  if(contactEl && ME) contactEl.value = (ME.email || ME.phone || '');
  var msg = document.getElementById('contact-msg');
  if(msg) msg.innerHTML = '';
  ce('contact-err');
}

function submitContact() {
  var subject = document.getElementById('contact-subject').value.trim();
  var name = document.getElementById('contact-name').value.trim();
  var contact = document.getElementById('contact-contact').value.trim();
  var message = document.getElementById('contact-message').value.trim();
  var err = document.getElementById('contact-err');
  var msg = document.getElementById('contact-msg');

  if(!subject){ err.textContent = '‚ö† Please select a subject.'; return; }
  if(!name){ err.textContent = '‚ö† Please enter your name.'; return; }
  if(!contact){ err.textContent = '‚ö† Please enter your email or phone number.'; return; }
  if(!message || message.length < 10){ err.textContent = '‚ö† Please write a message (at least 10 characters).'; return; }
  err.textContent = '';

  var body = encodeURIComponent(
    'Name: ' + name + '\n' +
    'Contact: ' + contact + '\n' +
    'Account: ' + (ME ? ME.username || '' : 'N/A') + '\n\n' +
    message
  );
  var mailto = 'mailto:admin@nurseprep.ng?subject=' + encodeURIComponent('[NursePrep Nigeria] ' + subject) + '&body=' + body;
  window.open(mailto, '_blank');

  try {
    var existing = JSON.parse(localStorage.getItem('np_contact_log')||'[]');
    existing.unshift({subject:subject, name:name, contact:contact, message:message, date: new Date().toLocaleDateString('en-GB'), ts: Date.now()});
    if(existing.length > 20) existing = existing.slice(0,20);
    localStorage.setItem('np_contact_log', JSON.stringify(existing));
  } catch(x){}

  msg.innerHTML = '<div class="al al-ok">‚úÖ Message sent! We\'ll get back to you within 24 hours.</div>';
  document.getElementById('contact-subject').value = '';
  document.getElementById('contact-message').value = '';
}

function toggleFAQ(el) {
  var isOpen = el.classList.contains('open');
  document.querySelectorAll('.contact-faq').forEach(function(f){ f.classList.remove('open'); });
  if(!isOpen) el.classList.add('open');
}


// =========================================================
// PAYMENT SYSTEM
// =========================================================
// Config ‚Äî swap these keys for live keys in production
var PAY_CONFIG = {
  paystack: {
    publicKey: 'pk_test_REPLACE_WITH_YOUR_PAYSTACK_PUBLIC_KEY',
    scriptUrl: 'https://js.paystack.co/v2/inline.js'
  },
  flutterwave: {
    publicKey: 'FLWPUBK_TEST-REPLACE_WITH_YOUR_FLUTTERWAVE_KEY',
    scriptUrl: 'https://checkout.flutterwave.com/v3.js'
  },
  remita: {
    merchantId: 'REPLACE_WITH_YOUR_REMITA_MERCHANT_ID',
    apiKey: 'REPLACE_WITH_YOUR_REMITA_API_KEY',
    scriptUrl: 'https://login.remita.net/payment/v1/remita-pay-inline.bundle.js'
  }
};

var PLANS = {
  monthly:    { label: 'Monthly Subscription',      price: 2500,   currency: 'NGN', type: 'individual', expiryDays: 30 },
  lifetime:   { label: 'Lifetime Access',            price: 99999,   currency: 'NGN', type: 'individual', expiryDays: null },
  bulk10:     { label: 'School Bulk ‚Äî 10 Seats',     price: 24999,  currency: 'NGN', type: 'school',     expiryDays: 365, seats: 10 },
  bulk50:     { label: 'School Bulk ‚Äî 50 Seats',     price: 99999,  currency: 'NGN', type: 'school',     expiryDays: 365, seats: 50 },
  enterprise: { label: 'Enterprise ‚Äî Custom',        price: null,  currency: 'NGN', type: 'school',     expiryDays: 365, seats: 999 }
};

var _selectedPlan = 'lifetime';
var _selectedProvider = 'paystack';
var _planType = 'individual';

function switchPlanType(type) {
  _planType = type;
  ['individual','school'].forEach(function(t){
    var tab = document.getElementById('ptab-'+t);
    var pane = document.getElementById('plans-'+t);
    if(tab) tab.classList.toggle('on', t === type);
    if(pane) pane.style.display = t === type ? 'block' : 'none';
  });
  // Select default plan for type
  if(type === 'individual') selectPlan('lifetime');
  else { selectPlan('bulk10'); }
}

function selectPlan(planKey) {
  _selectedPlan = planKey;
  // Deselect all cards
  document.querySelectorAll('.plan-card').forEach(function(c){ c.classList.remove('on'); });
  var card = document.getElementById('pcard-'+planKey);
  if(card) card.classList.add('on');
  // Show/hide bulk fields
  var bulkFields = document.getElementById('bulk-extra-fields');
  if(bulkFields) bulkFields.style.display = (planKey === 'bulk10' || planKey === 'bulk50') ? 'block' : 'none';
  // Update total
  updatePayTotal();
}

function selectProvider(prov) {
  _selectedProvider = prov;
  ['paystack','flutterwave','remita'].forEach(function(p){
    var el = document.getElementById('prov-'+p);
    if(el) el.classList.toggle('on', p === prov);
  });
  // Show Remita note only for remita
  var rn = document.getElementById('remita-note');
  if(rn) rn.style.display = prov === 'remita' ? 'block' : 'none';
  // Update secure label
  var sp = document.getElementById('pay-secure-prov');
  if(sp) sp.textContent = {paystack:'Paystack', flutterwave:'Flutterwave', remita:'Remita'}[prov];
  updatePayTotal();
}

function updatePayTotal() {
  var plan = PLANS[_selectedPlan];
  if(!plan) return;
  var totalEl = document.getElementById('pay-total-display');
  var labelEl = document.getElementById('pay-plan-label');
  var ctaEl = document.getElementById('pay-cta-btn');
  if(plan.price === null) {
    if(totalEl) totalEl.textContent = 'Custom';
    if(labelEl) labelEl.textContent = plan.label + ' ‚Äî Contact us';
    if(ctaEl) ctaEl.textContent = 'Request Quote ‚Üí';
  } else {
    var fmt = plan.currency + ' ' + plan.price.toLocaleString();
    if(totalEl) totalEl.textContent = fmt;
    if(labelEl) labelEl.textContent = plan.label;
    if(ctaEl) ctaEl.textContent = 'Pay ' + fmt + ' ‚Üí';
  }
}

function prepPaymentPage() {
  // Reset to defaults
  switchPlanType('individual');
  selectPlan('lifetime');
  selectProvider('paystack');
}

// ‚îÄ‚îÄ INITIATE PAYMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initiatePayment() {
  var plan = PLANS[_selectedPlan];
  if(!plan) return;

  // Enterprise ‚Üí contact admin
  if(_selectedPlan === 'enterprise') {
    go('contact-admin');
    return;
  }

  // Validate bulk fields if needed
  if(_planType === 'school' && (_selectedPlan === 'bulk10' || _selectedPlan === 'bulk50')) {
    var sn = (document.getElementById('bulk-school-name')||{}).value || '';
    var se_ = (document.getElementById('bulk-admin-email')||{}).value || '';
    if(!sn.trim() || !se_.trim()) {
      toast('‚ö† Please fill in school name and admin email.');
      return;
    }
  }

  if(_selectedProvider === 'paystack') {
    runPaystack(plan);
  } else if(_selectedProvider === 'flutterwave') {
    runFlutterwave(plan);
  } else if(_selectedProvider === 'remita') {
    runRemita(plan);
  }
}

// ‚îÄ‚îÄ PAYSTACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runPaystack(plan) {
  showPayModal('paystack');
  /* LIVE INTEGRATION ‚Äî uncomment when going live:
  loadScript(PAY_CONFIG.paystack.scriptUrl, function() {
    var handler = PaystackPop.setup({
      key: PAY_CONFIG.paystack.publicKey,
      email: ME ? ME.email : 'student@nurseprep.com',
      amount: plan.price * 100, // kobo
      currency: 'NGN',
      ref: generatePayRef('PSK'),
      metadata: {
        plan: _selectedPlan,
        userId: ME ? ME.id : '',
        custom_fields: [
          { display_name: 'Plan', variable_name: 'plan', value: plan.label }
        ]
      },
      callback: function(response) {
        onPaymentSuccess(response.reference, 'Paystack', plan);
      },
      onClose: function() { closePayModal(); }
    });
    handler.openIframe();
  });
  */
}

// ‚îÄ‚îÄ FLUTTERWAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runFlutterwave(plan) {
  showPayModal('flutterwave');
  /* LIVE INTEGRATION ‚Äî uncomment when going live:
  loadScript(PAY_CONFIG.flutterwave.scriptUrl, function() {
    FlutterwaveCheckout({
      public_key: PAY_CONFIG.flutterwave.publicKey,
      tx_ref: generatePayRef('FLW'),
      amount: plan.price,
      currency: 'NGN',
      payment_options: 'card,mpesa,mobilemoney',
      customer: {
        email: ME ? ME.email : 'student@nurseprep.com',
        name: ME ? ME.name : 'Student'
      },
      customizations: {
        title: 'NursePrep',
        description: plan.label,
        logo: 'https://nurseprep.com/logo.png'
      },
      callback: function(payment) {
        if(payment.status === 'successful') {
          onPaymentSuccess(payment.transaction_id, 'Flutterwave', plan);
        }
      },
      onclose: function() { closePayModal(); }
    });
  });
  */
}

// ‚îÄ‚îÄ REMITA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runRemita(plan) {
  var rrr = generateRRR();
  var amtFmt = plan.currency + ' ' + plan.price.toLocaleString();
  document.getElementById('remita-rrr').textContent = rrr;
  document.getElementById('remita-amount').textContent = amtFmt;
  document.getElementById('remita-plan-label').textContent = plan.label;

  // Show Remita-specific modal
  document.getElementById('pay-modal-awaiting').style.display = 'none';
  document.getElementById('pay-modal-success').style.display = 'none';
  document.getElementById('pay-modal-remita').style.display = 'block';
  document.getElementById('pay-modal-bg').classList.add('show');

  /* LIVE INTEGRATION ‚Äî uncomment when going live:
  // Step 1: call your backend to generate RRR from Remita API
  // POST https://login.remita.net/remita/exapp/api/v1/send/api/echannelsvc/merchant/api/paymentinit
  // Body: { merchantId, serviceTypeId, orderId, totalAmount, payerName, payerEmail, payerPhone, description }
  // Step 2: display RRR or invoke inline SDK
  loadScript(PAY_CONFIG.remita.scriptUrl, function() {
    var paymentEngine = RmPaymentEngine.init({
      key: PAY_CONFIG.remita.apiKey,
      processRrr: true,
      transactionId: rrr,
      extendedData: { customFields: [{ name: 'plan', value: plan.label }] },
      onSuccess: function(response) { onPaymentSuccess(rrr, 'Remita', plan); },
      onError: function(response) { toast('‚ö† Remita payment failed. Please try again.'); },
      onClose: function() {}
    });
    paymentEngine.showPaymentWidget();
  });
  */
}

function copyRRR() {
  var rrr = (document.getElementById('remita-rrr')||{}).textContent || '';
  try { navigator.clipboard.writeText(rrr); } catch(x){}
  toast('üìã RRR copied: ' + rrr);
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPayModal(provider) {
  var icons = { paystack:'üí≥', flutterwave:'üåä', remita:'üèõÔ∏è' };
  var names = { paystack:'Paystack', flutterwave:'Flutterwave', remita:'Remita' };
  document.getElementById('pmo-ico').textContent = icons[provider] || 'üí≥';
  document.getElementById('pmo-title').textContent = 'Processing Payment';
  document.getElementById('pmo-prov-name').textContent = names[provider] || provider;
  document.getElementById('pay-modal-awaiting').style.display = 'block';
  document.getElementById('pay-modal-success').style.display = 'none';
  document.getElementById('pay-modal-remita').style.display = 'none';
  document.getElementById('pay-modal-bg').classList.add('show');
}

function closePayModal() {
  document.getElementById('pay-modal-bg').classList.remove('show');
}

function closePaySuccess() {
  closePayModal();
  go('main', true);
}

// ‚îÄ‚îÄ ON SUCCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onPaymentSuccess(ref, providerName, plan) {
  // Activate pro on the account
  isPro = true;
  if(ME) {
    ME.isPro = true;
    ME.proCode = 'PAID-' + ref;
    ME.plan = _selectedPlan;
    ME.planLabel = plan.label;
    ME.planProvider = providerName;
    ME.planRef = ref;
    var expiry = null;
    if(plan.expiryDays) {
      var d = new Date();
      d.setDate(d.getDate() + plan.expiryDays);
      expiry = d.toISOString();
    }
    ME.planExpiry = expiry;
    for(var i=0;i<accounts.length;i++){
      if(accounts[i].id === ME.id){
        accounts[i].isPro = true;
        accounts[i].proCode = ME.proCode;
        accounts[i].plan = _selectedPlan;
        accounts[i].planLabel = plan.label;
        accounts[i].planProvider = providerName;
        accounts[i].planRef = ref;
        accounts[i].planExpiry = expiry;
        break;
      }
    }
    saveAcc();
  }

  // Store payment record
  var record = {
    ref: ref, plan: _selectedPlan, label: plan.label,
    price: plan.price, currency: plan.currency,
    provider: providerName, date: new Date().toLocaleDateString('en-GB'),
    ts: Date.now()
  };
  try {
    var hist = JSON.parse(localStorage.getItem('np_payment_history')||'[]');
    hist.unshift(record);
    localStorage.setItem('np_payment_history', JSON.stringify(hist));
  } catch(x){}

  // Update modal to success
  document.getElementById('pay-modal-awaiting').style.display = 'none';
  document.getElementById('pay-modal-remita').style.display = 'none';
  document.getElementById('pay-modal-success').style.display = 'block';
  document.getElementById('suc-plan-label').textContent = plan.label;
  document.getElementById('suc-amount').textContent = plan.price ? plan.currency + ' ' + plan.price.toLocaleString() : 'Custom';
  document.getElementById('suc-provider').textContent = providerName;
  document.getElementById('suc-ref').textContent = ref;
  document.getElementById('suc-expiry').textContent = plan.expiryDays
    ? new Date(Date.now() + plan.expiryDays * 86400000).toLocaleDateString('en-GB')
    : 'Lifetime ‚ôæÔ∏è';

  updateHomeUI();
  updateProfUI();
  renderYGrid();
}

// Mock payment for demo/testing
function simulatePaymentSuccess() {
  var plan = PLANS[_selectedPlan] || PLANS['lifetime'];
  var ref = generatePayRef(_selectedProvider === 'remita' ? 'REM' : _selectedProvider === 'flutterwave' ? 'FLW' : 'PSK');
  onPaymentSuccess(ref, {paystack:'Paystack', flutterwave:'Flutterwave', remita:'Remita'}[_selectedProvider] || 'Mock', plan);
}

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generatePayRef(prefix) {
  return (prefix || 'PAY') + '-' + Date.now() + '-' + Math.random().toString(36).substr(2,6).toUpperCase();
}

function generateRRR() {
  // Remita RRR format: 12-digit numeric
  var r = '';
  for(var i=0;i<12;i++) r += Math.floor(Math.random()*10);
  return r;
}

function loadScript(src, cb) {
  var existing = document.querySelector('script[src="'+src+'"]');
  if(existing) { cb(); return; }
  var s = document.createElement('script');
  s.src = src; s.onload = cb;
  document.head.appendChild(s);
}


// =========================================================
// YEAR MANAGEMENT (Admin)
// =========================================================

// Default years always present ‚Äî admin can add more
var DEFAULT_YEARS = ['2025','2024','2023','2022','2021','2020','2019','2018'];
var customYears = []; // extra years added by admin

function saveCustomYears() {
  try { localStorage.setItem('np_custom_years', JSON.stringify(customYears)); } catch(x){}
}
function loadCustomYears() {
  try {
    var d = localStorage.getItem('np_custom_years');
    if(d) customYears = JSON.parse(d);
  } catch(x){}
}

// Returns all years (default + custom + any already in DB), sorted descending
function getAllYears() {
  var all = DEFAULT_YEARS.concat(customYears);
  Object.keys(DB).forEach(function(y){ if(all.indexOf(y) === -1) all.push(y); });
  // dedupe and sort descending
  var seen = {};
  return all.filter(function(y){ if(seen[y]) return false; seen[y]=true; return true; })
             .sort(function(a,b){ return parseInt(b)-parseInt(a); });
}

// Populate all year dropdowns across the app
function populateYearDropdowns() {
  var years = getAllYears();
  var opts = years.map(function(y){ return '<option value="'+y+'">'+y+'</option>'; }).join('');

  // Upload tab
  var ay = document.getElementById('ay');
  if(ay){ var curAy=ay.value; ay.innerHTML=opts; if(curAy) ay.value=curAy; }

  // CSV import tab
  var csvAy = document.getElementById('csv-ay');
  if(csvAy){ var curCsv=csvAy.value; csvAy.innerHTML=opts; if(curCsv) csvAy.value=curCsv; }

  // View/Edit questions filter
  var vqYr = document.getElementById('vq-yr');
  if(vqYr){
    var curVq = vqYr.value || 'all';
    vqYr.innerHTML = '<option value="all">All Years</option>' + opts;
    vqYr.value = curVq;
  }

  // Years management tab selector
  var pmYr = document.getElementById('paper-mgmt-yr');
  if(pmYr){
    var curPm = pmYr.value;
    pmYr.innerHTML = '<option value="">‚Äî Select ‚Äî</option>' + opts;
    if(curPm) pmYr.value = curPm;
  }
}

function adminAddYear() {
  var inp = document.getElementById('new-year-input');
  var err = document.getElementById('new-year-err');
  var msg = document.getElementById('new-year-msg');
  err.textContent = '';
  msg.innerHTML = '';

  var yr = (inp.value || '').trim();
  if(!yr || isNaN(yr) || yr.length !== 4) {
    err.textContent = '‚ö† Please enter a valid 4-digit year (e.g. 2026).';
    return;
  }
  var num = parseInt(yr);
  if(num < 2000 || num > 2099) {
    err.textContent = '‚ö† Year must be between 2000 and 2099.';
    return;
  }

  var all = getAllYears();
  if(all.indexOf(yr) !== -1) {
    err.textContent = '‚ö† Year ' + yr + ' already exists.';
    return;
  }

  // Add to DB and custom years list
  if(!DB[yr]) DB[yr] = { 'Paper 1': [], 'Paper 2': [], 'OSCE': [] };
  if(customYears.indexOf(yr) === -1) customYears.push(yr);
  saveDB();
  saveCustomYears();
  populateYearDropdowns();
  renderYearsTab();
  renderYGrid();

  inp.value = '';
  msg.innerHTML = '<div class="al al-ok">‚úÖ Year <strong>' + yr + '</strong> added successfully!</div>';
  toast('üìÖ Year ' + yr + ' added!');
}

function adminDeleteYear(yr) {
  var qCount = 0;
  if(DB[yr]) {
    Object.values(DB[yr]).forEach(function(arr){ qCount += arr.length; });
  }
  var warn = qCount > 0
    ? 'Year ' + yr + ' has ' + qCount + ' question(s). Deleting will permanently remove all of them. Continue?'
    : 'Delete year ' + yr + '? This cannot be undone.';

  if(!confirm(warn)) return;

  delete DB[yr];
  customYears = customYears.filter(function(y){ return y !== yr; });
  saveDB();
  saveCustomYears();
  populateYearDropdowns();
  renderYearsTab();
  renderYGrid();
  toast('üóëÔ∏è Year ' + yr + ' deleted.');
}

function adminAddPaper() {
  var yrEl = document.getElementById('paper-mgmt-yr');
  var papEl = document.getElementById('new-paper-input');
  var yr = (yrEl && yrEl.value) || '';
  var paper = (papEl && papEl.value.trim()) || '';

  if(!yr) { toast('‚ö† Select a year first.'); return; }
  if(!paper) { toast('‚ö† Enter a paper name.'); return; }
  if(paper.length > 30) { toast('‚ö† Paper name too long (max 30 chars).'); return; }

  if(!DB[yr]) DB[yr] = {};
  if(DB[yr][paper] !== undefined) { toast('‚ö† Paper "' + paper + '" already exists in ' + yr + '.'); return; }

  DB[yr][paper] = [];
  saveDB();
  renderPaperMgmt();
  renderYearsTab();
  renderYGrid();
  papEl.value = '';
  toast('üìã Paper "' + paper + '" added to ' + yr + '.');
}

function adminDeletePaper(yr, paper) {
  var cnt = (DB[yr] && DB[yr][paper]) ? DB[yr][paper].length : 0;
  if(!confirm('Delete paper "' + paper + '" from ' + yr + '?' + (cnt > 0 ? ' This will remove ' + cnt + ' question(s).' : ''))) return;
  if(DB[yr]) delete DB[yr][paper];
  saveDB();
  renderPaperMgmt();
  renderYearsTab();
  renderYGrid();
  toast('üóëÔ∏è Paper "' + paper + '" removed from ' + yr + '.');
}


function jumpToPaperMgmt(yr) {
  var s = document.getElementById('paper-mgmt-yr');
  if(s){ s.value = yr; renderPaperMgmt(); s.scrollIntoView({behavior:'smooth'}); }
}

function renderPaperMgmt() {
  var yrEl = document.getElementById('paper-mgmt-yr');
  var listEl = document.getElementById('paper-mgmt-list');
  if(!yrEl || !listEl) return;
  var yr = yrEl.value;
  if(!yr) { listEl.innerHTML = ''; return; }
  var papers = DB[yr] ? Object.keys(DB[yr]) : [];
  if(papers.length === 0) {
    listEl.innerHTML = '<p style="color:var(--mt);font-size:13px">No papers yet for ' + yr + '. Add one above.</p>';
    return;
  }
  listEl.innerHTML = papers.map(function(p){
    var cnt = (DB[yr][p]||[]).length;
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px">' +
      '<div><span style="font-weight:700;font-size:14px;color:var(--tx)">' + p + '</span>' +
      '<span style="font-size:12px;color:var(--mt);margin-left:8px">' + cnt + ' question' + (cnt!==1?'s':'') + '</span></div>' +
      '<button class="yr-action-btn yr-del-btn" data-yr="' + yr + '" data-paper="' + encodeURIComponent(p) + '" onclick="var el=this;adminDeletePaper(el.dataset.yr,decodeURIComponent(el.dataset.paper))" title="Delete paper">üóëÔ∏è</button>' +
    '</div>';
  }).join('');
}

function renderYearsTab() {
  var listEl = document.getElementById('years-mgmt-list');
  var countEl = document.getElementById('years-count');
  if(!listEl) return;

  var years = getAllYears();
  if(countEl) countEl.textContent = '(' + years.length + ' total)';

  if(years.length === 0) {
    listEl.innerHTML = '<p style="color:var(--mt);font-size:14px">No years in the database yet.</p>';
    return;
  }

  listEl.innerHTML = years.map(function(yr){
    var papers = DB[yr] ? Object.keys(DB[yr]) : ['Paper 1','Paper 2','OSCE'];
    var totalQ = 0;
    papers.forEach(function(p){ totalQ += (DB[yr] && DB[yr][p] ? DB[yr][p].length : 0); });
    var isDefault = DEFAULT_YEARS.indexOf(yr) !== -1;
    var isLocked = !isPro && yr !== '2025' && yr !== '2024';

    var paperChips = papers.map(function(p){
      var cnt = (DB[yr] && DB[yr][p]) ? DB[yr][p].length : 0;
      return '<span class="yr-paper-chip">' + p + ' <span style="color:var(--g);font-weight:700">(' + cnt + ')</span>' +
        '<span class="remove-paper" data-yr="' + yr + '" data-paper="' + encodeURIComponent(p) + '" onclick="var el=this;adminDeletePaper(el.dataset.yr,decodeURIComponent(el.dataset.paper))" title="Remove paper">√ó</span>' +
        '</span>';
    }).join('');

    return '<div class="yr-mgmt-row">' +
      '<div class="yr-mgmt-num">' + yr + '</div>' +
      '<div class="yr-mgmt-info">' +
        '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">' +
          '<span style="font-size:12px;font-weight:600;color:var(--mt)">' + totalQ + ' question' + (totalQ!==1?'s':'') + '</span>' +
          (isDefault ? '<span class="yr-pro-badge">Default</span>' : '<span class="yr-locked-badge">Custom</span>') +
          (isLocked ? '<span class="yr-locked-badge">üîí Pro only</span>' : '') +
        '</div>' +
        '<div class="yr-mgmt-papers" style="margin-top:6px">' + (paperChips || '<span style="font-size:12px;color:var(--mt)">No papers</span>') + '</div>' +
      '</div>' +
      '<div class="yr-mgmt-actions">' +
        '<button class="yr-action-btn" style="background:rgba(10,110,78,.1);color:var(--g)" data-yr="' + yr + '" onclick="jumpToPaperMgmt(this.dataset.yr)" title="Manage papers">üìã</button>' +
        (!isDefault ? '<button class="yr-action-btn yr-del-btn" data-yr="' + yr + '" onclick="adminDeleteYear(this.dataset.yr)" title="Delete year">üóëÔ∏è</button>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

// Hook into switchAdminTab so the years tab renders fresh each time
var _origSwitchAdminTab = null; // patched below after function defined


// =========================================================
// MOCK EXAM ‚Äî ROTATION & VERSIONING SYSTEM
// =========================================================

// MOCK_BANKS: array of bank objects, sorted by createdAt asc
// Each bank: { id, title, questions[], createdAt, qCount, attemptsCount }
// mockSchedule: { activeBankIdx, intervalHours, nextRotationTs, rotationStartTs }

var MOCK_BANKS = [];
var _newBannerShown = false;
var mockSchedule = { activeBankIdx: 0, intervalHours: 24, nextRotationTs: 0, rotationStartTs: 0 };
var _rotationCheckInterval = null;

function saveMockBanks() {
  try { localStorage.setItem('np_mock_banks', JSON.stringify(MOCK_BANKS)); } catch(x){}
}
function loadMockBanks() {
  try {
    var d = localStorage.getItem('np_mock_banks');
    if(d) MOCK_BANKS = JSON.parse(d);
  } catch(x){}
}
function saveMockSchedule() {
  try { localStorage.setItem('np_mock_schedule', JSON.stringify(mockSchedule)); } catch(x){}
}
function loadMockSchedule() {
  try {
    var d = localStorage.getItem('np_mock_schedule');
    if(d) mockSchedule = JSON.parse(d);
  } catch(x){}
}

// ‚îÄ‚îÄ ACTIVE BANK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getActiveBank() {
  if(MOCK_BANKS.length === 0) return null;
  var idx = Math.min(mockSchedule.activeBankIdx || 0, MOCK_BANKS.length - 1);
  return MOCK_BANKS[idx];
}

function getActiveBankVersion() {
  if(MOCK_BANKS.length === 0) return 'No bank loaded';
  var idx = Math.min(mockSchedule.activeBankIdx || 0, MOCK_BANKS.length - 1);
  return 'v' + (idx + 1) + ' of ' + MOCK_BANKS.length;
}

// ‚îÄ‚îÄ AUTO-ROTATION CHECK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkMockRotation() {
  if(MOCK_BANKS.length < 2) return false; // nothing to rotate to
  if(!mockSchedule.intervalHours || mockSchedule.intervalHours === 0) return false;
  var now = Date.now();
  if(mockSchedule.nextRotationTs && now >= mockSchedule.nextRotationTs) {
    doRotateMock(false);
    return true;
  }
  return false;
}

function doRotateMock(isManual) {
  if(MOCK_BANKS.length === 0) { toast('‚ö† No exam banks available.'); return; }
  var nextIdx = (mockSchedule.activeBankIdx + 1) % MOCK_BANKS.length;
  mockSchedule.activeBankIdx = nextIdx;
  var now = Date.now();
  mockSchedule.rotationStartTs = now;
  if(mockSchedule.intervalHours && mockSchedule.intervalHours > 0) {
    mockSchedule.nextRotationTs = now + mockSchedule.intervalHours * 3600 * 1000;
  } else {
    mockSchedule.nextRotationTs = 0;
  }
  saveMockSchedule();
  // Sync MOCK_DB to the new active bank for backward compat
  var bank = getActiveBank();
  if(bank) {
    MOCK_DB = bank.questions;
    saveMockDB();
  }
  if(isManual) {
    var label = bank ? bank.title : 'Version ' + (nextIdx + 1);
    toast('üîÑ Rotated to: ' + label);
    renderAdminMockTab();
  } else {
    // Auto-rotation
    addNotification('admin', 'üìÖ Mock Exam updated! A new exam version is now live: ' + (bank ? bank.title : 'v'+(nextIdx+1)));
    // Show new-exam banner in lobby
    var banner = document.getElementById('mock-new-banner');
    if(banner) { banner.style.display = 'flex'; setTimeout(function(){ if(banner) banner.style.display = 'none'; }, 15000); }
  }
  updateMockHomeCard();
}

function startRotationWatcher() {
  clearInterval(_rotationCheckInterval);
  _rotationCheckInterval = setInterval(function() {
    var rotated = checkMockRotation();
    if(rotated) {
      renderMockLobby();
      // Flash the new-exam banner for students on lobby
      var banner = document.getElementById('mock-new-banner');
      if(banner) banner.style.display = 'flex';
    }
    updateRotationCountdowns();
  }, 1000); // tick every second for live countdown
}

// ‚îÄ‚îÄ COUNTDOWN HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatCountdown(ms) {
  if(ms <= 0) return 'Due now';
  var totalSecs = Math.floor(ms / 1000);
  var h = Math.floor(totalSecs / 3600);
  var m = Math.floor((totalSecs % 3600) / 60);
  var s = totalSecs % 60;
  if(h > 0) return h + 'h ' + m + 'm';
  if(m > 0) return m + 'm ' + s + 's';
  return s + 's';
}

function updateRotationCountdowns() {
  var now = Date.now();
  var hasSchedule = mockSchedule.nextRotationTs && mockSchedule.nextRotationTs > 0;
  var remaining = hasSchedule ? Math.max(0, mockSchedule.nextRotationTs - now) : 0;
  var total = mockSchedule.intervalHours ? mockSchedule.intervalHours * 3600 * 1000 : 0;

  // ‚îÄ‚îÄ LOBBY countdowns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var lobbyRow = document.getElementById('lobby-next-rotation-row');
  var lobbyBarWrap = document.getElementById('lobby-timer-bar-wrap');
  var lobbyNext = document.getElementById('lobby-next-rotation');
  var lobbyNextDate = document.getElementById('lobby-next-rotation-date');
  var lobbyBar = document.getElementById('lobby-rotation-bar');
  var lobbyPill = document.getElementById('lobby-rotation-pill');

  if(hasSchedule && mockSchedule.intervalHours > 0) {
    if(lobbyRow) lobbyRow.style.display = '';
    if(lobbyBarWrap) lobbyBarWrap.style.display = 'block';
    if(lobbyNext) lobbyNext.textContent = formatCountdown(remaining);
    if(lobbyNextDate) {
      var nextDt = new Date(mockSchedule.nextRotationTs);
      lobbyNextDate.textContent = nextDt.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}) + ' at ' + nextDt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }
    if(lobbyBar && total > 0) {
      lobbyBar.style.width = Math.max(2, (remaining / total) * 100) + '%';
    }
    if(lobbyPill) lobbyPill.innerHTML = '<span class="rotation-live-pill"><span style="width:6px;height:6px;border-radius:50%;background:#34D399;display:inline-block"></span>Live ¬∑ Every ' + mockSchedule.intervalHours + 'h</span>';
  } else {
    if(lobbyRow) lobbyRow.style.display = 'none';
    if(lobbyBarWrap) lobbyBarWrap.style.display = 'none';
    if(lobbyPill) lobbyPill.innerHTML = '<span class="rotation-off-pill">Manual only</span>';
  }

  // ‚îÄ‚îÄ ADMIN countdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var admRotation = document.getElementById('mock-rotation-status-adm');
  if(admRotation && MOCK_BANKS.length > 0) {
    var bank = getActiveBank();
    var bankLabel = bank ? bank.title : '‚Äî';
    var nextLabel, nextDateStr = '';
    if(hasSchedule && mockSchedule.intervalHours > 0) {
      nextLabel = 'Next rotation in <strong style="color:var(--g)">' + formatCountdown(remaining) + '</strong>';
      var ndt = new Date(mockSchedule.nextRotationTs);
      nextDateStr = '<div style="font-size:12px;color:var(--mt);margin-top:2px">' + ndt.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}) + ' at ' + ndt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) + '</div>';
    } else {
      nextLabel = 'Auto-rotation is <strong>off</strong>';
    }
    admRotation.innerHTML =
      '<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">' +
        '<span class="bank-active-dot"></span>' +
        '<span style="font-weight:700;font-size:14px;color:var(--gd)">' + bankLabel + '</span>' +
        '<span class="bank-ver-tag">' + getActiveBankVersion() + '</span>' +
      '</div>' +
      '<div style="font-size:13px;color:var(--mt)">' + nextLabel + '</div>' + nextDateStr;
    if(total > 0) {
      admRotation.innerHTML += '<div class="rotation-timer-bar" style="margin-top:10px"><div class="rotation-timer-fill" style="width:' + Math.max(0,(remaining/total)*100) + '%"></div></div>';
    }
  }

  // ‚îÄ‚îÄ Admin bank count ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var bc = document.getElementById('adm-bank-count');
  if(bc) bc.textContent = MOCK_BANKS.length + ' bank' + (MOCK_BANKS.length !== 1 ? 's' : '');
}

// ‚îÄ‚îÄ ADMIN FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveRotationSettings() {
  var intEl = document.getElementById('mock-rotation-interval');
  var nextTimeEl = document.getElementById('mock-next-update-time');
  var hrs = intEl ? parseInt(intEl.value) : 24;
  mockSchedule.intervalHours = hrs;
  var now = Date.now();

  // If admin set an explicit next-update datetime, use it
  if(nextTimeEl && nextTimeEl.value) {
    var exactTs = new Date(nextTimeEl.value).getTime();
    if(!isNaN(exactTs) && exactTs > now) {
      mockSchedule.rotationStartTs = now;
      mockSchedule.nextRotationTs = exactTs;
      nextTimeEl.value = '';
    } else if(!isNaN(exactTs)) {
      toast('‚ö† The selected time is in the past. Set a future time.');
      return;
    }
  } else if(hrs > 0) {
    mockSchedule.rotationStartTs = now;
    mockSchedule.nextRotationTs = now + hrs * 3600 * 1000;
  } else {
    mockSchedule.nextRotationTs = 0;
    mockSchedule.rotationStartTs = 0;
  }

  saveMockSchedule();
  updateRotationCountdowns();
  renderBankArchive();

  var msg = document.getElementById('rotation-msg');
  var desc = hrs === 0 ? 'manual only' : 'every ' + hrs + 'h';
  if(mockSchedule.nextRotationTs > now) {
    var ndt = new Date(mockSchedule.nextRotationTs);
    desc += ' ¬∑ next at ' + ndt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) + ' on ' + ndt.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
  }
  if(msg) {
    msg.innerHTML = '<div class="al al-ok">‚úÖ Schedule saved: ' + desc + '</div>';
    setTimeout(function(){ msg.innerHTML=''; }, 4000);
  }
  toast('üìÖ Update schedule saved.');
}

function adminManualRotate() {
  if(MOCK_BANKS.length < 2) {
    toast('‚ö† Upload at least 2 exam banks to enable rotation.');
    return;
  }
  if(!confirm('Rotate to the next exam bank now?')) return;
  doRotateMock(true);
}

function renderBankArchive() {
  var listEl = document.getElementById('bank-archive-list');
  var countEl = document.getElementById('bank-archive-count');
  if(!listEl) return;

  if(countEl) countEl.textContent = '(' + MOCK_BANKS.length + ' bank' + (MOCK_BANKS.length !== 1 ? 's' : '') + ')';
  var bankCountEl = document.getElementById('adm-bank-count');
  if(bankCountEl) bankCountEl.textContent = MOCK_BANKS.length + ' bank' + (MOCK_BANKS.length !== 1 ? 's' : '');

  if(MOCK_BANKS.length === 0) {
    listEl.innerHTML = '<p style="color:var(--mt);font-size:14px">No banks uploaded yet.</p>';
    return;
  }

  var activeIdx = Math.min(mockSchedule.activeBankIdx || 0, MOCK_BANKS.length - 1);
  listEl.innerHTML = MOCK_BANKS.slice().reverse().map(function(bank, ri) {
    var realIdx = MOCK_BANKS.length - 1 - ri;
    var isActive = realIdx === activeIdx;
    var d = new Date(bank.createdAt).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    var attempts = mockHistory.filter(function(h){ return h.bankId === bank.id; }).length;
    var passed = mockHistory.filter(function(h){ return h.bankId === bank.id && h.passed; }).length;
    return '<div class="bank-archive-card' + (isActive ? ' active-bank' : '') + '">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">' +
        '<div>' +
          (isActive ? '<span class="bank-active-dot"></span>' : '') +
          '<span style="font-weight:700;font-size:15px;color:var(--gd)">' + (bank.title || 'Bank v' + (realIdx+1)) + '</span>' +
        '</div>' +
        '<div style="display:flex;gap:6px;align-items:center">' +
          '<span class="bank-ver-tag">v' + (realIdx+1) + '</span>' +
          (isActive ? '<span style="background:rgba(34,197,94,.1);color:#15803d;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;border:1px solid rgba(34,197,94,.3)">ACTIVE</span>' : '') +
          (!isActive ? '<button onclick="adminSetActiveBank(' + realIdx + ')" style="background:var(--bg);border:1.5px solid var(--bd);border-radius:8px;padding:5px 10px;font-size:12px;font-weight:600;cursor:pointer;color:var(--g)">Set Active</button>' : '') +
          '<button onclick="adminDeleteBank(' + realIdx + ')" style="background:rgba(229,62,62,.08);border:1.5px solid rgba(229,62,62,.2);border-radius:8px;padding:5px 8px;font-size:12px;cursor:pointer;color:var(--red)">üóëÔ∏è</button>' +
        '</div>' +
      '</div>' +
      '<div style="font-size:12px;color:var(--mt);margin-top:4px">Uploaded ' + d + '</div>' +
      '<div class="bank-stats-row">' +
        '<div class="bank-stat"><div class="bank-stat-num">' + (bank.qCount || 0) + '</div><div class="bank-stat-lbl">Questions</div></div>' +
        '<div class="bank-stat"><div class="bank-stat-num">' + attempts + '</div><div class="bank-stat-lbl">Attempts</div></div>' +
        (attempts > 0 ? '<div class="bank-stat"><div class="bank-stat-num">' + Math.round(passed/attempts*100) + '%</div><div class="bank-stat-lbl">Pass Rate</div></div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

function adminSetActiveBank(idx) {
  if(idx < 0 || idx >= MOCK_BANKS.length) return;
  mockSchedule.activeBankIdx = idx;
  var now = Date.now();
  mockSchedule.rotationStartTs = now;
  if(mockSchedule.intervalHours && mockSchedule.intervalHours > 0) {
    mockSchedule.nextRotationTs = now + mockSchedule.intervalHours * 3600 * 1000;
  }
  saveMockSchedule();
  MOCK_DB = MOCK_BANKS[idx].questions;
  saveMockDB();
  renderBankArchive();
  updateRotationCountdowns();
  toast('‚úÖ Bank v' + (idx+1) + ' is now active.');
}

function adminDeleteBank(idx) {
  var bank = MOCK_BANKS[idx];
  if(!bank) return;
  var attempts = mockHistory.filter(function(h){ return h.bankId === bank.id; }).length;
  var warn = 'Delete "' + (bank.title || 'Bank v'+(idx+1)) + '"?';
  if(attempts > 0) warn += ' ' + attempts + ' attempt record(s) will be unlinked.';
  if(!confirm(warn)) return;
  MOCK_BANKS.splice(idx, 1);
  if(mockSchedule.activeBankIdx >= MOCK_BANKS.length) {
    mockSchedule.activeBankIdx = Math.max(0, MOCK_BANKS.length - 1);
  }
  if(MOCK_BANKS.length === 0) { MOCK_DB = []; saveMockDB(); }
  else { MOCK_DB = (getActiveBank()||{}).questions || []; saveMockDB(); }
  saveMockBanks();
  saveMockSchedule();
  renderBankArchive();
  updateRotationCountdowns();
  toast('üóëÔ∏è Bank deleted.');
}

// ‚îÄ‚îÄ LOBBY HISTORY LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLobbyHistory() {
  var wrap = document.getElementById('mock-lobby-history-wrap');
  var list = document.getElementById('mock-lobby-history-list');
  var totalBadge = document.getElementById('mock-hist-total-badge');
  if(!wrap || !list) return;

  var myAttempts = mockHistory.filter(function(h){ return !ME || h.name === ME.name; });
  if(myAttempts.length === 0) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';

  if(totalBadge) totalBadge.textContent = myAttempts.length + ' attempt' + (myAttempts.length !== 1 ? 's' : '');

  // Group by bankId
  var groups = {}; // bankId ‚Üí { bank, label, attempts[] }
  myAttempts.forEach(function(h) {
    var bid = h.bankId || 'unknown';
    if(!groups[bid]) {
      var bank = MOCK_BANKS.find(function(b){ return b.id === bid; });
      var label = bank ? bank.title : (h.bankVersion || 'Mock Exam');
      var isActive = bank && MOCK_BANKS.indexOf(bank) === (mockSchedule.activeBankIdx || 0);
      groups[bid] = { label: label, isActive: isActive, bank: bank, attempts: [] };
    }
    groups[bid].attempts.push(h);
  });

  // Sort groups: active bank first, then by most recent attempt
  var groupKeys = Object.keys(groups).sort(function(a, b) {
    if(groups[a].isActive) return -1;
    if(groups[b].isActive) return 1;
    var latA = groups[a].attempts[groups[a].attempts.length - 1].date;
    var latB = groups[b].attempts[groups[b].attempts.length - 1].date;
    return new Date(latB) - new Date(latA);
  });

  list.innerHTML = groupKeys.map(function(bid) {
    var g = groups[bid];
    var attemptsHtml = g.attempts.slice().reverse().map(function(h) {
      var d = new Date(h.date).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'});
      var time = new Date(h.date).toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'});
      var col = h.passed ? '#34D399' : '#F87171';
      var best = g.attempts.reduce(function(mx, a){ return a.pct > mx ? a.pct : mx; }, 0);
      return '<div class="mock-history-card" style="margin-bottom:8px">' +
        '<div style="display:flex;align-items:center;justify-content:space-between">' +
          '<div>' +
            '<div style="font-size:12px;color:rgba(255,255,255,.4)">' + d + ' at ' + time + (h.timeTaken ? ' ¬∑ ' + h.timeTaken : '') + '</div>' +
            '<div style="font-size:13px;color:' + col + ';font-weight:700;margin-top:3px">' + (h.passed?'‚úÖ PASS':'‚ùå FAIL') + ' ¬∑ ' + h.score + '/' + h.total + ' correct</div>' +
          '</div>' +
          '<div class="mock-hist-score" style="color:' + col + '">' + h.pct + '%</div>' +
        '</div>' +
      '</div>';
    }).join('');

    var bestPct = g.attempts.reduce(function(mx, a){ return a.pct > mx ? a.pct : mx; }, 0);
    var passCount = g.attempts.filter(function(a){ return a.passed; }).length;

    return '<div class="prev-bank-group">' +
      '<div class="prev-bank-label">' +
        (g.isActive ? 'üü¢ ' : 'üóÇÔ∏è ') + g.label +
        (g.isActive ? ' <span style="font-size:10px;background:#22c55e;color:#fff;padding:1px 6px;border-radius:10px;margin-left:4px">CURRENT</span>' : '') +
        '<span style="float:right;font-size:11px;color:rgba(255,255,255,.4)">' + g.attempts.length + ' attempt' + (g.attempts.length!==1?'s':'') + ' ¬∑ Best: ' + bestPct + '% ¬∑ ' + passCount + ' pass</span>' +
      '</div>' +
      attemptsHtml +
    '</div>';
  }).join('');
}

function toast(msg) {
  var old=document.querySelector('.toast'); if(old) old.remove();
  var t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(function(){ if(t.parentNode) t.remove(); },3200);
}

// =========================================================
// DARK MODE (toggle + load defined early in <head> to avoid ReferenceError)
// =========================================================

// =========================================================
// CONTINUE LAST QUIZ
// =========================================================
var _lastQuizState = null; // {year, paper, qi, total, mode}

function saveLastQuizState() {
  if(!QYear || !QPaper || QQ.length === 0) return;
  _lastQuizState = { year: QYear, paper: QPaper, qi: QI, total: QQ.length, mode: QMode };
  try { localStorage.setItem('np_last_quiz', JSON.stringify(_lastQuizState)); } catch(e){}
}

function loadLastQuizState() {
  try {
    var d = localStorage.getItem('np_last_quiz');
    if(d) _lastQuizState = JSON.parse(d);
  } catch(e){}
}

function updateContinueCard() {
  var card = document.getElementById('continue-card');
  if(!card) return;

  // Use in-progress state if available, otherwise fall back to last completed quiz
  var s = _lastQuizState;
  var isCompleted = false;

  if(!s || !s.year) {
    // Try last completed quiz from history
    if(quizHistory && quizHistory.length > 0) {
      var last = quizHistory[quizHistory.length - 1];
      s = { year: last.year, paper: last.paper, qi: last.total - 1, total: last.total, mode: last.mode || 'review', completed: true };
      isCompleted = true;
    } else {
      // Show demo card so feature is always visible
      s = { year: '2025', paper: 'Paper 1', qi: 0, total: 10, mode: 'review', demo: true };
    }
  }

  card.style.display = 'block';
  var pct = isCompleted ? 100 : (s.demo ? 0 : Math.round((s.qi / s.total) * 100));

  var titleEl = document.getElementById('continue-title');
  if(titleEl) titleEl.textContent = (s.year === 'Mock' ? 'NMCN Mock Exam' : s.year + ' ‚Äî ' + s.paper);

  var metaEl = document.getElementById('continue-meta');
  if(metaEl) {
    if(s.demo) {
      metaEl.textContent = 'Start your first quiz ¬∑ Tap to begin';
    } else if(isCompleted) {
      metaEl.textContent = 'Last played ¬∑ ' + s.total + ' questions ¬∑ Tap to retry';
    } else {
      metaEl.textContent = 'Q' + (s.qi + 1) + ' of ' + s.total + ' ¬∑ ' + (s.mode === 'exam' ? 'üéì Exam Mode' : 'üìñ Review Mode');
    }
  }

  var lbl = card.querySelector('.continue-card-label');
  if(lbl) lbl.textContent = isCompleted ? 'Play again' : (s.demo ? 'Quick start' : 'Continue where you left off');

  var ico = card.querySelector('.continue-card-ico');
  if(ico) ico.textContent = isCompleted ? 'üîÅ' : (s.demo ? 'üöÄ' : '‚ñ∂Ô∏è');

  var b = document.getElementById('continue-bar'); if(b) b.style.width = pct + '%';
  var p = document.getElementById('continue-pct');
  if(p) p.textContent = s.demo ? 'Ready to start' : (isCompleted ? '‚úÖ Completed' : pct + '% through');
}

function continueLastQuiz() {
  var s = _lastQuizState;
  // If no in-progress state, replay last completed quiz from history
  if(!s || !s.year) {
    if(quizHistory && quizHistory.length > 0) {
      var last = quizHistory[quizHistory.length - 1];
      if(last.year === 'Mock') { goMockExam(); return; }
      s = { year: last.year, paper: last.paper, qi: 0, total: last.total, mode: last.mode || 'review' };
    } else { return; }
  }
  if(s.year === 'Mock') { goMockExam(); return; }
  var qs = DB[s.year] && DB[s.year][s.paper];
  if(!qs || qs.length === 0) { toast('‚ö† Those questions are no longer available.'); return; }
  QYear = s.year; QPaper = s.paper; QMode = s.mode || 'review';
  QQ = isPro ? qs : qs.slice(0, Math.min(FREE_LIM, qs.length));
  QI = Math.min(s.qi || 0, QQ.length - 1);
  QScore = 0; QAnsed = false; QSessAns = QI; QAnswers = [];
  showQuizLoading(s.year + ' ‚Äî ' + s.paper, QMode, function(){ renderQ(); go('quiz'); });
}

// =========================================================
// QUIZ LOADING ANIMATION
// =========================================================
var nursingFacts = [
  '"The first duty of a nurse is the prevention of disease." ‚Äî Florence Nightingale',
  '"Nurses dispense comfort, compassion, and caring without even a prescription." ‚Äî Val Saintsbury',
  'The heart beats around 100,000 times per day. ü´Ä',
  'A normal adult respiratory rate is 12‚Äì20 breaths per minute.',
  'Normal SpO‚ÇÇ is 95‚Äì100%. Below 90% requires immediate action.',
  'Hand hygiene prevents up to 50% of hospital-acquired infections.',
  'Normal blood pressure is below 120/80 mmHg.',
  'Pain is considered the "5th vital sign" in nursing care.',
];

function showQuizLoading(title, mode, onDone) {
  var overlay = document.getElementById('quiz-loading-overlay');
  if(!overlay) { onDone(); return; }
  var titleEl = document.getElementById('loading-title');
  var subEl = document.getElementById('loading-sub');
  var factEl = document.getElementById('loading-fact');
  var emojiEl = document.getElementById('loading-emoji');
  var barEl = document.getElementById('loading-bar');
  
  if(titleEl) titleEl.textContent = 'Preparing ' + title;
  if(subEl) subEl.textContent = mode === 'exam' ? 'üéì Exam Mode ‚Äî no hints during quiz' : 'üìñ Review Mode ‚Äî explanations after each question';
  if(emojiEl) emojiEl.textContent = mode === 'exam' ? 'üéì' : 'ü©∫';
  if(factEl) factEl.textContent = nursingFacts[Math.floor(Math.random() * nursingFacts.length)];
  if(barEl) { barEl.style.animation = 'none'; barEl.style.width = '0%'; barEl.offsetWidth; barEl.style.animation = 'loadbar 1.5s cubic-bezier(.4,0,.2,1) forwards'; }
  
  overlay.classList.add('show');
  setTimeout(function(){
    overlay.classList.remove('show');
    onDone();
  }, 1600);
}

// =========================================================
// BOOKMARKS
// =========================================================
var bookmarks = []; // [{year, paper, qi, q:{q,o,c,e}}]

function saveBookmarks() { try { localStorage.setItem('np_bm', JSON.stringify(bookmarks)); } catch(e){} }
function loadBookmarks() { try { var d = localStorage.getItem('np_bm'); if(d) bookmarks = JSON.parse(d); } catch(e){} }

function getCurrentBookmarkKey() {
  if(!QQ || QQ.length === 0 || QI >= QQ.length) return null;
  return QYear + '|' + QPaper + '|' + QI;
}

function isCurrentBookmarked() {
  var key = getCurrentBookmarkKey();
  if(!key) return false;
  return bookmarks.some(function(b){ return b.year === QYear && b.paper === QPaper && b.qi === QI; });
}

function toggleBookmark() {
  if(!QQ || QQ.length === 0) return;
  var alreadyBm = isCurrentBookmarked();
  if(alreadyBm) {
    bookmarks = bookmarks.filter(function(b){ return !(b.year === QYear && b.paper === QPaper && b.qi === QI); });
    showBmToast('üîñ Bookmark removed');
  } else {
    bookmarks.push({ year: QYear, paper: QPaper, qi: QI, q: QQ[QI], savedAt: Date.now() });
    showBmToast('‚≠ê Question bookmarked!');
  }
  saveBookmarks();
  updateBmBtn();
}

function updateBmBtn() {
  var btn = document.getElementById('bm-btn');
  if(!btn) return;
  var bm = isCurrentBookmarked();
  btn.classList.toggle('bookmarked', bm);
  btn.textContent = bm ? '‚≠ê' : 'üîñ';
  btn.title = bm ? 'Remove bookmark' : 'Bookmark this question';
}

function showBmToast(msg) {
  var t = document.getElementById('bm-toast');
  if(!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2000);
}

function renderBookmarks() {
  var el = document.getElementById('bm-list-body');
  var sub = document.getElementById('bm-count-sub');
  if(!el) return;
  if(sub) sub.textContent = bookmarks.length + ' saved question' + (bookmarks.length !== 1 ? 's' : '');
  if(bookmarks.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-ico">üîñ</div><div style="font-size:14px">No bookmarks yet.<br><span style="font-size:12px">Tap üîñ on any quiz question to save it.</span></div></div>';
    return;
  }
  var letters = ['A','B','C','D'];
  el.innerHTML = bookmarks.slice().reverse().map(function(bm, idx){
    var q = bm.q;
    var realIdx = bookmarks.length - 1 - idx;
    return '<div class="bm-q-card">'+
      '<div class="bm-q-meta"><span>'+bm.year+' ‚Äî '+bm.paper+'</span><span style="background:var(--bg);padding:2px 8px;border-radius:10px">Q'+(bm.qi+1)+'</span>'+
        '<button onclick="removeBookmark('+realIdx+')" style="margin-left:auto;background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;padding:0">‚úï Remove</button></div>'+
      '<div class="bm-q-text">'+q.q+'</div>'+
      '<div class="bm-q-answer">‚úì Correct: '+letters[q.c]+'. '+q.o[q.c]+'</div>'+
      (q.e ? '<div style="font-size:12px;color:var(--mt);line-height:1.6">üí° '+q.e+'</div>' : '')+
    '</div>';
  }).join('');
}

function removeBookmark(idx) {
  bookmarks.splice(idx, 1);
  saveBookmarks();
  renderBookmarks();
}

// =========================================================
// REPORT QUESTION
// =========================================================
var _reportChoice = null;
var _reportQRef = null;

function showReportModal() {
  if(!QQ || QQ.length === 0) return;
  _reportChoice = null;
  _reportQRef = { year: QYear, paper: QPaper, qi: QI, q: QQ[QI] };
  document.querySelectorAll('.report-opt').forEach(function(o){ o.classList.remove('on'); });
  var btn = document.getElementById('report-submit-btn');
  if(btn) btn.disabled = true;
  document.getElementById('report-modal-overlay').classList.add('show');
}

function closeReportModal() {
  document.getElementById('report-modal-overlay').classList.remove('show');
}

function selectReport(el, reason) {
  document.querySelectorAll('.report-opt').forEach(function(o){ o.classList.remove('on'); });
  el.classList.add('on');
  _reportChoice = reason;
  var btn = document.getElementById('report-submit-btn');
  if(btn) btn.disabled = false;
}

function submitReport() {
  if(!_reportChoice || !_reportQRef) return;
  // Save report locally (in real app would send to backend)
  var reports = [];
  try { var d = localStorage.getItem('np_reports'); if(d) reports = JSON.parse(d); } catch(e){}
  reports.push({ reason: _reportChoice, ref: _reportQRef, date: new Date().toISOString(), reporter: ME ? ME.name : 'Anonymous' });
  try { localStorage.setItem('np_reports', JSON.stringify(reports)); } catch(e){}
  closeReportModal();
  toast('‚úÖ Report submitted! Thank you for helping us improve.');
}

// =========================================================
// SHAREABLE RESULT CERTIFICATE
// =========================================================
function showQuizCertificate() {
  var total = QI + 1;
  var pct = Math.round((QScore / total) * 100);
  var passed = pct >= 50;
  buildCertificate({
    name: ME ? ME.name : 'Student',
    paper: QYear + ' ‚Äî ' + QPaper,
    pct: pct,
    verdict: passed ? '‚úÖ PASS' : '‚ùå FAIL',
    verdictColor: passed ? '#34D399' : '#F87171',
    correct: QScore,
    total: total,
    mode: QMode === 'exam' ? 'Exam' : 'Review',
    date: new Date().toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'})
  });
}

function showMockCertificate() {
  var h = mockHistory[mockHistory.length - 1];
  if(!h) return;
  buildCertificate({
    name: ME ? ME.name : 'Student',
    paper: 'NMCN Mock Exam',
    pct: h.pct,
    verdict: h.passed ? '‚úÖ PASS' : '‚ùå FAIL',
    verdictColor: h.passed ? '#34D399' : '#F87171',
    correct: h.score,
    total: h.total,
    mode: 'Mock',
    date: new Date(h.date).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'})
  });
}

function buildCertificate(data) {
  var set = function(id, v){ var el=document.getElementById(id); if(el) el.textContent=v; };
  var setStyle = function(id, prop, val){ var el=document.getElementById(id); if(el) el.style[prop]=val; };
  set('cert-name', data.name);
  set('cert-pct', data.pct + '%');
  set('cert-verdict', data.verdict);
  set('cert-paper', data.paper);
  set('cert-correct', data.correct);
  set('cert-total', data.total);
  set('cert-mode', data.mode);
  set('cert-date', 'Completed ' + data.date + ' ¬∑ nurseprep.com');
  setStyle('cert-pct', 'color', data.verdictColor);
  setStyle('cert-verdict', 'color', data.verdictColor);
  document.getElementById('cert-overlay').classList.add('show');
}

function closeCertificate() {
  document.getElementById('cert-overlay').classList.remove('show');
}

function shareCertificate() {
  var h = mockHistory.length > 0 ? mockHistory[mockHistory.length - 1] : null;
  var pct = h ? h.pct : (QI > 0 ? Math.round((QScore/(QI+1))*100) : 0);
  var paper = h ? 'NMCN Mock Exam' : (QYear + ' ‚Äî ' + QPaper);
  var text = 'ü©∫ I just scored ' + pct + '% on the ' + paper + ' at NursePrep! üìö\n\nPreparing for the NMCN Exam ‚Äî join me at nurseprep.com üè•';
  if(navigator.share) {
    navigator.share({ title: 'NursePrep Result', text: text }).catch(function(){});
  } else {
    navigator.clipboard && navigator.clipboard.writeText(text);
    toast('üìã Result copied to clipboard! Paste anywhere to share.');
  }
}

// =========================================================
// INIT
// =========================================================

// ================================================================
//  AI EXPLAIN SYSTEM
// ================================================================

var AI_FREE_LIMIT = 3;          // free uses per day
var AI_DEPTH = 'simple';        // current depth selection
var _aiCurrentQ = null;         // question context for current session

// --- Usage tracking (per-day, localStorage) ---
function getAIUsage() {
  try {
    var today = new Date().toISOString().slice(0,10);
    var raw = localStorage.getItem('np_ai_usage');
    var d = raw ? JSON.parse(raw) : {};
    if(d.date !== today) return { date: today, count: 0 };
    return d;
  } catch(x) { return { date: '', count: 0 }; }
}
function incrementAIUsage() {
  try {
    var u = getAIUsage();
    u.count++;
    u.date = new Date().toISOString().slice(0,10);
    localStorage.setItem('np_ai_usage', JSON.stringify(u));
  } catch(x) {}
}

// --- Show/hide button after answer ---
function showAIExplainBtn() {
  var btn = document.getElementById('ai-explain-btn');
  if(!btn) return;
  btn.style.display = 'flex';
  // Label update
  var lbl = document.getElementById('ai-explain-btn-lbl');
  if(lbl) {
    var usage = getAIUsage();
    var remaining = isPro ? '‚àû' : Math.max(0, AI_FREE_LIMIT - usage.count);
    lbl.textContent = isPro
      ? 'Explain this with AI ‚ú¶'
      : ('Explain with AI (' + remaining + ' free today)');
  }
}

// --- Open modal ---
function openAIExplain() {
  if(!QQ || QQ.length === 0) return;
  var q = QQ[QI];
  _aiCurrentQ = q;

  // Check free limit
  var usage = getAIUsage();
  if(!isPro && usage.count >= AI_FREE_LIMIT) {
    showAIGate();
    return;
  }

  document.getElementById('ai-modal-overlay').classList.add('show');

  // Set context-aware title
  var titleEl = document.querySelector('.ai-sheet-hdr-title');
  if(titleEl) titleEl.textContent = (QYear === 'Hospital Final') ? 'Hospital AI Tutor' : 'AI Tutor';

  // Set question recap
  var recap = document.getElementById('ai-q-recap');
  if(recap) recap.textContent = '"' + q.q.substring(0, 120) + (q.q.length > 120 ? '‚Ä¶' : '') + '"';

  // Reset UI
  var resp = document.getElementById('ai-response');
  var loading = document.getElementById('ai-loading');
  if(resp) { resp.style.display = 'none'; resp.innerHTML = ''; }
  if(loading) loading.style.display = 'flex';

  // Reset depth to simple if first open
  setAIDepthActive('simple');

  // Fire request
  fetchAIExplanation(q, AI_DEPTH);
}

function showAIGate() {
  document.getElementById('ai-modal-overlay').classList.add('show');
  var recap = document.getElementById('ai-q-recap');
  if(recap) recap.style.display = 'none';
  var depthRow = document.getElementById('ai-depth-row');
  if(depthRow) depthRow.style.display = 'none';
  var body = document.getElementById('ai-sheet-body');
  var loading = document.getElementById('ai-loading');
  if(loading) loading.style.display = 'none';
  var resp = document.getElementById('ai-response');
  if(resp) {
    resp.style.display = 'block';
    resp.innerHTML =
      '<div class="ai-pro-gate">' +
        '<div class="ai-pro-gate-ico">üîí</div>' +
        '<div class="ai-pro-gate-title">Daily Limit Reached</div>' +
        '<div class="ai-pro-gate-sub">Free users get <strong>' + AI_FREE_LIMIT + ' AI explanations</strong> per day.<br>Upgrade to Pro for unlimited AI tutoring, deeper explanations, and mnemonics.</div>' +
        '<button class="btn btn-gold" style="max-width:260px;margin:0 auto" onclick="closeAIExplain();go(\"plans\")">Upgrade to Pro ‚Üí</button>' +
        '<div style="margin-top:12px;font-size:12px;color:var(--mt)">Resets at midnight ¬∑ You can still view the written explanation above</div>' +
      '</div>';
  }
}

function closeAIExplain(e) {
  if(e && e.target !== document.getElementById('ai-modal-overlay')) return;
  document.getElementById('ai-modal-overlay').classList.remove('show');
  // Restore hidden elements in case gate was shown
  var recap = document.getElementById('ai-q-recap');
  if(recap) recap.style.display = '';
  var depthRow = document.getElementById('ai-depth-row');
  if(depthRow) depthRow.style.display = '';
}

// --- Depth selector ---
function setAIDepth(el, depth) {
  AI_DEPTH = depth;
  setAIDepthActive(depth);
  if(_aiCurrentQ) {
    var resp = document.getElementById('ai-response');
    var loading = document.getElementById('ai-loading');
    if(resp) { resp.style.display = 'none'; resp.innerHTML = ''; }
    if(loading) loading.style.display = 'flex';
    document.getElementById('ai-loading-lbl').textContent = 'Switching mode‚Ä¶';
    fetchAIExplanation(_aiCurrentQ, depth);
  }
}
function setAIDepthActive(depth) {
  document.querySelectorAll('.ai-depth-btn').forEach(function(b) {
    b.classList.toggle('on', b.dataset.depth === depth);
  });
  AI_DEPTH = depth;
}

// --- Loading label cycling ---
var _loadingLabels = ['Thinking‚Ä¶', 'Reading the question‚Ä¶', 'Preparing explanation‚Ä¶', 'Almost ready‚Ä¶'];
var _loadingTimer = null;
function startLoadingCycle() {
  var i = 0;
  var el = document.getElementById('ai-loading-lbl');
  _loadingTimer = setInterval(function() {
    i = (i+1) % _loadingLabels.length;
    if(el) el.textContent = _loadingLabels[i];
  }, 1800);
}
function stopLoadingCycle() {
  if(_loadingTimer) { clearInterval(_loadingTimer); _loadingTimer = null; }
}

// --- Build prompt based on depth ---
function buildAIPrompt(q, depth) {
  var letters = ['A','B','C','D'];
  var opts = q.o.map(function(o, i) { return letters[i] + ') ' + o; }).join('\n');
  var correct = letters[q.c] + ') ' + q.o[q.c];
  var existing = q.e ? ('Existing explanation: ' + q.e) : '';

  var styleGuide = {
    simple:
      'Give a clear, simple explanation in 3-5 sentences. Use plain English. State WHY the correct answer is right and briefly WHY the others are wrong. End with one key takeaway sentence.',
    detailed:
      'Give a comprehensive clinical explanation. Cover: (1) Why the correct answer is right ‚Äî explain the underlying mechanism or principle. (2) Why each wrong option is incorrect. (3) A clinical pearl or real-world nursing application. Use structured paragraphs.',
    mnemonic:
      'Give a brief explanation of why the answer is correct, then create a memorable mnemonic, acronym, or rhyme that helps remember this fact. Label it clearly as "MNEMONIC:" and make it catchy and Nigeria-relevant where possible. Keep total response under 200 words.'
  };

  var isHospital = (QYear === 'Hospital Final');
  var context = isHospital
    ? 'You are an expert clinical nursing tutor for Nigerian hospital final exams. A Nigerian nursing student preparing for their hospital placement final assessment just answered this question.\n\n'
    : 'You are an expert NMCN (Nigerian Nursing & Midwifery Council of Nigeria) exam tutor. A Nigerian nursing student just answered this question.\n\n';
  return context +
    'QUESTION: ' + q.q + '\n' +
    'OPTIONS:\n' + opts + '\n' +
    'CORRECT ANSWER: ' + correct + '\n' +
    (existing ? existing + '\n' : '') +
    '\nINSTRUCTION: ' + styleGuide[depth] + '\n' +
    'Respond in plain text only ‚Äî no markdown asterisks, no bullet symbols. Use clear paragraph breaks. Be encouraging and pedagogical.';
}

// --- Typewriter renderer ---
function typewriterRender(el, text, done) {
  el.innerHTML = '';
  var i = 0;
  var cursor = document.createElement('span');
  cursor.className = 'ai-cursor';
  el.appendChild(cursor);
  var speed = text.length > 400 ? 10 : 16;
  var timer = setInterval(function() {
    if(i >= text.length) {
      clearInterval(timer);
      cursor.remove();
      if(done) done();
      return;
    }
    cursor.insertAdjacentText('beforebegin', text.charAt(i));
    i++;
    // Auto-scroll
    var sheet = document.getElementById('ai-sheet-body');
    if(sheet) sheet.scrollTop = sheet.scrollHeight;
  }, speed);
}

// --- Format raw text into structured HTML ---
function formatAIResponse(text, depth, q) {
  var letters = ['A','B','C','D'];
  var correct = letters[q.c] + ') ' + q.o[q.c];

  // Split into paragraphs
  var paras = text.trim().split(/\n\n+/).filter(function(p){ return p.trim(); });

  var html = '';

  // Usage bar (free users only)
  if(!isPro) {
    var usage = getAIUsage();
    var used = Math.min(usage.count, AI_FREE_LIMIT);
    var dots = '';
    for(var d=0; d<AI_FREE_LIMIT; d++) {
      dots += '<div class="ai-usage-dot' + (d < used ? ' used' : '') + '"></div>';
    }
    html += '<div class="ai-usage-bar"><div class="ai-usage-dots">' + dots + '</div><span>' + used + '/' + AI_FREE_LIMIT + ' free uses today</span></div>';
  }

  // Correct answer badge
  html += '<div class="ai-r-block"><strong>‚úì Correct Answer:</strong> ' + correct + '</div>';

  // Body paragraphs
  paras.forEach(function(p) {
    p = p.trim();
    if(!p) return;
    if(/^mnemonic[:\s]/i.test(p)) {
      html += '<div class="ai-mnemonic"><div class="ai-mnemonic-lbl">üß† Mnemonic</div>' + p.replace(/^mnemonic[:\s]*/i,'') + '</div>';
    } else if(/wrong|incorrect|not the|avoid|rather than/i.test(p) && depth === 'detailed') {
      html += '<div class="ai-wrong-block">' + p + '</div>';
    } else {
      html += '<p style="margin:0 0 12px">' + p + '</p>';
    }
  });

  // Action row
  html += '<div class="ai-action-row">' +
    '<button class="ai-action-btn" onclick="regenerateAI()">‚Ü∫ Regenerate</button>' +
    '<button class="ai-action-btn" onclick="copyAIExplanation()">‚éò Copy</button>' +
    '</div>';

  return html;
}

var _lastAIText = '';

function copyAIExplanation() {
  if(_lastAIText) {
    navigator.clipboard && navigator.clipboard.writeText(_lastAIText);
    toast('üìã Explanation copied!');
  }
}
function regenerateAI() {
  if(!_aiCurrentQ) return;
  var resp = document.getElementById('ai-response');
  var loading = document.getElementById('ai-loading');
  if(resp) { resp.style.display = 'none'; resp.innerHTML = ''; }
  if(loading) loading.style.display = 'flex';
  document.getElementById('ai-loading-lbl').textContent = 'Generating fresh explanation‚Ä¶';
  fetchAIExplanation(_aiCurrentQ, AI_DEPTH);
}

// --- Main fetch ---
function fetchAIExplanation(q, depth) {
  startLoadingCycle();
  var prompt = buildAIPrompt(q, depth);

  fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 600,
      messages: [{ role: 'user', content: prompt }]
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    stopLoadingCycle();
    var text = '';
    if(data && data.content && data.content[0] && data.content[0].text) {
      text = data.content[0].text.trim();
    } else if(data && data.error) {
      throw new Error(data.error.message || 'API error');
    } else {
      throw new Error('Unexpected response');
    }
    _lastAIText = text;
    incrementAIUsage();

    var loading = document.getElementById('ai-loading');
    var resp = document.getElementById('ai-response');
    if(loading) loading.style.display = 'none';
    if(resp) {
      resp.style.display = 'block';
      resp.innerHTML = formatAIResponse(text, depth, q);
    }
  })
  .catch(function(err) {
    stopLoadingCycle();
    var loading = document.getElementById('ai-loading');
    var resp = document.getElementById('ai-response');
    if(loading) loading.style.display = 'none';
    if(resp) {
      resp.style.display = 'block';
      // Show friendly error with fallback explanation
      var fallback = q.e ? '<div style="margin-top:12px;font-size:13px;line-height:1.6;color:var(--tx)"><strong>Written explanation:</strong><br>' + q.e + '</div>' : '';
      resp.innerHTML =
        '<div class="ai-error">' +
          '<div style="font-size:24px;margin-bottom:8px">‚ö°</div>' +
          '<strong>AI temporarily unavailable</strong><br>' +
          '<span style="font-size:12px;color:var(--mt);display:block;margin-top:4px">' +
            'To enable AI explanations, add your Anthropic API key to the app backend.' +
          '</span>' +
        '</div>' +
        fallback +
        '<div class="ai-action-row"><button class="ai-action-btn" onclick="regenerateAI()">‚Ü∫ Try again</button></div>';
    }
  });
}

// ================================================================
// Show AI button when answer is revealed
// ================================================================


loadAcc();
loadCodes();
loadDB();
loadChat();
loadPerformance();
loadNotifSettings();
loadNotifications();
loadMockDB();
loadMockSettings();
loadMockHistory();
loadCustomYears();
loadMockBanks();
loadMockSchedule();
loadDarkMode();
loadBookmarks();
loadLastQuizState();
startRotationWatcher();
// Show continue card if there's history
setTimeout(updateContinueCard, 100);

// Add admin login link to splash page discreetly
(function(){
  var splash = document.getElementById('pg-splash');
  var adminLink = document.createElement('p');
  adminLink.innerHTML = '<span onclick="go(\'admin-login\')" style="cursor:pointer;color:rgba(255,255,255,.18);font-size:11px;margin-top:16px;display:inline-block;user-select:none">‚öô</span>';
  splash.appendChild(adminLink);
})();

// Show splash immediately on load
go('splash');
</script>

<!-- ============================================================
     AI EXPLAIN MODAL
     ============================================================ -->
<div class="ai-modal-overlay" id="ai-modal-overlay" onclick="closeAIExplain(event)">
  <div class="ai-modal-sheet" onclick="event.stopPropagation()">
    <div class="ai-sheet-handle"></div>
    <div class="ai-sheet-hdr">
      <div class="ai-sheet-hdr-ico">‚ú¶</div>
      <div class="ai-sheet-hdr-title">AI Tutor</div>
      <button class="ai-sheet-hdr-close" onclick="closeAIExplain()">‚úï</button>
    </div>
    <div class="ai-q-recap" id="ai-q-recap"></div>
    <div class="ai-depth-row" id="ai-depth-row">
      <button class="ai-depth-btn on" data-depth="simple" onclick="setAIDepth(this,'simple')">üéØ Simple</button>
      <button class="ai-depth-btn" data-depth="detailed" onclick="setAIDepth(this,'detailed')">üìñ Detailed</button>
      <button class="ai-depth-btn" data-depth="mnemonic" onclick="setAIDepth(this,'mnemonic')">üß† Mnemonic</button>
    </div>
    <div class="ai-sheet-body" id="ai-sheet-body">
      <div class="ai-loading" id="ai-loading">
        <div class="ai-loading-dots">
          <div class="ai-loading-dot"></div>
          <div class="ai-loading-dot"></div>
          <div class="ai-loading-dot"></div>
        </div>
        <div class="ai-loading-lbl" id="ai-loading-lbl">Thinking‚Ä¶</div>
      </div>
      <div class="ai-response" id="ai-response" style="display:none"></div>
    </div>
  </div>
</div>
</body>
</html>
